 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23007bff' d='M50 0L100 50L50 100L0 50Z'/><path fill='%23e0e0e0' d='M50 10L90 50L50 90L10 50Z'/></svg>">
    
    <style>
        /* Global Styles & Variables */
        :root {
            --dark-bg: #0d0d0d; /* Even deeper dark background */
            --dark-fg: #1a1a1a; /* Slightly lighter for foreground elements */
            --text-color: #e0e0e0;
            --primary-color: #00aaff; /* Brighter Blue for a fresh feel */
            --primary-dark: #0088cc; /* Darker Blue */
            --accent-color: #ffaa00; /* Vibrant Orange/Gold */
            --accent-dark: #cc8800; /* Darker Orange */
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.8); /* Stronger shadows */
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --transition-speed: 0.3s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 18px; /* Slightly larger for modern cards */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif; /* Modern font stack */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px; /* Base font size */
            -webkit-font-smoothing: antialiased; /* Better text rendering */
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Scrollbar Styling for Dark Mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-fg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }


        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        button, input[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color var(--transition-speed), transform 0.15s ease, box-shadow var(--transition-speed);
            box-shadow: 0 4px 10px var(--shadow-color);
            letter-spacing: 0.5px;
            text-transform: uppercase; /* Professional look */
        }

        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.9);
        }

        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--dark-fg); /* Match foreground for sleek look */
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5); /* Inner shadow for depth */
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.25), inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .container {
            width: 90%;
            max-width: 520px; /* Slightly wider for modern feel */
            margin: auto;
            padding: 35px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 12px 30px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color); /* Subtle border */
        }

        .message {
            padding: 14px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            font-size: 0.98rem;
            word-wrap: break-word;
            border: 1px solid transparent; /* Default transparent border */
            animation: fadeIn 0.4s ease-out;
        }

        .message.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .message.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--error-color);
            border-color: var(--error-color);
        }
        .message.info {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info-color);
            border-color: var(--info-color);
        }

        .hidden {
            display: none !important;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg), #080808);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1.2s ease-out; /* Longer fade out */
            opacity: 1;
        }

        .splash-logo-container {
            width: 150px;
            height: 150px;
            position: relative;
        }

        .splash-logo-diamond {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            border-radius: 25px;
            box-shadow: 0 0 40px rgba(0, 170, 255, 0.8); /* Brighter glow */
            animation: splashDiamondPulse 2.5s infinite alternate ease-in-out;
        }

        .splash-logo-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem; /* Larger text */
            font-weight: 900; /* Bolder */
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 35px rgba(255, 255, 255, 0.6); /* Sharper glow */
            z-index: 1;
            letter-spacing: 3px;
        }

        .splash-loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite, glow 1.8s infinite alternate; /* Faster glow */
            margin-top: 50px;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.6);
        }

        /* Header */
        header {
            background-color: var(--dark-fg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 15px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 99;
            animation: slideDown 0.5s ease-out;
            min-height: 70px; /* Taller header */
        }

        .app-logo {
            display: flex;
            align-items: center;
            font-size: 2.2rem; /* Larger logo text */
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.7);
            letter-spacing: 1.5px;
        }

        .app-logo .shape {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--accent-color), #ffcc00); /* Brighter Gold */
            transform: rotate(45deg);
            border-radius: 10px;
            margin-right: 15px;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.7);
            animation: headerLogoSpin 4s infinite linear;
        }

        .header-icons {
            display: flex;
            gap: 15px; /* Space between icons */
            align-items: center;
        }

        .header-action-icon {
            font-size: 1.8rem; /* Larger icons */
            cursor: pointer;
            color: var(--text-color);
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 8px;
            border-radius: 50%; /* Circular hit area */
            background-color: rgba(255,255,255,0.05); /* Subtle background */
        }

        .header-action-icon:hover {
            color: var(--primary-color);
            transform: scale(1.1);
            background-color: rgba(0,170,255,0.1);
        }

        .header-icon-text {
            font-size: 0.8rem;
            margin-left: 5px;
            font-weight: 600;
            color: var(--accent-color);
        }

        /* Main Content */
        main {
            flex-grow: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased space between sections */
            overflow-y: auto;
            width: 100%;
            max-width: 1200px; /* Max width for content on large screens */
            margin: 0 auto;
        }

        section {
            display: none;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 20px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
        }

        section.active {
            display: block;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.4rem; /* Larger heading */
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
            letter-spacing: 1.5px;
            position: relative;
        }

        h2::after { /* Underline effect */
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: var(--accent-color);
            border-radius: 2px;
        }


        /* Password input with eye icon */
        .password-input-container {
            position: relative;
            margin-bottom: 15px;
        }

        .password-input-container input {
            padding-right: 50px; /* Space for the icon */
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--border-color);
            font-size: 1.4rem; /* Larger eye icon */
            transition: color var(--transition-speed);
            padding: 5px;
            border-radius: 5px;
        }

        .toggle-password:hover {
            color: var(--primary-color);
        }

        /* Post Creation Section */
        #create-post-section label {
            margin-bottom: 10px;
            font-size: 1rem;
        }

        #post-content {
            min-height: 150px; /* Taller textarea */
            resize: vertical;
            margin-bottom: 20px;
        }
        #post-limits-info {
            background-color: rgba(255, 170, 0, 0.1); /* Light accent background */
            border: 1px solid var(--accent-color);
            padding: 15px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        /* Post Display Section */
        #posts-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Larger min-width for posts */
            gap: 30px; /* More space between posts */
            padding-top: 10px; /* Breathing room at the top */
        }

        .post-card {
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            animation: slideInUp 0.6s ease-out; /* Animation for new posts */
            cursor: pointer; /* Indicate clickable */
        }

        .post-card:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.9);
            border-color: var(--primary-color); /* Highlight on hover */
        }

        .post-card h3 {
            color: var(--accent-color);
            margin-bottom: 12px;
            font-size: 1.4rem;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 170, 0, 0.5);
            display: flex;
            align-items: center;
        }
        .post-card h3 span.username {
            flex-grow: 1;
        }
        .post-card h3 .follow-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: none;
            text-transform: none;
        }
        .post-card h3 .follow-button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        .post-card h3 .follow-button.following {
            background-color: #6c757d; /* Grey when following */
        }
        .post-card h3 .follow-button.following:hover {
            background-color: #5a6268;
        }

        .post-card p {
            font-size: 1.05rem;
            margin-bottom: 20px;
            flex-grow: 1;
            word-wrap: break-word;
            color: var(--text-color);
            white-space: pre-wrap; /* Preserve line breaks */
        }
        .post-card .post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .post-meta {
            font-size: 0.88rem;
            color: #aaa;
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
            margin-bottom: 15px; /* Space before actions */
        }

        .post-actions {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
            justify-content: flex-end;
        }

        .post-actions button {
            padding: 8px 18px;
            font-size: 0.9rem;
            border-radius: 6px;
            background-color: var(--primary-color);
            box-shadow: none;
            transition: background-color 0.2s ease, transform 0.1s ease;
            text-transform: none; /* Keep natural case for actions */
        }

        .post-actions button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .post-actions button.delete-btn {
            background-color: var(--error-color);
        }
        .post-actions button.delete-btn:hover {
            background-color: #b02a37;
        }

        .post-actions button.like-btn.liked {
            background-color: var(--success-color); /* Green when liked */
        }
        .post-actions button.like-btn.liked:hover {
            background-color: #218838;
        }

        /* Unique Post Styles - Dynamic Examples */
        /* Horizontal Card */
        .post-card.horizontal {
            flex-direction: row;
            align-items: flex-start; /* Align content to top */
            gap: 20px;
            padding: 25px;
            min-height: 160px;
            border-left: 5px solid var(--accent-color);
            animation: slideInRight 0.7s ease-out;
        }
        .post-card.horizontal .post-content-wrapper {
            flex-grow: 1;
        }
        .post-card.horizontal .post-meta {
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
            min-width: 100px;
            border-top: none; /* No top border for horizontal */
            padding-top: 0;
            margin-bottom: 0;
        }
        .post-card.horizontal .post-actions {
            flex-direction: column; /* Stack buttons vertically in horizontal layout */
            gap: 8px;
        }

        /* Square Card */
        .post-card.square {
            aspect-ratio: 1 / 1; /* Maintain square aspect ratio */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: var(--border-radius-lg); /* Rounded square */
            animation: zoomIn 0.8s ease-out;
            border: 2px solid var(--info-color);
        }
        .post-card.square .post-content-wrapper {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 5; /* Limit lines for square */
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }
        .post-card.square .post-meta, .post-card.square .post-actions {
            margin-top: 10px;
            justify-content: center;
        }

        /* Neon Effect */
        .post-card.neon {
            box-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color) inset;
            border-color: var(--primary-color);
            position: relative;
            overflow: hidden;
            animation: neonGlow 1.5s infinite alternate ease-in-out;
        }
        .post-card.neon::before { /* Border glow effect */
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color), var(--primary-color));
            z-index: -1;
            filter: blur(8px);
            opacity: 0.7;
            border-radius: var(--border-radius-lg);
            animation: neonBorderPulse 3s infinite linear;
        }
        .post-card.neon h3, .post-card.neon p, .post-card.neon .post-meta {
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.8), 0 0 20px rgba(0, 170, 255, 0.6);
        }
        .post-card.neon .post-actions button {
            background-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.7);
        }
        .post-card.neon .post-actions button:hover {
            background-color: var(--accent-dark);
        }
        
        /* User Profile Section */
        #user-profile-section .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        #user-profile-section .profile-username {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        #user-profile-section .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            margin-bottom: 25px;
        }
        #user-profile-section .stat-item {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            flex: 1; /* Distribute space */
            max-width: 120px;
        }
        #user-profile-section .stat-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        #user-profile-section .stat-label {
            font-size: 0.85rem;
            color: #ccc;
        }
        #user-profile-section .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        #user-profile-section .profile-actions button {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        #user-profile-section .user-contact-details {
            margin-top: 30px;
            border-top: 1px dashed var(--border-color);
            padding-top: 20px;
        }
        #user-profile-section .user-contact-details p {
            margin-bottom: 10px;
            font-size: 1.05rem;
            color: #bbb;
        }
        #user-profile-section .user-contact-details strong {
            color: var(--text-color);
        }
        #user-profile-section .user-contact-details .contact-button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #user-profile-section .user-contact-details .contact-button-group button {
            padding: 8px 15px;
            font-size: 0.9rem;
            text-transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }


        /* Ad Limits / Coins / Credits Section */
        #ad-limits-section .limit-summary {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        #ad-limits-section .limit-card {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #ad-limits-section .limit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.9);
        }
        #ad-limits-section .limit-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }
        #ad-limits-section .limit-card .label {
            font-size: 0.9rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #ad-limits-section .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }
        #ad-limits-section .action-buttons button {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
        }
        #ad-limits-section .action-buttons button.reward-btn {
            background-color: var(--success-color);
        }
        #ad-limits-section .action-buttons button.reward-btn:hover {
            background-color: #218838;
        }


        /* Monetization Info Section */
        #monetization-section .monetization-card {
            background-color: rgba(0, 170, 255, 0.08); /* Light primary background */
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-md);
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        #monetization-section .monetization-card h3 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        #monetization-section .monetization-card p {
            font-size: 1.05rem;
            color: #ccc;
            margin-bottom: 10px;
            line-height: 1.8;
        }
        #monetization-section .monetization-card .highlight {
            color: var(--accent-color);
            font-weight: 600;
        }
        #monetization-section .share-app-button {
            margin-top: 25px;
            font-size: 1.1rem;
        }


        /* Message / Chat Section */
        #chat-section {
            display: flex;
            flex-direction: column;
            height: 100%; /* Take full height within main */
            max-height: 80vh; /* Limit for scrollable area */
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--dark-bg);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-sm);
            padding: 10px 15px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
        }
        .chat-message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .chat-message.received {
            align-self: flex-start;
            background-color: #444;
            color: var(--text-color);
            border-bottom-left-radius: 2px;
        }
        .chat-message .sender-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        .chat-message .message-text {
            font-size: 0.95rem;
        }
        .chat-message .timestamp {
            font-size: 0.75rem;
            color: #bbb;
            text-align: right;
            margin-top: 5px;
        }
        #chat-input-form {
            display: flex;
            gap: 10px;
        }
        #chat-input-form textarea {
            flex-grow: 1;
            margin-bottom: 0;
            min-height: 40px;
            max-height: 100px;
            resize: vertical;
            padding: 8px 12px;
        }
        #chat-input-form button {
            padding: 10px 20px;
            min-width: 80px;
        }
        #chat-cost-info {
            font-size: 0.85rem;
            color: #aaa;
            text-align: center;
            margin-top: 10px;
        }


        /* Other User Profile (when clicking on a post) */
        #other-user-profile-section {
            /* This section will reuse most of .profile-header, .profile-stats, .profile-actions etc. */
        }
        #other-user-profile-posts {
            margin-top: 30px;
            border-top: 1px dashed var(--border-color);
            padding-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        #other-user-profile-posts .post-card {
            cursor: default; /* Posts within profile aren't clickable to another profile */
            animation: slideInUp 0.5s ease-out;
        }
        #other-user-profile-posts .post-card:hover {
            transform: none; /* No lift on hover */
            box-shadow: 0 8px 20px var(--shadow-color);
            border-color: var(--border-color);
        }
        #other-user-profile-posts .post-card .post-actions {
            display: none; /* Hide actions on profile posts view */
        }
        #other-user-profile-posts .post-card h3 .follow-button {
            display: none; /* Hide follow button on self-profile posts */
        }


        /* Bottom Navigation */
        footer {
            background-color: var(--dark-fg);
            padding: 15px 0;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 15px var(--shadow-color);
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 99;
            animation: slideUp 0.5s ease-out;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            flex: 1; /* Distribute space evenly */
            max-width: 100px; /* Max width for nav items */
        }

        .nav-item.active {
            color: var(--primary-color);
            transform: translateY(-3px); /* Slight lift */
            background-color: rgba(0, 170, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.2);
        }

        .nav-item:hover {
            color: var(--primary-color);
            background-color: rgba(0, 170, 255, 0.05);
        }

        .nav-item .icon {
            font-size: 1.6rem;
            margin-bottom: 5px;
            width: 28px;
            height: 28px;
            background-color: currentColor; /* Use current text color for SVG masks */
            -webkit-mask-size: cover;
            mask-size: cover;
            transition: transform 0.2s ease;
        }

        .nav-item:hover .icon {
            transform: scale(1.1);
        }

        /* Custom SVG Icons (used as mask-image for better styling) */
        /* Home Icon */
        .icon-home { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z'/%3E%3C/svg%3E"); }
        /* Plus/Create Icon */
        .icon-plus { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z'/%3E%3C/svg%3E"); }
        /* User/Profile Icon */
        .icon-user { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4z'/%3E%3C/svg%3E"); }
        /* Chat Icon */
        .icon-chat { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z'/%3E%3C/svg%3E"); }
        /* Monetization Icon */
        .icon-money { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-4-4l1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-4-4l1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z'/%3E%3C/svg%3E"); }
        /* Settings Icon */
        .icon-settings { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5A3.5 3.5 0 0 1 15.5 12A3.5 3.5 0 0 1 12 15.5M12 5c.45 0 .9-.04 1.34.12l.62-1.63l1.88.7L16.92 5.5l1.63-.62l.7 1.88l-1.07 1.07l.12 1.34h2.09c.07.45.07.9 0 1.35h-2.09l-.12 1.34l1.07 1.07l-.7 1.88l-1.63-.62l-1.88.7l-.62 1.63c-.45.16-.9.16-1.35 0l-.62-1.63l-1.88-.7l-1.63.62l-.7-1.88l1.07-1.07l-.12-1.34H2.91c-.07-.45-.07-.9 0-1.35h2.09l.12-1.34l-1.07-1.07l.7-1.88l1.63.62l1.88-.7l.62-1.63c.45-.16.9-.16 1.35 0z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5A3.5 3.5 0 0 1 15.5 12A3.5 3.5 0 0 1 12 15.5M12 5c.45 0 .9-.04 1.34.12l.62-1.63l1.88.7L16.92 5.5l1.63-.62l.7 1.88l-1.07 1.07l.12 1.34h2.09c.07.45.07.9 0 1.35h-2.09l-.12 1.34l1.07 1.07l-.7 1.88l-1.63-.62l-1.88.7l-.62 1.63c-.45.16-.9.16-1.35 0l-.62-1.63l-1.88-.7l-1.63.62l-.7-1.88l1.07-1.07l-.12-1.34H2.91c-.07-.45-.07-.9 0-1.35h2.09l.12-1.34l-1.07-1.07l.7-1.88l1.63.62l1.88-.7l.62-1.63c.45-.16.9-.16 1.35 0z'/%3E%3C/svg%3E"); }


        /* Desktop Adjustments */
        @media (min-width: 768px) {
            body {
                font-size: 17px;
            }
            .container {
                padding: 40px;
                max-width: 600px; /* Larger max-width for forms on desktop */
            }
            header {
                padding: 20px 40px;
            }
            main {
                padding: 30px 40px;
                max-width: 1400px; /* Wider content area for desktop */
            }
            footer {
                padding: 15px 40px;
            }
            #posts-list {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Adjust post grid for wider screens */
            }
            .post-card.horizontal {
                grid-column: span 2; /* Make horizontal cards span 2 columns on desktop */
                max-width: none;
            }
            .post-card.square {
                max-width: 350px; /* Fixed size on desktop */
                justify-self: center; /* Center align square cards in their grid cell */
            }
            #chat-section {
                max-height: 90vh; /* Allow chat to take more height on desktop */
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--primary-color); }
            50% { box-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--accent-color); }
            100% { box-shadow: 0 0 5px var(--primary-color); }
        }

        @keyframes splashDiamondPulse {
            0%, 100% { transform: translate(-50%, -50%) rotate(45deg) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) rotate(45deg) scale(1.08); opacity: 0.8; }
        }

        @keyframes headerLogoSpin {
            0% { transform: rotate(45deg) scale(1); }
            25% { transform: rotate(135deg) scale(1.05); }
            50% { transform: rotate(225deg) scale(1); }
            75% { transform: rotate(315deg) scale(1.05); }
            100% { transform: rotate(405deg) scale(1); } /* 360 + 45 to keep initial orientation */
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes neonGlow {
            0% { box-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color) inset; }
            50% { box-shadow: 0 0 25px var(--primary-color), 0 0 40px var(--primary-color) inset; }
            100% { box-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color) inset; }
        }
        @keyframes neonBorderPulse {
            0%, 100% { opacity: 0.7; filter: blur(8px) brightness(1); }
            50% { opacity: 1; filter: blur(12px) brightness(1.2); }
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 20px; }
        .mt-4 { margin-top: 20px; }
        .mb-3 { margin-bottom: 15px; }
        .mt-3 { margin-top: 15px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    </head>
<body>

    <div id="splash-screen">
        <div class="splash-logo-container">
            <div class="splash-logo-diamond"></div>
            <div class="splash-logo-text">A</div>
        </div>
        <div class="splash-loader"></div>
        <p style="margin-top: 20px; font-size: 1.2rem; color: #bbb;">Loading AddMint Pro...</p>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="app-logo">
                <span class="shape"></span> AddMint
            </div>
            <div class="header-icons">
                <div class="header-action-icon" onclick="showSection('ad-limits-section')">
                    ðŸ’°
                    <span class="header-icon-text" id="header-coins">0</span>
                    <span class="header-icon-text" id="header-credits">0</span>
                    <span class="header-icon-text" id="header-limit">0</span>
                </div>
                <div class="header-action-icon" onclick="toggleSettingsMenu()">
                    &#x22EE; </div>
            </div>
        </header>

        <main>
            <section id="signin-auth" class="container active">
                <h2>Welcome Back!</h2>
                <div id="auth-status-message" class="message hidden"></div>
                <form id="signin-form">
                    <input type="email" id="signin-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signin-password', this)">&#128065;</span> </div>
                    <button type="submit">Sign In</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="showSection('signup-auth'); return false;">Sign Up Here</a></p>
                </form>
            </section>

            <section id="signup-auth" class="container">
                <h2>Join AddMint Today!</h2>
                <div id="signup-status-message" class="message hidden"></div>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signup-password" placeholder="Create Password (min 6 chars)" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signup-password', this)">&#128065;</span>
                    </div>
                    <div class="password-input-container">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signup-confirm-password', this)">&#128065;</span>
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="showSection('signin-auth'); return false;">Sign In</a></p>
                </section>
            </section>

            <section id="email-verify" class="container">
                <h2>Verify Your Email</h2>
                <div id="verify-email-message" class="message error"></div>
                <p class="text-center mb-4">A verification link has been sent to your email. Please check your inbox (and spam folder) to activate your account. Then sign in again.</p>
                <button onclick="sendVerificationEmail()">Resend Verification Email</button>
                <button onclick="auth.signOut(); showSection('signin-auth');" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

            <section id="setup-profile" class="container">
                <h2>Complete Your Profile</h2>
                <div id="profile-setup-message" class="message hidden"></div>
                <form id="profile-setup-form">
                    <label for="profileUsername">Choose a Username:</label>
                    <input type="text" id="profileUsername" placeholder="e.g., AddMintUser" required>

                    <label for="profilePhone" class="mt-4">Phone Number (Optional):</label>
                    <input type="text" id="profilePhone" placeholder="e.g., +919876543210">

                    <label for="profileWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="profileWhatsApp" placeholder="e.g., +919876543210 (for direct chats)">

                    <label for="profileInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="profileInstagram" placeholder="e.g., @yourhandle">

                    <button type="submit" class="mt-4">Save Profile & Continue</button>
                </form>
            </section>

            <section id="home-posts">
                <h2>Recent Updates</h2>
                <button class="mb-4" onclick="fetchPosts()">Refresh Feed</button>
                <div id="posts-list">
                    <p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>
                </div>
            </section>

            <section id="create-post-section">
                <h2>Share Your Thoughts</h2>
                <div id="create-post-message" class="message hidden"></div>
                <div id="post-limits-info" class="message info">
                    You have <span id="daily-free-posts-remaining">2</span> free posts remaining today. After that, each post costs 5 coins or 1 ad.
                </div>
                <form id="create-post-form">
                    <label for="post-content">What's on your mind today?</label>
                    <textarea id="post-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Publish Post</button>
                </form>
            </section>

            <section id="user-profile-section">
                <div class="profile-header">
                    <h2 class="profile-username" id="my-profile-display-name"></h2>
                    <p><strong>Email:</strong> <span id="my-profile-email"></span></p>
                    <div class="profile-stats">
                        <div class="stat-item"><div class="stat-count" id="my-posts-count">0</div><div class="stat-label">Posts</div></div>
                        <div class="stat-item"><div class="stat-count" id="my-followers-count">0</div><div class="stat-label">Followers</div></div>
                        <div class="stat-item"><div class="stat-count" id="my-following-count">0</div><div class="stat-label">Following</div></div>
                    </div>
                </div>
                <div id="my-user-contact-details" class="user-contact-details text-center">
                    <p><strong>Phone:</strong> <span id="my-profile-phone-number">N/A</span></p>
                    <p><strong>WhatsApp:</strong> <span id="my-profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="my-profile-instagram-handle">N/A</span></p>
                    <div class="contact-button-group">
                        </div>
                </div>
                <div class="profile-actions">
                    <button onclick="showSection('edit-profile-section')">Edit Profile</button>
                    <button onclick="auth.signOut()" style="background-color: var(--error-color);">Sign Out</button>
                </div>
                <h3 class="text-center mt-4" style="color:var(--primary-color);">My Posts</h3>
                <div id="my-active-posts-list" class="posts-list-small">
                     <p class="text-center" style="margin-top: 20px; font-style: italic; color: #aaa;">Loading your posts...</p>
                </div>
            </section>

            <section id="other-user-profile-section">
                <button onclick="showSection('home-posts')" style="background-color:#6c757d; margin-bottom: 20px;">&larr; Back to Feed</button>
                <div class="profile-header">
                    <h2 class="profile-username" id="other-profile-display-name"></h2>
                    <div class="profile-stats">
                        <div class="stat-item"><div class="stat-count" id="other-posts-count">0</div><div class="stat-label">Posts</div></div>
                        <div class="stat-item"><div class="stat-count" id="other-followers-count">0</div><div class="stat-label">Followers</div></div>
                        <div class="stat-item"><div class="stat-count" id="other-following-count">0</div><div class="stat-label">Following</div></div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="follow-unfollow-button" onclick="toggleFollow()" class="follow-button">Follow</button>
                </div>
                <div id="other-user-contact-details" class="user-contact-details text-center">
                    <div class="contact-button-group">
                        <button onclick="contactUser(targetProfileId, 'whatsapp')" style="background-color:#25D366;">WhatsApp</button>
                        <button onclick="contactUser(targetProfileId, 'instagram')" style="background-color:#E1306C;">Instagram</button>
                        <button onclick="contactUser(targetProfileId, 'phone')" style="background-color:#007bff;">Call</button>
                        <button onclick="openChatWithUser(targetProfileId, document.getElementById('other-profile-display-name').textContent)" style="background-color:#17a2b8;">Message</button>
                    </div>
                </div>
                <h3 class="text-center mt-4" style="color:var(--primary-color);">Active Posts by <span id="other-user-posts-label">User</span></h3>
                <div id="other-user-profile-posts">
                     <p class="text-center" style="margin-top: 20px; font-style: italic; color: #aaa;">Loading posts...</p>
                </div>
            </section>


            <section id="edit-profile-section" class="container">
                <h2>Update Your Profile Details</h2>
                <div id="edit-profile-message" class="message hidden"></div>
                <form id="edit-profile-form">
                    <label for="editUsername">Username:</label>
                    <input type="text" id="editUsername" required>

                    <label for="editPhone" class="mt-4">Phone Number (Optional):</label>
                    <input type="text" id="editPhone">

                    <label for="editWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="editWhatsApp">

                    <label for="editInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="editInstagram">

                    <button type="submit" class="mt-4">Save Changes</button>
                    <button type="button" onclick="showSection('user-profile-section')" class="mt-4" style="background-color: #6c757d;">Cancel</button>
                </form>
            </section>

            <section id="ad-limits-section">
                <h2>Your Wallet & Limits</h2>
                <div class="limit-summary">
                    <div class="limit-card">
                        <div class="value" id="current-coins">0</div>
                        <div class="label">Coins</div>
                    </div>
                    <div class="limit-card">
                        <div class="value" id="current-credits">0</div>
                        <div class="label">Credits</div>
                    </div>
                    <div class="limit-card">
                        <div class="value" id="current-ad-limits">0</div>
                        <div class="label">Ad Limits</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="reward-btn" onclick="requestAd('coins')">Watch Ad for 10 Coins</button>
                    <button class="reward-btn" onclick="requestAd('credits')">Watch Ad for 1 Credit</button>
                    <button class="reward-btn" onclick="requestAd('post_limit')">Watch Ad for 1 Post Limit</button>
                </div>
                <p class="text-center mt-4" style="font-style: italic; color: #bbb;">
                    Ad Limits are used for additional posts after your daily free limit.
                </p>
            </section>

            <section id="monetization-section">
                <h2>Monetization Opportunities!</h2>
                <div class="monetization-card">
                    <h3>Earn Money with AddMint Pro!</h3>
                    <p>Unlock earning potential when you reach <span class="highlight">100 Followers</span>.</p>
                    <p>After reaching 100 followers, for every <span class="highlight">150 posts</span> you publish, you can earn between <span class="highlight">â‚¹10 and â‚¹100!</span></p>
                    <p>The more engaging your content, the higher your earning potential!</p>
                    <p>Start sharing, grow your audience, and monetize your content!</p>
                    <p class="mt-4" style="font-weight: 600; color: var(--success-color);">
                        Share the app with your friends to gain more followers quickly!
                    </p>
                    <button class="share-app-button" onclick="shareApp()">Share AddMint Pro</button>
                </div>
            </section>

            <section id="chat-section">
                <h2 id="chat-header">Chat</h2>
                <div id="chat-messages">
                    <p class="text-center" id="no-chat-message" style="margin-top: 20px; font-style: italic; color: #aaa;">No messages yet. Start a conversation!</p>
                </div>
                <div id="chat-cost-info">1 message costs 1 Credit. Messages delete automatically after 24 hours.</div>
                <form id="chat-input-form">
                    <textarea id="chat-message-input" placeholder="Type your message..." rows="1"></textarea>
                    <button type="submit">Send</button>
                </form>
                <div id="chat-status-message" class="message hidden mt-3"></div>
            </section>


            <section id="settings-section" class="container">
                <h2>App Settings</h2>
                <p class="text-center mt-4">This is your settings panel. More options coming soon!</p>
                <p class="text-center mt-2">App Version: 1.0.0 Pro</p>
                <button onclick="auth.signOut()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

        </main>

        <footer>
            <div class="nav-item active" data-section="home-posts">
                <span class="icon icon-home"></span>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="create-post-section">
                <span class="icon icon-plus"></span>
                <span>Create</span>
            </div>
            <div class="nav-item" data-section="chat-section">
                <span class="icon icon-chat"></span>
                <span>Chat</span>
            </div>
            <div class="nav-item" data-section="monetization-section">
                <span class="icon icon-money"></span>
                <span>Earn</span>
            </div>
            <div class="nav-item" data-section="user-profile-section">
                <span class="icon icon-user"></span>
                <span>Profile</span>
            </div>
        </footer>
    </div>

    <script>
        // Firebase Configuration (YOURS)
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app", // Still needed for init, but not actively used for file uploads
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // const storage = firebase.storage(); // Not using storage for now, as per user's request

        let currentUserId = null;
        let currentUsername = null;
        let userProfileData = {}; // To store full user profile data (coins, credits, posts counts, etc.)
        let targetProfileId = null; // For displaying other user profiles
        let chatTargetUserId = null; // For current chat recipient
        let chatTargetUsername = null; // For current chat recipient's username
        let chatListener = null; // To manage Firestore chat snapshot listener

        // Constants
        const DAILY_FREE_POSTS_LIMIT = 2;
        const COST_PER_POST_COINS = 5;
        const AD_REWARD_COINS = 10;
        const AD_REWARD_CREDITS = 1;
        const AD_REWARD_POST_LIMIT = 1;
        const COST_PER_MESSAGE_CREDIT = 1;
        const MESSAGE_EXPIRY_HOURS = 24; // Messages delete after 24 hours
        const POST_EXPIRY_HOURS = 12; // Posts delete after 12 hours

        // --- UI Utility Functions ---
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.remove('active');
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('active');

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // If switching away from chat, detach listener
            if (sectionId !== 'chat-section' && chatListener) {
                chatListener(); // Detach the listener
                chatListener = null;
                chatTargetUserId = null;
                chatTargetUsername = null;
            }
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`; // Reset classes and add new ones
            element.classList.remove('hidden');
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                iconElement.innerHTML = "&#128064;"; // Open eye
            } else {
                input.type = "password";
                iconElement.innerHTML = "&#128065;"; // Closed eye
            }
        }

        function showMainAppUI() {
            document.getElementById('app-container').classList.remove('hidden');
            showSection('home-posts'); // Default to home/posts section
        }

        function hidePreloader() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.classList.add('hidden');
                document.body.style.overflow = 'auto'; // Allow scrolling after splash
            }, 1200); // Fade out over 1.2 seconds
        }

        function updateHeaderCoinsCreditsLimits() {
            document.getElementById('header-coins').textContent = userProfileData.coins || 0;
            document.getElementById('header-credits').textContent = userProfileData.credits || 0;
            document.getElementById('header-limit').textContent = userProfileData.adLimits || 0;
            document.getElementById('current-coins').textContent = userProfileData.coins || 0;
            document.getElementById('current-credits').textContent = userProfileData.credits || 0;
            document.getElementById('current-ad-limits').textContent = userProfileData.adLimits || 0;
            
            // Update free posts remaining message
            const dailyPostsUsed = userProfileData.dailyPostCounter || 0;
            const freePostsRemaining = Math.max(0, DAILY_FREE_POSTS_LIMIT - dailyPostsUsed);
            document.getElementById('daily-free-posts-remaining').textContent = freePostsRemaining;
        }

        // --- Authentication ---
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('signup-status-message');
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;

            if (password !== confirmPassword) {
                showMessage('signup-status-message', 'Passwords do not match.', 'error');
                return;
            }
            if (password.length < 6) {
                showMessage('signup-status-message', 'Password must be at least 6 characters long.', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                showMessage('signup-status-message', 'Account created! Verification email sent. Please check your inbox (and spam folder) to activate your account. Then sign in after verifying.', 'success');
                showSection('email-verify');
                document.getElementById('verify-email-message').textContent = `A verification email has been sent to ${email}. Please verify your email to continue.`;
            } catch (error) {
                console.error("Signup Error:", error.code, error.message);
                let displayMessage = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    displayMessage = 'This email is already registered. Please sign in or use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    displayMessage = 'The email address is not valid.';
                }
                showMessage('signup-status-message', displayMessage, 'error');
            }
        });

        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('auth-status-message');
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    showMessage('auth-status-message', 'Your email is not verified. Please verify it to continue.', 'error');
                    auth.signOut(); // Force sign out if email not verified
                    showSection('email-verify');
                    document.getElementById('verify-email-message').textContent = `Your email ${email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    return;
                }
                // If email is verified, auth state listener will handle showing main UI
            } catch (error) {
                console.error("Signin Error:", error.code, error.message);
                let displayMessage = error.message;
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    displayMessage = 'Invalid email or password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    displayMessage = 'The email address is not valid.';
                }
                showMessage('auth-status-message', displayMessage, 'error');
            }
        });

        async function sendVerificationEmail() {
            const user = auth.currentUser;
            if (user) {
                try {
                    await user.sendEmailVerification();
                    showMessage('verify-email-message', 'Verification email re-sent! Check your inbox (and spam folder).', 'success');
                } catch (error) {
                    console.error("Error sending verification email:", error.message);
                    showMessage('verify-email-message', `Error sending verification email: ${error.message}`, 'error');
                }
            } else {
                 showMessage('verify-email-message', 'No user logged in to send verification email.', 'error');
            }
        }

        // --- Profile Management ---
        document.getElementById('profile-setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('profile-setup-message');
            const username = document.getElementById('profileUsername').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const whatsapp = document.getElementById('profileWhatsApp').value.trim();
            const instagram = document.getElementById('profileInstagram').value.trim();

            if (!username) {
                showMessage('profile-setup-message', 'Username is required to identify you.', 'error');
                return;
            }

            try {
                await db.collection('users').doc(currentUserId).set({
                    username: username,
                    email: auth.currentUser.email,
                    phone: phone || null,
                    whatsapp: whatsapp || null,
                    instagram: instagram || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    coins: 0,
                    credits: 0,
                    adLimits: 0,
                    postCounter: 0, // Total posts created
                    dailyPostCounter: 0, // Posts created today
                    lastDailyPostReset: Date.now() // Timestamp of last reset
                }, { merge: true });

                currentUsername = username;
                showMessage('profile-setup-message', 'Profile saved successfully! Redirecting...', 'success');
                await fetchUserProfile(currentUserId);
                showMainAppUI();
            } catch (error) {
                console.error("Error setting up profile:", error.message);
                showMessage('profile-setup-message', `Failed to save profile: ${error.message}`, 'error');
            }
        });

        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('edit-profile-message');
            const username = document.getElementById('editUsername').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const whatsapp = document.getElementById('editWhatsApp').value.trim();
            const instagram = document.getElementById('editInstagram').value.trim();

            if (!username) {
                showMessage('edit-profile-message', 'Username is required.', 'error');
                return;
            }

            try {
                await db.collection('users').doc(currentUserId).update({
                    username: username,
                    phone: phone || null,
                    whatsapp: whatsapp || null,
                    instagram: instagram || null
                });
                currentUsername = username;
                showMessage('edit-profile-message', 'Profile updated successfully!', 'success');
                await fetchUserProfile(currentUserId);
                showSection('user-profile-section');
            } catch (error) {
                console.error("Error updating profile:", error.message);
                showMessage('edit-profile-message', `Failed to update profile: ${error.message}`, 'error');
            }
        });

        async function fetchUserProfile(uid) {
            if (!uid) return;
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    userProfileData = userDoc.data();
                    currentUsername = userProfileData.username;

                    // Reset daily post counter if a new day
                    const now = Date.now();
                    const lastReset = userProfileData.lastDailyPostReset || 0;
                    const twentyFourHours = 24 * 60 * 60 * 1000;

                    if (now - lastReset > twentyFourHours) {
                        userProfileData.dailyPostCounter = 0;
                        userProfileData.lastDailyPostReset = now;
                        // Update in Firestore as well
                        await db.collection('users').doc(uid).update({
                            dailyPostCounter: 0,
                            lastDailyPostReset: now
                        });
                        console.log("Daily post counter reset.");
                    }
                    
                    updateHeaderCoinsCreditsLimits(); // Update header stats

                    // Populate my profile section
                    document.getElementById('my-profile-email').textContent = userProfileData.email || 'N/A';
                    document.getElementById('my-profile-display-name').textContent = userProfileData.username || 'N/A';
                    document.getElementById('my-profile-phone-number').textContent = userProfileData.phone || 'N/A';
                    document.getElementById('my-profile-whatsapp-number').textContent = userProfileData.whatsapp || 'N/A';
                    document.getElementById('my-profile-instagram-handle').textContent = userProfileData.instagram || 'N/A';
                    document.getElementById('my-posts-count').textContent = userProfileData.postCounter || 0;
                    
                    // Fetch followers and following counts
                    await fetchFollowCounts(uid, 'my');

                    // Populate edit form
                    document.getElementById('editUsername').value = userProfileData.username || '';
                    document.getElementById('editPhone').value = userProfileData.phone || '';
                    document.getElementById('editWhatsApp').value = userProfileData.whatsapp || '';
                    document.getElementById('editInstagram').value = userProfileData.instagram || '';

                } else {
                    console.log("User profile not found in Firestore for current user. Prompting for setup.");
                    userProfileData = {};
                    showSection('setup-profile');
                    document.getElementById('profileUsername').value = auth.currentUser.displayName || '';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                // If profile fetch fails, ensure the app still proceeds, maybe to setup or a basic view.
                if (!userProfileData.username) showSection('setup-profile');
            }
        }

        async function fetchOtherUserProfile(uid) {
            if (!uid || uid === currentUserId) {
                showSection('user-profile-section'); // Redirect to self profile if trying to view self
                return;
            }
            targetProfileId = uid; // Set global target ID
            showSection('other-user-profile-section');
            document.getElementById('other-user-profile-posts').innerHTML = '<p class="text-center" style="margin-top: 20px; font-style: italic; color: #aaa;">Loading posts...</p>';
            
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const otherUserData = userDoc.data();
                    document.getElementById('other-profile-display-name').textContent = otherUserData.username || 'Unknown User';
                    document.getElementById('other-user-posts-label').textContent = otherUserData.username || 'User';
                    document.getElementById('other-posts-count').textContent = otherUserData.postCounter || 0;
                    
                    // Fetch followers/following for other user
                    await fetchFollowCounts(uid, 'other');

                    // Check if current user is following this user
                    const followerDoc = await db.collection('users').doc(uid).collection('followers').doc(currentUserId).get();
                    const followButton = document.getElementById('follow-unfollow-button');
                    if (followerDoc.exists) {
                        followButton.textContent = 'Following';
                        followButton.classList.add('following');
                    } else {
                        followButton.textContent = 'Follow';
                        followButton.classList.remove('following');
                    }

                    // Populate contact buttons and info for other user (if available)
                    const otherContactDetailsDiv = document.getElementById('other-user-contact-details');
                    otherContactDetailsDiv.querySelector('button[onclick*="whatsapp"]').style.display = otherUserData.whatsapp ? 'inline-block' : 'none';
                    otherContactDetailsDiv.querySelector('button[onclick*="instagram"]').style.display = otherUserData.instagram ? 'inline-block' : 'none';
                    otherContactDetailsDiv.querySelector('button[onclick*="phone"]').style.display = otherUserData.phone ? 'inline-block' : 'none';
                    
                    // Fetch posts by this user
                    fetchPosts(uid, 'other'); // Fetch posts specific to this user
                } else {
                    alert('User profile not found.');
                    showSection('home-posts');
                }
            } catch (error) {
                console.error("Error fetching other user profile:", error);
                alert(`Error loading user profile: ${error.message}`);
                showSection('home-posts');
            }
        }

        async function fetchFollowCounts(uid, prefix) {
            try {
                const followersSnapshot = await db.collection('users').doc(uid).collection('followers').get();
                const followingSnapshot = await db.collection('users').doc(uid).collection('following').get(); // Assuming 'following' subcollection

                document.getElementById(`${prefix}-followers-count`).textContent = followersSnapshot.size;
                document.getElementById(`${prefix}-following-count`).textContent = followingSnapshot.size;

            } catch (error) {
                console.error(`Error fetching ${prefix} follow counts:`, error);
                document.getElementById(`${prefix}-followers-count`).textContent = 'N/A';
                document.getElementById(`${prefix}-following-count`).textContent = 'N/A';
            }
        }


        async function toggleFollow() {
            if (!currentUserId) {
                showMessage('auth-status-message', 'Please sign in to follow users.', 'error');
                showSection('signin-auth');
                return;
            }
            if (!targetProfileId) return;

            const followButton = document.getElementById('follow-unfollow-button');
            const isFollowing = followButton.classList.contains('following');

            const followedUserRef = db.collection('users').doc(targetProfileId);
            const currentUserRef = db.collection('users').doc(currentUserId);

            const batch = db.batch();

            try {
                if (isFollowing) {
                    // Unfollow
                    batch.delete(followedUserRef.collection('followers').doc(currentUserId));
                    batch.delete(currentUserRef.collection('following').doc(targetProfileId));
                } else {
                    // Follow
                    batch.set(followedUserRef.collection('followers').doc(currentUserId), {
                        followerId: currentUserId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    batch.set(currentUserRef.collection('following').doc(targetProfileId), {
                        followedId: targetProfileId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await batch.commit();
                await fetchFollowCounts(targetProfileId, 'other'); // Update counts
                if (isFollowing) {
                    followButton.textContent = 'Follow';
                    followButton.classList.remove('following');
                } else {
                    followButton.textContent = 'Following';
                    followButton.classList.add('following');
                }
            } catch (error) {
                console.error("Error toggling follow:", error);
                alert(`Failed to ${isFollowing ? 'unfollow' : 'follow'}: ${error.message}`);
            }
        }


        // --- Post Management ---
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('create-post-message');
            const content = document.getElementById('post-content').value.trim();

            if (!content) {
                showMessage('create-post-message', 'Post content cannot be empty. Please type something.', 'error');
                return;
            }
            if (!currentUserId || !currentUsername) {
                showMessage('create-post-message', 'User not logged in or username not set. Please refresh and try again.', 'error');
                return;
            }

            const dailyPostsUsed = userProfileData.dailyPostCounter || 0;
            const adLimits = userProfileData.adLimits || 0;
            const coins = userProfileData.coins || 0;

            let requiresPaymentOrAd = false;
            if (dailyPostsUsed >= DAILY_FREE_POSTS_LIMIT) {
                requiresPaymentOrAd = true;
            }

            if (requiresPaymentOrAd) {
                if (coins >= COST_PER_POST_COINS) {
                    // Pay with coins
                    if (!confirm(`You have used your ${DAILY_FREE_POSTS_LIMIT} free posts today. This post will cost ${COST_PER_POST_COINS} coins. You have ${coins} coins. Proceed?`)) {
                        return;
                    }
                    await processPostCreation(content, 'coins');
                } else if (adLimits > 0) {
                    // Use ad limit
                     if (!confirm(`You have used your ${DAILY_FREE_POSTS_LIMIT} free posts today. This post will use 1 Ad Limit. You have ${adLimits} Ad Limits. Proceed?`)) {
                        return;
                    }
                    await processPostCreation(content, 'adLimit');
                } else {
                    // Must watch ad to get limit
                    if (!confirm(`You have used your ${DAILY_FREE_POSTS_LIMIT} free posts today and have no coins or ad limits. You must watch an ad to get 1 Ad Limit for this post. Watch ad now?`)) {
                        return;
                    }
                    requestAd('post_limit_before_post'); // Request ad specifically for post limit
                    return; // Wait for ad to complete via App Inventor callback
                }
            } else {
                // Free post
                await processPostCreation(content, 'free');
            }
        });

        async function processPostCreation(content, type) {
            try {
                // Calculate expiry time (12 hours from now)
                const expiryTime = Date.now() + (POST_EXPIRY_HOURS * 60 * 60 * 1000); // 12 hours in milliseconds

                const userRef = db.collection('users').doc(currentUserId);
                
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User profile not found!";

                    const userData = userDoc.data();
                    let newCoins = userData.coins || 0;
                    let newAdLimits = userData.adLimits || 0;
                    let newDailyPostCounter = userData.dailyPostCounter || 0;
                    let newPostCounter = userData.postCounter || 0;

                    if (type === 'coins') {
                        if (newCoins < COST_PER_POST_COINS) throw "Insufficient coins!";
                        newCoins -= COST_PER_POST_COINS;
                    } else if (type === 'adLimit') {
                        if (newAdLimits < 1) throw "No ad limits available!";
                        newAdLimits -= 1;
                    } else if (type === 'free') {
                        // Just increment daily counter
                    }

                    newDailyPostCounter += 1;
                    newPostCounter += 1;

                    // Update user's profile with new counts/balances
                    transaction.update(userRef, {
                        coins: newCoins,
                        adLimits: newAdLimits,
                        dailyPostCounter: newDailyPostCounter,
                        postCounter: newPostCounter,
                        lastDailyPostReset: userData.lastDailyPostReset || Date.now() // Ensure it's set
                    });

                    // Create the post
                    transaction.set(db.collection('posts').doc(), {
                        content: content,
                        timestamp: Date.now(), // Use client-side timestamp for consistency here. ServerTimestamp on write if only one update
                        expiryTime: expiryTime,
                        userId: currentUserId,
                        username: currentUsername,
                        likes: 0,
                        postCounter: newPostCounter, // Store user's total post count at time of creation (for monetization info)
                        dailyPostCounter: newDailyPostCounter // Store user's daily post count (for debugging/info)
                    });
                });

                showMessage('create-post-message', 'Post published successfully! Your thoughts are now live.', 'success');
                document.getElementById('post-content').value = ''; // Clear textarea
                fetchUserProfile(currentUserId); // Update user stats and header immediately
                fetchPosts(); // Refresh posts list to show new post
                showSection('home-posts'); // Go back to home
            } catch (error) {
                console.error("Error creating post:", error.message);
                showMessage('create-post-message', `Failed to publish post: ${error.message}`, 'error');
            }
        }


        // Function to create audio for a post
        function createPostSound(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; // You can change language here
            speechSynthesis.speak(utterance);
        }


        async function fetchPosts(userIdToFilter = null, targetDivPrefix = 'home') {
            const postsListDiv = document.getElementById(`${targetDivPrefix}-posts-list` || 'posts-list');
            postsListDiv.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>';
            const noPostsMessage = postsListDiv.querySelector('p');

            try {
                let query = db.collection('posts').orderBy('timestamp', 'desc');
                if (userIdToFilter) {
                    query = query.where('userId', '==', userIdToFilter);
                }
                
                const snapshot = await query.get();

                if (snapshot.empty) {
                    noPostsMessage.textContent = userIdToFilter ? "No posts by this user yet." : "No posts yet. Be the first to share something amazing!";
                    return;
                }

                postsListDiv.innerHTML = ''; // Clear loading message and prepare for posts
                let hasVisiblePosts = false;

                const postStyles = ['', 'horizontal', 'square', 'neon']; 
                let lastRandomIndex = -1;

                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;

                    if (post.expiryTime && post.expiryTime < Date.now()) {
                        return; // Skip expired posts
                    }

                    hasVisiblePosts = true;

                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * postStyles.length);
                    } while (randomIndex === lastRandomIndex && postStyles.length > 1);
                    lastRandomIndex = randomIndex;

                    const randomStyle = postStyles[randomIndex];
                    const postCard = document.createElement('div');
                    postCard.className = `post-card ${randomStyle}`;
                    postCard.id = `post-${postId}`;
                    postCard.dataset.userId = post.userId; // Store user ID on post card

                    // Handle clicking on post to view user profile
                    if (!userIdToFilter) { // Only make posts clickable on home feed
                        postCard.onclick = () => fetchOtherUserProfile(post.userId);
                    }


                    let contactButtonsHtml = '';
                    if (post.userId === currentUserId) {
                        contactButtonsHtml += `<button class="delete-btn" onclick="deletePost('${postId}', event)">Delete My Post</button>`;
                    } else if (userIdToFilter) {
                        // On other user profile, no contact buttons on individual posts, use main profile buttons
                        // Or if you want to allow:
                        // contactButtonsHtml += `
                        //     <button onclick="contactUser('${post.userId}', 'whatsapp', event)">WhatsApp</button>
                        //     <button onclick="contactUser('${post.userId}', 'instagram', event)">Instagram</button>
                        //     <button onclick="contactUser('${post.userId}', 'phone', event)">Call</button>
                        // `;
                    } else {
                        // For home feed, show contact buttons on post
                        contactButtonsHtml += `
                            <button onclick="contactUser('${post.userId}', 'whatsapp', event)" style="background-color:#25D366;">WhatsApp</button>
                            <button onclick="contactUser('${post.userId}', 'instagram', event)" style="background-color:#E1306C;">Instagram</button>
                            <button onclick="contactUser('${post.userId}', 'phone', event)" style="background-color:#007bff;">Call</button>
                            <button onclick="openChatWithUser('${post.userId}', '${post.username}', event)" style="background-color:#17a2b8;">Message</button>
                        `;
                    }
                    
                    const likeButtonClass = (userProfileData.likedPosts && userProfileData.likedPosts[postId]) ? 'liked' : '';


                    postCard.innerHTML = `
                        <div class="post-content-wrapper">
                            <h3>
                                <span class="username">${post.username || 'Anonymous User'}</span>
                                ${post.userId !== currentUserId ? `<button class="follow-button" onclick="event.stopPropagation(); toggleFollowFromPost('${post.userId}', this)">${'Follow'}</button>` : ''}
                            </h3>
                            <p>${post.content}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image">` : ''}
                        </div>
                        <div class="post-meta">
                            <span>Published: ${post.timestamp ? new Date(post.timestamp).toLocaleString() : 'N/A'}</span>
                            <span>Likes: <span id="likes-${postId}">${post.likes || 0}</span></span>
                        </div>
                        <div class="post-actions">
                            <button class="like-btn ${likeButtonClass}" onclick="likePost('${postId}', event)">Like Post</button>
                            <button onclick="createPostSound('${post.content}', event)" style="background-color:#6c757d;">ðŸ”Š Read Post</button>
                            <button onclick="translatePost('${postId}', event)" style="background-color:#17a2b8;">Translate</button>
                            ${contactButtonsHtml}
                        </div>
                    `;
                    postsListDiv.appendChild(postCard);

                    // If it's the current user's profile and you want to show only their posts here,
                    // you'd also need to call fetchMyPosts separately or handle it within this function.
                    if (userIdToFilter === currentUserId) {
                         document.getElementById('my-active-posts-list').appendChild(postCard.cloneNode(true)); // Clone for my profile
                         document.getElementById('my-active-posts-list').querySelector('p')?.remove();
                    }
                });

                if (!hasVisiblePosts) {
                    noPostsMessage.textContent = userIdToFilter ? "No posts by this user yet." : "No posts available at the moment. Be the first to share something amazing!";
                    noPostsMessage.classList.remove('hidden');
                } else {
                    noPostsMessage.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error fetching posts:", error);
                noPostsMessage.textContent = `Error loading posts: ${error.message}. Please refresh.`;
                noPostsMessage.classList.remove('hidden');
            }
        }

        // Separate function to fetch and display my posts
        async function fetchMyPosts() {
            const myPostsListDiv = document.getElementById('my-active-posts-list');
            myPostsListDiv.innerHTML = '<p class="text-center" style="margin-top: 20px; font-style: italic; color: #aaa;">Loading your posts...</p>';
            const noPostsMessage = myPostsListDiv.querySelector('p');

            if (!currentUserId) {
                noPostsMessage.textContent = "Please sign in to view your posts.";
                return;
            }

            try {
                const snapshot = await db.collection('posts')
                                         .where('userId', '==', currentUserId)
                                         .orderBy('timestamp', 'desc')
                                         .get();
                
                if (snapshot.empty) {
                    noPostsMessage.textContent = "You haven't published any posts yet. Start sharing!";
                    return;
                }

                myPostsListDiv.innerHTML = ''; // Clear loading message
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                     if (post.expiryTime && post.expiryTime < Date.now()) {
                        return; // Skip expired posts
                    }
                    const postCard = document.createElement('div');
                    postCard.className = `post-card`; // Simple style for user's own posts
                    postCard.id = `my-post-${postId}`;

                    postCard.innerHTML = `
                        <div class="post-content-wrapper">
                            <h3>${post.username || 'You'}</h3>
                            <p>${post.content}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image">` : ''}
                        </div>
                        <div class="post-meta">
                            <span>Published: ${post.timestamp ? new Date(post.timestamp).toLocaleString() : 'N/A'}</span>
                            <span>Likes: <span id="my-likes-${postId}">${post.likes || 0}</span></span>
                        </div>
                        <div class="post-actions">
                            <button class="delete-btn" onclick="deletePost('${postId}', event)">Delete Post</button>
                            <button onclick="createPostSound('${post.content}', event)" style="background-color:#6c757d;">ðŸ”Š Read Post</button>
                            <button onclick="translatePost('${postId}', event)" style="background-color:#17a2b8;">Translate</button>
                        </div>
                    `;
                    myPostsListDiv.appendChild(postCard);
                });
            } catch (error) {
                console.error("Error fetching my posts:", error);
                noPostsMessage.textContent = `Error loading your posts: ${error.message}`;
            }
        }


        // Function to toggle follow directly from post card (if not own post)
        async function toggleFollowFromPost(userId, buttonElement) {
            event.stopPropagation(); // Prevent post card click
            if (!currentUserId) {
                showMessage('auth-status-message', 'Please sign in to follow users.', 'error');
                showSection('signin-auth');
                return;
            }
            if (userId === currentUserId) return; // Cannot follow self

            const isFollowing = buttonElement.classList.contains('following');

            const followedUserRef = db.collection('users').doc(userId);
            const currentUserRef = db.collection('users').doc(currentUserId);

            const batch = db.batch();

            try {
                if (isFollowing) {
                    // Unfollow
                    batch.delete(followedUserRef.collection('followers').doc(currentUserId));
                    batch.delete(currentUserRef.collection('following').doc(userId));
                    buttonElement.textContent = 'Follow';
                    buttonElement.classList.remove('following');
                } else {
                    // Follow
                    batch.set(followedUserRef.collection('followers').doc(currentUserId), {
                        followerId: currentUserId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    batch.set(currentUserRef.collection('following').doc(userId), {
                        followedId: userId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    buttonElement.textContent = 'Following';
                    buttonElement.classList.add('following');
                }

                await batch.commit();
                // No need to fetch counts immediately for all posts, just update button.
                // Full counts will refresh on profile view.
            } catch (error) {
                console.error("Error toggling follow from post:", error);
                alert(`Failed to ${isFollowing ? 'unfollow' : 'follow'}: ${error.message}`);
            }
        }


        async function likePost(postId, event) {
            event.stopPropagation(); // Prevent post card click
            if (!currentUserId) {
                showMessage('auth-status-message', 'Please sign in to like posts.', 'error');
                showSection('signin-auth');
                return;
            }

            const postRef = db.collection('posts').doc(postId);
            const userLikedPostsRef = db.collection('users').doc(currentUserId);

            try {
                await db.runTransaction(async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    const userDoc = await transaction.get(userLikedPostsRef);

                    if (!postDoc.exists) {
                        throw "Post does not exist!";
                    }
                    if (!userDoc.exists) {
                        throw "User data not found!";
                    }

                    const postData = postDoc.data();
                    const userData = userDoc.data();
                    const likedPosts = userData.likedPosts || {};
                    let newLikes = postData.likes || 0;

                    const likeButton = event.target; // Get the button element that was clicked

                    if (likedPosts[postId]) {
                        // Already liked, so unlike
                        newLikes = Math.max(0, newLikes - 1); // Ensure likes don't go negative
                        delete likedPosts[postId];
                        likeButton.classList.remove('liked');
                        likeButton.textContent = 'Like Post';
                    } else {
                        // Not liked, so like
                        newLikes += 1;
                        likedPosts[postId] = true; // Mark as liked
                        likeButton.classList.add('liked');
                        likeButton.textContent = 'Liked!';
                    }

                    transaction.update(postRef, { likes: newLikes });
                    transaction.update(userLikedPostsRef, { likedPosts: likedPosts });

                    // Update UI immediately (using original post ID from the feed)
                    document.getElementById(`likes-${postId}`).textContent = newLikes;
                    if (document.getElementById(`my-likes-${postId}`)) { // For user's own profile view
                        document.getElementById(`my-likes-${postId}`).textContent = newLikes;
                    }
                });
                console.log(`Post ${postId} like status toggled.`);
                // Refresh local user data to keep likedPosts in sync
                await fetchUserProfile(currentUserId); 
            } catch (error) {
                console.error("Error liking post:", error.message);
                alert(`Failed to like/unlike post: ${error.message}`);
            }
        }


        async function deletePost(postId, event) {
            event.stopPropagation(); // Prevent post card click
            if (!currentUserId) {
                alert("Please sign in to delete posts.");
                showSection('signin-auth');
                return;
            }
            if (!confirm("Are you sure you want to permanently delete this post? This action cannot be undone.")) {
                return;
            }
            try {
                await db.collection('posts').doc(postId).delete();
                console.log(`Post ${postId} deleted.`);
                document.getElementById(`post-${postId}`)?.remove(); // Remove from home UI
                document.getElementById(`my-post-${postId}`)?.remove(); // Remove from my profile UI
                // Decrement user's post count (if not done via Cloud Functions)
                if (userProfileData.postCounter > 0) {
                     await db.collection('users').doc(currentUserId).update({
                        postCounter: firebase.firestore.FieldValue.increment(-1)
                    });
                    userProfileData.postCounter--; // Update local cache
                    document.getElementById('my-posts-count').textContent = userProfileData.postCounter;
                }
                fetchPosts(); // Refresh home feed
            } catch (error) {
                console.error("Error deleting post:", error.message);
                alert(`Failed to delete post: ${error.message}`);
            }
        }

        async function translatePost(postId, event) {
            event.stopPropagation(); // Prevent post card click
            const postCard = document.getElementById(`post-${postId}`) || document.getElementById(`my-post-${postId}`);
            const postContentElement = postCard.querySelector('p');
            const originalText = postContentElement.dataset.originalText || postContentElement.textContent;

            if (!postContentElement.dataset.originalText) {
                postContentElement.dataset.originalText = originalText; // Store original
            }

            if (navigator.language) {
                 // Simple browser-based translation prompt
                if (confirm(`Translate this post to your browser's language (${navigator.language})?`)) {
                    // This will likely trigger the browser's built-in translation
                    // For more control, you'd need a translation API
                    alert("This feature will attempt to trigger your browser's built-in translation. For a more robust solution, a translation API would be required.");
                    // You might need to directly change text and rely on a library
                    // For now, it's a conceptual "translate" button.
                    // A proper implementation would involve:
                    // 1. Sending originalText to a translation API (e.g., Google Cloud Translate).
                    // 2. Receiving translated text.
                    // 3. Updating postContentElement.textContent with translated text.
                    // 4. Storing translated text as dataset.translatedText and toggle.
                }
            } else {
                alert("Your browser does not support automatic translation via JavaScript directly. Please use your browser's built-in translation features if available.");
            }
        }

        // --- Post Cleanup (Client-side initiated) ---
        async function cleanupOldPosts() {
            if (!currentUserId) {
                console.log("Not logged in, skipping cleanup.");
                return;
            }

            console.log("Attempting to clean up old posts and messages...");
            const now = Date.now();
            let cleanedUpCount = 0;

            try {
                // Cleanup expired posts
                const postSnapshot = await db.collection('posts')
                                         .where('expiryTime', '<', now)
                                         .orderBy('expiryTime', 'asc')
                                         .limit(50) 
                                         .get();

                const postBatch = db.batch();
                postSnapshot.forEach(doc => {
                    const postData = doc.data();
                    if (postData.expiryTime && postData.expiryTime < now) {
                        postBatch.delete(db.collection('posts').doc(doc.id));
                        cleanedUpCount++;
                    }
                });
                if (cleanedUpCount > 0) {
                    await postBatch.commit();
                    console.log(`Successfully cleaned up ${cleanedUpCount} expired posts.`);
                    fetchPosts(); // Re-fetch posts to update UI
                    fetchMyPosts(); // Re-fetch my posts
                } else {
                    console.log("No expired posts found for cleanup in this batch.");
                }

                // Cleanup expired messages
                let cleanedUpMessagesCount = 0;
                const messageSnapshot = await db.collection('messages')
                                             .where('expiryTime', '<', now)
                                             .orderBy('expiryTime', 'asc')
                                             .limit(50) 
                                             .get();
                const messageBatch = db.batch();
                messageSnapshot.forEach(doc => {
                    const messageData = doc.data();
                    if (messageData.expiryTime && messageData.expiryTime < now) {
                        messageBatch.delete(db.collection('messages').doc(doc.id));
                        cleanedUpMessagesCount++;
                    }
                });
                if (cleanedUpMessagesCount > 0) {
                    await messageBatch.commit();
                    console.log(`Successfully cleaned up ${cleanedUpMessagesCount} expired messages.`);
                    // If chat is open, refresh it
                    if (chatTargetUserId) {
                        loadChatMessages(chatTargetUserId);
                    }
                } else {
                    console.log("No expired messages found for cleanup in this batch.");
                }

            } catch (error) {
                console.error("Error during cleanup:", error);
            }
        }


        // --- AppInventor WebViewStringChange Communication ---
        // These are global functions that App Inventor (via RunJavaScript) will call.

        window.adRequested = (status, rewardType) => {
            console.log(`App Inventor confirmed ad request status: ${status} for ${rewardType}`);
            if (status === 'OK' && rewardType === 'post_limit_before_post') {
                // If ad for post limit was watched, proceed with post creation
                // We need to re-trigger the post creation process after ad success
                // This is a bit tricky, might need to store the post content temporarily
                // For simplicity now, let's just add the limit and ask user to retry
                alert("Ad watched successfully! You've received 1 Ad Limit. Please try creating your post again.");
                // Immediately update user's ad limits
                if (currentUserId) {
                    db.collection('users').doc(currentUserId).update({
                        adLimits: firebase.firestore.FieldValue.increment(AD_REWARD_POST_LIMIT)
                    }).then(() => {
                        fetchUserProfile(currentUserId); // Refresh UI
                    }).catch(err => console.error("Failed to update ad limits after ad:", err));
                }
            }
        };

        window.updateCoins = () => {
            console.log("App Inventor says: User watched ad, update coins!");
            if (currentUserId) {
                const userRef = db.collection('users').doc(currentUserId);
                db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist for coin update!";
                    const currentCoins = (userDoc.data().coins || 0);
                    transaction.update(userRef, { coins: currentCoins + AD_REWARD_COINS });
                }).then(() => {
                    console.log("Coins updated successfully!");
                    alert(`You earned ${AD_REWARD_COINS} coins!`);
                    fetchUserProfile(currentUserId); // Update header and UI
                }).catch((error) => {
                    console.error("Coin update failed:", error);
                    alert(`Failed to update coins: ${error.message}`);
                });
            }
        };

        window.updateCredits = () => {
            console.log("App Inventor says: User watched ad, update credits!");
            if (currentUserId) {
                const userRef = db.collection('users').doc(currentUserId);
                db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist for credit update!";
                    const currentCredits = (userDoc.data().credits || 0);
                    transaction.update(userRef, { credits: currentCredits + AD_REWARD_CREDITS });
                }).then(() => {
                    console.log("Credits updated successfully!");
                    alert(`You earned ${AD_REWARD_CREDITS} credit!`);
                    fetchUserProfile(currentUserId); // Update header and UI
                }).catch((error) => {
                    console.error("Credit update failed:", error);
                    alert(`Failed to update credits: ${error.message}`);
                });
            }
        };

        window.updateAdLimits = () => {
            console.log("App Inventor says: User watched ad, update ad limits!");
            if (currentUserId) {
                const userRef = db.collection('users').doc(currentUserId);
                db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist for ad limit update!";
                    const currentAdLimits = (userDoc.data().adLimits || 0);
                    transaction.update(userRef, { adLimits: currentAdLimits + AD_REWARD_POST_LIMIT });
                }).then(() => {
                    console.log("Ad Limits updated successfully!");
                    alert(`You earned ${AD_REWARD_POST_LIMIT} Ad Limit!`);
                    fetchUserProfile(currentUserId); // Update header and UI
                }).catch((error) => {
                    console.error("Ad Limit update failed:", error);
                    alert(`Failed to update Ad Limits: ${error.message}`);
                });
            }
        };


        // --- AppInventor Callbacks for Unity Ads (called by App Inventor) ---
        // These are helper functions for AppInventor to call via WebViewString/RunJavaScript
        function requestAd(rewardType) {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                // Tell App Inventor to show an ad for a specific reward type
                window.AppInventor.setWebViewString(`SHOW_AD:${rewardType}`);
            } else {
                alert(`AppInventor not detected. Cannot show ad for ${rewardType}.`);
                console.warn("AppInventor object not found. Running in browser or emulator without full AI2 bridge.");
                // Simulate success in dev mode
                if (confirm("Simulate ad success for development?")) {
                    if (rewardType === 'coins') window.updateCoins();
                    else if (rewardType === 'credits') window.updateCredits();
                    else if (rewardType === 'post_limit' || rewardType === 'post_limit_before_post') window.updateAdLimits();
                }
            }
        }
        
        function shareApp() {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString("SHARE_APP:Share AddMint Pro with your friends and family! Link: [Your App Store Link or Download Link Here]");
            } else {
                alert("Share feature not available in browser. Imagine sharing the app!");
                console.warn("AppInventor object not found. Cannot trigger share.");
            }
        }


        // --- Direct Messaging/Chat Functionality ---
        document.getElementById('chat-input-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('chat-status-message');
            const messageContent = document.getElementById('chat-message-input').value.trim();

            if (!messageContent) {
                showMessage('chat-status-message', 'Message cannot be empty.', 'error');
                return;
            }
            if (!currentUserId || !chatTargetUserId) {
                showMessage('chat-status-message', 'No recipient selected or not logged in.', 'error');
                return;
            }
            if (currentUserId === chatTargetUserId) {
                showMessage('chat-status-message', 'You cannot send messages to yourself.', 'error');
                return;
            }

            if (userProfileData.credits < COST_PER_MESSAGE_CREDIT) {
                showMessage('chat-status-message', `You need ${COST_PER_MESSAGE_CREDIT} credit to send a message. You have ${userProfileData.credits || 0} credits.`, 'error');
                return;
            }

            try {
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(currentUserId);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User profile not found!";

                    const currentCredits = userDoc.data().credits || 0;
                    if (currentCredits < COST_PER_MESSAGE_CREDIT) throw "Insufficient credits to send message!";

                    const newCredits = currentCredits - COST_PER_MESSAGE_CREDIT;
                    transaction.update(userRef, { credits: newCredits });

                    // Create message
                    const expiryTime = Date.now() + (MESSAGE_EXPIRY_HOURS * 60 * 60 * 1000);
                    transaction.set(db.collection('messages').doc(), {
                        senderId: currentUserId,
                        senderUsername: currentUsername,
                        receiverId: chatTargetUserId,
                        content: messageContent,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        expiryTime: expiryTime
                    });
                });

                document.getElementById('chat-message-input').value = ''; // Clear input
                showMessage('chat-status-message', 'Message sent!', 'success');
                fetchUserProfile(currentUserId); // Update credit count
                // Chat listener will automatically update the messages
            } catch (error) {
                console.error("Error sending message:", error.message);
                showMessage('chat-status-message', `Failed to send message: ${error.message}`, 'error');
            }
        });

        // Function to start a chat with a specific user
        function openChatWithUser(userId, username, event = null) {
            if (event) event.stopPropagation(); // Prevent bubbling if from post card
            if (!currentUserId) {
                showMessage('auth-status-message', 'Please sign in to chat.', 'error');
                showSection('signin-auth');
                return;
            }
            if (userId === currentUserId) {
                alert("You cannot chat with yourself directly through this interface.");
                return;
            }
            
            chatTargetUserId = userId;
            chatTargetUsername = username;
            document.getElementById('chat-header').textContent = `Chat with ${username}`;
            showSection('chat-section');
            loadChatMessages(userId);
        }

        // Load chat messages using a real-time listener
        function loadChatMessages(otherUserId) {
            if (chatListener) {
                chatListener(); // Detach previous listener if any
            }
            const chatMessagesDiv = document.getElementById('chat-messages');
            chatMessagesDiv.innerHTML = '<p class="text-center" id="no-chat-message" style="margin-top: 20px; font-style: italic; color: #aaa;">Loading messages...</p>';
            const noChatMessage = document.getElementById('no-chat-message');
            noChatMessage.classList.remove('hidden');

            chatListener = db.collection('messages')
                .where('expiryTime', '>', Date.now()) // Only active messages
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chatMessagesDiv.innerHTML = ''; // Clear existing messages
                    let hasMessages = false;
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        // Filter messages relevant to the current chat (between current user and target user)
                        if ((message.senderId === currentUserId && message.receiverId === otherUserId) ||
                            (message.senderId === otherUserId && message.receiverId === currentUserId)) {
                            
                            hasMessages = true;
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('chat-message');
                            messageDiv.classList.add(message.senderId === currentUserId ? 'sent' : 'received');

                            messageDiv.innerHTML = `
                                ${message.senderId !== currentUserId ? `<div class="sender-name">${message.senderUsername || 'Unknown'}</div>` : ''}
                                <div class="message-text">${message.content}</div>
                                <div class="timestamp">${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString() : 'N/A'}</div>
                            `;
                            chatMessagesDiv.appendChild(messageDiv);
                        }
                    });

                    if (!hasMessages) {
                        noChatMessage.textContent = "No messages yet. Start a conversation!";
                        noChatMessage.classList.remove('hidden');
                    } else {
                        noChatMessage.classList.add('hidden');
                        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
                    }
                }, error => {
                    console.error("Error loading chat messages:", error);
                    noChatMessage.textContent = `Error loading messages: ${error.message}`;
                    noChatMessage.classList.remove('hidden');
                });
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Manage bottom navigation clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    showSection(sectionId);
                    // Perform actions specific to the section being shown
                    if (sectionId === 'home-posts') {
                        fetchPosts();
                        cleanupOldPosts(); 
                    } else if (sectionId === 'user-profile-section' && currentUserId) {
                        fetchUserProfile(currentUserId);
                        fetchMyPosts(); // Also fetch and display current user's posts
                    } else if (sectionId === 'chat-section' && !chatTargetUserId) {
                         // If user clicks on Chat but no specific recipient is chosen,
                         // show a message or list of recent chats (more advanced feature)
                         document.getElementById('chat-header').textContent = 'Direct Messages';
                         document.getElementById('chat-messages').innerHTML = `<p class="text-center" style="margin-top: 20px; font-style: italic; color: #aaa;">
                            Select a user from a post to start a new chat, or view your existing conversations here (feature coming soon).
                         </p>`;
                    }
                });
            });

            // Firebase Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                setTimeout(() => {
                    hidePreloader();

                    if (user) {
                        currentUserId = user.uid;
                        if (user.emailVerified) {
                            fetchUserProfile(currentUserId)
                                .then(() => {
                                    if (!userProfileData || !userProfileData.username) {
                                        showSection('setup-profile');
                                        document.getElementById('profileUsername').value = user.displayName || '';
                                    } else {
                                        showMainAppUI();
                                        cleanupOldPosts();
                                        fetchPosts(); // Initial load of posts
                                    }
                                })
                                .catch(error => {
                                    console.error("Error during profile fetch after login:", error);
                                    showMainAppUI(); // Attempt to show main UI even if profile fetch has issues
                                    cleanupOldPosts();
                                    fetchPosts();
                                });
                        } else {
                            showSection('email-verify');
                            document.getElementById('verify-email-message').textContent = `Your email ${user.email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                        }
                    } else {
                        currentUserId = null;
                        currentUsername = null;
                        userProfileData = {};
                        document.getElementById('app-container').classList.remove('hidden');
                        showSection('signin-auth');
                    }
                }, 1500);
            });
        });

        // Function for header menu icon (currently shows settings)
        function toggleSettingsMenu() {
            showSection('settings-section');
        }

    </script>
</body>
</html>
