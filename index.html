<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint</title>
    <style>
        /* ========================================================= */
        /* == Global Styles, Variables & Resets ==================== */
        /* ========================================================= */
        :root {
            --dark-bg: #0d0d0d;
            --dark-fg: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #00aaff;
            --primary-dark: #0077c2;
            --accent-color: #ffcc00;
            --accent-dark: #cc9900;
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --success-color: #4CAF50;
            --error-color: #E53935;
            --info-color: #2196F3;
            --transition-speed: 0.4s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 18px;
            --font-family: 'Poppins', 'Segoe UI', 'Roboto', sans-serif;
            
            /* NEON Colors */
            --neon-blue: #00aaff;
            --neon-blue-shadow: rgba(0, 170, 255, 0.8);
            --neon-pink: #ff00ff;
            --neon-pink-shadow: rgba(255, 0, 255, 0.8);
            --neon-green: #00ff00;
            --neon-green-shadow: rgba(0, 255, 0, 0.8);
            --neon-yellow: #ffff00;
            --neon-yellow-shadow: rgba(255, 255, 0, 0.8);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg), #121212);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed); }
        a:hover { color: var(--accent-color); text-decoration: underline; }

        button, input[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
        }
        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        }
        
        input[type="email"], input[type="password"], input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
            appearance: none;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }
        
        .container {
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
        }

        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            word-wrap: break-word;
            border: 1px solid transparent;
            animation: slideInUp 0.4s ease-out;
        }
        .message.success { background-color: rgba(76, 175, 80, 0.2); color: var(--success-color); border-color: var(--success-color); }
        .message.error { background-color: rgba(229, 57, 53, 0.2); color: var(--error-color); border-color: var(--error-color); }
        .message.info { background-color: rgba(33, 150, 243, 0.2); color: var(--info-color); border-color: var(--info-color); }

        .hidden { display: none !important; }

        /* ========================================================= */
        /* == App Layout & Structure =============================== */
        /* ========================================================= */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            transition: opacity 0.5s ease;
        }

        header {
            background-color: var(--dark-fg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 3px 20px var(--shadow-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99;
            animation: slideDown 0.5s ease-out;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .app-logo {
            display: flex;
            align-items: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.6);
            letter-spacing: 1px;
            position: relative;
        }
        .app-logo .shape {
            width: 40px; height: 40px;
            background: linear-gradient(45deg, var(--accent-color), #ffdb58);
            transform: rotate(45deg);
            border-radius: 10px;
            margin-right: 15px;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.6);
            animation: headerLogoSpin 4s infinite linear, headerLogoBounce 2s infinite alternate;
        }
        .header-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .stat-item:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .stat-item .icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        .header-menu-btn, .header-refresh-btn {
            font-size: 1.5rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .header-menu-btn:hover, .header-refresh-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }


        /* Scrollable Main Content */
        main {
            flex-grow: 1;
            padding: 20px;
            padding-top: 80px;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        section {
            display: none;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        section.active { display: block; }
        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
            letter-spacing: 1px;
        }
        
        footer {
            background-color: var(--dark-fg);
            padding: 10px 0; /* Reduced height */
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -3px 20px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 99;
            animation: slideUp 0.5s ease-out;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 5px 8px; /* Reduced padding */
            border-radius: var(--border-radius-sm);
            flex: 1;
            max-width: 100px;
        }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); background-color: rgba(0, 170, 255, 0.1); }
        .nav-item:hover { color: var(--primary-color); background-color: rgba(0, 170, 255, 0.05); }
        .nav-item .icon {
            font-size: 1.5rem; /* Reduced icon size */
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }
        .nav-item:hover .icon { transform: scale(1.1); }


        /* ========================================================= */
        /* == Section Specific Styles ============================== */
        /* ========================================================= */
        
        .password-input-container { position: relative; margin-bottom: 15px; }
        .password-input-container input { padding-right: 50px; }
        .toggle-password {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--border-color);
            font-size: 1.3rem;
            transition: color var(--transition-speed);
            padding: 5px;
            border-radius: 5px;
        }
        .toggle-password:hover { color: var(--primary-color); }
        
        .username-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        .username-input-group input {
            padding-right: 40px; /* Space for the icon */
            margin-bottom: 0;
        }
        .username-status-icon {
            position: absolute;
            right: 10px;
            font-size: 1.2rem;
        }
        .username-status-icon.available { color: var(--success-color); }
        .username-status-icon.unavailable { color: var(--error-color); }

        /* Post Display Section */
        #posts-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #posts-container > .post-card {
            margin-bottom: 0;
        }
        .horizontal-scroll-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            background-color: rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.6s ease-out;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            max-width: 100%;
        }
        .horizontal-scroll-container .post-card {
            min-width: 280px;
            flex-shrink: 0;
            padding: 20px;
        }

        .post-card {
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }
        .post-card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.9); border-color: var(--primary-color); }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .post-header h3 { color: var(--accent-color); font-size: 1.4rem; font-weight: 700; text-shadow: 0 0 5px rgba(255, 204, 0, 0.4); cursor: pointer; }
        .post-actions-icons {
            display: flex;
            gap: 10px;
            position: relative;
        }
        .action-icon-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .action-icon-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .action-icon-btn.liked {
            color: var(--error-color); /* Red for liked heart */
            animation: heartBeat 0.5s ease-in-out;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--dark-fg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
            min-width: 150px;
            overflow: hidden;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .dropdown-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .dropdown-menu button {
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            font-size: 1rem;
            border-radius: 0;
            box-shadow: none;
            transition: background-color 0.2s ease;
        }
        .dropdown-menu button:hover {
            background-color: var(--border-color);
        }
        
        .post-card p { font-size: 1.05rem; margin-bottom: 20px; flex-grow: 1; word-wrap: break-word; color: var(--text-color); }
        .post-card p a { color: var(--primary-color); text-decoration: underline; }
        .post-meta { font-size: 0.88rem; color: #aaa; margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); }
        .post-likes-count { margin-left: 5px; }

        /* Neon Post Styles with different colors */
        .post-card.neon-blue {
            box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-blue) inset;
            border-color: var(--neon-blue);
        }
        .post-card.neon-blue.glowing { animation: neonBlueGlow 0.4s forwards, fadeOutGlow 3s 0.4s forwards; }
        .post-card.neon-blue h3, .post-card.neon-blue p, .post-card.neon-blue .post-meta { text-shadow: 0 0 10px var(--neon-blue-shadow), 0 0 20px var(--neon-blue-shadow); }

        .post-card.neon-pink {
            box-shadow: 0 0 15px var(--neon-pink), 0 0 25px var(--neon-pink) inset;
            border-color: var(--neon-pink);
        }
        .post-card.neon-pink.glowing { animation: neonPinkGlow 0.4s forwards, fadeOutGlow 3s 0.4s forwards; }
        .post-card.neon-pink h3, .post-card.neon-pink p, .post-card.neon-pink .post-meta { text-shadow: 0 0 10px var(--neon-pink-shadow), 0 0 20px var(--neon-pink-shadow); }

        .post-card.neon-green {
            box-shadow: 0 0 15px var(--neon-green), 0 0 25px var(--neon-green) inset;
            border-color: var(--neon-green);
        }
        .post-card.neon-green.glowing { animation: neonGreenGlow 0.4s forwards, fadeOutGlow 3s 0.4s forwards; }
        .post-card.neon-green h3, .post-card.neon-green p, .post-card.neon-green .post-meta { text-shadow: 0 0 10px var(--neon-green-shadow), 0 0 20px var(--neon-green-shadow); }

        .post-card.neon-yellow {
            box-shadow: 0 0 15px var(--neon-yellow), 0 0 25px var(--neon-yellow) inset;
            border-color: var(--neon-yellow);
        }
        .post-card.neon-yellow.glowing { animation: neonYellowGlow 0.4s forwards, fadeOutGlow 3s 0.4s forwards; }
        .post-card.neon-yellow h3, .post-card.neon-yellow p, .post-card.neon-yellow .post-meta { text-shadow: 0 0 10px var(--neon-yellow-shadow), 0 0 20px var(--neon-yellow-shadow); }
        
        .url-link { color: var(--primary-color); text-decoration: underline; }

        /* Emoji reaction picker */
        .reaction-picker {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 50px;
            padding: 8px 15px;
            position: absolute;
            bottom: -50px; /* Position below the post card */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 5;
        }
        .reaction-picker.visible {
            bottom: -60px; /* Nudge it down slightly when visible */
            opacity: 1;
            visibility: visible;
        }
        .reaction-picker span {
            font-size: 1.8rem;
            cursor: pointer;
            transform: scale(1);
            transition: transform 0.2s ease;
        }
        .reaction-picker span:hover {
            transform: scale(1.3);
        }
        .post-reactions {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 10px;
            text-align: right;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
            padding-top: 5px;
        }
        .reaction-count {
            margin-right: 10px;
            display: inline-block;
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: 0 8px 25px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .profile-image-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            position: relative;
            animation: profilePulse 2s infinite ease-out;
            margin-bottom: 20px;
            cursor: pointer; /* To suggest it's clickable for logo change */
        }
        .profile-image {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--neon-blue) 0%, var(--neon-pink) 100%);
            animation: profileImageGlow 3s infinite alternate ease-in-out;
            border-radius: 50%;
        }
        .profile-info {
            text-align: center;
            width: 100%;
        }
        .profile-info h3 {
            color: var(--accent-color);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
        }
        .profile-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
        }
        .profile-stat-item strong {
            font-size: 1.4rem;
            color: var(--primary-color);
        }
        .profile-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .profile-buttons button {
            padding: 10px 20px;
            font-size: 0.95rem;
        }
        #user-profile-details, #other-user-profile-details {
            background-color: var(--dark-fg);
            padding: 20px;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        #user-profile-details p, #other-user-profile-details p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
        }
        #user-profile-details p strong, #other-user-profile-details p strong {
            color: var(--primary-color);
        }
        .profile-posts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* Search Section */
        #search-results-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
            animation: fadeIn 0.4s ease-out;
        }
        .search-result-item .user-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--primary-color);
            flex-shrink: 0;
        }
        .search-result-item .user-info {
            flex-grow: 1;
        }
        .search-result-item h4 {
            font-size: 1.1rem;
            color: var(--accent-color);
        }
        .search-result-item button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Daily Reward Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background: linear-gradient(145deg, var(--dark-fg), #282828);
            padding: 40px 30px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color);
            max-width: 90%;
            width: 400px;
            transform: scale(0.8);
            opacity: 0;
            animation: popUpAnimation 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .popup-content h3 {
            color: var(--accent-color);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.6);
        }
        .popup-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
        }
        .popup-content li {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content li .icon {
            font-size: 1.3rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        .popup-content button {
            padding: 10px 25px;
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none;
        }
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--dark-fg);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8);
            z-index: 101;
            transition: right 0.3s ease-out;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }
        .side-menu.visible {
            right: 0;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .menu-header h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .menu-close-btn {
            font-size: 2rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .menu-item:hover {
            background-color: rgba(0, 170, 255, 0.1);
        }
        .menu-item .icon {
            margin-right: 15px;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            margin-left: auto;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Chat Window Styling */
        #chat-window {
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            background-color: var(--dark-bg);
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .chat-message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 3px;
        }
        .chat-message.received {
            align-self: flex-start;
            background-color: var(--dark-fg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 3px;
        }
        .chat-message .timestamp {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            text-align: right;
            display: block;
        }
        .chat-message.received .timestamp {
             text-align: left;
        }


        /* ========================================================= */
        /* == ANIMATIONS =========================================== */
        /* ========================================================= */

        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0d0d0d, #080808);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
            color: white;
            font-size: 2rem;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes neonBlueGlow {
            from { box-shadow: 0 0 10px rgba(0, 170, 255, 0.4), 0 0 20px rgba(0, 170, 255, 0.4) inset; }
            to { box-shadow: 0 0 25px var(--neon-blue), 0 0 40px var(--neon-blue) inset; }
        }
        @keyframes neonPinkGlow {
            from { box-shadow: 0 0 10px rgba(255, 0, 255, 0.4), 0 0 20px rgba(255, 0, 255, 0.4) inset; }
            to { box-shadow: 0 0 25px var(--neon-pink), 0 0 40px var(--neon-pink) inset; }
        }
        @keyframes neonGreenGlow {
            from { box-shadow: 0 0 10px rgba(0, 255, 0, 0.4), 0 0 20px rgba(0, 255, 0, 0.4) inset; }
            to { box-shadow: 0 0 25px var(--neon-green), 0 0 40px var(--neon-green) inset; }
        }
        @keyframes neonYellowGlow {
            from { box-shadow: 0 0 10px rgba(255, 255, 0, 0.4), 0 0 20px rgba(255, 255, 0, 0.4) inset; }
            to { box-shadow: 0 0 25px var(--neon-yellow), 0 0 40px var(--neon-yellow) inset; }
        }
        @keyframes fadeOutGlow {
            0% { box-shadow: var(--current-shadow); }
            100% { box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--border-color); }
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes profilePulse { 0%, 100% { box-shadow: 0 0 0 0px rgba(0, 170, 255, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(0, 170, 255, 0); } }
        @keyframes profileImageGlow { from { filter: brightness(1) contrast(1); } to { filter: brightness(1.2) contrast(1.1); } }
        @keyframes heartBeat { 0% { transform: scale(1); } 25% { transform: scale(1.2); } 50% { transform: scale(1); } 75% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes popUpAnimation { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

    <div id="splash-screen" class="splash-screen">
        Loading...
    </div>

    <div id="app-container" class="hidden">
        
        <header>
            <div class="header-left">
                <button class="header-menu-btn" onclick="App.UI.toggleSideMenu()">☰</button>
                <div class="app-logo">
                    <span class="shape"></span> AddMint
                </div>
            </div>
            <div class="header-right">
                <button class="header-refresh-btn" onclick="App.Posts.fetch(true)">↻</button>
                <div class="header-stats">
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">💰</span>
                        <span id="header-coins">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">❖</span>
                        <span id="header-limit">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">💡</span>
                        <span id="header-credits">0</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="side-menu-overlay" class="side-menu-overlay" onclick="App.UI.toggleSideMenu()"></div>
        <div id="side-menu" class="side-menu">
            <div class="menu-header">
                <h3>Menu</h3>
                <button class="menu-close-btn" onclick="App.UI.toggleSideMenu()">×</button>
            </div>
            <a href="#" class="menu-item" onclick="App.UI.toggleDataSaver()">
                <span class="icon">☀</span> Data Saver
                <label class="toggle-switch">
                    <input type="checkbox" id="data-saver-toggle">
                    <span class="slider"></span>
                </label>
            </a>
            <a href="https://www.instagram.com/addmint__" target="_blank" class="menu-item">
                <span class="icon">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:1em;height:1em;vertical-align:middle;">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M30 0H70C86.5685 0 100 13.4315 100 30V70C100 86.5685 86.5685 100 70 100H30C13.4315 100 0 86.5685 0 70V30C0 13.4315 13.4315 0 30 0ZM50 25C36.1929 25 25 36.1929 25 50C25 63.8071 36.1929 75 50 75C63.8071 75 75 63.8071 75 50C75 36.1929 63.8071 25 50 25ZM75 20C78.3137 20 81 17.3137 81 14C81 10.6863 78.3137 8 75 8C71.6863 8 69 10.6863 69 14C69 17.3137 71.6863 20 75 20ZM50 35C44.4772 35 40 39.4772 40 45C40 50.5228 44.4772 55 50 55C55.5228 55 60 50.5228 60 45C60 39.4772 55.5228 35 50 35Z" fill="url(#instagramGradient)"/>
                        <defs>
                            <linearGradient id="instagramGradient" x1="0" y1="0" x2="100" y2="100" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#fd5c4d"/>
                                <stop offset="0.2" stop-color="#fc8621"/>
                                <stop offset="0.4" stop-color="#ffb737"/>
                                <stop offset="0.6" stop-color="#f8dc74"/>
                                <stop offset="0.8" stop-color="#a23ccf"/>
                                <stop offset="1" stop-color="#5522c0"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </span> Instagram
            </a>
            <a href="https://www.youtube.com/@add_mint" target="_blank" class="menu-item">
                <span class="icon">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:1em;height:1em;vertical-align:middle;">
                        <rect width="100" height="100" rx="20" fill="#FF0000"/>
                        <path d="M68 49.9997L40 30L40 69.9997L68 49.9997Z" fill="white"/>
                    </svg>
                </span> YouTube
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('about-section'); App.UI.toggleSideMenu();">
                <span class="icon">ℹ</span> About
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('privacy-policy-section'); App.UI.toggleSideMenu();">
                <span class="icon">🔒</span> Privacy Policy
            </a>
        </div>


        <main id="main-content">
            <section id="signin-auth" class="container active">
                <h2>Welcome Back!</h2>
                <div id="auth-status-message" class="message hidden"></div>
                <form id="signin-form">
                    <input type="email" id="signin-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signin-password', this)">👁</span>
                    </div>
                    <button type="submit">Sign In</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="App.UI.showSection('signup-auth'); return false;">Sign Up Here</a></p>
                </form>
            </section>

            <section id="signup-auth" class="container">
                <h2>Join AddMint Today!</h2>
                <div id="signup-status-message" class="message hidden"></div>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signup-password" placeholder="Create Password (min 6 chars)" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-password', this)">👁</span>
                    </div>
                    <div class="password-input-container">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-confirm-password', this)">👁</span>
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="App.UI.showSection('signin-auth'); return false;">Sign In</a></p>
                </form>
            </section>

            <section id="email-verify" class="container">
                <h2>Verify Your Email</h2>
                <div id="verify-email-message" class="message error"></div>
                <p class="text-center mb-4">A verification link has been sent. Please check your inbox.</p>
                <button onclick="App.Auth.sendVerificationEmail()">Resend Verification Email</button>
                <button onclick="App.Auth.logout()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

            <section id="setup-profile" class="container">
                <h2>Complete Your Profile</h2>
                <div id="profile-setup-message" class="message hidden"></div>
                <form id="profile-setup-form">
                    <p class="mb-4 text-center" style="color: #ccc;">Choose a username and at least one contact method.</p>
                    <label for="profileUsername">Choose a Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="profileUsername" placeholder="e.g., AddMintUser" required>
                        <span id="username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="profileWhatsApp">WhatsApp Number (Optional):</label>
                    <input type="text" id="profileWhatsApp" placeholder="e.g., 919876543210 (without +)">
                    <label for="profileInstagram">Instagram Handle (Optional):</label>
                    <input type="text" id="profileInstagram" placeholder="e.g., yourhandle">
                    <button type="submit" class="mt-4">Save Profile & Continue</button>
                </form>
            </section>

            <section id="home-posts">
                <h2>Recent Updates</h2>
                <div id="posts-container">
                    <p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>
                </div>
                <div id="loading-spinner" class="text-center hidden" style="padding: 20px;">
                    <div class="spinner"></div>
                </div>
            </section>
            
            <section id="search-section" class="container">
                <h2>Find Users & Posts</h2>
                <div id="search-message" class="message hidden"></div>
                <div class="username-input-group mb-4">
                    <input type="text" id="search-input" placeholder="Search users, posts..." oninput="App.Search.performSearch()">
                </div>
                <h3>Users:</h3>
                <div id="search-results-list-users">
                    <p class="text-center" style="color: #aaa;">No user results.</p>
                </div>
                <h3 style="margin-top: 30px;">Posts:</h3>
                <div id="search-results-list-posts">
                     <p class="text-center" style="color: #aaa;">No post results.</p>
                </div>
            </section>

            <section id="create-post-section">
                <h2>Share Your Thoughts</h2>
                <div id="create-post-message" class="message hidden"></div>
                <form id="create-post-form" class="mt-4">
                    <label for="post-content">What's on your mind today?</label>
                    <textarea id="post-content" placeholder="Type your message here..." required></textarea>
                    
                    <label class="mt-4">Post Boost (Auto-Delete after...):</label>
                    <div class="mt-2">
                        <select id="post-boost-option" class="form-control">
                            <option value="12">12 Hours (Free)</option>
                            <option value="18">18 Hours (1 Ad)</option>
                            <option value="24">24 Hours (2 Ads)</option>
                            <option value="30">30 Hours (3 Ads)</option>
                        </select>
                    </div>

                    <button type="submit" class="mt-4">Publish Post</button>
                    <p class="text-center mt-2">Cost: 1 Limit & 5 Coins</p>
                </form>
            </section>
            
            <section id="ad-rewards-section" class="container">
                <h2>Get More!</h2>
                <div id="ad-rewards-message" class="message hidden"></div>
                <p class="text-center mb-4">Watch an ad to get more coins, credits, or post limits.</p>
                <div class="reward-buttons">
                    <button onclick="App.Monetization.requestAd('coins');"><span class="icon">💰</span> Get 10 Coins</button>
                    <button onclick="App.Monetization.requestAd('credits');"><span class="icon">💡</span> Get 10 Credits</button>
                    <button onclick="App.Monetization.requestAd('limits');"><span class="icon">❖</span> Get 1 Post Limit</button>
                </div>
            </section>
            
            <div id="daily-reward-popup" class="popup-overlay hidden">
                <div class="popup-content">
                    <h3>Daily Rewards! 🎉</h3>
                    <p>You've received your rewards for today!</p>
                    <ul>
                        <li><span class="icon">💰</span> 10 Coins</li>
                        <li><span class="icon">❖</span> 1 Post Limit</li>
                        <li><span class="icon">💡</span> 10 Credits</li>
                    </ul>
                    <button onclick="App.Monetization.hideDailyRewardPopup()">Claim</button>
                </div>
            </div>
            
            <section id="about-section" class="container">
                <h2>About AddMint</h2>
                <p>Welcome to AddMint! Our goal is to create a fun and engaging social platform where you can share your thoughts and connect with others. We believe in providing a seamless user experience while giving creators the tools they need to grow. Join our community and start sharing today!</p>
            </section>

            <section id="privacy-policy-section" class="container">
                <h2>Privacy Policy</h2>
                <p>Your privacy is important to us. This policy explains how we collect, use, and protect your information. By using our app, you agree to the collection and use of information in accordance with this policy.</p>
                <p>We may collect information such as your name, email, and social media handles to provide and improve our service. We do not share your personal information with third parties without your consent.</p>
                <p>We take reasonable measures to protect your information from unauthorized access or disclosure. However, no method of transmission over the internet or electronic storage is 100% secure.</p>
                <p>If you have any questions about this Privacy Policy, please contact us through the app.</p>
            </section>

            <section id="user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container" onclick="App.Profile.openLogoPicker()">
                        <div class="profile-image" id="profile-image-own"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item">
                                <strong id="profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button onclick="App.UI.showSection('edit-profile-section');">Edit Profile</button>
                            <button onclick="App.Auth.logout()" style="background-color: var(--error-color);">Sign Out</button>
                        </div>
                    </div>
                </div>
                <div id="user-profile-details" class="container" style="background: none; box-shadow: none;">
                    <p><strong>Email:</strong> <span id="profile-email"></span></p>
                    <p><strong>WhatsApp:</strong> <span id="profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="profile-instagram-handle">N/A</span></p>
                </div>
                <h4 style="margin-top: 30px; text-align: center; color: var(--primary-color);">Your Posts</h4>
                <div id="profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>

            <section id="edit-profile-section" class="container">
                <h2>Update Your Profile Details</h2>
                <div id="edit-profile-message" class="message hidden"></div>
                <form id="edit-profile-form">
                    <label for="editUsername">Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="editUsername" required>
                        <span id="edit-username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="editWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="editWhatsApp">
                    <label for="editInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="editInstagram">
                    <button type="submit" class="mt-4">Save Changes</button>
                    <button type="button" onclick="App.UI.showSection('user-profile-section')" class="mt-4" style="background-color: #6c757d;">Cancel</button>
                </form>
            </section>

            <section id="other-user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <div class="profile-image" id="profile-image-other"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="other-profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item">
                                <strong id="other-profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="other-profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="other-profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button id="other-follow-btn" onclick="App.Profile.toggleFollow()">Follow</button>
                            <button id="other-whatsapp-btn" onclick="App.UI.openWhatsAppProfile()">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 5px;">
                                    <path d="M12.04 2C7.38 2 3.53 5.86 3.53 10.53C3.53 12.07 3.93 13.52 4.67 14.81L3.06 20.12L8.51 18.57C9.72 19.23 11.09 19.58 12.5 19.58L12.04 19.59V19.59C16.69 19.59 20.55 15.73 20.55 11.07C20.55 6.42 16.69 2.56 12.04 2.56V2ZM16.69 14.51C16.4 14.98 13.91 16.27 13.41 16.38C12.91 16.48 12.52 16.53 12.13 16.43C11.73 16.32 11.16 16.14 10.59 15.93C9.44 15.48 8.44 14.39 7.68 13.23C7.05 12.27 6.64 11.16 6.37 10.88C6.1 10.6 5.82 9.9 6.51 9.77C7.19 9.64 7.63 9.47 7.72 9.3C7.82 9.13 7.88 8.95 7.97 8.76C8.06 8.57 8.16 8.38 8.24 8.23C8.42 7.89 8.61 7.42 8.76 7.07C8.91 6.72 9.07 6.55 9.24 6.52C9.41 6.49 9.61 6.5 9.77 6.5C9.93 6.5 10.11 6.5 10.28 6.5C10.45 6.5 10.62 6.52 10.74 6.64C10.87 6.76 11.04 6.94 11.16 7.08C11.3 7.22 11.38 7.33 11.47 7.46C11.66 7.73 11.87 8.01 12.02 8.22C12.18 8.44 12.33 8.65 12.45 8.87C12.57 9.09 12.69 9.3 12.79 9.42C12.92 9.57 13.06 9.67 13.21 9.8C13.62 10.15 14.07 10.5 14.49 10.87C15.01 11.34 15.44 11.75 15.79 12.13C16.15 12.52 16.42 12.87 16.61 13.26C16.8 13.65 16.89 14.08 16.69 14.51Z" fill="#25D366"/>
                                </svg> WhatsApp
                            </button>
                            <button id="other-instagram-btn" onclick="App.UI.openInstagramProfile()">
                                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:1em;height:1em;vertical-align:middle;margin-right: 5px;">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M30 0H70C86.5685 0 100 13.4315 100 30V70C100 86.5685 86.5685 100 70 100H30C13.4315 100 0 86.5685 0 70V30C0 13.4315 13.4315 0 30 0ZM50 25C36.1929 25 25 36.1929 25 50C25 63.8071 36.1929 75 50 75C63.8071 75 75 63.8071 75 50C75 36.1929 63.8071 25 50 25ZM75 20C78.3137 20 81 17.3137 81 14C81 10.6863 78.3137 8 75 8C71.6863 8 69 10.6863 69 14C69 17.3137 71.6863 20 75 20ZM50 35C44.4772 35 40 39.4772 40 45C40 50.5228 44.4772 55 50 55C55.5228 55 60 50.5228 60 45C60 39.4772 55.5228 35 50 35Z" fill="url(#instagramGradientSmall)"/>
                                    <defs>
                                        <linearGradient id="instagramGradientSmall" x1="0" y1="0" x2="100" y2="100" gradientUnits="userSpaceOnUse">
                                            <stop stop-color="#fd5c4d"/>
                                            <stop offset="0.2" stop-color="#fc8621"/>
                                            <stop offset="0.4" stop-color="#ffb737"/>
                                            <stop offset="0.6" stop-color="#f8dc74"/>
                                            <stop offset="0.8" stop-color="#a23ccf"/>
                                            <stop offset="1" stop-color="#5522c0"/>
                                        </linearGradient>
                                    </defs>
                                </svg>Instagram
                            </button>
                            <button id="other-message-btn" onclick="App.Messages.startNewChat()"><span class="icon">💬</span> Message</button>
                        </div>
                    </div>
                </div>
                <h4 style="margin-top: 30px; text-align: center; color: var(--primary-color);">Posts</h4>
                <div id="other-profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>
            
            <section id="message-section" class="container">
                <h2 id="message-recipient-name">Message User</h2>
                <div id="message-status-message" class="message hidden"></div>
                <div id="chat-window">
                    <p style="color: #aaa; text-align: center;">Start chatting! (Messages delete after 12 hours)</p>
                </div>
                <form id="send-message-form" class="mt-4">
                    <textarea id="message-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Send Message (1 Credit)</button>
                </form>
            </section>
        </main>

        <footer>
            <div class="nav-item active" data-section="home-posts">
                <span class="icon">⌂</span>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="search-section">
                <span class="icon">⌕</span>
                <span>Search</span>
            </div>
            <div class="nav-item" data-section="create-post-section">
                <span class="icon">➕</span>
                <span>Create</span>
            </div>
            <div class="nav-item" data-section="user-profile-section">
                <span class="icon">◉</span>
                <span>Profile</span>
            </div>
        </footer>
    </div>
    
    <script>
        const App = {};
        
        App.firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };
        firebase.initializeApp(App.firebaseConfig);
        App.auth = firebase.auth();
        App.db = firebase.firestore();

        App.currentUserId = null;
        App.currentUsername = null;
        App.userProfileData = {};
        App.profileToView = null;
        App.neonColors = ['neon-blue', 'neon-pink', 'neon-green', 'neon-yellow'];
        App.profileLogos = [
            '&#128100;', '&#128101;', '&#128102;', '&#128103;', '&#128104;', // People
            '&#128054;', '&#128049;', '&#128057;', '&#128038;', '&#128062;', // Animals
            '&#127760;', '&#127765;', '&#127757;', '&#127797;', '&#127802;', // Nature
            '&#128640;', '&#128761;', '&#128737;', '&#128663;', '&#128670;', // Transport
            '&#127918;', '&#127912;', '&#127925;', '&#127931;', '&#127940;', // Sports/Music
            '&#128214;', '&#128220;', '&#128161;', '&#128187;', '&#128269;', // Objects/Symbols
            '&#128512;', '&#128522;', '&#128525;', '&#128531;', '&#128540;', // Faces
            '&#128077;', '&#128079;', '&#128076;', '&#128080;', '&#128170;', // Hand gestures
            '&#127775;', '&#127774;', '&#127807;', '&#127808;', '&#127810;', // Food/Weather
            '&#127916;', '&#127926;', '&#127941;', '&#127942;', '&#127943;'  // Activities
        ];
        
        App.lastPost = null;
        App.isLoadingPosts = false;
        App.postsCache = [];
        App.isDataSaver = false;
        App.currentGlowingPost = null;
        
        App.UI = {
            showSection: (sectionId) => {
                document.querySelectorAll('section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
                
                if (sectionId === 'home-posts') {
                    document.getElementById('main-content').scrollTop = 0;
                }
            },
            showMessage: (elementId, message, type = 'info') => {
                const element = document.getElementById(elementId);
                element.innerHTML = message;
                element.className = `message ${type}`;
                element.classList.remove('hidden');
            },
            hideMessage: (elementId) => {
                document.getElementById(elementId).classList.add('hidden');
            },
            togglePasswordVisibility: (inputId, iconElement) => {
                const input = document.getElementById(inputId);
                if (input.type === "password") {
                    input.type = "text";
                    iconElement.innerHTML = '👀';
                } else {
                    input.type = "password";
                    iconElement.innerHTML = '👁';
                }
            },
            updateHeaderStats: (coins, limits, credits) => {
                document.getElementById('header-coins').textContent = App.UI.formatNumber(coins);
                document.getElementById('header-limit').textContent = App.UI.formatNumber(limits);
                document.getElementById('header-credits').textContent = App.UI.formatNumber(credits);
            },
            hidePreloader: () => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    document.getElementById('app-container').classList.remove('hidden');
                }, 500);
            },
            playPostSound: (postContent) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(postContent);
                    utterance.lang = 'hi-IN'; // Set language to Hindi
                    speechSynthesis.speak(utterance);
                } else {
                    alert("Your browser does not support Text-to-Speech.");
                }
            },
            openWhatsAppProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.whatsapp) {
                        window.open(`https://wa.me/${profile.whatsapp}`, '_system'); // Use _system to open in external app
                    } else {
                        alert('No WhatsApp number available for this user.');
                    }
                }).catch(e => console.error("WhatsApp error:", e));
            },
            openInstagramProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.instagram) {
                        window.open(`https://www.instagram.com/${profile.instagram}`, '_system'); // Use _system
                    } else {
                        alert('No Instagram handle available for this user.');
                    }
                }).catch(e => console.error("Instagram error:", e));
            },
            toggleDropdown: (postId) => {
                const dropdown = document.getElementById(`dropdown-${postId}`);
                if (dropdown) {
                    dropdown.classList.toggle('visible');
                    document.querySelectorAll('.dropdown-menu').forEach(d => {
                        if (d.id !== `dropdown-${postId}`) {
                            d.classList.remove('visible');
                        }
                    });
                }
            },
            hideAllDropdowns: () => {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('visible'));
            },
            generateUserLogo: (uid) => {
                const colorPalette = [
                    '#ff00ff', '#00ff00', '#00aaff', '#ffff00',
                    '#ff5500', '#8800ff', '#ff0055', '#00ffaa'
                ];
                const hash = Array.from(uid).reduce((sum, char) => sum + char.charCodeAt(0), 0);
                const color1 = colorPalette[hash % colorPalette.length];
                const color2 = colorPalette[(hash + 3) % colorPalette.length];
                const gradient = `linear-gradient(135deg, ${color1}, ${color2})`;
                return gradient;
            },
            toggleSideMenu: () => {
                const menu = document.getElementById('side-menu');
                const overlay = document.getElementById('side-menu-overlay');
                menu.classList.toggle('visible');
                overlay.style.display = menu.classList.contains('visible') ? 'block' : 'none';
            },
            toggleDataSaver: () => {
                App.isDataSaver = document.getElementById('data-saver-toggle').checked;
                // Add more logic here to handle image loading based on data saver status
                alert(`Data Saver is now ${App.isDataSaver ? 'ON' : 'OFF'}.`);
            },
            formatNumber: (num) => {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                }
                if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num;
            },
            applyNeonGlow: (postId) => {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    if (App.currentGlowingPost && App.currentGlowingPost !== postElement) {
                        App.currentGlowingPost.classList.remove('glowing');
                    }
                    postElement.style.setProperty('--current-shadow', postElement.style.boxShadow);
                    postElement.classList.add('glowing');
                    App.currentGlowingPost = postElement;
                    setTimeout(() => {
                        postElement.classList.remove('glowing');
                        App.currentGlowingPost = null;
                    }, 3000); // Glow for 3 seconds
                }
            },
            openLogoPicker: () => {
                const selectedLogo = prompt("Choose a profile logo (enter an emoji or keyword):\n" +
                                        "Examples: 🧑, 🐶, 🌳, 🚀, 💡, 😄\n" +
                                        "You can also choose a random one by typing 'random'.");
                if (selectedLogo) {
                    App.Profile.updateLogo(selectedLogo);
                }
            }
        };

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.post-actions-icons')) {
                App.UI.hideAllDropdowns();
            }
        });
        
        App.Auth = {
            signup: async (email, password, confirmPassword) => {
                App.UI.hideMessage('signup-status-message');
                if (password !== confirmPassword) {
                    App.UI.showMessage('signup-status-message', 'Passwords do not match.', 'error');
                    return;
                }
                if (password.length < 6) {
                    App.UI.showMessage('signup-status-message', 'Password must be at least 6 characters long.', 'error');
                    return;
                }
                
                try {
                    const userCredential = await App.auth.createUserWithEmailAndPassword(email, password);
                    await App.Auth.sendVerificationEmail();
                    App.UI.showMessage('signup-status-message', 'Successfully signed up! Please check your email for a verification link.', 'success');
                    App.UI.showSection('email-verify');
                } catch (error) {
                    App.UI.showMessage('signup-status-message', `Error: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Signup error:", error);
                }
            },
            signin: async (email, password) => {
                App.UI.hideMessage('auth-status-message');
                try {
                    await App.auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    App.UI.showMessage('auth-status-message', `Error: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Signin error:", error);
                }
            },
            logout: async () => {
                try {
                    await App.auth.signOut();
                    App.currentUserId = null;
                    App.UI.showSection('signin-auth');
                } catch (error) {
                    console.error("Logout error:", error);
                }
            },
            sendVerificationEmail: async () => {
                const user = App.auth.currentUser;
                if (user) {
                    try {
                        await user.sendEmailVerification();
                        App.UI.showMessage('verify-email-message', 'Verification link sent! Please check your inbox.', 'info');
                    } catch (error) {
                        App.UI.showMessage('verify-email-message', `Error sending verification email: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                        console.error("Verification email error:", error);
                    }
                }
            }
        };

        App.Profile = {
            checkUsernameAvailability: async (username, isEdit = false) => {
                const icon = document.getElementById(isEdit ? 'edit-username-status-icon' : 'username-status-icon');
                if (!username || username.length < 3) {
                    icon.classList.add('hidden');
                    return false;
                }
                
                const usersRef = App.db.collection('users').where('username', '==', username.toLowerCase());
                const snapshot = await usersRef.get();
                
                let isAvailable = true;
                if (!snapshot.empty) {
                    if (isEdit && snapshot.docs[0].id === App.currentUserId) {
                        isAvailable = true;
                    } else {
                        isAvailable = false;
                    }
                }
                
                if (isAvailable) {
                    icon.classList.remove('hidden', 'unavailable');
                    icon.classList.add('available');
                    icon.innerHTML = '✔'; // Green tick
                    return true;
                } else {
                    icon.classList.remove('hidden', 'available');
                    icon.classList.add('unavailable');
                    icon.innerHTML = '✖'; // Red cross
                    return false;
                }
            },
            setup: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('profile-setup-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('profile-setup-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                if (!username || (!whatsapp && !instagram)) {
                    App.UI.showMessage('profile-setup-message', 'Please provide a username and at least one contact method.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).set({
                        username: username.toLowerCase(),
                        email: App.auth.currentUser.email,
                        whatsapp: whatsapp || null,
                        instagram: instagram ? instagram.replace(/^@/, '') : null, // Remove @ if present
                        coins: 10,
                        credits: 10,
                        postLimit: 1,
                        lastRewardDate: new Date().toDateString(),
                        profileLogo: App.UI.generateUserLogo(App.currentUserId) // Default generated logo
                    });
                    App.UI.showMessage('profile-setup-message', 'Profile saved successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (error) {
                    App.UI.showMessage('profile-setup-message', `Error saving profile: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Profile setup error:", error);
                }
            },
            edit: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('edit-profile-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username, true);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('edit-profile-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).update({
                        username: username.toLowerCase(),
                        whatsapp: whatsapp || null,
                        instagram: instagram ? instagram.replace(/^@/, '') : null,
                    });
                    App.UI.showMessage('edit-profile-message', 'Profile updated successfully!', 'success');
                    setTimeout(() => {
                        App.UI.showSection('user-profile-section');
                        App.Profile.fetch(App.currentUserId, true);
                    }, 1000);
                } catch (error) {
                    App.UI.showMessage('edit-profile-message', `Error updating profile: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Profile edit error:", error);
                }
            },
            fetch: async (uid, isCurrentUser = false) => {
                try {
                    const userDoc = await App.db.collection('users').doc(uid).get();
                    if (!userDoc.exists) {
                        if (isCurrentUser) {
                            App.UI.showSection('setup-profile');
                            return;
                        }
                        return null;
                    }
                    const data = userDoc.data();
                    
                    const postsSnapshot = await App.db.collection('posts').where('userId', '==', uid).get();
                    const followersSnapshot = await App.db.collection('users').doc(uid).collection('followers').get();
                    const followingSnapshot = await App.db.collection('users').doc(uid).collection('following').get();
                    
                    data.postsCount = postsSnapshot.size;
                    data.followersCount = followersSnapshot.size;
                    data.followingCount = followingSnapshot.size;
                    data.uid = uid;
                    
                    if (isCurrentUser) {
                        App.userProfileData = data;
                        App.currentUsername = data.username;
                        App.UI.updateHeaderStats(data.coins || 0, data.postLimit || 0, data.credits || 0);
                        App.Profile.renderCurrentUserProfile(data, postsSnapshot.docs);
                    } else {
                        App.Profile.renderOtherUserProfile(data, postsSnapshot.docs);
                    }
                    return data;
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    return null;
                }
            },
            renderCurrentUserProfile: (profile, posts) => {
                document.getElementById('profile-display-name').textContent = profile.username;
                document.getElementById('profile-posts-count').textContent = App.UI.formatNumber(profile.postsCount);
                document.getElementById('profile-followers-count').textContent = App.UI.formatNumber(profile.followersCount);
                document.getElementById('profile-following-count').textContent = App.UI.formatNumber(profile.followingCount);
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('profile-instagram-handle').textContent = profile.instagram || 'N/A';
                document.getElementById('profile-image-own').style.background = profile.profileLogo || App.UI.generateUserLogo(profile.uid);
                
                document.getElementById('editUsername').value = profile.username || '';
                document.getElementById('editWhatsApp').value = profile.whatsapp || '';
                document.getElementById('editInstagram').value = profile.instagram || '';
                
                App.Posts.renderAll(posts, 'profile-posts-grid', true);
            },
            renderOtherUserProfile: (profile, posts) => {
                document.getElementById('other-profile-display-name').textContent = profile.username;
                document.getElementById('other-profile-posts-count').textContent = App.UI.formatNumber(profile.postsCount);
                document.getElementById('other-profile-followers-count').textContent = App.UI.formatNumber(profile.followersCount);
                document.getElementById('other-profile-following-count').textContent = App.UI.formatNumber(profile.followingCount);
                document.getElementById('other-profile-email').textContent = profile.email;
                document.getElementById('other-profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('other-profile-instagram-handle').textContent = profile.instagram || 'N/A';
                document.getElementById('profile-image-other').style.background = profile.profileLogo || App.UI.generateUserLogo(profile.uid);
                
                App.db.collection('users').doc(App.currentUserId).collection('following').doc(profile.uid).get().then(doc => {
                    const followBtn = document.getElementById('other-follow-btn');
                    if (doc.exists) {
                        followBtn.textContent = 'Following';
                    } else {
                        followBtn.textContent = 'Follow';
                    }
                });
                
                document.getElementById('other-whatsapp-btn').style.display = profile.whatsapp ? 'inline-flex' : 'none';
                document.getElementById('other-instagram-btn').style.display = profile.instagram ? 'inline-flex' : 'none';

                App.Posts.renderAll(posts, 'other-profile-posts-grid', false);
            },
            toggleFollow: async (targetUserId = App.profileToView) => {
                if (!targetUserId || targetUserId === App.currentUserId) return;
                
                const followRef = App.db.collection('users').doc(App.currentUserId).collection('following').doc(targetUserId);
                const followerRef = App.db.collection('users').doc(targetUserId).collection('followers').doc(App.currentUserId);
                
                try {
                    const doc = await followRef.get();
                    if (doc.exists) {
                        await followRef.delete();
                        await followerRef.delete();
                        alert('Unfollowed user.');
                    } else {
                        await followRef.set({ followedAt: new Date() });
                        await followerRef.set({ followedAt: new Date() });
                        alert('Followed user!');
                    }
                    App.Profile.fetch(targetUserId, false); // Refresh to update counts
                } catch (error) {
                    console.error("Error toggling follow:", error);
                    alert("An error occurred. Please try again: " + error.message);
                }
            },
            updateLogo: async (selectedLogo) => {
                try {
                    let logoValue = '';
                    if (selectedLogo === 'random') {
                        logoValue = App.UI.generateUserLogo(App.currentUserId + Math.random()); // new random gradient
                    } else if (selectedLogo.length <= 2) { // Assume single emoji
                        logoValue = `center center / 50% no-repeat url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" font-size="80" text-anchor="middle" dominant-baseline="central">${selectedLogo}</text></svg>')`;
                    } else {
                        // For keywords, we can generate a simple initial or use a fixed background
                        logoValue = `linear-gradient(45deg, ${App.UI.generateUserLogo(selectedLogo)})`; // Use keyword to generate gradient
                    }

                    await App.db.collection('users').doc(App.currentUserId).update({
                        profileLogo: logoValue
                    });
                    document.getElementById('profile-image-own').style.background = logoValue;
                    alert('Profile logo updated!');
                } catch (error) {
                    console.error("Error updating logo:", error);
                    alert('Failed to update logo. ' + error.message);
                }
            }
        };

        App.Search = {
            performSearch: async () => {
                const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                const usersResultsContainer = document.getElementById('search-results-list-users');
                const postsResultsContainer = document.getElementById('search-results-list-posts');
                usersResultsContainer.innerHTML = '';
                postsResultsContainer.innerHTML = '';
                
                if (searchTerm.length < 2) {
                    usersResultsContainer.innerHTML = '<p class="text-center" style="color: #aaa;">No user results.</p>';
                    postsResultsContainer.innerHTML = '<p class="text-center" style="color: #aaa;">No post results.</p>';
                    App.UI.hideMessage('search-message');
                    return;
                }

                App.UI.hideMessage('search-message');

                try {
                    // Search Users
                    const usersRef = App.db.collection('users').where('username', '>=', searchTerm).where('username', '<=', searchTerm + '\uf8ff').limit(10);
                    const usersSnapshot = await usersRef.get();
                    
                    if (usersSnapshot.empty) {
                        usersResultsContainer.innerHTML = '<p class="text-center" style="color: #aaa;">No users found matching your search.</p>';
                    } else {
                        usersSnapshot.docs.forEach(doc => {
                            const user = doc.data();
                            if (doc.id === App.currentUserId) return; // Don't show current user in search results
                            
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.onclick = () => {
                                App.profileToView = doc.id;
                                App.Profile.fetch(doc.id, false);
                                App.UI.showSection('other-user-profile-section');
                            };
                            
                            const userLogo = document.createElement('div');
                            userLogo.className = 'user-logo';
                            userLogo.style.background = user.profileLogo || App.UI.generateUserLogo(doc.id);
                            
                            const userInfo = document.createElement('div');
                            userInfo.className = 'user-info';
                            userInfo.innerHTML = `<h4>${user.username}</h4>`;
                            
                            const followButton = document.createElement('button');
                            followButton.textContent = 'Follow';
                            followButton.onclick = (e) => {
                                e.stopPropagation(); // Prevent opening profile when clicking follow
                                App.Profile.toggleFollow(doc.id);
                            };

                            resultItem.appendChild(userLogo);
                            resultItem.appendChild(userInfo);
                            resultItem.appendChild(followButton);
                            usersResultsContainer.appendChild(resultItem);
                        });
                    }

                    // Search Posts (very basic - by content. For more, need proper indexing/full-text search)
                    const postsRef = App.db.collection('posts').orderBy('timestamp', 'desc').limit(10); // Limit results for performance
                    const postsSnapshot = await postsRef.get();
                    const matchingPosts = postsSnapshot.docs.filter(doc => doc.data().content.toLowerCase().includes(searchTerm));

                    if (matchingPosts.length === 0) {
                        postsResultsContainer.innerHTML = '<p class="text-center" style="color: #aaa;">No posts found matching your search.</p>';
                    } else {
                        App.Posts.renderAll(matchingPosts, 'search-results-list-posts', false, false);
                    }

                } catch (error) {
                    App.UI.showMessage('search-message', `Error searching: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Search error:", error);
                }
            }
        };

        App.Posts = {
            create: async (content) => {
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    App.UI.showMessage('create-post-message', 'User profile not found.', 'error');
                    return;
                }
                const userData = userDoc.data();
                
                const postsLimit = userData.postLimit || 0;
                const coins = userData.coins || 0;
                const boostOption = document.getElementById('post-boost-option').value;
                const boostDuration = parseInt(boostOption); // in hours

                let requiredAds = 0;
                if (boostOption === '18') requiredAds = 1;
                else if (boostOption === '24') requiredAds = 2;
                else if (boostOption === '30') requiredAds = 3;

                // New logic: must have both 1 limit AND 5 coins
                if (postsLimit < 1 || coins < 5) {
                    App.UI.showMessage('create-post-message', 'You need at least 1 post limit and 5 coins to post. Please get more to post.', 'error');
                    return;
                }
                
                if (requiredAds > 0) {
                     App.UI.showMessage('create-post-message', `You need to watch ${requiredAds} ad(s) for this boost option. After watching the ad, click 'Publish Post' again.`, 'info');
                     // This is where you would trigger the ad from your App Inventor app
                     // window.AppInventor.requestAd(`boost_post_${boostDuration}`);
                     // For now, we return, expecting user to click again after ad
                     return;
                }

                await App.Posts.submitNewPost(content, userData, userRef, boostDuration);
            },
            submitNewPost: async (content, userData, userRef, boostDuration = 12) => {
                const newPostRef = App.db.collection('posts').doc();
                const updateData = {
                    postLimit: firebase.firestore.FieldValue.increment(-1),
                    coins: firebase.firestore.FieldValue.increment(-5)
                };
                
                const neonColor = App.Posts.getRandomPostStyle();
                const expiryTime = new Date(Date.now() + (boostDuration * 60 * 60 * 1000));

                try {
                    await App.db.runTransaction(async (transaction) => {
                        transaction.set(newPostRef, {
                            content,
                            userId: App.currentUserId,
                            username: userData.username,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            likes: 0,
                            views: 0, // Initialize views
                            style: neonColor,
                            expiryTime: expiryTime.getTime(),
                            reactions: {} // New field for emoji reactions
                        });
                        transaction.update(userRef, updateData);
                    });

                    App.UI.showMessage('create-post-message', 'Post published successfully!', 'success');
                    document.getElementById('post-content').value = '';
                    await App.Profile.fetch(App.currentUserId, true);
                    App.Posts.fetch(true); // Refresh posts after upload
                } catch (error) {
                    App.UI.showMessage('create-post-message', `Error publishing post: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Post creation error:", error);
                }
            },
            fetch: async (forceRefresh = false, targetDivId = 'posts-container', userId = null) => {
                const container = document.getElementById(targetDivId);
                const spinner = document.getElementById('loading-spinner');

                if (App.isLoadingPosts && !forceRefresh) return;
                App.isLoadingPosts = true;

                if (forceRefresh) {
                    App.lastPost = null;
                    container.innerHTML = '';
                    App.postsCache = [];
                }

                if (App.lastPost === null && targetDivId === 'posts-container') {
                    spinner.classList.remove('hidden');
                }

                let query = App.db.collection('posts').orderBy('timestamp', 'desc').limit(25);
                if (App.lastPost && targetDivId === 'posts-container') { // Only paginate home feed
                    query = query.startAfter(App.lastPost);
                }
                if (userId) {
                    query = query.where('userId', '==', userId);
                }

                try {
                    const snapshot = await query.get();
                    const validPosts = [];
                    const now = Date.now();

                    for (const doc of snapshot.docs) {
                        const postData = doc.data();
                        const expiry = postData.expiryTime;
                        const isExpired = expiry && expiry < now;
                        
                        if (isExpired) {
                            await doc.ref.delete().catch(e => console.error("Error deleting expired post:", e));
                        } else {
                            validPosts.push(doc);
                        }
                    }

                    if (validPosts.length === 0) {
                        if (App.postsCache.length === 0 && targetDivId === 'posts-container') {
                            container.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>';
                        } else if (targetDivId === 'posts-container') {
                            // If we run out of posts for home feed, shuffle the cache and display again for an infinite feel
                            const shuffledCache = App.postsCache.sort(() => Math.random() - 0.5);
                            App.Posts.renderAll(shuffledCache.slice(0, 25), targetDivId, userId !== null, true); // Render a chunk from cache
                            spinner.classList.add('hidden');
                            App.isLoadingPosts = false;
                            return; // Stop here if using cache
                        } else { // For profile or search, if no posts, just show message
                            container.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>';
                        }
                    }

                    if (targetDivId === 'posts-container') {
                        App.lastPost = snapshot.docs.length > 0 ? snapshot.docs[snapshot.docs.length - 1] : null;
                    }
                    
                    if (forceRefresh || targetDivId !== 'posts-container') {
                         App.postsCache = validPosts.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                         App.postsCache.push(...validPosts.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                    
                    App.Posts.renderAll(validPosts, targetDivId, userId !== null, !forceRefresh);

                } catch (error) {
                    container.innerHTML = '<p class="text-center message error">Error loading posts. Please try again: ' + error.message.replace('Firebase: Error ', '') + '</p>';
                    console.error("Error fetching posts:", error);
                } finally {
                    spinner.classList.add('hidden');
                    App.isLoadingPosts = false;
                }
            },
            renderAll: async (postDocs, containerId, isProfileView, append = false) => {
                const container = document.getElementById(containerId);
                let currentPostsHTML = append ? container.innerHTML : '';

                if (postDocs.length === 0 && !append) {
                    container.innerHTML = `<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>`;
                    return;
                }
                
                let verticalPostsCount = 0;
                let horizontalPostsBatch = [];
                
                const postElements = [];
                for (const doc of postDocs) {
                    const postData = isProfileView ? doc.data() : { id: doc.id, ...doc.data() };
                    const postId = isProfileView ? doc.id : doc.id;
                    postElements.push(await App.Posts.createPostElement(postId, postData, isProfileView));
                }

                for (let i = 0; i < postElements.length; i++) {
                    const postElement = postElements[i];
                    if (containerId === 'posts-container' && !App.isDataSaver && Math.random() < 0.3 && verticalPostsCount >= 5) { // Randomly insert horizontal block
                        horizontalPostsBatch.push(postElement);
                        if (horizontalPostsBatch.length >= 4 || i === postElements.length - 1) { // Render batch if enough or last posts
                            const horizontalContainer = document.createElement('div');
                            horizontalContainer.className = 'horizontal-scroll-container';
                            horizontalPostsBatch.forEach(el => horizontalContainer.appendChild(el));
                            currentPostsHTML += horizontalContainer.outerHTML;
                            horizontalPostsBatch = [];
                            verticalPostsCount = 0;
                        }
                    } else {
                        currentPostsHTML += postElement.outerHTML;
                        verticalPostsCount++;
                    }
                }
                container.innerHTML = currentPostsHTML;

                // Re-attach event listeners as innerHTML overwrites them
                postElements.forEach(postElement => {
                    const postId = postElement.dataset.postId;
                    const likeButton = document.querySelector(`[data-post-id="${postId}"] .like-btn`);
                    const soundButton = document.querySelector(`[data-post-id="${postId}"] .action-icon-btn:nth-child(2)`);
                    const translateButton = document.querySelector(`[data-post-id="${postId}"] .action-icon-btn:nth-child(1)`);
                    const optionsButton = document.querySelector(`[data-post-id="${postId}"] .action-icon-btn:nth-child(3)`);
                    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                    
                    if (likeButton) {
                        likeButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            App.Posts.like(postId, likeButton);
                        });
                        postCard.addEventListener('dblclick', (e) => {
                            e.stopPropagation();
                            App.Posts.like(postId, likeButton);
                        });
                    }
                    if (soundButton) soundButton.addEventListener('click', (e) => { e.stopPropagation(); App.UI.playPostSound(postElement.querySelector('p').textContent); });
                    if (translateButton) translateButton.addEventListener('click', (e) => { e.stopPropagation(); App.Posts.translate(postElement.querySelector('p').textContent); });
                    if (optionsButton) optionsButton.addEventListener('click', (e) => { e.stopPropagation(); App.UI.toggleDropdown(postId); });
                    
                    // Long press for emoji reaction
                    let pressTimer;
                    postCard.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            App.Posts.showReactionPicker(postId, postCard);
                        }, 500); // 500ms for long press
                    });
                    postCard.addEventListener('touchend', () => clearTimeout(pressTimer));
                    postCard.addEventListener('touchmove', () => clearTimeout(pressTimer));

                    // Add click to glow
                    postCard.addEventListener('click', () => {
                        App.UI.applyNeonGlow(postId);
                    });

                    // Update views for each post being rendered
                    App.Posts.updateViews(postId);
                });

            },
            createPostElement: async (postId, postData, isProfilePost = false) => {
                const postElement = document.createElement('div');
                postElement.className = `post-card ${postData.style || ''}`;
                postElement.dataset.postId = postId;
                postElement.dataset.userId = postData.userId;
                
                const isOwner = postData.userId === App.currentUserId;
                const likedDoc = await App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId).get();
                postData.hasLiked = likedDoc.exists;

                const postHeader = document.createElement('div');
                postHeader.className = 'post-header';
                
                const postTitle = document.createElement('h3');
                postTitle.textContent = postData.username;
                postTitle.onclick = () => {
                    App.profileToView = postData.userId;
                    App.Profile.fetch(postData.userId, isOwner);
                    App.UI.showSection(isOwner ? 'user-profile-section' : 'other-user-profile-section');
                };
                
                const actionIcons = document.createElement('div');
                actionIcons.className = 'post-actions-icons';
                
                const likeButton = document.createElement('span');
                likeButton.innerHTML = postData.hasLiked ? '❤' : '♡'; // Heart icon
                likeButton.className = `like-btn action-icon-btn ${postData.hasLiked ? 'liked' : ''}`;
                
                const translateButton = document.createElement('span');
                translateButton.innerHTML = '🌐'; // Earth icon
                translateButton.className = 'action-icon-btn';
                
                const soundButton = document.createElement('span');
                soundButton.innerHTML = '🔊';
                soundButton.className = 'action-icon-btn';
                
                const optionsButton = document.createElement('span');
                optionsButton.innerHTML = '⋮'; // Three dots
                optionsButton.className = 'action-icon-btn';

                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = `dropdown-${postId}`;
                dropdownMenu.className = 'dropdown-menu';

                const reportButton = document.createElement('button');
                reportButton.textContent = 'Report Post';
                reportButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.report(postId);
                    App.UI.hideAllDropdowns();
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Post';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.delete(postId);
                    App.UI.hideAllDropdowns();
                };

                dropdownMenu.appendChild(reportButton);
                if (isOwner) {
                    dropdownMenu.appendChild(deleteButton);
                }
                
                actionIcons.appendChild(likeButton);
                actionIcons.appendChild(translateButton);
                actionIcons.appendChild(soundButton);
                actionIcons.appendChild(optionsButton);
                actionIcons.appendChild(dropdownMenu);
                
                postHeader.appendChild(postTitle);
                postHeader.appendChild(actionIcons);
                
                const postBody = document.createElement('p');
                postBody.innerHTML = App.Posts.formatTextWithLinks(postData.content);
                
                const postMeta = document.createElement('div');
                postMeta.className = 'post-meta';
                postMeta.innerHTML = `<span>Likes: <span id="likes-count-${postId}">${App.UI.formatNumber(postData.likes || 0)}</span> | Views: <span id="views-count-${postId}">${App.UI.formatNumber(postData.views || 0)}</span></span><span>${postData.timestamp ? new Date(postData.timestamp.toDate()).toLocaleString() : 'N/A'}</span>`;
                
                const reactionContainer = document.createElement('div');
                reactionContainer.className = 'post-reactions';
                reactionContainer.id = `reactions-container-${postId}`;
                App.Posts.renderReactions(postData.reactions || {}, reactionContainer);

                // Add Reaction Picker placeholder
                const reactionPicker = document.createElement('div');
                reactionPicker.className = 'reaction-picker';
                reactionPicker.id = `reaction-picker-${postId}`;
                ['👍', '😂', '😡', '❤️', '🤔', '🎉'].forEach(emoji => {
                    const span = document.createElement('span');
                    span.textContent = emoji;
                    span.onclick = (e) => {
                        e.stopPropagation();
                        App.Posts.addReaction(postId, emoji);
                        reactionPicker.classList.remove('visible');
                    };
                    reactionPicker.appendChild(span);
                });

                postElement.appendChild(postHeader);
                postElement.appendChild(postBody);
                postElement.appendChild(postMeta);
                postElement.appendChild(reactionContainer);
                postElement.appendChild(reactionPicker); // Add picker to post

                return postElement;
            },
            getRandomPostStyle: () => {
                const styles = App.neonColors;
                return styles[Math.floor(Math.random() * styles.length)];
            },
            formatTextWithLinks: (text) => {
                const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|\b\w+\.(?:com|org|net|in|co|us|gov)\b(?:\/\S*)?)/g;
                return text.replace(urlRegex, (url) => {
                    let fullUrl = url;
                    if (!url.startsWith('http')) {
                        fullUrl = `https://${url}`;
                    }
                    return `<a href="${fullUrl}" target="_blank" class="url-link">${url}</a>`;
                });
            },
            like: async (postId, likeButton) => {
                const likeRef = App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId);
                const postRef = App.db.collection('posts').doc(postId);
                
                try {
                    const doc = await likeRef.get();
                    const likesCountElement = document.getElementById(`likes-count-${postId}`);
                    
                    if (doc.exists) {
                        await likeRef.delete();
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
                        if (likesCountElement) likesCountElement.textContent = App.UI.formatNumber(parseInt(likesCountElement.textContent) - 1);
                        likeButton.innerHTML = '♡'; // White heart
                        likeButton.classList.remove('liked');
                    } else {
                        await likeRef.set({ likedAt: new Date() });
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
                        if (likesCountElement) likesCountElement.textContent = App.UI.formatNumber(parseInt(likesCountElement.textContent) + 1);
                        likeButton.innerHTML = '❤'; // Red heart
                        likeButton.classList.add('liked');
                    }
                } catch (error) {
                    console.error("Error liking post:", error);
                    alert('Error liking post. Please try again: ' + error.message.replace('Firebase: Error ', ''));
                }
            },
            delete: async (postId) => {
                if (confirm('Are you sure you want to delete this post?')) {
                    try {
                        const postRef = App.db.collection('posts').doc(postId);
                        await postRef.delete();
                        alert('Post deleted.');
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) postElement.remove();
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        alert('Error deleting post. Please try again: ' + error.message.replace('Firebase: Error ', ''));
                    }
                }
            },
            translate: (postContent) => {
                const encodedContent = encodeURIComponent(postContent);
                const translateUrl = `https://translate.google.com/?sl=auto&tl=hi&text=${encodedContent}`;
                window.open(translateUrl, '_blank');
            },
            report: async (postId) => {
                if (confirm('Are you sure you want to report this post for inappropriate content?')) {
                    try {
                        const reportRef = App.db.collection('posts').doc(postId).collection('reports').doc(App.currentUserId);
                        await reportRef.set({
                            reportedBy: App.currentUserId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Post reported. Thank you for your feedback.');
                    } catch (error) {
                        console.error("Error reporting post:", error);
                        alert('Error reporting post. Please try again: ' + error.message.replace('Firebase: Error ', ''));
                    }
                }
            },
            updateViews: async (postId) => {
                // To prevent excessive writes, you might implement a client-side throttle
                // or a Cloud Function that aggregates views. For now, a simple increment.
                const viewTrackingRef = App.db.collection('posts').doc(postId).collection('views').doc(App.currentUserId);
                try {
                    const doc = await viewTrackingRef.get();
                    let incrementBy = 0;
                    if (!doc.exists) {
                        incrementBy = 1;
                    } else {
                        const viewData = doc.data();
                        const viewsToday = viewData.count || 0;
                        if (viewsToday < 3) { // Limit 3 views per user per post
                            incrementBy = 1;
                        }
                    }

                    if (incrementBy > 0) {
                        await App.db.runTransaction(async (transaction) => {
                            const postDoc = await transaction.get(App.db.collection('posts').doc(postId));
                            if (postDoc.exists) {
                                transaction.update(App.db.collection('posts').doc(postId), {
                                    views: firebase.firestore.FieldValue.increment(incrementBy)
                                });
                            }
                            transaction.set(viewTrackingRef, {
                                count: firebase.firestore.FieldValue.increment(incrementBy),
                                lastViewed: new Date().getTime()
                            }, { merge: true }); // Use merge to update count
                        });
                        const viewsCountElement = document.getElementById(`views-count-${postId}`);
                        if (viewsCountElement) {
                            viewsCountElement.textContent = App.UI.formatNumber(parseInt(viewsCountElement.textContent) + incrementBy);
                        }
                    }
                } catch (error) {
                    console.error("Error updating views:", error);
                }
            },
            showReactionPicker: (postId, postElement) => {
                const picker = document.getElementById(`reaction-picker-${postId}`);
                if (picker) {
                    // Hide any other visible pickers
                    document.querySelectorAll('.reaction-picker.visible').forEach(p => p.classList.remove('visible'));
                    picker.classList.add('visible');
                    // Automatically hide after some time if no interaction
                    setTimeout(() => {
                        picker.classList.remove('visible');
                    }, 5000); // Hide after 5 seconds
                }
            },
            addReaction: async (postId, emoji) => {
                const postRef = App.db.collection('posts').doc(postId);
                try {
                    await postRef.update({
                        [`reactions.${emoji}`]: firebase.firestore.FieldValue.increment(1)
                    });
                    // Immediately update UI for better responsiveness
                    const reactionsContainer = document.getElementById(`reactions-container-${postId}`);
                    if (reactionsContainer) {
                        const postDoc = await postRef.get();
                        App.Posts.renderReactions(postDoc.data().reactions || {}, reactionsContainer);
                    }
                } catch (error) {
                    console.error("Error adding reaction:", error);
                    alert("Could not add reaction. " + error.message.replace('Firebase: Error ', ''));
                }
            },
            renderReactions: (reactions, containerElement) => {
                containerElement.innerHTML = ''; // Clear previous reactions
                let totalReactions = 0;
                let reactionHTML = '';
                for (const emoji in reactions) {
                    const count = reactions[emoji];
                    if (count > 0) {
                        reactionHTML += `<span class="reaction-count">${emoji} ${App.UI.formatNumber(count)}</span>`;
                        totalReactions += count;
                    }
                }
                if (totalReactions > 0) {
                    containerElement.innerHTML = reactionHTML;
                }
            }
        };

        App.Monetization = {
            checkDailyRewards: async () => {
                if (!App.currentUserId) return;
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                
                const lastRewardDate = userData.lastRewardDate;
                const today = new Date().toDateString();
                
                if (lastRewardDate !== today) {
                    try {
                        await userRef.update({
                            coins: firebase.firestore.FieldValue.increment(10),
                            credits: firebase.firestore.FieldValue.increment(10),
                            postLimit: firebase.firestore.FieldValue.increment(1),
                            lastRewardDate: today
                        });
                        App.UI.updateHeaderStats(
                            (userData.coins || 0) + 10,
                            (userData.postLimit || 0) + 1,
                            (userData.credits || 0) + 10
                        );
                        document.getElementById('daily-reward-popup').classList.add('visible');
                    } catch (error) {
                        console.error("Error giving daily reward:", error);
                    }
                }
            },
            hideDailyRewardPopup: () => {
                document.getElementById('daily-reward-popup').classList.remove('visible');
            },
            requestAd: (rewardType) => {
                alert(`Triggering ad for ${rewardType}. Once the ad is complete, we'll give you the reward.`);
            },
            handleAdCompletion: async (rewardType) => {
                if (!App.currentUserId) {
                    console.error("Ad callback received but user is not logged in.");
                    return;
                }
                const userRef = App.db.collection('users').doc(App.currentUserId);
                
                try {
                    let updateData = {};
                    let rewardMessage = '';

                    if (rewardType.startsWith('boost_')) {
                         const duration = rewardType.split('_')[1];
                         alert(`Your post has been boosted for ${duration} hours!`);
                         // This is where you would update the post's expiry time if a post was pending for boost
                         // For now, it's a message only
                    } else if (rewardType === 'coins') {
                        updateData = { coins: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Coins';
                    } else if (rewardType === 'credits') {
                        updateData = { credits: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Credits';
                    } else if (rewardType === 'limits') {
                        updateData = { postLimit: firebase.firestore.FieldValue.increment(1) };
                        rewardMessage = '1 Post Limit';
                    }
                    
                    if (Object.keys(updateData).length > 0) {
                        await userRef.update(updateData);
                        App.UI.showMessage('ad-rewards-message', `Success! You received your reward: ${rewardMessage}.`, 'success');
                    }
                    
                    App.Profile.fetch(App.currentUserId, true);
                } catch (error) {
                    App.UI.showMessage('ad-rewards-message', `Error processing reward: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Reward processing error:", error);
                }
            }
        };

        App.Messages = {
            currentChatRecipientId: null,
            currentChatRecipientName: null,
            chatListener: null, // To manage real-time listener

            startNewChat: async () => {
                const credits = App.userProfileData.credits || 0;
                if (credits < 1) {
                    alert('You do not have enough credits to send a message. Please get more credits.');
                    return;
                }
                
                App.Messages.currentChatRecipientId = App.profileToView;
                App.Messages.currentChatRecipientName = document.getElementById('other-profile-display-name').textContent;
                document.getElementById('message-recipient-name').textContent = `Chat with ${App.Messages.currentChatRecipientName}`;
                App.UI.showSection('message-section');
                
                // Clear existing messages and start new listener
                document.getElementById('chat-window').innerHTML = '<p style="color: #aaa; text-align: center;">Loading messages...</p>';
                App.Messages.listenForMessages();
            },
            listenForMessages: () => {
                if (App.Messages.chatListener) {
                    App.Messages.chatListener(); // Unsubscribe previous listener
                }

                const chatWindow = document.getElementById('chat-window');
                const now = Date.now();
                const twelveHoursAgo = now - (12 * 60 * 60 * 1000); // 12 hours in milliseconds

                // Query messages where current user is sender AND recipient is target user
                // OR current user is recipient AND sender is target user
                const query1 = App.db.collection('messages')
                    .where('senderId', '==', App.currentUserId)
                    .where('recipientId', '==', App.Messages.currentChatRecipientId)
                    .where('timestamp', '>', new Date(twelveHoursAgo));

                const query2 = App.db.collection('messages')
                    .where('senderId', '==', App.Messages.currentChatRecipientId)
                    .where('recipientId', '==', App.currentUserId)
                    .where('timestamp', '>', new Date(twelveHoursAgo));

                // Combine results from both queries and order by timestamp
                // Note: Firestore doesn't allow OR queries across different fields or ranges easily.
                // A better approach for complex chat queries is to use a dedicated 'chats' collection
                // or combine client-side (less efficient for many messages).
                // For this example, we'll fetch two separate queries and merge.
                // For proper real-time chat, a combined ordered stream would require a Cloud Function to orchestrate.

                // Using onSnapshot for real-time updates
                App.Messages.chatListener = App.db.collection('messages')
                    .where('participants', 'array-contains', App.currentUserId) // Assuming a 'participants' array [user1_id, user2_id]
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(async (snapshot) => {
                        let allMessages = [];
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            const msgTimestamp = msg.timestamp ? msg.timestamp.toDate().getTime() : 0;
                            // Filter for messages relevant to THIS chat and within 12 hours
                            if (
                                (msgTimestamp > twelveHoursAgo) &&
                                (
                                    (msg.senderId === App.currentUserId && msg.recipientId === App.Messages.currentChatRecipientId) ||
                                    (msg.senderId === App.Messages.currentChatRecipientId && msg.recipientId === App.currentUserId)
                                )
                            ) {
                                allMessages.push(msg);
                            } else if (msgTimestamp <= twelveHoursAgo && doc.exists) {
                                // Delete expired messages from Firebase
                                doc.ref.delete().catch(e => console.error("Error deleting old message:", e));
                            }
                        });

                        // Sort messages by timestamp
                        allMessages.sort((a, b) => (a.timestamp ? a.timestamp.toDate().getTime() : 0) - (b.timestamp ? b.timestamp.toDate().getTime() : 0));
                        
                        chatWindow.innerHTML = ''; // Clear chat window
                        if (allMessages.length === 0) {
                             chatWindow.innerHTML = '<p style="color: #aaa; text-align: center;">No messages yet. Start a conversation!</p>';
                        } else {
                            allMessages.forEach(msg => {
                                const messageElement = document.createElement('div');
                                messageElement.className = `chat-message ${msg.senderId === App.currentUserId ? 'sent' : 'received'}`;
                                messageElement.textContent = msg.content;
                                const timestampSpan = document.createElement('span');
                                timestampSpan.className = 'timestamp';
                                timestampSpan.textContent = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '';
                                messageElement.appendChild(timestampSpan);
                                chatWindow.appendChild(messageElement);
                            });
                        }
                        chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
                    }, (error) => {
                        console.error("Error listening to messages:", error);
                        App.UI.showMessage('message-status-message', `Error loading chat: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    });
            },
            send: async (message) => {
                if (!App.Messages.currentChatRecipientId) return;
                
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userData = (await userRef.get()).data();
                
                if (userData.credits < 1) {
                    App.UI.showMessage('message-status-message', 'You do not have enough credits.', 'error');
                    return;
                }
                
                try {
                    await App.db.runTransaction(async (transaction) => {
                        const newMsgRef = App.db.collection('messages').doc();
                        transaction.set(newMsgRef, {
                            senderId: App.currentUserId,
                            senderName: App.currentUsername,
                            recipientId: App.Messages.currentChatRecipientId,
                            content: message,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            expiryTime: new Date(Date.now() + (12 * 60 * 60 * 1000)).getTime(), // 12 hours from now
                            participants: [App.currentUserId, App.Messages.currentChatRecipientId].sort() // For easier querying
                        });
                        transaction.update(userRef, {
                            credits: firebase.firestore.FieldValue.increment(-1)
                        });
                    });
                    
                    App.UI.showMessage('message-status-message', 'Message sent successfully! 1 credit deducted.', 'success');
                    document.getElementById('message-content').value = '';
                    App.Profile.fetch(App.currentUserId, true); // Update credits
                } catch (error) {
                    App.UI.showMessage('message-status-message', `Error sending message: ${error.message.replace('Firebase: Error ', '')}`, 'error');
                    console.error("Message send error:", error);
                }
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                App.Auth.signup(email, password, confirmPassword);
            });

            document.getElementById('signin-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                App.Auth.signin(email, password);
            });
            
            document.getElementById('profileUsername').addEventListener('input', (e) => {
                clearTimeout(this.checkTimer);
                this.checkTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value);
                }, 500);
            });
            document.getElementById('editUsername').addEventListener('input', (e) => {
                clearTimeout(this.checkTimer);
                this.checkTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value, true);
                }, 500);
            });

            document.getElementById('profile-setup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('profileUsername').value;
                const whatsapp = document.getElementById('profileWhatsApp').value;
                const instagram = document.getElementById('profileInstagram').value;
                App.Profile.setup(username, whatsapp, instagram);
            });
            
            document.getElementById('edit-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('editUsername').value;
                const whatsapp = document.getElementById('editWhatsApp').value;
                const instagram = document.getElementById('editInstagram').value;
                App.Profile.edit(username, whatsapp, instagram);
            });
            
            document.getElementById('create-post-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const content = document.getElementById('post-content').value;
                if (content.trim() !== '') {
                    App.Posts.create(content);
                }
            });
            
            document.getElementById('send-message-form').addEventListener('submit', (e) => {
                 e.preventDefault();
                 const message = document.getElementById('message-content').value;
                 if (message.trim() !== '') {
                     App.Messages.send(message);
                 }
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    App.UI.showSection(sectionId);
                    if (sectionId === 'home-posts') {
                        App.Posts.fetch(true);
                    } else if (sectionId === 'user-profile-section') {
                        App.Profile.fetch(App.currentUserId, true);
                    } else if (sectionId === 'search-section') {
                        document.getElementById('search-input').value = '';
                        document.getElementById('search-results-list-users').innerHTML = '<p class="text-center" style="color: #aaa;">No user results.</p>';
                        document.getElementById('search-results-list-posts').innerHTML = '<p class="text-center" style="color: #aaa;">No post results.</p>';
                    }
                });
            });

            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('scroll', () => {
                const activeSection = document.querySelector('section.active');
                if (activeSection && activeSection.id === 'home-posts' && mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100 && !App.isLoadingPosts) {
                    App.Posts.fetch();
                }
            });
        });

        App.auth.onAuthStateChanged(async (user) => {
            if (user) {
                App.currentUserId = user.uid;
                if (user.emailVerified) {
                    App.db.collection('users').doc(App.currentUserId).get().then(doc => {
                        if (doc.exists && doc.data().username) {
                            App.UI.showSection('home-posts');
                            App.Profile.fetch(App.currentUserId, true);
                            App.Monetization.checkDailyRewards();
                            App.Posts.fetch();
                        } else {
                            App.UI.showSection('setup-profile');
                        }
                    }).catch(error => {
                        console.error("Error fetching user profile:", error);
                        App.UI.showSection('setup-profile');
                    });
                } else {
                    App.UI.showSection('email-verify');
                }
            } else {
                App.currentUserId = null;
                App.UI.showSection('signin-auth');
            }
            App.UI.hidePreloader();
        });
        
        window.handleAdCompletion = (rewardType) => {
            if (rewardType) {
                App.Monetization.handleAdCompletion(rewardType);
            }
        };

    </script>
</body>
</html>
