<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23007bff' d='M50 0L100 50L50 100L0 50Z'/><path fill='%23e0e0e0' d='M50 10L90 50L50 90L10 50Z'/></svg>">
    
    <style>
        /* Global Styles & Variables */
        :root {
            --dark-bg: #121212; /* Deeper dark background */
            --dark-fg: #1e1e1e; /* Slightly lighter for foreground elements */
            --text-color: #e0e0e0;
            --primary-color: #007bff; /* Bright Blue */
            --primary-dark: #0056b3; /* Darker Blue */
            --accent-color: #ffc107; /* Bright Yellow/Amber */
            --accent-dark: #cc9a00; /* Darker Yellow */
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.7);
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --transition-speed: 0.3s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed); }
        a:hover { color: var(--accent-color); text-decoration: underline; }

        button, input[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color var(--transition-speed), transform 0.15s ease, box-shadow var(--transition-speed);
            box-shadow: 0 4px 10px var(--shadow-color);
            letter-spacing: 0.5px;
        }
        button:hover, input[type="submit"]:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.8); }
        button:active, input[type="submit"]:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
        
        input[type="email"], input[type="password"], input[type="text"], textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25), inset 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 0.95rem; }
        
        .container {
            width: 90%; max-width: 480px; margin: auto; padding: 30px;
            background-color: var(--dark-fg); border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 25px var(--shadow-color); animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
        }
        
        .message { padding: 12px; margin-bottom: 15px; border-radius: var(--border-radius-sm); font-size: 0.95rem; word-wrap: break-word; border: 1px solid transparent; animation: fadeIn 0.4s ease-out; }
        .message.success { background-color: rgba(40, 167, 69, 0.2); color: var(--success-color); border-color: var(--success-color); }
        .message.error { background-color: rgba(220, 53, 69, 0.2); color: var(--error-color); border-color: var(--error-color); }
        .message.info { background-color: rgba(23, 162, 184, 0.2); color: var(--info-color); border-color: var(--info-color); }
        .hidden { display: none !important; }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark-bg), #0f0f0f);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 1.2s ease-out; opacity: 1;
        }
        .splash-logo-container { width: 120px; height: 120px; position: relative; }
        .splash-logo-diamond {
            width: 100px; height: 100px; background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(45deg); border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 123, 255, 0.7);
            animation: splashDiamondPulse 2s infinite alternate ease-in-out;
        }
        .splash-logo-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3.5rem; font-weight: 800; color: white;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.6), 0 0 25px rgba(255, 255, 255, 0.4);
            z-index: 1; letter-spacing: 2px;
        }
        .splash-loader {
            border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite, glow 1.5s infinite alternate;
            margin-top: 40px; box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        /* Header */
        header {
            background-color: var(--dark-fg); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 15px var(--shadow-color);
            position: sticky; top: 0; z-index: 99; animation: slideDown 0.5s ease-out;
        }
        .app-logo { display: flex; align-items: center; font-size: 1.9rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 0 8px rgba(0, 123, 255, 0.6); letter-spacing: 1px; }
        .app-logo .shape {
            width: 35px; height: 35px; background: linear-gradient(45deg, var(--accent-color), #ffd700);
            transform: rotate(45deg); border-radius: 8px; margin-right: 12px;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.6); animation: headerLogoSpin 4s infinite linear;
        }
        .header-menu-icon, .header-stats button {
            font-size: 1.2rem; cursor: pointer; color: var(--text-color);
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 5px; border-radius: 5px;
        }
        .header-menu-icon:hover, .header-stats button:hover { color: var(--primary-color); transform: scale(1.1); }
        .header-stats { display: flex; align-items: center; gap: 15px; }
        .stats-item { display: flex; align-items: center; color: var(--text-color); font-size: 1rem; }
        .stats-item .icon { width: 24px; height: 24px; margin-right: 5px; background-color: currentColor; -webkit-mask-size: cover; mask-size: cover; }
        .stats-item .value { font-weight: 700; color: var(--accent-color); text-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
        .stats-icon-add { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z'/%3E%3C/svg%3E"); }
        .stats-icon-coin { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-1-3h2c1.1 0 2-.9 2-2s-.9-2-2-2h-2V7h2v1h-2v2h2c1.1 0 2 .9 2 2s-.9 2-2 2h-2v2z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-1-3h2c1.1 0 2-.9 2-2s-.9-2-2-2h-2V7h2v1h-2v2h2c1.1 0 2 .9 2 2s-.9 2-2 2h-2v2z'/%3E%3C/svg%3E"); }
        .stats-icon-credit { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-2c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1zm-1-7H4V6h15v5zm-5.5 0c1.47 0 2.66-1.19 2.66-2.66S15.97 5.68 14.5 5.68S11.84 6.87 11.84 8.34S13.03 11 14.5 11z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm-1 14H5c-.55 0-1-.45-1-1v-2c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v2c0 .55-.45 1-1 1zm-1-7H4V6h15v5zm-5.5 0c1.47 0 2.66-1.19 2.66-2.66S15.97 5.68 14.5 5.68S11.84 6.87 11.84 8.34S13.03 11 14.5 11z'/%3E%3C/svg%3E"); }
        .stats-icon-limit { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3C/svg%3E"); }


        /* Main Content */
        main {
            flex-grow: 1; padding: 20px; display: flex; flex-direction: column;
            gap: 25px; overflow-y: auto; width: 100%; max-width: 1200px; margin: 0 auto;
        }
        section {
            display: none; padding: 25px; background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg); box-shadow: 0 6px 15px var(--shadow-color);
            animation: fadeIn 0.6s ease-out; border: 1px solid var(--border-color);
        }
        section.active { display: block; }
        h2 { color: var(--primary-color); margin-bottom: 25px; text-align: center; font-size: 2rem; font-weight: 700; text-shadow: 0 0 8px rgba(0, 123, 255, 0.4); letter-spacing: 1px; }

        /* Password input with eye icon */
        .password-input-container { position: relative; margin-bottom: 15px; }
        .password-input-container input { padding-right: 50px; }
        .toggle-password {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: var(--border-color); font-size: 1.3rem; transition: color var(--transition-speed);
            padding: 5px; border-radius: 5px;
        }
        .toggle-password:hover { color: var(--primary-color); }

        /* Post Creation Section */
        #create-post-section label { margin-bottom: 10px; font-size: 1rem; }
        #post-content { min-height: 120px; resize: vertical; margin-bottom: 20px; }
        .post-cost-info { margin-bottom: 15px; font-size: 0.9rem; color: #999; }
        .post-cost-info .highlight { color: var(--accent-color); font-weight: 700; }
        .post-cost-info .highlight.red { color: var(--error-color); }

        /* Post Display Section */
        #posts-list {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; padding-top: 10px;
        }
        .post-card {
            background-color: var(--dark-bg); border-radius: var(--border-radius-lg);
            padding: 25px; box-shadow: 0 8px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex; flex-direction: column; border: 1px solid var(--border-color);
            overflow: hidden; position: relative; animation: slideInUp 0.6s ease-out;
        }
        .post-card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.9); border-color: var(--primary-color); }
        .post-card h3 { color: var(--accent-color); margin-bottom: 12px; font-size: 1.4rem; font-weight: 700; text-shadow: 0 0 5px rgba(255, 193, 7, 0.4); cursor: pointer; }
        .post-card p { font-size: 1.05rem; margin-bottom: 20px; flex-grow: 1; word-wrap: break-word; color: var(--text-color); }
        .post-meta { font-size: 0.88rem; color: #aaa; margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); margin-bottom: 15px; }
        .post-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; }
        .post-actions button { padding: 8px 18px; font-size: 0.9rem; border-radius: 6px; background-color: var(--primary-color); box-shadow: none; transition: background-color 0.2s ease, transform 0.1s ease; }
        .post-actions button:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .post-actions button.delete-btn { background-color: var(--error-color); }
        .post-actions button.delete-btn:hover { background-color: #b02a37; }
        .like-button .icon { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E"); }
        .like-button.liked { color: var(--error-color); }
        .like-button .icon { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E"); }

        /* New Post Interaction Icons */
        .post-interaction-icons { display: flex; gap: 15px; }
        .post-interaction-icons .icon {
            width: 24px; height: 24px; background-color: #999; cursor: pointer;
            -webkit-mask-size: cover; mask-size: cover;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .post-interaction-icons .icon:hover { background-color: var(--primary-color); transform: scale(1.1); }
        .icon-sound { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M3 10v4c0 .55.45 1 1 1h3l5 5V5L7 1H4c-.55 0-1 .45-1 1zm13.5 4c-.79 0-1.45-.44-1.87-1.07l-.92.92A4.99 4.99 0 0 0 19 12c0-2.21-1.2-4.14-2.9-5.18l-.92.92A3 3 0 0 1 16.5 10c0 1.38-.83 2.5-2 3c-.17.07-.35.1-.5.1l.92.92c.62-.26 1.17-.67 1.63-1.18.66.45 1.48.78 2.37.93l.42-.42c-.88-.13-1.66-.46-2.31-.88z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M3 10v4c0 .55.45 1 1 1h3l5 5V5L7 1H4c-.55 0-1 .45-1 1zm13.5 4c-.79 0-1.45-.44-1.87-1.07l-.92.92A4.99 4.99 0 0 0 19 12c0-2.21-1.2-4.14-2.9-5.18l-.92.92A3 3 0 0 1 16.5 10c0 1.38-.83 2.5-2 3c-.17.07-.35.1-.5.1l.92.92c.62-.26 1.17-.67 1.63-1.18.66.45 1.48.78 2.37.93l.42-.42c-.88-.13-1.66-.46-2.31-.88z'/%3E%3C/svg%3E"); }
        .icon-translate { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12.87 15.69l1.71 1.71L17 14.96l-4.13-4.13L9.62 14l2.25 2.25l1-1.06zm5.83-8.88A9.95 9.95 0 0 0 12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10c0-1.65-.41-3.23-1.1-4.6l-2.47 2.47c.5.95.8 2.01.8 3.13c0 4.42-3.58 8-8 8s-8-3.58-8-8s3.58-8 8-8c1.12 0 2.18.3 3.13.8l2.47-2.47zm-1.84 9.17l-1.71-1.71l-1.06 1.06l-1.06-1.06l1.71-1.71L12.87 15.69zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8s8-3.59 8-8s-3.59-8-8-8z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3E%3Cpath d='M12.87 15.69l1.71 1.71L17 14.96l-4.13-4.13L9.62 14l2.25 2.25l1-1.06zm5.83-8.88A9.95 9.95 0 0 0 12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10c0-1.65-.41-3.23-1.1-4.6l-2.47 2.47c.5.95.8 2.01.8 3.13c0 4.42-3.58 8-8 8s-8-3.58-8-8s3.58-8 8-8c1.12 0 2.18.3 3.13.8l2.47-2.47zm-1.84 9.17l-1.71-1.71l-1.06 1.06l-1.06-1.06l1.71-1.71L12.87 15.69zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8s8-3.59 8-8s-3.59-8-8-8z'/%3E%3C/svg%3E"); }

        /* Follow buttons */
        .follow-btn { background-color: var(--success-color); }
        .follow-btn:hover { background-color: #1e7e34; }
        .unfollow-btn { background-color: #6c757d; }
        .unfollow-btn:hover { background-color: #5a6268; }

        /* Profile page */
        .profile-stats { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); }
        .profile-stats-item strong { font-size: 1.5rem; color: var(--accent-color); }
        .profile-posts-list { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .profile-posts-list .post-card { max-width: none; }
        .monetization-info { background-color: rgba(255, 193, 7, 0.1); padding: 20px; border-radius: var(--border-radius-md); border: 1px solid var(--accent-color); }
        .monetization-info h3 { color: var(--accent-color); }

        /* Modals and Overlays */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--dark-fg); padding: 30px; border-radius: var(--border-radius-lg);
            max-width: 90%; max-height: 90%; overflow-y: auto;
            animation: zoomIn 0.3s ease-out; position: relative;
        }
        .modal-close {
            position: absolute; top: 10px; right: 20px;
            font-size: 2rem; color: #fff; cursor: pointer; transition: color 0.2s ease;
        }
        .modal-close:hover { color: var(--error-color); }

        /* Media queries for desktop support and animations */
        @media (min-width: 768px) {
            body { font-size: 17px; }
            .container { padding: 40px; max-width: 580px; }
            header { padding: 20px 40px; }
            main { padding: 30px 40px; max-width: 1400px; }
            footer { padding: 15px 40px; }
            .post-card.horizontal { grid-column: span 2; max-width: none; }
            #posts-list { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes glow { 0% { box-shadow: 0 0 5px var(--primary-color); } 50% { box-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--accent-color); } 100% { box-shadow: 0 0 5px var(--primary-color); } }
        @keyframes splashDiamondPulse { 0%, 100% { transform: translate(-50%, -50%) rotate(45deg) scale(1); opacity: 1; } 50% { transform: translate(-50%, -50%) rotate(45deg) scale(1.08); opacity: 0.8; } }
        @keyframes headerLogoSpin { 0% { transform: rotate(45deg) scale(1); } 25% { transform: rotate(135deg) scale(1.05); } 50% { transform: rotate(225deg) scale(1); } 75% { transform: rotate(315deg) scale(1.05); } 100% { transform: rotate(405deg) scale(1); } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes neonGlow { 0% { box-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color) inset; } 50% { box-shadow: 0 0 25px var(--primary-color), 0 0 40px var(--primary-color) inset; } 100% { box-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color) inset; } }
        @keyframes neonBorderPulse { 0%, 100% { opacity: 0.7; filter: blur(8px) brightness(1); } 50% { opacity: 1; filter: blur(12px) brightness(1.2); } }

        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 20px; }
        .mt-4 { margin-top: 20px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo-container">
            <div class="splash-logo-diamond"></div>
            <div class="splash-logo-text">A</div>
        </div>
        <div class="splash-loader"></div>
        <p style="margin-top: 20px; font-size: 1.1rem; color: #bbb;">Loading AddMint Pro...</p>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="app-logo">
                <span class="shape"></span> AddMint
            </div>
            <div class="header-stats">
                <div class="stats-item">
                    <span class="icon stats-icon-coin"></span>
                    <span class="value" id="header-coins">0</span>
                </div>
                <div class="stats-item">
                    <span class="icon stats-icon-credit"></span>
                    <span class="value" id="header-credits">0</span>
                </div>
                <div class="stats-item">
                    <span class="icon stats-icon-limit"></span>
                    <span class="value" id="header-limits">0</span>
                </div>
                <button class="stats-icon-add" onclick="showModal('earn-rewards-modal')">
                    <span class="icon stats-icon-add"></span>
                </button>
            </div>
        </header>

        <main>
            <section id="signin-auth" class="container active">
                <h2>Welcome Back!</h2>
                <div id="auth-status-message" class="message hidden"></div>
                <form id="signin-form">
                    <input type="email" id="signin-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signin-password', this)">&#128065;</span>
                    </div>
                    <button type="submit">Sign In</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="showSection('signup-auth'); return false;">Sign Up Here</a></p>
                </form>
            </section>
            
            <section id="signup-auth" class="container">
                <h2>Join AddMint Today!</h2>
                <div id="signup-status-message" class="message hidden"></div>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signup-password" placeholder="Create Password (min 6 chars)" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signup-password', this)">&#128065;</span>
                    </div>
                    <div class="password-input-container">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('signup-confirm-password', this)">&#128065;</span>
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="showSection('signin-auth'); return false;">Sign In</a></p>
                </form>
            </section>
            
            <section id="email-verify" class="container">
                <h2>Verify Your Email</h2>
                <div id="verify-email-message" class="message error"></div>
                <p class="text-center mb-4">A verification link has been sent to your email. Please check your inbox (and spam folder) to activate your account. Then sign in again.</p>
                <button onclick="sendVerificationEmail()">Resend Verification Email</button>
                <button onclick="auth.signOut(); showSection('signin-auth');" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

            <section id="setup-profile" class="container">
                <h2>Complete Your Profile</h2>
                <div id="profile-setup-message" class="message hidden"></div>
                <form id="profile-setup-form">
                    <label for="profileUsername">Choose a Username:</label>
                    <input type="text" id="profileUsername" placeholder="e.g., AddMintUser" required>
                    <label for="profilePhone" class="mt-4">Phone Number (Optional):</label>
                    <input type="text" id="profilePhone" placeholder="e.g., +919876543210">
                    <label for="profileWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="profileWhatsApp" placeholder="e.g., +919876543210 (for direct chats)">
                    <label for="profileInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="profileInstagram" placeholder="e.g., @yourhandle">
                    <button type="submit" class="mt-4">Save Profile & Continue</button>
                </form>
            </section>

            <section id="home-posts">
                <h2>Recent Updates</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button class="mb-4" onclick="fetchPosts()">Refresh Feed</button>
                    <button onclick="claimDailyFreebies()">Claim Daily Freebies!</button>
                </div>
                <div id="posts-list">
                    <p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>
                </div>
            </section>
            
            <section id="create-post-section">
                <h2>Share Your Thoughts</h2>
                <div id="create-post-message" class="message hidden"></div>
                <p class="post-cost-info">You have <span id="post-limits-info" class="highlight">0</span> free posts remaining today.</p>
                <p class="post-cost-info">After free limit, each post costs <span class="highlight red">1</span> ad or <span class="highlight red">5</span> coins.</p>
                <form id="create-post-form">
                    <textarea id="post-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Publish Post</button>
                    <button type="button" class="mt-4" onclick="requestAdForPost()">Watch Ad for 1 Post Limit</button>
                </form>
            </section>
            
            <section id="user-profile-section">
                <h2>My Personal Profile</h2>
                <div id="user-profile-details">
                    <p><strong>Email:</strong> <span id="profile-email"></span></p>
                    <p><strong>Username:</strong> <span id="profile-display-name"></span></p>
                    <p><strong>Phone:</strong> <span id="profile-phone-number">N/A</span></p>
                    <p><strong>WhatsApp:</strong> <span id="profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="profile-instagram-handle">N/A</span></p>
                    <div class="profile-stats">
                        <div class="profile-stats-item"><strong><span id="profile-posts-count">0</span></strong><br>Posts</div>
                        <div class="profile-stats-item"><strong><span id="profile-followers-count">0</span></strong><br>Followers</div>
                        <div class="profile-stats-item"><strong><span id="profile-following-count">0</span></strong><br>Following</div>
                    </div>
                    <div class="mt-4 monetization-info">
                        <h3>Monetization Coming Soon</h3>
                        <p>You can earn real money after reaching 100 followers. Every 150 posts, you can earn from 10 to 100 rupees. Share the app and get more followers!</p>
                    </div>
                    <button onclick="showSection('edit-profile-section')" class="mt-4">Edit Profile</button>
                    <button onclick="auth.signOut()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
                </div>
            </section>
            
            <section id="edit-profile-section" class="container">
                <h2>Update Your Profile Details</h2>
                <div id="edit-profile-message" class="message hidden"></div>
                <form id="edit-profile-form">
                    <label for="editUsername">Username:</label>
                    <input type="text" id="editUsername" required>
                    <label for="editPhone" class="mt-4">Phone Number (Optional):</label>
                    <input type="text" id="editPhone">
                    <label for="editWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="editWhatsApp">
                    <label for="editInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="editInstagram">
                    <button type="submit" class="mt-4">Save Changes</button>
                    <button type="button" onclick="showSection('user-profile-section')" class="mt-4" style="background-color: #6c757d;">Cancel</button>
                </form>
            </section>
            
            <section id="my-posts-section">
                <h2>My Active Posts</h2>
                <div id="my-posts-list" class="profile-posts-list">
                    <p class="text-center">Loading your posts...</p>
                </div>
                <button class="mt-4" onclick="showSection('user-profile-section')">Back to Profile</button>
            </section>

            <section id="other-user-profile-section">
                <h2><span id="other-profile-username">User Profile</span></h2>
                <p><strong>Posts:</strong> <span id="other-profile-posts-count"></span></p>
                <p><strong>Followers:</strong> <span id="other-profile-followers-count"></span></p>
                <p><strong>Following:</strong> <span id="other-profile-following-count"></span></p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="follow-btn" onclick="followUser()">Follow</button>
                    <button id="message-btn" onclick="openMessageModal()">Message</button>
                </div>
                <div id="other-profile-posts-list" class="profile-posts-list mt-4"></div>
                <button class="mt-4" onclick="showSection('home-posts')">Back to Feed</button>
            </section>

            <section id="settings-section" class="container">
                <h2>App Settings</h2>
                <p class="text-center mt-4">This is your settings panel. More options coming soon!</p>
                <p class="text-center mt-2">App Version: 1.0.0 Pro</p>
                <button onclick="auth.signOut()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>
        </main>
        
        <footer>
            <div class="nav-item active" data-section="home-posts">
                <span class="icon icon-home"></span>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="create-post-section">
                <span class="icon icon-plus"></span>
                <span>Create</span>
            </div>
            <div class="nav-item" data-section="user-profile-section">
                <span class="icon icon-user"></span>
                <span>Profile</span>
            </div>
            <div class="nav-item" data-section="settings-section">
                <span class="icon icon-settings"></span>
                <span>Settings</span>
            </div>
        </footer>
        
        <div id="earn-rewards-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="hideModal('earn-rewards-modal')">&times;</span>
                <h2>Earn More</h2>
                <p class="text-center mb-4">Watch a full ad to earn rewards. Ads must not be skipped.</p>
                <button onclick="requestAd('coins')" class="mt-4">Watch Ad for 10 Coins</button>
                <button onclick="requestAd('credits')" class="mt-4" style="background-color: #6c757d;">Watch Ad for 10 Credits</button>
                <button onclick="requestAd('limits')" class="mt-4" style="background-color: #17a2b8;">Watch Ad for 1 Post Limit</button>
            </div>
        </div>
        
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="hideModal('message-modal')">&times;</span>
                <h2 id="message-modal-header">Send a Message</h2>
                <p id="message-modal-info" class="text-center mb-4"></p>
                <form id="send-message-form">
                    <textarea id="message-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Send Message</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration (YOURS)
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUserId = null;
        let currentUsername = null;
        let userProfileData = {}; // To store full user profile data
        let otherUserProfileData = {}; // To store the profile of a user we are viewing
        
        // --- UI Utility Functions ---
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.remove('active');
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
        }
        function showModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function hideModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
        }
        function hideMessage(elementId) { document.getElementById(elementId).classList.add('hidden'); }
        
        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                iconElement.innerHTML = "&#128064;";
            } else {
                input.type = "password";
                iconElement.innerHTML = "&#128065;";
            }
        }
        
        function showMainAppUI() {
            document.getElementById('app-container').classList.remove('hidden');
            showSection('home-posts');
            updateHeaderUI();
        }
        
        function hidePreloader() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 1200);
        }

        // --- Header UI Update ---
        function updateHeaderUI() {
            document.getElementById('header-coins').textContent = userProfileData.coins || 0;
            document.getElementById('header-credits').textContent = userProfileData.credits || 0;
            document.getElementById('header-limits').textContent = userProfileData.postLimits || 0;
            document.getElementById('post-limits-info').textContent = userProfileData.postLimits || 0;
        }

        // --- Ad and Currency Management ---
        function requestAd(type) {
            // This function sends a command to App Inventor to show an ad
            // 'coins', 'credits', 'limits'
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(`UNITY_AD:REWARDED:${type.toUpperCase()}`);
            } else {
                alert(`AppInventor not detected. Would have shown ad for ${type}.`);
                // For testing purposes, simulate a reward
                // handleAdCompletion(type); 
            }
        }
        
        function requestAdForPost() {
            // Specific ad request for a post limit
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(`UNITY_AD:REWARDED:LIMITS_FOR_POST`);
            } else {
                alert(`AppInventor not detected. Would have shown ad for a post limit.`);
                // For testing, simulate ad completion
                // handleAdCompletion('limits');
            }
        }
        
        window.handleAdCompletion = async (rewardType) => {
            // This function will be called by App Inventor after a successful ad view.
            if (!currentUserId) {
                console.error("No user logged in to receive ad reward.");
                return;
            }
            const userRef = db.collection('users').doc(currentUserId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    
                    const newProfileData = userDoc.data();
                    let rewardMessage = '';
                    
                    switch(rewardType) {
                        case 'coins':
                            newProfileData.coins = (newProfileData.coins || 0) + 10;
                            rewardMessage = "You have earned 10 coins!";
                            break;
                        case 'credits':
                            newProfileData.credits = (newProfileData.credits || 0) + 10;
                            rewardMessage = "You have earned 10 credits!";
                            break;
                        case 'limits':
                            newProfileData.postLimits = (newProfileData.postLimits || 0) + 1;
                            rewardMessage = "You have earned 1 post limit!";
                            break;
                        case 'limits_for_post':
                            newProfileData.postLimits = (newProfileData.postLimits || 0) + 1;
                            rewardMessage = "You have earned 1 post limit!";
                            break;
                        default:
                            console.error("Unknown reward type:", rewardType);
                            return;
                    }
                    transaction.update(userRef, newProfileData);
                    userProfileData = newProfileData; // Update local state
                    updateHeaderUI(); // Update UI
                    showMessage('create-post-message', rewardMessage, 'success');
                    alert(rewardMessage);
                });
            } catch (error) {
                console.error("Failed to update user profile with ad reward:", error);
                alert("Failed to claim reward. Please try again.");
            }
        };

        async function claimDailyFreebies() {
            if (!currentUserId) {
                alert("Please sign in to claim your daily freebies.");
                return;
            }
            const userRef = db.collection('users').doc(currentUserId);
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    const userData = userDoc.data();

                    const now = new Date();
                    const lastClaimed = userData.dailyFreebieLastClaimed ? userData.dailyFreebieLastClaimed.toDate() : null;

                    if (lastClaimed && now.getDate() === lastClaimed.getDate() && now.getMonth() === lastClaimed.getMonth() && now.getFullYear() === lastClaimed.getFullYear()) {
                        alert("You have already claimed your daily freebies today. Check back tomorrow!");
                        return;
                    }

                    const newCoins = (userData.coins || 0) + 10;
                    const newCredits = (userData.credits || 0) + 10;
                    const newLimits = (userData.postLimits || 0) + 2;

                    transaction.update(userRef, {
                        coins: newCoins,
                        credits: newCredits,
                        postLimits: newLimits,
                        dailyFreebieLastClaimed: new Date()
                    });
                    
                    userProfileData.coins = newCoins;
                    userProfileData.credits = newCredits;
                    userProfileData.postLimits = newLimits;
                    userProfileData.dailyFreebieLastClaimed = new Date();

                    updateHeaderUI();
                    alert("Daily freebies claimed! You received 10 Coins, 10 Credits, and 2 Post Limits.");
                });
            } catch (error) {
                console.error("Error claiming daily freebies:", error);
                alert("Failed to claim daily freebies. Please try again.");
            }
        }
        
        // --- Authentication & Profile Management ---
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('signup-status-message');
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            if (password !== confirmPassword) { showMessage('signup-status-message', 'Passwords do not match.', 'error'); return; }
            if (password.length < 6) { showMessage('signup-status-message', 'Password must be at least 6 characters long.', 'error'); return; }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                showMessage('signup-status-message', 'Account created! Verification email sent. Please check your inbox and sign in after verifying.', 'success');
                showSection('email-verify');
                document.getElementById('verify-email-message').textContent = `A verification email has been sent to ${email}. Please verify your email to continue.`;
            } catch (error) {
                console.error("Signup Error:", error.code, error.message);
                let displayMessage = error.message;
                if (error.code === 'auth/email-already-in-use') { displayMessage = 'This email is already registered. Please sign in or use a different email.'; }
                showMessage('signup-status-message', displayMessage, 'error');
            }
        });
        
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('auth-status-message');
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    showMessage('auth-status-message', 'Your email is not verified. Please verify it to continue.', 'error');
                    auth.signOut();
                    showSection('email-verify');
                    document.getElementById('verify-email-message').textContent = `Your email ${email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    return;
                }
            } catch (error) {
                console.error("Signin Error:", error.code, error.message);
                let displayMessage = error.message;
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') { displayMessage = 'Invalid email or password. Please try again.'; }
                showMessage('auth-status-message', displayMessage, 'error');
            }
        });
        
        async function sendVerificationEmail() {
            const user = auth.currentUser;
            if (user) {
                try {
                    await user.sendEmailVerification();
                    showMessage('verify-email-message', 'Verification email re-sent! Check your inbox (and spam folder).', 'success');
                } catch (error) {
                    console.error("Error sending verification email:", error.message);
                    showMessage('verify-email-message', `Error sending verification email: ${error.message}`, 'error');
                }
            } else {
                 showMessage('verify-email-message', 'No user logged in to send verification email.', 'error');
            }
        }
        
        document.getElementById('profile-setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('profile-setup-message');
            const username = document.getElementById('profileUsername').value.trim();
            if (!username) { showMessage('profile-setup-message', 'Username is required to identify you.', 'error'); return; }
            
            try {
                const initialProfileData = {
                    username: username,
                    email: auth.currentUser.email,
                    phone: document.getElementById('profilePhone').value.trim() || null,
                    whatsapp: document.getElementById('profileWhatsApp').value.trim() || null,
                    instagram: document.getElementById('profileInstagram').value.trim() || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    coins: 10, // Initial freebies
                    credits: 10,
                    postLimits: 2,
                    followers: [], // Initialize with empty arrays
                    following: [],
                    likedPosts: [], // Store liked posts
                    dailyFreebieLastClaimed: null
                };
                await db.collection('users').doc(currentUserId).set(initialProfileData);
                
                userProfileData = initialProfileData;
                currentUsername = username;
                showMessage('profile-setup-message', 'Profile saved successfully! Redirecting...', 'success');
                showMainAppUI();
            } catch (error) {
                console.error("Error setting up profile:", error.message);
                showMessage('profile-setup-message', `Failed to save profile: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('edit-profile-message');
            const username = document.getElementById('editUsername').value.trim();
            if (!username) { showMessage('edit-profile-message', 'Username is required.', 'error'); return; }
            
            try {
                await db.collection('users').doc(currentUserId).update({
                    username: username,
                    phone: document.getElementById('editPhone').value.trim() || null,
                    whatsapp: document.getElementById('editWhatsApp').value.trim() || null,
                    instagram: document.getElementById('editInstagram').value.trim() || null
                });
                userProfileData.username = username;
                userProfileData.phone = document.getElementById('editPhone').value.trim() || null;
                userProfileData.whatsapp = document.getElementById('editWhatsApp').value.trim() || null;
                userProfileData.instagram = document.getElementById('editInstagram').value.trim() || null;
                currentUsername = username;
                showMessage('edit-profile-message', 'Profile updated successfully!', 'success');
                showSection('user-profile-section');
            } catch (error) {
                console.error("Error updating profile:", error.message);
                showMessage('edit-profile-message', `Failed to update profile: ${error.message}`, 'error');
            }
        });
        
        async function fetchUserProfile(uid, targetSection) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    if (uid === currentUserId) {
                        userProfileData = data;
                        currentUsername = data.username;
                        updateHeaderUI();
                        document.getElementById('profile-email').textContent = data.email || 'N/A';
                        document.getElementById('profile-display-name').textContent = data.username || 'N/A';
                        document.getElementById('profile-phone-number').textContent = data.phone || 'N/A';
                        document.getElementById('profile-whatsapp-number').textContent = data.whatsapp || 'N/A';
                        document.getElementById('profile-instagram-handle').textContent = data.instagram || 'N/A';
                        
                        document.getElementById('editUsername').value = data.username || '';
                        document.getElementById('editPhone').value = data.phone || '';
                        document.getElementById('editWhatsApp').value = data.whatsapp || '';
                        document.getElementById('editInstagram').value = data.instagram || '';
                        
                        // Fetch counts
                        const postsCount = await db.collection('posts').where('userId', '==', currentUserId).get().then(snap => snap.size);
                        document.getElementById('profile-posts-count').textContent = postsCount;
                        document.getElementById('profile-followers-count').textContent = (data.followers ? data.followers.length : 0);
                        document.getElementById('profile-following-count').textContent = (data.following ? data.following.length : 0);
                        
                        showSection(targetSection);
                    } else {
                        // Other user's profile
                        otherUserProfileData = data;
                        document.getElementById('other-profile-username').textContent = data.username || 'N/A';
                        const postsCount = await db.collection('posts').where('userId', '==', uid).get().then(snap => snap.size);
                        document.getElementById('other-profile-posts-count').textContent = postsCount;
                        document.getElementById('other-profile-followers-count').textContent = (data.followers ? data.followers.length : 0);
                        document.getElementById('other-profile-following-count').textContent = (data.following ? data.following.length : 0);
                        
                        const followBtn = document.getElementById('follow-btn');
                        if (userProfileData.following && userProfileData.following.includes(uid)) {
                            followBtn.textContent = 'Unfollow';
                            followBtn.className = 'unfollow-btn';
                        } else {
                            followBtn.textContent = 'Follow';
                            followBtn.className = 'follow-btn';
                        }
                        
                        showSection(targetSection);
                        fetchPostsForUser(uid, 'other-profile-posts-list');
                    }
                } else {
                    console.log("User profile not found in Firestore.");
                    // Fallback to setup or error
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
        }
        
        async function followUser() {
            if (!currentUserId || !otherUserProfileData.email) return;
            
            const userRef = db.collection('users').doc(currentUserId);
            const otherUserRef = db.collection('users').doc(otherUserProfileData.uid);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const otherUserDoc = await transaction.get(otherUserRef);
                    
                    if (!userDoc.exists || !otherUserDoc.exists) throw "User not found!";
                    
                    const userData = userDoc.data();
                    const otherUserData = otherUserDoc.data();
                    
                    let newFollowing = userData.following || [];
                    let newFollowers = otherUserData.followers || [];
                    
                    const isFollowing = newFollowing.includes(otherUserProfileData.uid);
                    
                    if (isFollowing) {
                        newFollowing = newFollowing.filter(id => id !== otherUserProfileData.uid);
                        newFollowers = newFollowers.filter(id => id !== currentUserId);
                        alert(`You have unfollowed ${otherUserProfileData.username}.`);
                    } else {
                        newFollowing.push(otherUserProfileData.uid);
                        newFollowers.push(currentUserId);
                        alert(`You are now following ${otherUserProfileData.username}.`);
                    }
                    
                    transaction.update(userRef, { following: newFollowing });
                    transaction.update(otherUserRef, { followers: newFollowers });
                    
                    userProfileData.following = newFollowing; // Update local state
                    document.getElementById('follow-btn').textContent = isFollowing ? 'Follow' : 'Unfollow';
                    document.getElementById('follow-btn').className = isFollowing ? 'follow-btn' : 'unfollow-btn';
                    document.getElementById('other-profile-followers-count').textContent = newFollowers.length;
                });
            } catch (error) {
                console.error("Error following user:", error);
                alert(`Failed to follow/unfollow user: ${error.message}`);
            }
        }

        // --- Post Management ---
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('create-post-message');
            const content = document.getElementById('post-content').value.trim();
            if (!content) { showMessage('create-post-message', 'Post content cannot be empty.', 'error'); return; }
            if (!currentUserId || !currentUsername) { showMessage('create-post-message', 'User not logged in or username not set.', 'error'); return; }
            
            const userRef = db.collection('users').doc(currentUserId);
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const userData = userDoc.data();
                    
                    // Check for free post limit
                    const postsTodaySnapshot = await db.collection('posts')
                                                        .where('userId', '==', currentUserId)
                                                        .where('timestamp', '>', new Date(new Date().setHours(0,0,0,0))) // Posts from today
                                                        .get();
                    const freePostsRemaining = 2 - postsTodaySnapshot.size;
                    
                    let cost = { type: 'limit', value: 1 };
                    if (freePostsRemaining > 0) {
                        cost = { type: 'free', value: 0 };
                    } else if ((userData.postLimits || 0) > 0) {
                        cost = { type: 'limit', value: 1 };
                    } else if ((userData.coins || 0) >= 5) {
                        cost = { type: 'coins', value: 5 };
                    } else {
                        throw new Error("You have no free posts, post limits, or enough coins (5) to publish. Please watch an ad to earn more.");
                    }
                    
                    // Deduct cost and create post
                    const postRef = db.collection('posts').doc();
                    const postData = {
                        content: content,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        expiryTime: Date.now() + (24 * 60 * 60 * 1000), // 24 hours from now
                        userId: currentUserId,
                        username: currentUsername,
                        likes: 0,
                        soundUrl: 'dummy_sound.mp3', // Placeholder for now
                        translation: { en: content, hi: 'Hindi translation placeholder' } // Placeholder for translate
                    };
                    
                    if (cost.type === 'limit') {
                        transaction.update(userRef, { postLimits: firebase.firestore.FieldValue.increment(-1) });
                        userProfileData.postLimits = (userData.postLimits || 0) - 1;
                    } else if (cost.type === 'coins') {
                        transaction.update(userRef, { coins: firebase.firestore.FieldValue.increment(-5) });
                        userProfileData.coins = (userData.coins || 0) - 5;
                    }
                    
                    transaction.set(postRef, postData);
                    
                    updateHeaderUI();
                    showMessage('create-post-message', 'Post published successfully!', 'success');
                    document.getElementById('post-content').value = '';
                    showSection('home-posts');
                    fetchPosts();
                });
            } catch (error) {
                console.error("Error creating post:", error.message);
                showMessage('create-post-message', `Failed to publish post: ${error.message}`, 'error');
            }
        });

        async function fetchPostsForUser(uid, listId) {
            const postsListDiv = document.getElementById(listId);
            postsListDiv.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching user\'s posts...</p>';
            
            try {
                const snapshot = await db.collection('posts')
                                         .where('userId', '==', uid)
                                         .orderBy('timestamp', 'desc')
                                         .get();
                
                if (snapshot.empty) {
                    postsListDiv.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts found for this user.</p>';
                    return;
                }
                
                postsListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const postCard = createPostCard(post, postId, uid === currentUserId);
                    postsListDiv.appendChild(postCard);
                });
                
            } catch (error) {
                console.error("Error fetching user posts:", error);
                postsListDiv.innerHTML = `<p class="text-center message error">Error loading posts: ${error.message}</p>`;
            }
        }
        
        async function fetchPosts() {
            const postsListDiv = document.getElementById('posts-list');
            postsListDiv.innerHTML = '<p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>';
            
            try {
                const snapshot = await db.collection('posts').orderBy('timestamp', 'desc').get();
                if (snapshot.empty) {
                    postsListDiv.innerHTML = '<p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts yet. Be the first to share something amazing!</p>';
                    return;
                }
                
                postsListDiv.innerHTML = '';
                const postStyles = ['', 'horizontal', 'square', 'neon'];
                let lastRandomIndex = -1;
                
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    
                    let randomIndex;
                    do { randomIndex = Math.floor(Math.random() * postStyles.length); } while (randomIndex === lastRandomIndex && postStyles.length > 1);
                    lastRandomIndex = randomIndex;
                    
                    const postCard = createPostCard(post, postId, post.userId === currentUserId, postStyles[randomIndex]);
                    postsListDiv.appendChild(postCard);
                });
            } catch (error) {
                console.error("Error fetching posts:", error);
                postsListDiv.innerHTML = `<p class="text-center message error">Error loading posts: ${error.message}. Please refresh.</p>`;
            }
        }

        function createPostCard(post, postId, isMyPost, style = '') {
            const postCard = document.createElement('div');
            postCard.className = `post-card ${style}`;
            postCard.id = `post-${postId}`;
            
            const isLiked = userProfileData.likedPosts && userProfileData.likedPosts.includes(postId);
            
            let contactButtonsHtml = '';
            if (isMyPost) {
                contactButtonsHtml = `<button class="delete-btn" onclick="deletePost('${postId}')">Delete</button>`;
            } else {
                contactButtonsHtml = `
                    <button onclick="contactUser('${post.userId}', 'whatsapp')">WhatsApp</button>
                    <button onclick="contactUser('${post.userId}', 'instagram')">Instagram</button>
                    <button onclick="contactUser('${post.userId}', 'phone')">Call</button>
                    <button onclick="contactUser('${post.userId}', 'message')">Message</button>
                `;
            }
            
            postCard.innerHTML = `
                <div class="post-content-wrapper">
                    <h3 onclick="showOtherUserProfile('${post.userId}')">${post.username || 'Anonymous User'}</h3>
                    <p>${post.content}</p>
                </div>
                <div class="post-meta">
                    <span>Published: ${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'N/A'}</span>
                    <div class="post-interaction-icons">
                        <span class="icon icon-sound" onclick="playSound('${post.soundUrl}')" title="Play Sound"></span>
                        <span class="icon icon-translate" onclick="translatePost('${postId}')" title="Translate"></span>
                    </div>
                </div>
                <div class="post-actions">
                    <button class="like-button ${isLiked ? 'liked' : ''}" onclick="toggleLike('${postId}')">
                        <span class="icon like-icon"></span> <span id="likes-${postId}">${post.likes || 0}</span>
                    </button>
                    ${contactButtonsHtml}
                </div>
            `;
            return postCard;
        }

        async function toggleLike(postId) {
            if (!currentUserId) {
                showMessage('auth-status-message', 'Please sign in to like posts.', 'error');
                showSection('signin-auth');
                return;
            }
            
            const postRef = db.collection('posts').doc(postId);
            const likeRef = db.collection('posts').doc(postId).collection('likes').doc(currentUserId);
            const userRef = db.collection('users').doc(currentUserId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    const userLikeDoc = await transaction.get(likeRef);
                    const userDoc = await transaction.get(userRef);
                    
                    if (!postDoc.exists || !userDoc.exists) throw "Document not found!";
                    
                    let newLikesCount = postDoc.data().likes || 0;
                    
                    if (userLikeDoc.exists) {
                        // Unlike the post
                        transaction.delete(likeRef);
                        newLikesCount = Math.max(0, newLikesCount - 1);
                        
                        const likedPostsArray = userDoc.data().likedPosts || [];
                        const updatedLikedPosts = likedPostsArray.filter(id => id !== postId);
                        transaction.update(userRef, { likedPosts: updatedLikedPosts });
                        userProfileData.likedPosts = updatedLikedPosts; // Update local state
                        
                    } else {
                        // Like the post
                        transaction.set(likeRef, { userId: currentUserId, likedAt: new Date() });
                        newLikesCount++;
                        
                        const likedPostsArray = userDoc.data().likedPosts || [];
                        likedPostsArray.push(postId);
                        transaction.update(userRef, { likedPosts: likedPostsArray });
                        userProfileData.likedPosts = likedPostsArray; // Update local state
                    }
                    
                    transaction.update(postRef, { likes: newLikesCount });
                    
                    // Update UI immediately
                    const likesSpan = document.getElementById(`likes-${postId}`);
                    if (likesSpan) likesSpan.textContent = newLikesCount;
                    const likeButton = likesSpan.closest('.like-button');
                    if (likeButton) {
                        if (userLikeDoc.exists) {
                            likeButton.classList.remove('liked');
                        } else {
                            likeButton.classList.add('liked');
                        }
                    }
                });
            } catch (error) {
                console.error("Error liking/unliking post:", error);
                alert(`Failed to like/unlike post: ${error.message}`);
            }
        }
        
        // --- AppInventor WebViewStringChange Communication ---
        window.handleAdCompletion = async (rewardType) => {
            // This function is called by App Inventor after a successful ad
            // See the blocks section for how this is implemented
            if (!currentUserId) return;
            const userRef = db.collection('users').doc(currentUserId);
            
            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User not found!";
                    const userData = userDoc.data();

                    if (rewardType === 'coins') {
                        const newCoins = (userData.coins || 0) + 10;
                        transaction.update(userRef, { coins: newCoins });
                        userProfileData.coins = newCoins;
                        updateHeaderUI();
                    } else if (rewardType === 'credits') {
                        const newCredits = (userData.credits || 0) + 10;
                        transaction.update(userRef, { credits: newCredits });
                        userProfileData.credits = newCredits;
                        updateHeaderUI();
                    } else if (rewardType.startsWith('limits')) {
                        const newLimits = (userData.postLimits || 0) + 1;
                        transaction.update(userRef, { postLimits: newLimits });
                        userProfileData.postLimits = newLimits;
                        updateHeaderUI();
                    }
                });
                alert(`Reward granted for watching ad!`);
            } catch (error) {
                console.error("Error rewarding user for ad:", error);
                alert("An error occurred while granting your reward. Please try again.");
            }
        };

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    showSection(sectionId);
                    if (sectionId === 'home-posts') {
                        fetchPosts();
                    } else if (sectionId === 'user-profile-section' && currentUserId) {
                        fetchUserProfile(currentUserId, 'user-profile-section');
                    }
                });
            });
            
            auth.onAuthStateChanged(async (user) => {
                setTimeout(() => {
                    hidePreloader();
                    if (user) {
                        currentUserId = user.uid;
                        if (user.emailVerified) {
                            fetchUserProfile(currentUserId, 'home-posts').then(() => {
                                if (!userProfileData || !userProfileData.username) {
                                    showSection('setup-profile');
                                    document.getElementById('profileUsername').value = user.displayName || '';
                                } else {
                                    showMainAppUI();
                                    fetchPosts();
                                }
                            });
                        } else {
                            showSection('email-verify');
                            document.getElementById('verify-email-message').textContent = `Your email ${user.email} is not verified. Please check your inbox (and spam folder) for the verification link.`;
                        }
                    } else {
                        currentUserId = null;
                        currentUsername = null;
                        userProfileData = {};
                        document.getElementById('app-container').classList.remove('hidden');
                        showSection('signin-auth');
                    }
                }, 1500);
            });
        });
        
        function showOtherUserProfile(userId) {
            if (userId === currentUserId) {
                showSection('user-profile-section');
                fetchUserProfile(currentUserId, 'user-profile-section');
            } else {
                fetchUserProfile(userId, 'other-user-profile-section');
            }
        }
        
        function openMessageModal() {
            if (!currentUserId || !otherUserProfileData.uid) return;
            showModal('message-modal');
            document.getElementById('message-modal-header').textContent = `Message ${otherUserProfileData.username}`;
            document.getElementById('message-modal-info').textContent = `1 message costs 1 credit. Your message will be deleted automatically after 24 hours.`;
            document.getElementById('send-message-form').onsubmit = sendMessage;
        }

        async function sendMessage(e) {
            e.preventDefault();
            const messageContent = document.getElementById('message-content').value.trim();
            if (!messageContent) return;
            
            if ((userProfileData.credits || 0) < 1) {
                alert("You do not have enough credits to send a message. Please earn more.");
                return;
            }

            const userRef = db.collection('users').doc(currentUserId);
            const messageRef = db.collection('messages').doc();

            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User not found!";
                    
                    transaction.update(userRef, { credits: firebase.firestore.FieldValue.increment(-1) });
                    transaction.set(messageRef, {
                        senderId: currentUserId,
                        receiverId: otherUserProfileData.uid,
                        content: messageContent,
                        timestamp: Date.now()
                    });
                });
                
                userProfileData.credits -= 1;
                updateHeaderUI();
                hideModal('message-modal');
                alert("Message sent successfully!");
            } catch (error) {
                console.error("Error sending message:", error);
                alert(`Failed to send message: ${error.message}`);
            }
        }

        function playSound(url) {
            // This is a placeholder for a future function that would play sound from a URL.
            // Since Firebase Storage is not used, you'd need an alternative sound hosting service.
            alert(`Playing sound from URL: ${url}`);
        }

        function translatePost(postId) {
            // Placeholder for a translation function.
            // This would fetch the post's 'translation' map from Firestore
            // and toggle the displayed text between the original and translated version.
            alert(`Translate function for post ${postId} would be implemented here.`);
        }
        
    </script>
</body>
</html>
