<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint</title>
    <style>
        /* ========================================================= */
        /* == Global Styles, Variables & Resets ==================== */
        /* ========================================================= */
        :root {
            --dark-bg: #0d0d0d;
            --dark-fg: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #00aaff;
            --primary-dark: #0077c2;
            --accent-color: #ffcc00;
            --accent-dark: #cc9900;
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --success-color: #4CAF50;
            --error-color: #E53935;
            --info-color: #2196F3;
            --transition-speed: 0.4s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 18px;
            --font-family: 'Poppins', 'Segoe UI', 'Roboto', sans-serif;
            
            /* NEON Colors */
            --neon-blue: #00aaff;
            --neon-blue-shadow: rgba(0, 170, 255, 0.8);
            --neon-pink: #ff00ff;
            --neon-pink-shadow: rgba(255, 0, 255, 0.8);
            --neon-green: #00ff00;
            --neon-green-shadow: rgba(0, 255, 0, 0.8);
            --neon-yellow: #ffff00;
            --neon-yellow-shadow: rgba(255, 255, 0, 0.8);
            --neon-purple: #9b59b6;
            --neon-purple-shadow: rgba(155, 89, 182, 0.8);
            --neon-orange: #e67e22;
            --neon-orange-shadow: rgba(230, 126, 34, 0.8);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg), #121212);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed); }
        a:hover { color: var(--accent-color); text-decoration: underline; }

        button, input[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
        }
        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        }
        
        input[type="email"], input[type="password"], input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
            appearance: none;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }
        
        .container {
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
        }

        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            word-wrap: break-word;
            border: 1px solid transparent;
            animation: slideInUp 0.4s ease-out;
        }
        .message.success { background-color: rgba(76, 175, 80, 0.2); color: var(--success-color); border-color: var(--success-color); }
        .message.error { background-color: rgba(229, 57, 53, 0.2); color: var(--error-color); border-color: var(--error-color); }
        .message.info { background-color: rgba(33, 150, 243, 0.2); color: var(--info-color); border-color: var(--info-color); }

        .hidden { display: none !important; }

        /* ========================================================= */
        /* == App Layout & Structure =============================== */
        /* ========================================================= */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            transition: opacity 0.5s ease;
        }

        header {
            background-color: var(--dark-fg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 3px 20px var(--shadow-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99;
            animation: slideDown 0.5s ease-out;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .app-logo {
            display: flex;
            align-items: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.6);
            letter-spacing: 1px;
            position: relative;
        }
        .app-logo .shape {
            width: 40px; height: 40px;
            background: linear-gradient(45deg, var(--accent-color), #ffdb58);
            transform: rotate(45deg);
            border-radius: 10px;
            margin-right: 15px;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.6);
            animation: headerLogoSpin 4s infinite linear, headerLogoBounce 2s infinite alternate;
        }
        .header-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .stat-item:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .stat-item .icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        .header-menu-btn, .header-refresh-btn {
            font-size: 1.5rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .header-menu-btn:hover, .header-refresh-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }


        /* Scrollable Main Content */
        main {
            flex-grow: 1;
            padding: 20px;
            padding-top: 80px;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        section {
            display: none;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        section.active { display: block; }
        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
            letter-spacing: 1px;
        }
        
        footer {
            background-color: var(--dark-fg);
            padding: 10px 0; /* Reduced height */
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -3px 20px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 99;
            animation: slideUp 0.5s ease-out;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 5px 8px; /* Reduced padding */
            border-radius: var(--border-radius-sm);
            flex: 1;
            max-width: 100px;
        }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); background-color: rgba(0, 170, 255, 0.1); }
        .nav-item:hover { color: var(--primary-color); background-color: rgba(0, 170, 255, 0.05); }
        .nav-item .icon {
            font-size: 1.5rem; /* Reduced icon size */
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }
        .nav-item:hover .icon { transform: scale(1.1); }


        /* ========================================================= */
        /* == Section Specific Styles ============================== */
        /* ========================================================= */
        
        .password-input-container { position: relative; margin-bottom: 15px; }
        .password-input-container input { padding-right: 50px; }
        .toggle-password {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--border-color);
            font-size: 1.3rem;
            transition: color var(--transition-speed);
            padding: 5px;
            border-radius: 5px;
        }
        .toggle-password:hover { color: var(--primary-color); }
        
        .username-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        .username-input-group input {
            padding-right: 40px; /* Space for the icon */
            margin-bottom: 0;
        }
        .username-status-icon {
            position: absolute;
            right: 10px;
            font-size: 1.2rem;
        }
        .username-status-icon.available { color: var(--success-color); }
        .username-status-icon.unavailable { color: var(--error-color); }

        /* Post Display Section */
        #posts-container {
            display: flex; /* Use flex to allow vertical and horizontal mixing */
            flex-direction: column;
            gap: 20px;
        }
        #posts-container > .post-card {
            margin-bottom: 0;
        }
        .horizontal-scroll-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            background-color: rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.6s ease-out;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            max-width: 100%;
            flex-wrap: nowrap; /* Prevent wrapping in horizontal mode */
        }
        .horizontal-scroll-container .post-card {
            min-width: 280px;
            flex-shrink: 0;
            padding: 20px;
        }

        .post-card {
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }
        .post-card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.9); border-color: var(--primary-color); }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .post-header h3 { color: var(--accent-color); font-size: 1.4rem; font-weight: 700; text-shadow: 0 0 5px rgba(255, 204, 0, 0.4); cursor: pointer; }
        .post-actions-icons {
            display: flex;
            gap: 10px;
            position: relative;
        }
        .action-icon-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .action-icon-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .action-icon-btn.liked {
            color: var(--error-color); /* Red for liked heart */
            animation: heartBeat 0.5s ease-in-out;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--dark-fg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
            min-width: 150px;
            overflow: hidden;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .dropdown-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .dropdown-menu button {
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            font-size: 1rem;
            border-radius: 0;
            box-shadow: none;
            transition: background-color 0.2s ease;
        }
        .dropdown-menu button:hover {
            background-color: var(--border-color);
        }
        
        .post-card p { font-size: 1.05rem; margin-bottom: 20px; flex-grow: 1; word-wrap: break-word; color: var(--text-color); }
        .post-card p a { color: var(--primary-color); text-decoration: underline; }
        .post-meta { font-size: 0.88rem; color: #aaa; margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); }
        .post-likes-count { margin-left: 5px; }

        /* Neon Post Styles with different colors */
        .post-card.neon-blue.neon-active {
            box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-blue) inset;
            border-color: var(--neon-blue);
            animation: neonBlueGlow 0.5s ease-in-out forwards; /* Changed animation to one-shot */
        }
        .post-card.neon-pink.neon-active {
            box-shadow: 0 0 15px var(--neon-pink), 0 0 25px var(--neon-pink) inset;
            border-color: var(--neon-pink);
            animation: neonPinkGlow 0.5s ease-in-out forwards;
        }
        .post-card.neon-green.neon-active {
            box-shadow: 0 0 15px var(--neon-green), 0 0 25px var(--neon-green) inset;
            border-color: var(--neon-green);
            animation: neonGreenGlow 0.5s ease-in-out forwards;
        }
        .post-card.neon-yellow.neon-active {
            box-shadow: 0 0 15px var(--neon-yellow), 0 0 25px var(--neon-yellow) inset;
            border-color: var(--neon-yellow);
            animation: neonYellowGlow 0.5s ease-in-out forwards;
        }
        .post-card.neon-purple.neon-active {
            box-shadow: 0 0 15px var(--neon-purple), 0 0 25px var(--neon-purple) inset;
            border-color: var(--neon-purple);
            animation: neonPurpleGlow 0.5s ease-in-out forwards;
        }
        .post-card.neon-orange.neon-active {
            box-shadow: 0 0 15px var(--neon-orange), 0 0 25px var(--neon-orange) inset;
            border-color: var(--neon-orange);
            animation: neonOrangeGlow 0.5s ease-in-out forwards;
        }
        
        .url-link { color: var(--primary-color); text-decoration: underline; }

        /* Profile Section */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 20px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .profile-image-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            position: relative;
            animation: profilePulse 2s infinite ease-out;
            margin-bottom: 15px;
        }
        .profile-image {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--neon-blue) 0%, var(--neon-pink) 100%);
            animation: profileImageGlow 3s infinite alternate ease-in-out;
            border-radius: 50%;
        }
        .profile-info {
            text-align: center;
            width: 100%;
        }
        .profile-username {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
        }
        .profile-stat-item {
            text-align: center;
            font-size: 0.9rem;
            color: #ccc;
            cursor: pointer;
        }
        .profile-stat-item strong {
            display: block;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .profile-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .profile-buttons button {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        /* Search Section */
        #search-results-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
            animation: fadeIn 0.4s ease-out;
        }
        .search-result-item .user-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--primary-color);
        }
        .search-result-item .user-info {
            flex-grow: 1;
        }
        .search-result-item h4 {
            font-size: 1.1rem;
            color: var(--accent-color);
        }
        .search-result-item button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Daily Reward Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background: linear-gradient(145deg, var(--dark-fg), #282828);
            padding: 40px 30px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color);
            max-width: 90%;
            width: 400px;
            transform: scale(0.8);
            opacity: 0;
            animation: popUpAnimation 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .popup-content h3 {
            color: var(--accent-color);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.6);
        }
        .popup-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
        }
        .popup-content li {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content li .icon {
            font-size: 1.3rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        .popup-content button {
            padding: 10px 25px;
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none;
        }
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--dark-fg);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8);
            z-index: 101;
            transition: right 0.3s ease-out;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }
        .side-menu.visible {
            right: 0;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .menu-header h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .menu-close-btn {
            font-size: 2rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .menu-item:hover {
            background-color: rgba(0, 170, 255, 0.1);
        }
        .menu-item .icon {
            margin-right: 15px;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            margin-left: auto;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Specific Menu Icons - Code based */
        .icon-whatsapp::before { content: '‚´∏'; font-weight: bold; } /* Geometric shape for WhatsApp */
        .icon-instagram::before { content: '‚óé'; font-weight: bold; } /* Geometric shape for Instagram */
        .icon-youtube::before { content: '‚ñ∑'; font-weight: bold; } /* Geometric shape for YouTube */

        /* Reaction Panel */
        .reaction-panel {
            position: absolute;
            bottom: 10px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-fg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .reaction-panel.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-20px); /* Move slightly up */
        }
        .reaction-panel .emoji-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .reaction-panel .emoji-btn:hover {
            background-color: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }

        .post-reactions-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }
        .post-reaction-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
            background-color: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 3px 8px;
        }
        .post-reaction-item .emoji {
            font-size: 1.2rem;
            margin-right: 5px;
        }

        /* Chat Window Styles */
        #chat-window {
            height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            background-color: var(--dark-bg);
        }
        .chat-message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.95rem;
            word-wrap: break-word;
            position: relative;
        }
        .chat-message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .chat-message.received {
            align-self: flex-start;
            background-color: var(--dark-fg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 2px;
        }
        .chat-message .timestamp {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
            display: block;
            text-align: right;
        }
        .chat-message.received .timestamp {
            text-align: left;
        }


        /* ========================================================= */
        /* == ANIMATIONS =========================================== */
        /* ========================================================= */

        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0d0d0d, #080808);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            flex-direction: column;
            gap: 20px;
        }
        .splash-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, var(--accent-color), var(--primary-color));
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 170, 255, 0.6), 0 0 50px rgba(255, 204, 0, 0.6);
            animation: splashLogoAnimation 2s infinite alternate ease-in-out;
        }
        @keyframes splashLogoAnimation {
            0% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes neonBlueGlow { 0% { box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue) inset; } 100% { box-shadow: 0 0 25px var(--neon-blue), 0 0 40px var(--neon-blue) inset; } }
        @keyframes neonPinkGlow { 0% { box-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink) inset; } 100% { box-shadow: 0 0 25px var(--neon-pink), 0 0 40px var(--neon-pink) inset; } }
        @keyframes neonGreenGlow { 0% { box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green) inset; } 100% { box-shadow: 0 0 25px var(--neon-green), 0 0 40px var(--neon-green) inset; } }
        @keyframes neonYellowGlow { 0% { box-shadow: 0 0 10px var(--neon-yellow), 0 0 20px var(--neon-yellow) inset; } 100% { box-shadow: 0 0 25px var(--neon-yellow), 0 0 40px var(--neon-yellow) inset; } }
        @keyframes neonPurpleGlow { 0% { box-shadow: 0 0 10px var(--neon-purple), 0 0 20px var(--neon-purple) inset; } 100% { box-shadow: 0 0 25px var(--neon-purple), 0 0 40px var(--neon-purple) inset; } }
        @keyframes neonOrangeGlow { 0% { box-shadow: 0 0 10px var(--neon-orange), 0 0 20px var(--neon-orange) inset; } 100% { box-shadow: 0 0 25px var(--neon-orange), 0 0 40px var(--neon-orange) inset; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes profilePulse { 0%, 100% { box-shadow: 0 0 0 0px rgba(0, 170, 255, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(0, 170, 255, 0); } }
        @keyframes profileImageGlow { from { filter: brightness(1) contrast(1); } to { filter: brightness(1.2) contrast(1.1); } }
        @keyframes heartBeat { 0% { transform: scale(1); } 25% { transform: scale(1.2); } 50% { transform: scale(1); } 75% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes popUpAnimation { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo"></div>
        AddMint
    </div>

    <div id="app-container" class="hidden">
        
        <header>
            <div class="header-left">
                <button class="header-menu-btn" onclick="App.UI.toggleSideMenu()">‚ò∞</button>
                <div class="app-logo">
                    <span class="shape"></span> AddMint
                </div>
            </div>
            <div class="header-right">
                <button class="header-refresh-btn" onclick="App.Posts.fetch(true)">‚Üª</button>
                <div class="header-stats">
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">üí∞</span>
                        <span id="header-coins">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">‚ùñ</span>
                        <span id="header-limit">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">üí°</span>
                        <span id="header-credits">0</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="side-menu-overlay" class="side-menu-overlay" onclick="App.UI.toggleSideMenu()"></div>
        <div id="side-menu" class="side-menu">
            <div class="menu-header">
                <h3>Menu</h3>
                <button class="menu-close-btn" onclick="App.UI.toggleSideMenu()">√ó</button>
            </div>
            <a href="#" class="menu-item" onclick="App.UI.toggleDataSaver()">
                <span class="icon">‚òÄ</span> Data Saver
                <label class="toggle-switch">
                    <input type="checkbox" id="data-saver-toggle">
                    <span class="slider"></span>
                </label>
            </a>
            <a href="https://www.instagram.com/addmint__" target="_blank" class="menu-item">
                <span class="icon icon-instagram"></span> Instagram
            </a>
            <a href="https://youtube.com/@add_mint" target="_blank" class="menu-item">
                <span class="icon icon-youtube"></span> YouTube
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('about-section'); App.UI.toggleSideMenu();">
                <span class="icon">‚Ñπ</span> About
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('privacy-policy-section'); App.UI.toggleSideMenu();">
                <span class="icon">üîí</span> Privacy Policy
            </a>
        </div>


        <main id="main-content">
            <section id="signin-auth" class="container active">
                <h2>Welcome Back!</h2>
                <div id="auth-status-message" class="message hidden"></div>
                <form id="signin-form">
                    <input type="email" id="signin-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signin-password', this)">üëÅ</span>
                    </div>
                    <button type="submit">Sign In</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="App.UI.showSection('signup-auth'); return false;">Sign Up Here</a></p>
                </form>
            </section>

            <section id="signup-auth" class="container">
                <h2>Join AddMint Today!</h2>
                <div id="signup-status-message" class="message hidden"></div>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signup-password" placeholder="Create Password (min 6 chars)" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-password', this)">üëÅ</span>
                    </div>
                    <div class="password-input-container">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-confirm-password', this)">üëÅ</span>
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="App.UI.showSection('signin-auth'); return false;">Sign In</a></p>
                </form>
            </section>

            <section id="email-verify" class="container">
                <h2>Verify Your Email</h2>
                <div id="verify-email-message" class="message error"></div>
                <p class="text-center mb-4">A verification link has been sent. Please check your inbox.</p>
                <button onclick="App.Auth.sendVerificationEmail()">Resend Verification Email</button>
                <button onclick="App.Auth.logout()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

            <section id="setup-profile" class="container">
                <h2>Complete Your Profile</h2>
                <div id="profile-setup-message" class="message hidden"></div>
                <form id="profile-setup-form">
                    <p class="mb-4 text-center" style="color: #ccc;">Choose a username and at least one contact method.</p>
                    <label for="profileUsername">Choose a Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="profileUsername" placeholder="e.g., AddMintUser" required>
                        <span id="username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="profileWhatsApp">WhatsApp Number (Optional):</label>
                    <input type="text" id="profileWhatsApp" placeholder="e.g., 919876543210 (without +)">
                    <label for="profileInstagram">Instagram Handle (Optional):</label>
                    <input type="text" id="profileInstagram" placeholder="e.g., yourhandle">
                    <button type="submit" class="mt-4">Save Profile & Continue</button>
                </form>
            </section>

            <section id="home-posts">
                <h2>Recent Updates</h2>
                <div id="posts-container">
                    <p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>
                </div>
                <div id="loading-spinner" class="text-center hidden" style="padding: 20px;">
                    <div class="spinner"></div>
                </div>
            </section>
            
            <section id="search-section" class="container">
                <h2>Find Users</h2>
                <div id="search-message" class="message hidden"></div>
                <div class="username-input-group mb-4">
                    <input type="text" id="search-username-input" placeholder="Search by username..." oninput="App.Search.searchUsers()">
                </div>
                <div id="search-results-list">
                    </div>
            </section>

            <section id="create-post-section">
                <h2>Share Your Thoughts</h2>
                <div id="create-post-message" class="message hidden"></div>
                <form id="create-post-form" class="mt-4">
                    <label for="post-content">What's on your mind today?</label>
                    <textarea id="post-content" placeholder="Type your message here..." required></textarea>
                    
                    <label class="mt-4">Post Boost (Auto-Delete after...):</label>
                    <div class="mt-2">
                        <select id="post-boost-option" class="form-control">
                            <option value="12">12 Hours (Free)</option>
                            <option value="18">18 Hours (1 Ad)</option>
                            <option value="24">24 Hours (2 Ads)</option>
                            <option value="30">30 Hours (3 Ads)</option>
                        </select>
                    </div>

                    <button type="submit" class="mt-4">Publish Post</button>
                    <p class="text-center mt-2">Cost: 1 Limit & 5 Coins</p>
                </form>
            </section>
            
            <section id="ad-rewards-section" class="container">
                <h2>Get More!</h2>
                <div id="ad-rewards-message" class="message hidden"></div>
                <p class="text-center mb-4">Watch an ad to get more coins, credits, or post limits.</p>
                <div class="reward-buttons">
                    <button onclick="App.Monetization.requestAd('coins');"><span class="icon">üí∞</span> Get 10 Coins</button>
                    <button onclick="App.Monetization.requestAd('credits');"><span class="icon">üí°</span> Get 10 Credits</button>
                    <button onclick="App.Monetization.requestAd('limits');"><span class="icon">‚ùñ</span> Get 1 Post Limit</button>
                </div>
            </section>
            
            <div id="daily-reward-popup" class="popup-overlay hidden">
                <div class="popup-content">
                    <h3>Daily Rewards! üéâ</h3>
                    <p>You've received your rewards for today!</p>
                    <ul>
                        <li><span class="icon">üí∞</span> 10 Coins</li>
                        <li><span class="icon">‚ùñ</span> 1 Post Limit</li>
                        <li><span class="icon">üí°</span> 10 Credits</li>
                    </ul>
                    <button onclick="App.Monetization.hideDailyRewardPopup()">Claim</button>
                </div>
            </div>
            
            <section id="about-section" class="container">
                <h2>About AddMint</h2>
                <p>Welcome to AddMint! Our goal is to create a fun and engaging social platform where you can share your thoughts and connect with others. We believe in providing a seamless user experience while giving creators the tools they need to grow. Join our community and start sharing today!</p>
            </section>

            <section id="privacy-policy-section" class="container">
                <h2>Privacy Policy</h2>
                <p>Your privacy is important to us. This policy explains how we collect, use, and protect your information. By using our app, you agree to the collection and use of information in accordance with this policy.</p>
                <p>We may collect information such as your name, email, and social media handles to provide and improve our service. We do not share your personal information with third parties without your consent.</p>
                <p>We take reasonable measures to protect your information from unauthorized access or disclosure. However, no method of transmission over the internet or electronic storage is 100% secure.</p>
                <p>If you have any questions about this Privacy Policy, please contact us through the app.</p>
            </section>

            <section id="user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <div class="profile-image" id="profile-image-own"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item" onclick="App.Profile.showFollowers()">
                                <strong id="profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowers()">
                                <strong id="profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowing()">
                                <strong id="profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button onclick="App.UI.showSection('edit-profile-section');">Edit Profile</button>
                            <button onclick="App.Auth.logout()" style="background-color: var(--error-color);">Sign Out</button>
                        </div>
                    </div>
                </div>
                <div id="user-profile-details" class="container" style="background: none; box-shadow: none;">
                    <p><strong>Email:</strong> <span id="profile-email"></span></p>
                    <p><strong>WhatsApp:</strong> <span id="profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="profile-instagram-handle">N/A</span></p>
                </div>
                <h4 style="margin-top: 30px; text-align: center;">Active Posts</h4>
                <div id="profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>

            <section id="edit-profile-section" class="container">
                <h2>Update Your Profile Details</h2>
                <div id="edit-profile-message" class="message hidden"></div>
                <form id="edit-profile-form">
                    <label for="editUsername">Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="editUsername" required>
                        <span id="edit-username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="editWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="editWhatsApp">
                    <label for="editInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="editInstagram">
                    <button type="submit" class="mt-4">Save Changes</button>
                    <button type="button" onclick="App.UI.showSection('user-profile-section')" class="mt-4" style="background-color: #6c757d;">Cancel</button>
                </form>
            </section>

            <section id="other-user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <div class="profile-image" id="profile-image-other"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="other-profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item">
                                <strong id="other-profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="other-profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item">
                                <strong id="other-profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button id="other-follow-btn" onclick="App.Profile.toggleFollow()">Follow</button>
                            <button id="other-whatsapp-btn" onclick="App.UI.openWhatsAppProfile()"><span class="icon icon-whatsapp"></span> WhatsApp</button>
                            <button id="other-instagram-btn" onclick="App.UI.openInstagramProfile()"><span class="icon icon-instagram"></span> Instagram</button>
                            <button id="other-message-btn" onclick="App.Messages.startNewChat()"><span class="icon">üí¨</span> Message</button>
                        </div>
                    </div>
                </div>
                <div id="other-user-profile-details" class="container" style="background: none; box-shadow: none;">
                    <p><strong>Email:</strong> <span id="other-profile-email"></span></p>
                    <p><strong>WhatsApp:</strong> <span id="other-profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="other-profile-instagram-handle">N/A</span></p>
                </div>
                <h4 style="margin-top: 30px; text-align: center;">Posts</h4>
                <div id="other-profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>
            
            <section id="message-section" class="container">
                <h2 id="message-recipient-name">Message User</h2>
                <div id="message-status-message" class="message hidden"></div>
                <div id="chat-window">
                    <p style="color: #aaa;">Start chatting!</p>
                </div>
                <form id="send-message-form" class="mt-4">
                    <textarea id="message-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Send Message (1 Credit)</button>
                </form>
            </section>

            <section id="list-section" class="container">
                <h2 id="list-title"></h2>
                <div id="list-container">
                    </div>
                <button onclick="App.UI.showSection(App.currentUserId === App.profileToView ? 'user-profile-section' : 'other-user-profile-section')" class="mt-4">Back to Profile</button>
            </section>
        </main>

        <footer>
            <div class="nav-item active" data-section="home-posts">
                <span class="icon">‚åÇ</span>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="search-section">
                <span class="icon">‚åï</span>
                <span>Search</span>
            </div>
            <div class="nav-item" data-section="create-post-section">
                <span class="icon">‚ûï</span>
                <span>Create</span>
            </div>
            <div class="nav-item" data-section="user-profile-section">
                <span class="icon">‚óâ</span>
                <span>Profile</span>
            </div>
        </footer>
    </div>
    
    <script>
        const App = {};
        
        App.firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };
        firebase.initializeApp(App.firebaseConfig);
        App.auth = firebase.auth();
        App.db = firebase.firestore();

        App.currentUserId = null;
        App.currentUsername = null;
        App.userProfileData = {};
        App.profileToView = null; // Stores the UID of the user whose profile is currently being viewed
        App.neonColors = ['neon-blue', 'neon-pink', 'neon-green', 'neon-yellow', 'neon-purple', 'neon-orange'];
        App.profileLogoShapes = ['‚óà', '‚óâ', '‚óÜ', '‚òÖ', '‚öô', '‚ö°', '‚ùÄ', '‚ô´', '‚ôï', 'üöÄ', '‚àû', '‚ú¢', '‚®Å', '‚è£', '‚åæ', '‚éà', '‚ßâ', '‚çü', 'üüÜ', '‚öõ', 'üúÇ', 'üúÑ', 'üúÉ', 'üúÅ', 'üúî', 'üúó', 'üúò', 'üúö', 'üúõ', 'üúù', 'üúü', 'üùä', 'üùã', 'üùå', 'üùç', 'üùé', 'üùè', 'üùê', 'üùë', 'üùí', 'üùì', 'üùî', 'üùï', 'üùñ', 'üùó', 'üùò', 'üùô', 'üùö', 'üùõ', 'üùú', 'üùù', 'üùû', 'üùü', 'üù†', 'üù°', 'üù¢', 'üù£', 'üù§', 'üù•', 'üù¶', 'üùß', 'üù®', 'üù©', 'üù™', 'üù´', 'üù¨', 'üù≠', 'üùÆ', 'üùØ', 'üù∞', 'üù±', 'üù≤', 'üù≥', 'üù¥', 'üùµ', 'üù∂', 'üù∑', 'üù∏', 'üùπ', 'üù∫', 'üùª', 'üùº', 'üùΩ', 'üùæ', 'üùø']; // More abstract Unicode characters
        
        App.lastPost = null;
        App.isLoadingPosts = false;
        App.postsCache = []; // Stores all fetched posts to loop them infinitely
        App.postCacheIndex = 0; // Index for looping through postsCache
        App.isDataSaver = false;
        App.activeNeonPost = null; // To track which post is currently neon

        App.UI = {
            showSection: (sectionId) => {
                document.querySelectorAll('section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
                
                if (sectionId === 'home-posts') {
                    document.getElementById('main-content').scrollTop = 0;
                }
            },
            showMessage: (elementId, message, type = 'info') => {
                const element = document.getElementById(elementId);
                element.innerHTML = message;
                element.className = `message ${type}`;
                element.classList.remove('hidden');
            },
            hideMessage: (elementId) => {
                document.getElementById(elementId).classList.add('hidden');
            },
            togglePasswordVisibility: (inputId, iconElement) => {
                const input = document.getElementById(inputId);
                if (input.type === "password") {
                    input.type = "text";
                    iconElement.innerHTML = 'üëÄ';
                } else {
                    input.type = "password";
                    iconElement.innerHTML = 'üëÅ';
                }
            },
            updateHeaderStats: (coins, limits, credits) => {
                document.getElementById('header-coins').textContent = App.Utils.formatNumber(coins);
                document.getElementById('header-limit').textContent = App.Utils.formatNumber(limits);
                document.getElementById('header-credits').textContent = App.Utils.formatNumber(credits);
            },
            hidePreloader: () => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    document.getElementById('app-container').classList.remove('hidden');
                }, 500); // Increased timeout for a smoother fade out
            },
            playPostSound: (postContent) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(postContent);
                    utterance.lang = 'hi-IN'; // Set language to Hindi
                    speechSynthesis.speak(utterance);
                } else {
                    alert("Your device does not support Text-to-Speech.");
                }
            },
            openWhatsAppProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.whatsapp) {
                        window.open(`https://wa.me/${profile.whatsapp}`, '_blank');
                    } else {
                        alert('No WhatsApp number available for this user.');
                    }
                }).catch(error => {
                    console.error("Error fetching WhatsApp profile:", error);
                    alert("An error occurred. Please try again.");
                });
            },
            openInstagramProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.instagram) {
                        window.open(`https://www.instagram.com/${profile.instagram}`, '_blank');
                    } else {
                        alert('No Instagram handle available for this user.');
                    }
                }).catch(error => {
                    console.error("Error fetching Instagram profile:", error);
                    alert("An error occurred. Please try again.");
                });
            },
            toggleDropdown: (postId) => {
                const dropdown = document.getElementById(`dropdown-${postId}`);
                if (dropdown) {
                    dropdown.classList.toggle('visible');
                    document.querySelectorAll('.dropdown-menu').forEach(d => {
                        if (d.id !== `dropdown-${postId}`) {
                            d.classList.remove('visible');
                        }
                    });
                }
            },
            hideAllDropdowns: () => {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('visible'));
            },
            generateUserLogo: (uid) => {
                const colorPalette = [
                    '#ff00ff', '#00ff00', '#00aaff', '#ffff00',
                    '#ff5500', '#8800ff', '#ff0055', '#00ffaa',
                    '#FF4500', '#DA70D6', '#7B68EE', '#ADFF2F',
                    '#20B2AA', '#9370DB', '#FF6347', '#4682B4'
                ];
                const hash = Array.from(uid).reduce((sum, char) => sum + char.charCodeAt(0), 0);
                const color1 = colorPalette[hash % colorPalette.length];
                const color2 = colorPalette[(hash + 3) % colorPalette.length];
                const shape = App.profileLogoShapes[hash % App.profileLogoShapes.length];

                return {
                    background: `linear-gradient(135deg, ${color1}, ${color2})`,
                    text: shape
                };
            },
            toggleSideMenu: () => {
                const menu = document.getElementById('side-menu');
                const overlay = document.getElementById('side-menu-overlay');
                menu.classList.toggle('visible');
                overlay.style.display = menu.classList.contains('visible') ? 'block' : 'none';
            },
            toggleDataSaver: () => {
                App.isDataSaver = document.getElementById('data-saver-toggle').checked;
                // Add more sophisticated data saver logic here, e.g., lazy loading images/videos.
                alert(`Data Saver is now ${App.isDataSaver ? 'ON' : 'OFF'}.`);
            },
            activateNeonEffect: (postElement) => {
                if (App.activeNeonPost && App.activeNeonPost !== postElement) {
                    App.activeNeonPost.classList.remove('neon-active');
                }
                postElement.classList.add('neon-active');
                App.activeNeonPost = postElement;

                clearTimeout(postElement.neonTimeout);
                postElement.neonTimeout = setTimeout(() => {
                    postElement.classList.remove('neon-active');
                    App.activeNeonPost = null;
                }, 3000); // 3 seconds
            },
            showReactionPanel: (postElement, postId) => {
                const existingPanel = postElement.querySelector('.reaction-panel');
                if (existingPanel) {
                    existingPanel.classList.toggle('visible');
                    return;
                }

                const panel = document.createElement('div');
                panel.className = 'reaction-panel';
                panel.innerHTML = `
                    <button class="emoji-btn" data-emoji="üëç">üëç</button>
                    <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
                    <button class="emoji-btn" data-emoji="üòÆ">üòÆ</button>
                    <button class="emoji-btn" data-emoji="üò¢">üò¢</button>
                `;
                panel.querySelectorAll('.emoji-btn').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation();
                        App.Posts.addReaction(postId, button.dataset.emoji);
                        panel.classList.remove('visible');
                    };
                });
                postElement.appendChild(panel);
                setTimeout(() => panel.classList.add('visible'), 10);
                
                // Hide if click outside
                const hidePanel = (event) => {
                    if (!postElement.contains(event.target)) {
                        panel.classList.remove('visible');
                        document.removeEventListener('click', hidePanel);
                    }
                };
                document.addEventListener('click', hidePanel);
            },
            showList: async (listType, uid) => {
                const listTitleElement = document.getElementById('list-title');
                const listContainerElement = document.getElementById('list-container');
                listContainerElement.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';
                App.UI.showSection('list-section');
                
                try {
                    let collectionRef;
                    if (listType === 'followers') {
                        listTitleElement.textContent = 'Followers';
                        collectionRef = App.db.collection('users').doc(uid).collection('followers');
                    } else if (listType === 'following') {
                        listTitleElement.textContent = 'Following';
                        collectionRef = App.db.collection('users').doc(uid).collection('following');
                    } else {
                        listContainerElement.innerHTML = '<p class="message error">Invalid list type.</p>';
                        return;
                    }

                    const snapshot = await collectionRef.get();
                    if (snapshot.empty) {
                        listContainerElement.innerHTML = '<p class="message info">No one here yet!</p>';
                        return;
                    }

                    listContainerElement.innerHTML = ''; // Clear spinner
                    for (const doc of snapshot.docs) {
                        const targetUid = doc.id;
                        const userDoc = await App.db.collection('users').doc(targetUid).get();
                        if (userDoc.exists) {
                            const user = userDoc.data();
                            const listItem = document.createElement('div');
                            listItem.className = 'search-result-item'; // Reusing search item style
                            listItem.innerHTML = `
                                <div class="user-logo" style="background: ${App.UI.generateUserLogo(targetUid).background};">
                                    <span style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; height: 100%;">${App.UI.generateUserLogo(targetUid).text}</span>
                                </div>
                                <div class="user-info">
                                    <h4>${user.username}</h4>
                                </div>
                                ${targetUid !== App.currentUserId ? `<button data-uid="${targetUid}">View Profile</button>` : ''}
                            `;
                            if (targetUid !== App.currentUserId) {
                                listItem.querySelector('button').onclick = () => {
                                    App.profileToView = targetUid;
                                    App.Profile.fetch(targetUid, false);
                                    App.UI.showSection('other-user-profile-section');
                                };
                            }
                            listContainerElement.appendChild(listItem);
                        }
                    }

                } catch (error) {
                    console.error("Error fetching list:", error);
                    listContainerElement.innerHTML = '<p class="message error">Failed to load list. Please try again.</p>';
                }
            }
        };

        App.Utils = {
            formatNumber: (num) => {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                }
                if (num >= 1000) {
                    return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
                }
                return num;
            },
            // For general error messages that should not expose internal details
            getGenericErrorMessage: () => {
                return "An error occurred. Please try again.";
            }
        };
        
        App.Auth = {
            signup: async (email, password, confirmPassword) => {
                App.UI.hideMessage('signup-status-message');
                if (password !== confirmPassword) {
                    App.UI.showMessage('signup-status-message', 'Passwords do not match.', 'error');
                    return;
                }
                if (password.length < 6) {
                    App.UI.showMessage('signup-status-message', 'Password must be at least 6 characters long.', 'error');
                    return;
                }
                
                try {
                    const userCredential = await App.auth.createUserWithEmailAndPassword(email, password);
                    await App.Auth.sendVerificationEmail();
                    App.UI.showMessage('signup-status-message', 'Successfully signed up! Please check your email for a verification link.', 'success');
                    App.UI.showSection('email-verify');
                } catch (error) {
                    App.UI.showMessage('signup-status-message', `Error: ${error.message}`, 'error');
                    console.error("Signup error:", error);
                }
            },
            signin: async (email, password) => {
                App.UI.hideMessage('auth-status-message');
                try {
                    await App.auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    App.UI.showMessage('auth-status-message', `Error: ${error.message}`, 'error');
                    console.error("Signin error:", error);
                }
            },
            logout: async () => {
                try {
                    await App.auth.signOut();
                    App.currentUserId = null;
                    App.UI.showSection('signin-auth');
                } catch (error) {
                    console.error("Logout error:", error);
                }
            },
            sendVerificationEmail: async () => {
                const user = App.auth.currentUser;
                if (user) {
                    try {
                        await user.sendEmailVerification();
                        App.UI.showMessage('verify-email-message', 'Verification link sent! Please check your inbox.', 'info');
                    } catch (error) {
                        App.UI.showMessage('verify-email-message', `Error sending verification email: ${error.message}`, 'error');
                        console.error("Verification email error:", error);
                    }
                }
            }
        };

        App.Profile = {
            checkUsernameAvailability: async (username, isEdit = false) => {
                const icon = document.getElementById(isEdit ? 'edit-username-status-icon' : 'username-status-icon');
                const cleanUsername = username.toLowerCase().trim();
                if (!cleanUsername || cleanUsername.length < 3) {
                    icon.classList.add('hidden');
                    return false;
                }
                
                const usersRef = App.db.collection('users').where('username', '==', cleanUsername);
                const snapshot = await usersRef.get();
                
                let isAvailable = true;
                if (!snapshot.empty) {
                    if (isEdit && snapshot.docs[0].id === App.currentUserId) {
                        isAvailable = true; // Same user updating their own username to itself
                    } else {
                        isAvailable = false; // Another user already has this username
                    }
                }
                
                if (isAvailable) {
                    icon.classList.remove('hidden', 'unavailable');
                    icon.classList.add('available');
                    icon.innerHTML = '‚úî'; // Green tick
                    return true;
                } else {
                    icon.classList.remove('hidden', 'available');
                    icon.classList.add('unavailable');
                    icon.innerHTML = '‚úñ'; // Red cross
                    return false;
                }
            },
            setup: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('profile-setup-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('profile-setup-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                if (!username || (!whatsapp && !instagram)) {
                    App.UI.showMessage('profile-setup-message', 'Please provide a username and at least one contact method.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).set({
                        username: username.toLowerCase().trim(),
                        email: App.auth.currentUser.email,
                        whatsapp: whatsapp.trim() || null,
                        instagram: instagram.trim() || null,
                        coins: 10,
                        credits: 10,
                        postLimit: 1,
                        lastRewardDate: new Date().toDateString(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp() // Track last active for views
                    });
                    App.UI.showMessage('profile-setup-message', 'Profile saved successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (error) {
                    App.UI.showMessage('profile-setup-message', `Error saving profile: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Profile setup error:", error);
                }
            },
            edit: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('edit-profile-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username, true);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('edit-profile-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).update({
                        username: username.toLowerCase().trim(),
                        whatsapp: whatsapp.trim() || null,
                        instagram: instagram.trim() || null,
                    });
                    App.UI.showMessage('edit-profile-message', 'Profile updated successfully!', 'success');
                    setTimeout(() => {
                        App.UI.showSection('user-profile-section');
                        App.Profile.fetch(App.currentUserId, true);
                    }, 1000);
                } catch (error) {
                    App.UI.showMessage('edit-profile-message', `Error updating profile: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Profile edit error:", error);
                }
            },
            fetch: async (uid, isCurrentUser = false) => {
                App.profileToView = uid; // Set the current profile being viewed
                try {
                    const userDoc = await App.db.collection('users').doc(uid).get();
                    if (!userDoc.exists) {
                        if (isCurrentUser) {
                            App.UI.showSection('setup-profile');
                            return;
                        }
                        alert('User profile not found.');
                        return null;
                    }
                    const data = userDoc.data();
                    
                    const postsSnapshot = await App.db.collection('posts').where('userId', '==', uid).get();
                    const followersSnapshot = await App.db.collection('users').doc(uid).collection('followers').get();
                    const followingSnapshot = await App.db.collection('users').doc(uid).collection('following').get();
                    
                    data.postsCount = postsSnapshot.size;
                    data.followersCount = followersSnapshot.size;
                    data.followingCount = followingSnapshot.size;
                    data.uid = uid;
                    
                    if (isCurrentUser) {
                        App.userProfileData = data;
                        App.currentUsername = data.username;
                        App.UI.updateHeaderStats(data.coins || 0, data.postLimit || 0, data.credits || 0);
                        App.Profile.renderCurrentUserProfile(data, postsSnapshot.docs);
                    } else {
                        App.Profile.renderOtherUserProfile(data, postsSnapshot.docs);
                    }
                    return data;
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    alert(App.Utils.getGenericErrorMessage());
                    return null;
                }
            },
            renderCurrentUserProfile: (profile, posts) => {
                document.getElementById('profile-display-name').textContent = profile.username;
                document.getElementById('profile-posts-count').textContent = App.Utils.formatNumber(profile.postsCount);
                document.getElementById('profile-followers-count').textContent = App.Utils.formatNumber(profile.followersCount);
                document.getElementById('profile-following-count').textContent = App.Utils.formatNumber(profile.followingCount);
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('profile-instagram-handle').textContent = profile.instagram || 'N/A';
                
                const logoData = App.UI.generateUserLogo(profile.uid);
                const profileImgOwn = document.getElementById('profile-image-own');
                profileImgOwn.style.background = logoData.background;
                profileImgOwn.innerHTML = `<span style="font-size: 3rem; display: flex; align-items: center; justify-content: center; height: 100%;">${logoData.text}</span>`;
                
                document.getElementById('editUsername').value = profile.username || '';
                document.getElementById('editWhatsApp').value = profile.whatsapp || '';
                document.getElementById('editInstagram').value = profile.instagram || '';
                
                App.Posts.renderAll(posts, 'profile-posts-grid', true);
            },
            renderOtherUserProfile: (profile, posts) => {
                document.getElementById('other-profile-display-name').textContent = profile.username;
                document.getElementById('other-profile-posts-count').textContent = App.Utils.formatNumber(profile.postsCount);
                document.getElementById('other-profile-followers-count').textContent = App.Utils.formatNumber(profile.followersCount);
                document.getElementById('other-profile-following-count').textContent = App.Utils.formatNumber(profile.followingCount);
                document.getElementById('other-profile-email').textContent = profile.email;
                document.getElementById('other-profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('other-profile-instagram-handle').textContent = profile.instagram || 'N/A';
                
                const logoData = App.UI.generateUserLogo(profile.uid);
                const profileImgOther = document.getElementById('profile-image-other');
                profileImgOther.style.background = logoData.background;
                profileImgOther.innerHTML = `<span style="font-size: 3rem; display: flex; align-items: center; justify-content: center; height: 100%;">${logoData.text}</span>`;
                
                App.db.collection('users').doc(App.currentUserId).collection('following').doc(profile.uid).get().then(doc => {
                    const followBtn = document.getElementById('other-follow-btn');
                    if (doc.exists) {
                        followBtn.textContent = 'Following';
                        followBtn.style.backgroundColor = '#6c757d'; // Indicate already following
                    } else {
                        followBtn.textContent = 'Follow';
                        followBtn.style.backgroundColor = var('--primary-color');
                    }
                });
                
                document.getElementById('other-whatsapp-btn').style.display = profile.whatsapp ? 'inline-flex' : 'none';
                document.getElementById('other-instagram-btn').style.display = profile.instagram ? 'inline-flex' : 'none';

                App.Posts.renderAll(posts, 'other-profile-posts-grid', false);
            },
            toggleFollow: async (targetUserId = App.profileToView) => {
                if (!targetUserId || targetUserId === App.currentUserId) return;
                
                const followRef = App.db.collection('users').doc(App.currentUserId).collection('following').doc(targetUserId);
                const followerRef = App.db.collection('users').doc(targetUserId).collection('followers').doc(App.currentUserId);
                
                try {
                    const doc = await followRef.get();
                    if (doc.exists) {
                        await followRef.delete();
                        await followerRef.delete();
                        alert('User unfollowed.');
                    } else {
                        await followRef.set({ followedAt: new Date() });
                        await followerRef.set({ followedAt: new Date() });
                        alert('User followed!');
                    }
                    App.Profile.fetch(targetUserId, false); // Re-fetch target profile to update button
                    App.Profile.fetch(App.currentUserId, true); // Re-fetch current user profile to update counts
                } catch (error) {
                    console.error("Error toggling follow:", error);
                    alert(App.Utils.getGenericErrorMessage());
                }
            },
            showFollowers: () => {
                App.UI.showList('followers', App.currentUserId);
            },
            showFollowing: () => {
                App.UI.showList('following', App.currentUserId);
            }
        };

        App.Search = {
            searchUsers: async () => {
                const searchTerm = document.getElementById('search-username-input').value.toLowerCase().trim();
                const resultsContainer = document.getElementById('search-results-list');
                resultsContainer.innerHTML = '';
                
                if (searchTerm.length < 2) {
                    App.UI.showMessage('search-message', 'Please enter at least 2 characters to search.', 'info');
                    return;
                }

                App.UI.hideMessage('search-message');

                try {
                    const usersRef = App.db.collection('users')
                                    .orderBy('username')
                                    .startAt(searchTerm)
                                    .endAt(searchTerm + '\uf8ff')
                                    .limit(20);
                    const snapshot = await usersRef.get();
                    
                    if (snapshot.empty) {
                        App.UI.showMessage('search-message', 'No users found.', 'info');
                        return;
                    }

                    snapshot.docs.forEach(doc => {
                        const user = doc.data();
                        if (doc.id === App.currentUserId) return; // Don't show current user in search results
                        
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        
                        const userLogoDiv = document.createElement('div');
                        userLogoDiv.className = 'user-logo';
                        const logoData = App.UI.generateUserLogo(doc.id);
                        userLogoDiv.style.background = logoData.background;
                        userLogoDiv.innerHTML = `<span style="font-size: 1.5rem; display: flex; align-items: center; justify-content: center; height: 100%;">${logoData.text}</span>`;
                        
                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info';
                        userInfo.innerHTML = `<h4>${user.username}</h4>`;
                        
                        const followButton = document.createElement('button');
                        // Check if current user is already following this user
                        App.db.collection('users').doc(App.currentUserId).collection('following').doc(doc.id).get().then(followDoc => {
                            if (followDoc.exists) {
                                followButton.textContent = 'Following';
                                followButton.style.backgroundColor = '#6c757d';
                            } else {
                                followButton.textContent = 'Follow';
                            }
                        });
                        followButton.onclick = () => {
                            App.Profile.toggleFollow(doc.id);
                        };

                        resultItem.appendChild(userLogoDiv);
                        resultItem.appendChild(userInfo);
                        resultItem.appendChild(followButton);
                        resultsContainer.appendChild(resultItem);
                    });
                } catch (error) {
                    App.UI.showMessage('search-message', `Error searching: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Search error:", error);
                }
            }
        };

        App.Posts = {
            create: async (content) => {
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    App.UI.showMessage('create-post-message', 'User profile not found.', 'error');
                    return;
                }
                const userData = userDoc.data();
                
                const postsLimit = userData.postLimit || 0;
                const coins = userData.coins || 0;
                const boostDuration = document.getElementById('post-boost-option').value;

                let requiredAds = 0;
                if (boostDuration === '18') requiredAds = 1;
                else if (boostDuration === '24') requiredAds = 2;
                else if (boostDuration === '30') requiredAds = 3;

                // New logic: must have both 1 limit AND 5 coins
                if (postsLimit <= 0 || coins < 5) {
                    App.UI.showMessage('create-post-message', 'You need at least 1 post limit and 5 coins to post. Please get more to post.', 'error');
                    return;
                }
                
                if (requiredAds > 0) {
                     App.UI.showMessage('create-post-message', `You need to watch ${requiredAds} ad(s) for this boost option.`, 'info');
                     // This is where you would trigger the ad from your App Inventor app
                     // window.AppInventor.requestAd(`boost_${boostDuration}`);
                     return;
                }

                await App.Posts.submitNewPost(content, userData, userRef, boostDuration);
            },
            submitNewPost: async (content, userData, userRef, boostDuration = '12') => {
                const newPostRef = App.db.collection('posts').doc();
                const updateData = {
                    postLimit: firebase.firestore.FieldValue.increment(-1),
                    coins: firebase.firestore.FieldValue.increment(-5)
                };
                
                const neonColor = App.Posts.getRandomPostStyle();
                const expiryTime = new Date(Date.now() + (parseInt(boostDuration) * 60 * 60 * 1000));

                try {
                    await App.db.runTransaction(async (transaction) => {
                        transaction.set(newPostRef, {
                            content,
                            userId: App.currentUserId,
                            username: userData.username,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            likes: 0,
                            views: 0, // Initialize views
                            style: neonColor,
                            expiryTime: expiryTime.getTime()
                        });
                        transaction.update(userRef, updateData);
                    });

                    App.UI.showMessage('create-post-message', 'Post published successfully!', 'success');
                    document.getElementById('post-content').value = '';
                    await App.Profile.fetch(App.currentUserId, true);
                    App.Posts.fetch(true); // Refresh posts after upload
                } catch (error) {
                    App.UI.showMessage('create-post-message', `Error publishing post: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Post creation error:", error);
                }
            },
            fetch: async (forceRefresh = false, targetDivId = 'posts-container', userId = null) => {
                const container = document.getElementById(targetDivId);
                const spinner = document.getElementById('loading-spinner');

                if (App.isLoadingPosts) return;
                App.isLoadingPosts = true;

                if (forceRefresh) {
                    App.lastPost = null;
                    container.innerHTML = '';
                    App.postsCache = [];
                    App.postCacheIndex = 0;
                }

                if (App.lastPost === null) {
                    spinner.classList.remove('hidden');
                }

                let query = App.db.collection('posts').orderBy('timestamp', 'desc').limit(25);
                if (App.lastPost) {
                    query = query.startAfter(App.lastPost);
                }
                if (userId) {
                    query = query.where('userId', '==', userId);
                }

                try {
                    const snapshot = await query.get();
                    let fetchedPostDocs = snapshot.docs;

                    // Filter out expired posts and delete them
                    const validPosts = [];
                    for (const doc of fetchedPostDocs) {
                        const postData = doc.data();
                        const expiry = postData.expiryTime;
                        const isExpired = expiry && expiry < Date.now();
                        
                        if (isExpired) {
                            await doc.ref.delete().catch(e => console.error("Error deleting expired post:", e));
                        } else {
                            validPosts.push(doc);
                        }
                    }

                    if (validPosts.length > 0) {
                        App.lastPost = validPosts[validPosts.length - 1];
                    } else if (snapshot.empty && App.postsCache.length > 0) {
                        // If no new posts and cache exists, loop from cache
                        console.log("No new posts, looping from cache...");
                        App.lastPost = null; // Reset to loop from beginning next time
                        App.postCacheIndex = 0; // Reset index for full loop
                    }

                    if (forceRefresh || App.postsCache.length === 0) {
                         App.postsCache = validPosts.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                         // Only add genuinely new posts to the cache
                         const newUniquePosts = validPosts.filter(doc => !App.postsCache.some(cached => cached.id === doc.id));
                         App.postsCache.push(...newUniquePosts.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                    
                    let postsToRender = [];
                    if (validPosts.length > 0) {
                        postsToRender = validPosts;
                    } else if (App.postsCache.length > 0) {
                        // If no new posts were fetched, and we have a cache, use it
                        const numToLoadFromCache = 15; // Load a batch from cache
                        const endIndex = Math.min(App.postCacheIndex + numToLoadFromCache, App.postsCache.length);
                        postsToRender = App.postsCache.slice(App.postCacheIndex, endIndex).map(p => ({ id: p.id, data: () => p }));
                        App.postCacheIndex = endIndex % App.postsCache.length; // Loop back if end reached
                        if (App.postCacheIndex === 0 && endIndex === App.postsCache.length) {
                            // Shuffling entire cache for next loop if it was fully consumed
                            App.postsCache.sort(() => Math.random() - 0.5);
                        }
                    }

                    if (postsToRender.length === 0 && App.postsCache.length === 0 && !snapshot.empty) { // Check for initial empty state
                        container.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>';
                    } else {
                        App.Posts.renderAll(postsToRender, targetDivId, userId !== null, !forceRefresh);
                    }

                } catch (error) {
                    container.innerHTML = `<p class="text-center message error">Error loading posts: ${App.Utils.getGenericErrorMessage()}</p>`;
                    console.error("Error fetching posts:", error);
                } finally {
                    spinner.classList.add('hidden');
                    App.isLoadingPosts = false;
                }
            },
            renderAll: async (postDocs, containerId, isProfileView, append = false) => {
                const container = document.getElementById(containerId);
                if (!append) container.innerHTML = '';
                
                if (postDocs.length === 0 && !append) {
                    container.innerHTML = `<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>`;
                    return;
                }
                
                let verticalPostsContainer = document.getElementById('posts-list-vertical');
                if (!verticalPostsContainer || !append) {
                    verticalPostsContainer = document.createElement('div');
                    verticalPostsContainer.id = 'posts-list-vertical';
                    verticalPostsContainer.style.display = 'grid';
                    verticalPostsContainer.style.gap = '20px';
                    if (!append) container.appendChild(verticalPostsContainer);
                }

                let currentVerticalCount = 0;
                let horizontalBatch = [];

                for (const doc of postDocs) {
                    const postId = doc.id;
                    const postData = doc.data();
                    
                    // Fetch likes, views, reactions for each post
                    const likedDoc = await App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId).get();
                    postData.hasLiked = likedDoc.exists;
                    
                    const viewsDoc = await App.db.collection('posts').doc(postId).collection('views').doc(App.currentUserId).get();
                    postData.hasViewed = viewsDoc.exists;
                    if (!postData.hasViewed && !isProfileView) { // Only count view on home feed and if not already viewed by current user
                        await App.Posts.viewPost(postId);
                        postData.views = (postData.views || 0) + 1; // Optimistically update count
                    }

                    const reactionsSnapshot = await App.db.collection('posts').doc(postId).collection('reactions').get();
                    postData.reactions = {};
                    reactionsSnapshot.forEach(reactionDoc => {
                        postData.reactions[reactionDoc.id] = reactionDoc.data().count; // Count of each emoji type
                    });
                    
                    const postElement = await App.Posts.createPostElement(postId, postData, isProfileView);

                    if (!isProfileView && !App.isDataSaver) { // Only mix horizontal posts if not in profile view and data saver is off
                        // Randomly insert horizontal section after 5-10 vertical posts
                        if (currentVerticalCount >= 5 && Math.random() > 0.5 && horizontalBatch.length < 10) {
                            horizontalBatch.push(postElement);
                            if (horizontalBatch.length >= 4 && Math.random() > 0.3) { // Trigger horizontal block more often once it has enough
                                const horizontalContainer = document.createElement('div');
                                horizontalContainer.className = 'horizontal-scroll-container';
                                horizontalBatch.forEach(el => horizontalContainer.appendChild(el));
                                container.appendChild(horizontalContainer);
                                horizontalBatch = [];
                                currentVerticalCount = 0; // Reset vertical count after a horizontal block
                            }
                        } else {
                            verticalPostsContainer.appendChild(postElement);
                            currentVerticalCount++;
                        }
                    } else {
                        verticalPostsContainer.appendChild(postElement);
                    }
                }
                
                // Append any remaining horizontal posts
                if (horizontalBatch.length > 0) {
                     const horizontalContainer = document.createElement('div');
                     horizontalContainer.className = 'horizontal-scroll-container';
                     horizontalBatch.forEach(el => horizontalContainer.appendChild(el));
                     container.appendChild(horizontalContainer);
                }
                
                // If appending, ensure the vertical container is re-appended to keep order correct
                if (append && !container.querySelector(`#posts-list-vertical`)) {
                    container.appendChild(verticalPostsContainer);
                } else if (!append && container.querySelector(`#posts-list-vertical`)) {
                     // If not appending and a container already exists, ensure it's cleared/replaced correctly
                     container.innerHTML = '';
                     container.appendChild(verticalPostsContainer);
                }
            },
            createPostElement: async (postId, postData, isProfilePost = false) => {
                const postElement = document.createElement('div');
                postElement.className = `post-card ${postData.style || ''}`;
                postElement.dataset.postId = postId;
                postElement.dataset.userId = postData.userId;
                
                const isOwner = postData.userId === App.currentUserId;

                // Long press / Double click logic
                let pressTimer;
                const touchStart = (e) => {
                    if (e.touches && e.touches.length > 1) return; // Ignore multi-touch
                    e.stopPropagation(); // Prevent scroll
                    pressTimer = setTimeout(() => {
                        App.UI.showReactionPanel(postElement, postId);
                    }, 500); // 0.5 seconds for long press
                };
                const touchEnd = () => {
                    clearTimeout(pressTimer);
                };
                const doubleClick = (e) => {
                    e.stopPropagation();
                    App.Posts.like(postId, postElement.querySelector('.like-btn'));
                };
                
                postElement.addEventListener('touchstart', touchStart);
                postElement.addEventListener('touchend', touchEnd);
                postElement.addEventListener('click', () => App.UI.activateNeonEffect(postElement));
                postElement.addEventListener('dblclick', doubleClick);

                const postHeader = document.createElement('div');
                postHeader.className = 'post-header';
                
                const postTitle = document.createElement('h3');
                postTitle.textContent = postData.username;
                postTitle.onclick = (e) => {
                    e.stopPropagation(); // Prevent long press/double click
                    App.profileToView = postData.userId;
                    App.Profile.fetch(postData.userId, isOwner);
                    App.UI.showSection(isOwner ? 'user-profile-section' : 'other-user-profile-section');
                };
                
                const actionIcons = document.createElement('div');
                actionIcons.className = 'post-actions-icons';
                
                const likeButton = document.createElement('span');
                likeButton.innerHTML = postData.hasLiked ? '‚ù§Ô∏è' : '‚ô°'; // Heart icon
                likeButton.className = `like-btn action-icon-btn ${postData.hasLiked ? 'liked' : ''}`;
                likeButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.like(postId, likeButton);
                };
                
                const soundButton = document.createElement('span');
                soundButton.innerHTML = 'üîä';
                soundButton.className = 'action-icon-btn';
                soundButton.onclick = (e) => {
                    e.stopPropagation();
                    App.UI.playPostSound(postData.content);
                };

                const translateButton = document.createElement('span');
                translateButton.innerHTML = 'üåê'; // Earth icon
                translateButton.className = 'action-icon-btn';
                translateButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.translate(postData.content);
                };

                const optionsButton = document.createElement('span');
                optionsButton.innerHTML = '‚ãÆ'; // Three dots
                optionsButton.className = 'action-icon-btn';
                optionsButton.onclick = (e) => {
                    e.stopPropagation();
                    App.UI.toggleDropdown(postId);
                };

                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = `dropdown-${postId}`;
                dropdownMenu.className = 'dropdown-menu';

                const reportButton = document.createElement('button');
                reportButton.textContent = 'Report Post';
                reportButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.report(postId);
                    App.UI.hideAllDropdowns();
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Post';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.delete(postId);
                    App.UI.hideAllDropdowns();
                };

                dropdownMenu.appendChild(reportButton);
                if (isOwner) {
                    dropdownMenu.appendChild(deleteButton);
                }
                
                actionIcons.appendChild(likeButton);
                actionIcons.appendChild(translateButton);
                actionIcons.appendChild(soundButton);
                actionIcons.appendChild(optionsButton);
                actionIcons.appendChild(dropdownMenu);
                
                postHeader.appendChild(postTitle);
                postHeader.appendChild(actionIcons);
                
                const postBody = document.createElement('p');
                postBody.innerHTML = App.Posts.formatTextWithLinks(postData.content);
                
                const postMeta = document.createElement('div');
                postMeta.className = 'post-meta';
                postMeta.innerHTML = `
                    <span>Likes: <span id="likes-count-${postId}">${App.Utils.formatNumber(postData.likes)}</span></span>
                    <span>Views: <span id="views-count-${postId}">${App.Utils.formatNumber(postData.views || 0)}</span></span>
                    <span>${postData.timestamp ? new Date(postData.timestamp.toDate()).toLocaleString() : 'N/A'}</span>
                `;

                const reactionsDisplay = document.createElement('div');
                reactionsDisplay.className = 'post-reactions-display';
                for (const emoji in postData.reactions) {
                    const count = postData.reactions[emoji];
                    if (count > 0) {
                        const reactionItem = document.createElement('span');
                        reactionItem.className = 'post-reaction-item';
                        reactionItem.innerHTML = `<span class="emoji">${emoji}</span> ${App.Utils.formatNumber(count)}`;
                        reactionsDisplay.appendChild(reactionItem);
                    }
                }
                
                postElement.appendChild(postHeader);
                postElement.appendChild(postBody);
                postElement.appendChild(postMeta);
                postElement.appendChild(reactionsDisplay);
                
                return postElement;
            },
            getRandomPostStyle: () => {
                const styles = App.neonColors;
                return styles[Math.floor(Math.random() * styles.length)];
            },
            formatTextWithLinks: (text) => {
                const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|\b\w+\.(?:com|org|net|in|co|us|gov)\b(?:\/\S*)?)/g;
                return text.replace(urlRegex, (url) => {
                    let fullUrl = url;
                    if (!url.startsWith('http')) {
                        fullUrl = `https://${url}`;
                    }
                    return `<a href="${fullUrl}" target="_blank" class="url-link">${url}</a>`;
                });
            },
            like: async (postId, likeButton) => {
                const likeRef = App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId);
                const postRef = App.db.collection('posts').doc(postId);
                
                try {
                    const doc = await likeRef.get();
                    const likesCountElement = document.getElementById(`likes-count-${postId}`);
                    
                    if (doc.exists) {
                        await likeRef.delete();
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
                        if (likesCountElement) likesCountElement.textContent = App.Utils.formatNumber(parseInt(likesCountElement.textContent) - 1);
                        likeButton.innerHTML = '‚ô°'; // White heart
                        likeButton.classList.remove('liked');
                    } else {
                        await likeRef.set({ likedAt: new Date() });
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
                        if (likesCountElement) likesCountElement.textContent = App.Utils.formatNumber(parseInt(likesCountElement.textContent) + 1);
                        likeButton.innerHTML = '‚ù§Ô∏è'; // Red heart
                        likeButton.classList.add('liked');
                    }
                } catch (error) {
                    console.error("Error liking post:", error);
                    alert(App.Utils.getGenericErrorMessage());
                }
            },
            delete: async (postId) => {
                if (confirm('Are you sure you want to delete this post?')) {
                    try {
                        const postRef = App.db.collection('posts').doc(postId);
                        await postRef.delete();
                        alert('Post deleted.');
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) postElement.remove();
                        // Also remove from cache
                        App.postsCache = App.postsCache.filter(p => p.id !== postId);
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        alert(App.Utils.getGenericErrorMessage());
                    }
                }
            },
            translate: (postContent) => {
                const encodedContent = encodeURIComponent(postContent);
                const translateUrl = `https://translate.google.com/?sl=auto&tl=hi&text=${encodedContent}`;
                window.open(translateUrl, '_blank');
            },
            report: async (postId) => {
                if (confirm('Are you sure you want to report this post for inappropriate content?')) {
                    try {
                        const reportRef = App.db.collection('posts').doc(postId).collection('reports').doc(App.currentUserId);
                        await reportRef.set({
                            reportedBy: App.currentUserId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Post reported. Thank you for your feedback.');
                    } catch (error) {
                        console.error("Error reporting post:", error);
                        alert(App.Utils.getGenericErrorMessage());
                    }
                }
            },
            viewPost: async (postId) => {
                if (!App.currentUserId) return; // Only count views for logged in users
                const viewRef = App.db.collection('posts').doc(postId).collection('views').doc(App.currentUserId);
                const postRef = App.db.collection('posts').doc(postId);

                try {
                    const viewDoc = await viewRef.get();
                    if (!viewDoc.exists) { // Only count if user hasn't viewed this post before
                        await viewRef.set({
                            viewedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await postRef.update({
                            views: firebase.firestore.FieldValue.increment(1)
                        });
                        const viewsCountElement = document.getElementById(`views-count-${postId}`);
                        if (viewsCountElement) {
                            viewsCountElement.textContent = App.Utils.formatNumber(parseInt(viewsCountElement.textContent) + 1);
                        }
                    }
                } catch (error) {
                    console.warn("Error counting view for post:", error);
                }
            },
            addReaction: async (postId, emoji) => {
                if (!App.currentUserId) {
                    alert('Please sign in to react.');
                    return;
                }
                
                const postReactionRef = App.db.collection('posts').doc(postId).collection('reactions').doc(emoji);
                const userReactionRef = App.db.collection('posts').doc(postId).collection('userReactions').doc(App.currentUserId);

                try {
                    const userHasReacted = (await userReactionRef.get()).exists;

                    if (userHasReacted) {
                        alert('You can only add one reaction per post.');
                        return;
                    }

                    await App.db.runTransaction(async (transaction) => {
                        const currentReactionDoc = await transaction.get(postReactionRef);
                        const currentCount = currentReactionDoc.exists ? currentReactionDoc.data().count : 0;
                        
                        transaction.set(postReactionRef, { count: currentCount + 1 });
                        transaction.set(userReactionRef, { emoji: emoji, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    });

                    // Optimistically update UI
                    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                    if (postElement) {
                        let reactionItem = postElement.querySelector(`.post-reaction-item .emoji[data-emoji="${emoji}"]`);
                        if (reactionItem) {
                            // Update existing count
                            const countSpan = reactionItem.nextElementSibling;
                            countSpan.textContent = App.Utils.formatNumber(parseInt(countSpan.textContent) + 1);
                        } else {
                            // Add new emoji reaction display
                            const reactionsDisplay = postElement.querySelector('.post-reactions-display');
                            if (reactionsDisplay) {
                                const newReactionItem = document.createElement('span');
                                newReactionItem.className = 'post-reaction-item';
                                newReactionItem.innerHTML = `<span class="emoji" data-emoji="${emoji}">${emoji}</span> ${App.Utils.formatNumber(1)}`;
                                reactionsDisplay.appendChild(newReactionItem);
                            }
                        }
                    }
                    alert('Reaction added!');

                } catch (error) {
                    console.error("Error adding reaction:", error);
                    alert(App.Utils.getGenericErrorMessage());
                }
            }
        };

        App.Monetization = {
            checkDailyRewards: async () => {
                if (!App.currentUserId) return;
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                
                const lastRewardDate = userData.lastRewardDate;
                const today = new Date().toDateString();
                
                if (lastRewardDate !== today) {
                    try {
                        await userRef.update({
                            coins: firebase.firestore.FieldValue.increment(10),
                            credits: firebase.firestore.FieldValue.increment(10),
                            postLimit: firebase.firestore.FieldValue.increment(1),
                            lastRewardDate: today
                        });
                        App.UI.updateHeaderStats(
                            (userData.coins || 0) + 10,
                            (userData.postLimit || 0) + 1,
                            (userData.credits || 0) + 10
                        );
                        document.getElementById('daily-reward-popup').classList.add('visible');
                    } catch (error) {
                        console.error("Error giving daily reward:", error);
                        alert(App.Utils.getGenericErrorMessage());
                    }
                }
            },
            hideDailyRewardPopup: () => {
                document.getElementById('daily-reward-popup').classList.remove('visible');
            },
            requestAd: (rewardType) => {
                alert(`Triggering ad for ${rewardType}. Once the ad is complete, you will receive the reward.`);
                // In a real app, you'd call a native function here, e.g.:
                // window.AppInventor.requestAd(rewardType);
            },
            handleAdCompletion: async (rewardType) => {
                if (!App.currentUserId) {
                    console.error("Ad callback received but user is not logged in.");
                    return;
                }
                const userRef = App.db.collection('users').doc(App.currentUserId);
                
                try {
                    let updateData = {};
                    let rewardMessage = '';

                    // This part should be more robust in a production app, ensuring server-side validation of ad completion
                    // For now, assuming ad completion is always true
                    if (rewardType === 'coins') {
                        updateData = { coins: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Coins';
                    } else if (rewardType === 'credits') {
                        updateData = { credits: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Credits';
                    } else if (rewardType === 'limits') {
                        updateData = { postLimit: firebase.firestore.FieldValue.increment(1) };
                        rewardMessage = '1 Post Limit';
                    } else if (rewardType.startsWith('boost_')) {
                        // This case is currently handled by just showing a message after successful post creation logic
                        // If ads are meant to pay for post boosts *after* initial creation, this would need a pending post ID
                        rewardMessage = `Post boost for ${rewardType.split('_')[1]} hours! (Simulated)`;
                    }
                    
                    if (Object.keys(updateData).length > 0) {
                        await userRef.update(updateData);
                        App.UI.showMessage('ad-rewards-message', `Success! You received your reward: ${rewardMessage}.`, 'success');
                    }
                    
                    App.Profile.fetch(App.currentUserId, true);
                } catch (error) {
                    App.UI.showMessage('ad-rewards-message', `Error processing reward: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Reward processing error:", error);
                }
            }
        };

        App.Messages = {
            chatRecipientId: null, // Stores the UID of the user currently chatting with
            chatRecipientName: null,
            chatListener: null, // To store the Firestore listener unsubscribe function

            startNewChat: async () => {
                const credits = App.userProfileData.credits || 0;
                if (credits < 1) {
                    alert('You do not have enough credits to send a message. Please get more credits.');
                    return;
                }
                
                App.Messages.chatRecipientId = App.profileToView;
                App.Messages.chatRecipientName = document.getElementById('other-profile-display-name').textContent;
                document.getElementById('message-recipient-name').textContent = `Chat with ${App.Messages.chatRecipientName}`;
                App.UI.showSection('message-section');
                App.Messages.loadMessages(); // Load messages when chat window opens
            },
            send: async (message) => {
                if (!App.Messages.chatRecipientId) return;
                
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userData = (await userRef.get()).data();
                
                if (userData.credits < 1) {
                    App.UI.showMessage('message-status-message', 'You do not have enough credits.', 'error');
                    return;
                }
                
                try {
                    await App.db.runTransaction(async (transaction) => {
                        const newMsgRef = App.db.collection('messages').doc();
                        transaction.set(newMsgRef, {
                            senderId: App.currentUserId,
                            senderName: App.currentUsername,
                            recipientId: App.Messages.chatRecipientId,
                            content: message,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        transaction.update(userRef, {
                            credits: firebase.firestore.FieldValue.increment(-1)
                        });
                    });
                    
                    App.UI.showMessage('message-status-message', 'Message sent successfully! 1 credit deducted.', 'success');
                    document.getElementById('message-content').value = '';
                    App.Profile.fetch(App.currentUserId, true); // Update credits in header
                } catch (error) {
                    App.UI.showMessage('message-status-message', `Error sending message: ${App.Utils.getGenericErrorMessage()}`, 'error');
                    console.error("Message send error:", error);
                }
            },
            loadMessages: () => {
                const chatWindow = document.getElementById('chat-window');
                chatWindow.innerHTML = ''; // Clear previous messages
                
                if (App.Messages.chatListener) {
                    App.Messages.chatListener(); // Unsubscribe previous listener
                }

                const twentyFourHoursAgo = new Date(Date.now() - (12 * 60 * 60 * 1000)); // 12 hours
                
                // Query for messages where current user is sender AND recipient is target
                const query1 = App.db.collection('messages')
                    .where('senderId', '==', App.currentUserId)
                    .where('recipientId', '==', App.Messages.chatRecipientId)
                    .where('timestamp', '>=', twentyFourHoursAgo)
                    .orderBy('timestamp', 'asc');
                
                // Query for messages where current user is recipient AND sender is target
                const query2 = App.db.collection('messages')
                    .where('senderId', '==', App.Messages.chatRecipientId)
                    .where('recipientId', '==', App.currentUserId)
                    .where('timestamp', '>=', twentyFourHoursAgo)
                    .orderBy('timestamp', 'asc');

                const allMessages = [];

                const processSnapshot = (snapshot) => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const msg = { id: change.doc.id, ...change.doc.data() };
                            // Only add if not already present to avoid duplicates from two queries
                            if (!allMessages.some(m => m.id === msg.id)) {
                                allMessages.push(msg);
                            }
                        }
                    });
                    // Sort all messages by timestamp
                    allMessages.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));
                    App.Messages.renderMessages(allMessages);
                };

                App.Messages.chatListener = query1.onSnapshot(processSnapshot);
                query2.onSnapshot(processSnapshot); // No need to store this listener, the combined array will manage updates
            },
            renderMessages: (messages) => {
                const chatWindow = document.getElementById('chat-window');
                chatWindow.innerHTML = ''; // Clear for re-render after sorting
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `chat-message ${msg.senderId === App.currentUserId ? 'sent' : 'received'}`;
                    messageElement.innerHTML = `
                        ${msg.content}
                        <span class="timestamp">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString() : ''}</span>
                    `;
                    chatWindow.appendChild(messageElement);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                App.Auth.signup(email, password, confirmPassword);
            });

            document.getElementById('signin-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                App.Auth.signin(email, password);
            });
            
            document.getElementById('profileUsername').addEventListener('input', (e) => {
                clearTimeout(this.checkTimer);
                this.checkTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value);
                }, 500);
            });
            document.getElementById('editUsername').addEventListener('input', (e) => {
                clearTimeout(this.checkTimer);
                this.checkTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value, true);
                }, 500);
            });

            document.getElementById('profile-setup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('profileUsername').value;
                const whatsapp = document.getElementById('profileWhatsApp').value;
                const instagram = document.getElementById('profileInstagram').value;
                App.Profile.setup(username, whatsapp, instagram);
            });
            
            document.getElementById('edit-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('editUsername').value;
                const whatsapp = document.getElementById('editWhatsApp').value;
                const instagram = document.getElementById('editInstagram').value;
                App.Profile.edit(username, whatsapp, instagram);
            });
            
            document.getElementById('create-post-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const content = document.getElementById('post-content').value;
                if (content.trim() !== '') {
                    App.Posts.create(content);
                }
            });
            
            document.getElementById('send-message-form').addEventListener('submit', (e) => {
                 e.preventDefault();
                 const message = document.getElementById('message-content').value;
                 if (message.trim() !== '') {
                     App.Messages.send(message);
                 }
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    App.UI.showSection(sectionId);
                    if (sectionId === 'home-posts') {
                        App.Posts.fetch(true);
                    } else if (sectionId === 'user-profile-section') {
                        App.Profile.fetch(App.currentUserId, true);
                    } else if (sectionId === 'search-section') {
                        document.getElementById('search-username-input').value = '';
                        document.getElementById('search-results-list').innerHTML = '';
                        App.UI.hideMessage('search-message');
                    }
                });
            });

            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('scroll', () => {
                const activeSection = document.querySelector('section.active');
                if (activeSection && activeSection.id === 'home-posts' && mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100 && !App.isLoadingPosts) {
                    App.Posts.fetch();
                }
            });
        });

        App.auth.onAuthStateChanged(async (user) => {
            if (user) {
                App.currentUserId = user.uid;
                if (user.emailVerified) {
                    App.db.collection('users').doc(App.currentUserId).get().then(doc => {
                        if (doc.exists && doc.data().username) {
                            App.UI.showSection('home-posts');
                            App.Profile.fetch(App.currentUserId, true);
                            App.Monetization.checkDailyRewards();
                            App.Posts.fetch();
                        } else {
                            App.UI.showSection('setup-profile');
                        }
                    }).catch(error => {
                        console.error("Error fetching user profile or setup required:", error);
                        App.UI.showSection('setup-profile'); // Fallback to setup if any error
                    });
                } else {
                    App.UI.showSection('email-verify');
                }
            } else {
                App.currentUserId = null;
                App.UI.showSection('signin-auth');
            }
            App.UI.hidePreloader();
        });
        
        // This function would be called from your App Inventor app after an ad completes
        window.handleAdCompletion = (rewardType) => {
            if (rewardType) {
                App.Monetization.handleAdCompletion(rewardType);
            }
        };

    </script>
</body>
</html>
