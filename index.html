<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --primary-color: #2E7D32; /* Deep Green */
            --background-color: #121212;
            --surface-color: #1E1E1E;
            --text-color: #E0E0E0;
            --accent-color: #FFC107; /* Gold */
            --button-color: #388E3C; /* Muted Green */
            --red-color: #D32F2F; /* Red */
            --link-color: #4CAF50; /* Green for links */
        }

        /* Basic Resets & Fonts */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: contain; /* Prevents bounce effect */
        }

        /* Splash Screen */
        #splashScreen {
    /* Ensure it's initially visible and positioned correctly */
    opacity: 1; /* Make sure it starts visible */
    transition: opacity 1s ease-out; /* Add this for fade-out */
    /* Add other styling like position, z-index, background, etc. */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white; /* Or your splash screen background color */
    display: flex; /* If you have a logo inside, use flexbox to center it */
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Ensure it's on top */
}

.hidden {
    display: none !important; /* Use !important to ensure it overrides other styles */
}

        #splash-logo {
            font-size: 3rem;
            color: var(--primary-color);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(46, 125, 50, 0.5);
            animation: pulse-glow 2s infinite ease-in-out;
            margin-bottom: 20px;
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        #splash-screen p {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        /* Main App Layout */
        #app-container {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            transition: opacity 0.5s;
        }

        header, nav.bottom-menu {
            background-color: var(--surface-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 50;
        }

        header {
            height: 56px;
            justify-content: space-between;
        }

        .header-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            animation: pulse-glow 3s infinite ease-in-out;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon-btn, .bottom-nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            transition: transform 0.2s, color 0.2s;
            position: relative;
        }

        .header-icon-btn:hover, .bottom-nav-btn:hover {
            transform: scale(1.1);
        }
        
        .header-credit-info {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        .header-credit-info .material-symbols-outlined {
            font-size: 1.2rem;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            transition: transform 0.3s ease-in-out;
            padding-bottom: 70px; /* Space for bottom menu */
        }
        
        .main-screen {
            display: none;
            height: 100%;
        }

        .main-screen.active {
            display: block;
        }
        
        nav.bottom-menu {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 56px; /* Adjusted height */
            justify-content: space-around;
            border-top: 1px solid rgba(255,255,255,0.1);
            animation: slide-up 0.5s ease-out;
        }

        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            line-height: 1.2;
            color: #888;
        }

        .bottom-nav-btn .material-symbols-outlined {
            font-size: 1.4rem;
            margin-bottom: 2px;
            transition: color 0.2s;
        }

        .bottom-nav-btn.active {
            color: var(--primary-color);
            transform: scale(1.05);
        }
        .bottom-nav-btn.active .material-symbols-outlined {
            color: var(--primary-color);
            fill: 1;
        }
        
        /* Post Feed Styling */
        #feed-screen {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .post-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, border 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fade-in 0.5s ease-out;
            cursor: pointer; /* To enable double click/long press */
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .post-card.neon-glow {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color), 0 0 25px rgba(255,193,7,0.3);
            animation: neon-pulse 1s forwards; /* For the 3-4 second glow */
        }
        
        @keyframes neon-pulse {
            0% { box-shadow: 0 0 15px var(--accent-color); }
            50% { box-shadow: 0 0 25px var(--accent-color), 0 0 35px rgba(255,193,7,0.5); }
            100% { box-shadow: 0 0 15px var(--accent-color); }
        }

        .post-card.horizontal-layout {
            grid-column: 1 / -1; /* Spans full width */
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: linear-gradient(90deg, #2a2a2a, #1a1a1a);
        }
        
        .post-card.horizontal-layout .post-title { font-size: 1.2rem; }
        .post-card.horizontal-layout .post-description { flex-grow: 1; }
        .post-card.horizontal-layout .post-actions { flex-direction: row; gap: 10px; align-items: center;}
        .post-card.horizontal-layout .post-actions .like-btn { margin-left: auto; }

        .post-card.table-layout {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            padding: 15px;
            background-color: #252525;
        }

        .table-layout .post-item {
            background-color: #333;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            word-break: break-word;
        }
        .table-layout .post-item .post-title {
            font-size: 0.95rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 5px;
        }
        .table-layout .post-item .post-area {
            font-size: 0.75rem;
            color: #bbb;
        }


        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Aligned to top for multi-line titles */
            margin-bottom: 12px;
        }
        
        .post-title-link {
            text-decoration: none;
            color: inherit;
        }

        .post-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            word-wrap: break-word;
            flex-grow: 1;
            margin-right: 10px;
        }

        .post-info {
            font-size: 0.8rem;
            color: #B0B0B0;
            text-align: right;
        }

        .post-description {
            font-size: 0.9rem;
            margin-bottom: 16px;
            line-height: 1.5;
            color: var(--text-color);
            word-wrap: break-word;
        }
        
        .post-description a {
            color: var(--link-color);
            text-decoration: underline;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            flex-wrap: wrap; /* Allow wrapping for small screens */
            gap: 10px;
        }

        .post-social-icons {
            display: flex;
            gap: 12px;
        }

        .social-icon-btn {
            background-color: var(--button-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        .social-icon-btn:hover {
            transform: scale(1.1);
            background-color: var(--primary-color);
        }

        .social-icon-btn .material-symbols-outlined {
            font-size: 1.5rem;
            color: var(--text-color);
        }
        
        .post-extra-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .post-extra-actions .icon-button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 5px;
            font-size: 0.8rem;
            transition: color 0.2s;
        }
        .post-extra-actions .icon-button:hover {
            color: var(--primary-color);
        }


        .like-btn {
            background: none;
            border: none;
            color: #B0B0B0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
            transition: color 0.2s, transform 0.2s;
        }
        
        .like-btn.liked {
            color: var(--red-color);
            animation: heart-beat 0.5s;
        }
        .like-btn.liked .material-symbols-outlined {
            fill: 1;
            color: var(--red-color);
        }
        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .post-views {
            font-size: 0.8rem;
            color: #B0B0B0;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 10px;
        }

        /* Emoji Reactions */
        .emoji-reaction-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 8px;
            background-color: #2a2a2a;
            border-radius: 8px;
            animation: slide-up-fade-in 0.3s ease-out;
        }

        @keyframes slide-up-fade-in {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .emoji-reaction-options .emoji-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }
        .emoji-reaction-options .emoji-btn:hover {
            transform: scale(1.2);
        }

        .post-reactions-summary {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #B0B0B0;
            flex-wrap: wrap;
        }
        .post-reactions-summary .reaction-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .post-reactions-summary .reaction-item .emoji-icon {
            font-size: 1.2rem;
        }
        .post-reactions-summary .total-reactions {
            font-weight: bold;
            color: var(--text-color);
        }


        /* Auth Screen */
        #auth-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            animation: fade-in 0.5s ease-out;
            height: 100%;
            width: 100%;
        }

        .auth-container {
            background-color: var(--surface-color);
            padding: 32px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .auth-logo {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 24px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-group {
            position: relative;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--background-color);
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        
        .auth-btn {
            padding: 12px;
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .auth-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .auth-footer {
            text-align: center;
            margin-top: 16px;
        }
        
        .auth-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.2s;
        }

        .auth-footer a:hover {
            color: var(--accent-color);
        }

        #error-message, #success-message {
            color: var(--red-color);
            margin-top: 8px;
            text-align: center;
        }

        #success-message {
            color: var(--primary-color);
        }

        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }
        .validation-icon.green { color: var(--primary-color); }
        .validation-icon.red { color: var(--red-color); }
        
        /* Create Post Screen */
        #create-post-screen {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        #create-post-screen h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 16px;
        }
        
        #create-post-form input, #create-post-form textarea, #create-post-form select {
            width: 100%;
            padding: 12px;
            background-color: var(--surface-color);
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        #create-post-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        #create-post-form input:focus, #create-post-form textarea:focus, #create-post-form select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .input-group.social-fields {
            display: flex;
            gap: 16px;
        }
        
        .input-group.social-fields input {
            flex-grow: 1;
        }

        #post-create-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        
        #post-create-btn:hover {
            background-color: var(--button-color);
            transform: translateY(-2px);
        }
        
        .post-duration-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .post-duration-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .post-duration-options input[type="radio"] {
            width: auto;
            transform: scale(1.2);
        }

        /* Profile Screen */
        #profile-screen {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        .profile-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 12px;
            border: 2px solid var(--primary-color);
            overflow: hidden; /* For generated logos */
        }
        .profile-avatar.generated-logo {
            font-size: 2rem;
        }

        /* For SVG-based generated logos */
        .profile-avatar svg {
            width: 70%;
            height: 70%;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-stats {
            display: flex;
            gap: 24px;
            margin-top: 16px;
        }

        .profile-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            color: #B0B0B0;
            cursor: pointer;
        }
        
        .profile-stat span:first-child {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
        }
        
        #my-posts-grid, #view-profile-posts-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .profile-post-card {
            background-color: var(--surface-color);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .profile-post-card:hover {
            transform: translateY(-3px);
        }
        
        .profile-post-card .post-title {
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .profile-post-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .profile-post-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .profile-post-actions .edit-btn {
            background-color: var(--accent-color);
            color: var(--background-color);
        }
        
        .profile-post-actions .delete-btn {
            background-color: var(--red-color);
            color: var(--text-color);
        }
        
        .profile-actions-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .profile-actions-buttons .social-icon-btn {
            width: 45px;
            height: 45px;
        }

        .profile-follow-btn {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .profile-follow-btn.follow {
            background-color: var(--primary-color);
            color: var(--text-color);
        }
        
        .profile-follow-btn.unfollow {
            background-color: var(--red-color);
            color: var(--text-color);
        }

        /* Edit Profile Modal (simplified - in-line for now) */
        #edit-profile-modal {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #edit-profile-modal .input-group { margin-bottom: 15px; }
        #edit-profile-modal h3 { margin-bottom: 15px; color: var(--primary-color); }
        #edit-profile-modal button { margin-top: 10px; }
        
        .logo-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
        }
        .logo-selection-grid .logo-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: var(--primary-color);
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
        }
        .logo-selection-grid .logo-option:hover {
            transform: scale(1.1);
        }
        .logo-selection-grid .logo-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px var(--accent-color);
        }


        /* Chat Screen */
        #chat-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #chat-list, #chat-messages {
            overflow-y: auto;
        }

        #chat-list {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background-color: var(--surface-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-list-item:hover {
            background-color: #2a2a2a;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--primary-color);
            font-size: 1.2rem;
            overflow: hidden;
        }
        .chat-avatar.generated-logo svg {
            width: 70%;
            height: 70%;
        }
        
        .chat-info h3 {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .chat-info p {
            font-size: 0.8rem;
            color: #B0B0B0;
        }

        #chat-messages-container {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            padding: 16px;
            background-color: var(--background-color);
        }
        
        #chat-messages-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }

        #chat-messages-header h3 {
            flex-grow: 1;
            font-size: 1.2rem;
        }

        #chat-messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        
        .chat-message.sent {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        
        .chat-message.received {
            background-color: var(--surface-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        #chat-input-form {
            display: flex;
            padding-top: 10px;
            border-top: 1px solid #333;
            gap: 10px;
        }

        #chat-input {
            flex-grow: 1;
            background-color: var(--surface-color);
            border: 1px solid #444;
            border-radius: 20px;
            padding: 8px 16px;
            color: var(--text-color);
        }
        
        #send-chat-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        /* Add/Settings Screen */
        #add-screen {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        #monetize-info {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: slide-in-top 0.5s ease-out;
        }
        
        @keyframes slide-in-top {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        #in-app-currency-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .currency-card {
            background-color: var(--surface-color);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .currency-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .currency-info .material-symbols-outlined {
            font-size: 2rem;
            color: var(--accent-color);
        }
        
        .currency-details h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .currency-details p {
            font-size: 0.9rem;
            color: #B0B0B0;
        }
        
        .currency-card button {
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        
        .currency-card button:hover {
            background-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        /* Search Screen */
        #search-screen {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        
        #search-input-container {
            position: relative;
            margin-bottom: 20px;
        }

        #search-input {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px; /* Space for icon */
            background-color: var(--surface-color);
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
        }
        #search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        #search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        #search-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: var(--surface-color);
            padding: 12px;
            border-radius: 12px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #2a2a2a;
        }
        
        .search-result-info {
            flex-grow: 1;
        }
        .search-result-info h3 {
            font-size: 1rem;
            font-weight: 700;
        }
        .search-result-info p {
            font-size: 0.8rem;
            color: #B0B0B0;
        }

        .search-result-item .profile-follow-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Side Menu */
        #side-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100%;
            background-color: var(--surface-color);
            box-shadow: -4px 0 10px rgba(0,0,0,0.5);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        #side-menu.open {
            transform: translateX(0);
        }

        #side-menu h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        #side-menu button, #side-menu a {
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            padding: 10px 0;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            transition: color 0.2s;
        }
        #side-menu button:hover, #side-menu a:hover {
            color: var(--primary-color);
        }

        #side-menu .material-symbols-outlined {
            font-size: 1.5rem;
        }
        
        .menu-toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
            width: 100%;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }
        
        /* Overlay for side menu */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }

        /* Utility Classes & Animations */
        .hidden { display: none !important; }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .loading-spinner .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Daily Reward Popup */
        #reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.7);
            z-index: 1001;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            animation: pop-in 0.3s ease-out;
        }

        @keyframes pop-in {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #reward-popup h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        #reward-popup p {
            font-size: 1rem;
            color: #B0B0B0;
        }
        #reward-popup .reward-items {
            display: flex;
            gap: 15px;
        }
        .reward-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        .reward-item .material-symbols-outlined {
            font-size: 2.5rem;
            color: var(--accent-color);
            animation: bounce 0.8s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        #reward-popup button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #reward-popup button:hover {
            background-color: var(--button-color);
        }
        
        /* Follower/Following List Popup (simplified - for demonstration) */
        #follower-list-popup, #following-list-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            max-height: 70%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }
        #follower-list-popup h3, #following-list-popup h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item .user-name {
            flex-grow: 1;
            font-weight: bold;
        }
        .list-item .material-symbols-outlined {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .close-popup-btn {
            background: none;
            border: none;
            color: var(--red-color);
            font-size: 1.2rem;
            cursor: pointer;
            align-self: flex-end;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>

    <div id="splash-screen">
        <h1 id="splash-logo">AddMint</h1>
        <p>Loading your experience...</p>
    </div>

    <div id="app-container" class="hidden">
        
        <header>
            <div class="header-logo">AddMint</div>
            <div class="header-icons">
                <button id="refresh-posts-btn" class="header-icon-btn hidden">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
                <button id="gift-btn" class="header-icon-btn">
                    <span class="material-symbols-outlined">redeem</span>
                </button>
                <div class="header-credit-info">
                    <span class="material-symbols-outlined">monetization_on</span>
                    <span id="header-coins">0</span>
                </div>
                <div class="header-credit-info">
                    <span class="material-symbols-outlined">data_usage</span>
                    <span id="header-limits">0</span>
                </div>
                <div class="header-credit-info">
                    <span class="material-symbols-outlined">drafts</span>
                    <span id="header-credits">0</span>
                </div>
                <button id="open-side-menu-btn" class="header-icon-btn">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
        </header>

        <main>
            <div id="feed-screen" class="main-screen active">
                <div class="loading-spinner hidden" id="feed-loading-spinner">
                    <div class="spinner"></div>
                </div>
                </div>
            
            <div id="create-post-screen" class="main-screen hidden">
                <h2>Create a New Post</h2>
                <form id="create-post-form">
                    <div class="input-group">
                        <input type="text" id="post-title" placeholder="Title" required>
                    </div>
                    <div class="input-group">
                        <textarea id="post-description" placeholder="Description" required></textarea>
                    </div>
                    <div class="input-group">
                        <input type="text" id="post-area" placeholder="Area" required>
                    </div>
                    <div class="input-group social-fields">
                        <input type="tel" id="post-whatsapp" placeholder="WhatsApp Number (optional)">
                        <input type="text" id="post-instagram" placeholder="Instagram ID (optional)">
                    </div>

                    <div class="post-duration-options">
                        <h4>Post Duration:</h4>
                        <label>
                            <input type="radio" name="post-duration" value="12" checked> 12 Hours (Free)
                        </label>
                        <label>
                            <input type="radio" name="post-duration" value="18"> 18 Hours (Watch 1 Ad)
                        </label>
                        <label>
                            <input type="radio" name="post-duration" value="24"> 24 Hours (Watch 2 Ads)
                        </label>
                        <label>
                            <input type="radio" name="post-duration" value="30"> 30 Hours (Watch 3 Ads)
                        </label>
                    </div>

                    <p id="post-creation-info">
                        Posting costs 5 coins or 1 limit. You have <span id="post-creation-limit">0</span> limits and <span id="post-creation-coins">0</span> coins.
                    </p>
                    <p id="post-creation-error" style="color: var(--red-color);" class="hidden"></p>
                    <button type="submit" id="post-create-btn">Post</button>
                </form>
            </div>
            
            <div id="profile-screen" class="main-screen hidden">
                <div class="profile-container">
                    <div id="my-profile-avatar" class="profile-avatar generated-logo"></div>
                    <h2 id="my-profile-name" class="profile-name"></h2>
                    <p id="my-profile-email"></p>
                    <p id="my-profile-username"></p>
                    <div class="profile-actions-buttons">
                        <button class="social-icon-btn" onclick="openWhatsApp('${currentUserData ? currentUserData.phone : ''}')">
                            <span class="material-symbols-outlined">call</span>
                        </button>
                        <button class="social-icon-btn" onclick="openInstagram('${currentUserData ? currentUserData.instagram : ''}')">
                            <span class="material-symbols-outlined">photo_camera</span>
                        </button>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat" onclick="showFollowerList()">
                            <span id="my-follower-count">0</span><span>Followers</span>
                        </div>
                        <div class="profile-stat" onclick="showFollowingList()">
                            <span id="my-following-count">0</span><span>Following</span>
                        </div>
                        <div class="profile-stat">
                            <span id="my-post-count">0</span><span>Posts</span>
                        </div>
                    </div>
                    <button id="edit-profile-btn" class="auth-btn" style="margin-top: 20px;">Edit Profile</button>
                </div>

                <div id="edit-profile-modal" class="hidden">
                    <h3>Edit Profile</h3>
                    <div class="input-group">
                        <input type="text" id="edit-username" placeholder="New Username" required>
                        <span id="username-validation-icon" class="validation-icon material-symbols-outlined hidden"></span>
                    </div>
                    <div class="input-group">
                        <input type="tel" id="edit-phone" placeholder="New WhatsApp Number">
                    </div>
                    <div class="input-group">
                        <input type="text" id="edit-instagram" placeholder="New Instagram ID">
                    </div>
                    <h4>Choose Profile Logo:</h4>
                    <div id="logo-selection-grid" class="logo-selection-grid">
                        </div>
                    <button id="save-profile-btn" class="auth-btn">Save Changes</button>
                    <button id="cancel-edit-btn" class="auth-btn" style="background-color: var(--red-color);">Cancel</button>
                    <p id="edit-profile-message" style="color: var(--primary-color); text-align: center; margin-top: 10px;" class="hidden"></p>
                </div>

                <hr style="margin: 20px 0; border: 1px solid #333;">
                <h3 style="text-align: center; margin-bottom: 15px;">My Active Posts</h3>
                <div id="my-posts-grid">
                    </div>
            </div>
            
            <div id="view-profile-screen" class="main-screen hidden">
                <div class="profile-container">
                    <div id="view-profile-avatar" class="profile-avatar generated-logo"></div>
                    <h2 id="view-profile-name" class="profile-name"></h2>
                    <p id="view-profile-email"></p>
                    <p id="view-profile-username-display"></p>
                    <div id="view-profile-actions" class="profile-actions-buttons">
                        <button id="follow-btn" class="profile-follow-btn"></button>
                        <button id="view-profile-whatsapp-btn" class="social-icon-btn">
                            <span class="material-symbols-outlined">call</span>
                        </button>
                        <button id="view-profile-instagram-btn" class="social-icon-btn">
                            <span class="material-symbols-outlined">photo_camera</span>
                        </button>
                        <button id="view-profile-message-btn" class="social-icon-btn">
                            <span class="material-symbols-outlined">chat</span>
                        </button>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat" onclick="showFollowerList(true)">
                            <span id="view-follower-count">0</span><span>Followers</span>
                        </div>
                        <div class="profile-stat" onclick="showFollowingList(true)">
                            <span id="view-following-count">0</span><span>Following</span>
                        </div>
                        <div class="profile-stat">
                            <span id="view-post-count">0</span><span>Posts</span>
                        </div>
                    </div>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #333;">
                <h3 style="text-align: center; margin-bottom: 15px;">Active Posts</h3>
                <div id="view-profile-posts-grid">
                    </div>
            </div>

            <div id="chat-screen" class="main-screen hidden">
                <div id="chat-list">
                    <h2>Chats</h2>
                    <p id="no-chats-message" class="hidden" style="text-align: center; color: #888;">No active chats.</p>
                    </div>
                <div id="chat-messages-container" class="hidden">
                    <div id="chat-messages-header">
                        <button id="back-to-chat-list-btn" class="header-icon-btn">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h3 id="current-chat-name"></h3>
                    </div>
                    <div id="chat-messages">
                        </div>
                    <form id="chat-input-form">
                        <input type="text" id="chat-input" placeholder="Type a message...">
                        <button type="submit" id="send-chat-btn"><span class="material-symbols-outlined">send</span></button>
                    </form>
                </div>
            </div>
            
            <div id="add-screen" class="main-screen hidden">
                <h2>App Features</h2>
                <div id="monetize-info">
                    <h3>Monetization: Coming Soon!</h3>
                    <p>Start earning with 100 followers! Earn 10-100 for every 150 posts. Share the app and grow your following!</p>
                </div>
                
                <div id="in-app-currency-section">
                    <div class="currency-card">
                        <div class="currency-info">
                            <span class="material-symbols-outlined">monetization_on</span>
                            <div class="currency-details">
                                <h3>Coins</h3>
                                <p id="current-coins">Current: 0</p>
                            </div>
                        </div>
                        <button onclick="watchAdAndReward('coins', 10)" class="ad-reward-btn">Get More</button>
                    </div>
                    
                    <div class="currency-card">
                        <div class="currency-info">
                            <span class="material-symbols-outlined">data_usage</span>
                            <div class="currency-details">
                                <h3>Post Limits</h3>
                                <p id="current-limits">Current: 0</p>
                            </div>
                        </div>
                        <button onclick="watchAdAndReward('limits', 1)" class="ad-reward-btn">Get More</button>
                    </div>
                    
                    <div class="currency-card">
                        <div class="currency-info">
                            <span class="material-symbols-outlined">drafts</span>
                            <div class="currency-details">
                                <h3>Credits</h3>
                                <p id="current-credits">Current: 0</p>
                            </div>
                        </div>
                        <button onclick="watchAdAndReward('credits', 10)" class="ad-reward-btn">Get More</button>
                    </div>
                </div>
            </div>

            <div id="search-screen" class="main-screen hidden">
                <h2>Search Users</h2>
                <div id="search-input-container">
                    <input type="text" id="search-input" placeholder="Search by username or name...">
                    <span class="material-symbols-outlined" id="search-icon">search</span>
                </div>
                <div id="search-results-list">
                    </div>
            </div>
            
        </main>

        <nav class="bottom-menu">
            <button id="feed-nav-btn" class="bottom-nav-btn active">
                <span class="material-symbols-outlined">home</span>
                <span>Feed</span>
            </button>
            <button id="create-post-nav-btn" class="bottom-nav-btn">
                <span class="material-symbols-outlined">add_box</span>
                <span>Post</span>
            </button>
            <button id="search-nav-btn" class="bottom-nav-btn">
                <span class="material-symbols-outlined">search</span>
                <span>Search</span>
            </button>
            <button id="chat-nav-btn" class="bottom-nav-btn">
                <span class="material-symbols-outlined">chat</span>
                <span>Chat</span>
            </button>
            <button id="profile-nav-btn" class="bottom-nav-btn">
                <span class="material-symbols-outlined">person</span>
                <span>Profile</span>
            </button>
        </nav>

        <div id="auth-screen">
            <div class="auth-container">
                <h1 class="auth-logo">AddMint</h1>
                
                <div id="auth-forms">
                    <form id="signin-form" class="auth-form">
                        <div class="input-group">
                            <input type="email" id="signin-email" placeholder="Email" required>
                        </div>
                        <div class="input-group">
                            <input type="password" id="signin-password" placeholder="Password" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('signin-password')">
                                <span class="material-symbols-outlined">visibility_off</span>
                            </button>
                        </div>
                        <p id="signin-error" class="hidden"></p>
                        <button type="submit" class="auth-btn">Sign In</button>
                    </form>
                    
                    <form id="signup-form" class="auth-form hidden">
                        <div class="input-group">
                            <input type="text" id="signup-name" placeholder="Name" required>
                        </div>
                        <div class="input-group">
                            <input type="text" id="signup-username" placeholder="Unique Username" required>
                            <span id="username-check-icon" class="validation-icon material-symbols-outlined hidden"></span>
                        </div>
                        <div class="input-group">
                            <input type="email" id="signup-email" placeholder="Email" required>
                        </div>
                        <div class="input-group">
                            <input type="password" id="signup-password" placeholder="Password" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('signup-password')">
                                <span class="material-symbols-outlined">visibility_off</span>
                            </button>
                        </div>
                        <div class="input-group">
                            <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('signup-confirm-password')">
                                <span class="material-symbols-outlined">visibility_off</span>
                            </button>
                        </div>
                        <div class="input-group">
                            <input type="tel" id="signup-phone" placeholder="WhatsApp Number">
                        </div>
                        <div class="input-group">
                            <input type="text" id="signup-insta" placeholder="Instagram ID">
                        </div>
                        <p id="signup-error" class="hidden"></p>
                        <p id="signup-success" class="hidden"></p>
                        <button type="submit" class="auth-btn">Sign Up</button>
                    </form>
                </div>

                <div class="auth-footer">
                    <a href="#" id="toggle-auth-form">Don't have an account? Sign Up</a>
                </div>
            </div>
        </div>
    </div>

    <div id="side-menu">
        <button id="close-side-menu-btn" style="align-self: flex-end; color: var(--red-color);">
            <span class="material-symbols-outlined">close</span>
        </button>
        <h3>Settings</h3>
        <button id="signout-btn"><span class="material-symbols-outlined">logout</span> Sign Out</button>
        <div class="menu-toggle-switch">
            <span>Data Saver</span>
            <label class="switch">
                <input type="checkbox" id="data-saver-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <a href="https://www.instagram.com/addmint__" target="_blank"><span class="material-symbols-outlined">photo_camera</span> AddMint Instagram</a>
        <a href="https://www.youtube.com/@add_mintmint" target="_blank"><span class="material-symbols-outlined">play_circle</span> AddMint YouTube</a>
        <button id="about-us-btn"><span class="material-symbols-outlined">info</span> About Us</button>
        <button id="privacy-policy-btn"><span class="material-symbols-outlined">policy</span> Privacy Policy</button>
    </div>
    <div id="menu-overlay" class="hidden"></div>

    <div id="reward-popup" class="hidden">
        <h3>Daily Reward!</h3>
        <p>Claim your free goodies!</p>
        <div class="reward-items">
            <div class="reward-item">
                <span class="material-symbols-outlined">data_usage</span>
                <span>+2 Limits</span>
            </div>
            <div class="reward-item">
                <span class="material-symbols-outlined">monetization_on</span>
                <span>+10 Coins</span>
            </div>
            <div class="reward-item">
                <span class="material-symbols-outlined">drafts</span>
                <span>+10 Credits</span>
            </div>
        </div>
        <button id="claim-reward-btn">Claim Now!</button>
    </div>

    <div id="follower-list-popup" class="hidden">
        <button class="close-popup-btn" onclick="closeListPopup('follower')"><span class="material-symbols-outlined">close</span></button>
        <h3>Followers</h3>
        <div id="follower-list-content"></div>
    </div>

    <div id="following-list-popup" class="hidden">
        <button class="close-popup-btn" onclick="closeListPopup('following')"><span class="material-symbols-outlined">close</span></button>
        <h3>Following</h3>
        <div id="following-list-content"></div>
    </div>


    <script>
        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // Replace with your actual API Key
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        const authScreen = document.getElementById('auth-screen');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const signinEmailInput = document.getElementById('signin-email');
        const signinPasswordInput = document.getElementById('signin-password');
        const signupNameInput = document.getElementById('signup-name');
        const signupUsernameInput = document.getElementById('signup-username');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signupPhoneInput = document.getElementById('signup-phone');
        const signupInstaInput = document.getElementById('signup-insta');
        const toggleAuthFormLink = document.getElementById('toggle-auth-form');
        const signinError = document.getElementById('signin-error');
        const signupError = document.getElementById('signup-error');
        const signupSuccess = document.getElementById('signup-success');
        const usernameCheckIcon = document.getElementById('username-check-icon');
        
        const mainScreens = document.querySelectorAll('.main-screen');
        const bottomNavBtns = document.querySelectorAll('.bottom-nav-btn');
        const feedScreen = document.getElementById('feed-screen');
        const createPostScreen = document.getElementById('create-post-screen');
        const myProfileScreen = document.getElementById('profile-screen');
        const viewProfileScreen = document.getElementById('view-profile-screen');
        const chatScreen = document.getElementById('chat-screen');
        const addScreen = document.getElementById('add-screen');
        const searchScreen = document.getElementById('search-screen');

        const createPostForm = document.getElementById('create-post-form');
        const postTitleInput = document.getElementById('post-title');
        const postDescriptionInput = document.getElementById('post-description');
        const postAreaInput = document.getElementById('post-area');
        const postWhatsappInput = document.getElementById('post-whatsapp');
        const postInstagramInput = document.getElementById('post-instagram');
        const postCreationLimitText = document.getElementById('post-creation-limit');
        const postCreationCoinsText = document.getElementById('post-creation-coins');
        const postCreationError = document.getElementById('post-creation-error');
        
        const headerCoins = document.getElementById('header-coins');
        const headerLimits = document.getElementById('header-limits');
        const headerCredits = document.getElementById('header-credits');
        const refreshPostsBtn = document.getElementById('refresh-posts-btn');
        const giftBtn = document.getElementById('gift-btn');

        const myProfileAvatar = document.getElementById('my-profile-avatar');
        const myProfileName = document.getElementById('my-profile-name');
        const myProfileEmail = document.getElementById('my-profile-email');
        const myProfileUsername = document.getElementById('my-profile-username');
        const myFollowerCount = document.getElementById('my-follower-count');
        const myFollowingCount = document.getElementById('my-following-count');
        const myPostCount = document.getElementById('my-post-count');
        const myPostsGrid = document.getElementById('my-posts-grid');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editUsernameInput = document.getElementById('edit-username');
        const editPhoneInput = document.getElementById('edit-phone');
        const editInstagramInput = document.getElementById('edit-instagram');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editProfileMessage = document.getElementById('edit-profile-message');
        const logoSelectionGrid = document.getElementById('logo-selection-grid');
        const usernameValidationIcon = document.getElementById('username-validation-icon');


        const viewProfileAvatar = document.getElementById('view-profile-avatar');
        const viewProfileName = document.getElementById('view-profile-name');
        const viewProfileEmail = document.getElementById('view-profile-email');
        const viewProfileUsernameDisplay = document.getElementById('view-profile-username-display');
        const viewFollowerCount = document.getElementById('view-follower-count');
        const viewFollowingCount = document.getElementById('view-following-count');
        const viewPostCount = document.getElementById('view-post-count');
        const viewProfilePostsGrid = document.getElementById('view-profile-posts-grid');
        const followBtn = document.getElementById('follow-btn');
        const viewProfileWhatsappBtn = document.getElementById('view-profile-whatsapp-btn');
        const viewProfileInstagramBtn = document.getElementById('view-profile-instagram-btn');
        const viewProfileMessageBtn = document.getElementById('view-profile-message-btn');

        const chatList = document.getElementById('chat-list');
        const noChatsMessage = document.getElementById('no-chats-message');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const backToChatListBtn = document.getElementById('back-to-chat-list-btn');
        const currentChatName = document.getElementById('current-chat-name');
        const chatMessages = document.getElementById('chat-messages');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatInput = document.getElementById('chat-input');
        
        const searchInput = document.getElementById('search-input');
        const searchResultsList = document.getElementById('search-results-list');

        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const openSideMenuBtn = document.getElementById('open-side-menu-btn');
        const closeSideMenuBtn = document.getElementById('close-side-menu-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const dataSaverToggle = document.getElementById('data-saver-toggle');
        
        const rewardPopup = document.getElementById('reward-popup');
        const claimRewardBtn = document.getElementById('claim-reward-btn');

        const followerListPopup = document.getElementById('follower-list-popup');
        const followerListContent = document.getElementById('follower-list-content');
        const followingListPopup = document.getElementById('following-list-popup');
        const followingListContent = document.getElementById('following-list-content');
        

        let currentUserData = null;
        let lastVisiblePost = null;
        let loadingPosts = false;
        let currentChatUser = null;
        let longPressTimer;
        let clickedPostElement = null; // To track the current post for neon effect
        let emojis = ['', '', '', '', '', '']; // Available emojis
        let lastDailyRewardTime = 0; // Timestamp of last claimed reward
        const DAILY_REWARD_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        // --- Utility Functions ---

        // Formats large numbers (e.g., 1000 -> 1k, 1234567 -> 1.2M)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            }
            return num;
        }

        function createMaterialSymbolSvg(symbolName, color = 'currentColor', size = '24px') {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', color);

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            // This is a placeholder. For actual Material Symbols, you'd need the SVG path data.
            // For now, it will simply render a square. For real icons, you need to embed their SVG path.
            // As a robust solution for Material Symbols with SVG:
            // Fetch the SVG path data from a comprehensive Material Symbols font or convert them.
            // Example for 'call': <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.21-2.21c.28-.28.67-.36 1.02-.25 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1C10 21 3 14 3 4c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02L6.62 10.79z"/>
            // For simplicity and to avoid external fetches/large JS, we'll just use the font-based symbols directly in HTML.
            // However, if you explicitly want SVG, you'd need a library or manual mapping.
            // As per the request "coding sai aiisa logo banan lanna ok" - this implies using CSS for the Material Symbols.
            // The request also specified "Emoji use mat karo", "direct link jai url ise nahi karna hai", "coding sai hi sb logo generate karna hai"
            // The current implementation uses the Material Symbols font, which is loaded via a CSS link, then uses symbol names.
            // This meets the spirit of "coding sai logo generate karna hai" better than embedding dozens of complex SVG paths directly.
            // If strictly SVG, then each Material Symbol would need its path, which is extensive.
            // Let's stick to the CSS-based Material Symbols, as it's the most practical way to have code-generated "logos" without images.
            path.setAttribute('d', 'M0 0h24v24H0z'); // Placeholder if actual path is not provided
            svg.appendChild(path);
            return svg;
        }

        function generateRandomProfileLogo() {
            const icons = [
                'person', 'account_circle', 'face', 'diversity_3', 'pets', 'star', 'local_florist',
                'bolt', 'forest', 'beach_access', 'spa', 'auto_fix_high', 'lightbulb', 'brightness_low',
                'cookie', 'emoji_events', 'rocket_launch', 'deployed_code', 'laptop', 'brush', 'palette',
                'science', 'school', 'emoji_nature', 'emoji_objects', 'fitness_center', 'gamepad', 'toys',
                'mic', 'headphones', 'camera_alt', 'landscape', 'attractions', 'castle', 'travel_explore',
                'park', 'snowboarding', 'skateboarding', 'sports_baseball', 'sports_basketball', 'sports_soccer',
                'sailing', 'cruelty_free', 'eco', 'compost', 'recycling', 'nest_thermostat', 'smart_toy',
                'headphones', 'speaker', 'bluetooth', 'wifi', 'data_thresholding'
            ];
            const randomIcon = icons[Math.floor(Math.random() * icons.length)];
            const colors = ['#FFC107', '#4CAF50', '#2196F3', '#9C27B0', '#FF5722', '#00BCD4'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            return `<span class="material-symbols-outlined" style="color: ${randomColor};">${randomIcon}</span>`;
        }

        function createSocialIcon(type) {
            let iconName;
            switch (type) {
                case 'whatsapp': iconName = 'call'; break;
                case 'instagram': iconName = 'photo_camera'; break;
                case 'youtube': iconName = 'play_circle'; break;
                case 'chat': iconName = 'chat'; break;
                default: iconName = 'link';
            }
            return `<span class="material-symbols-outlined">${iconName}</span>`;
        }
        
        function openWhatsApp(number) {
            if (number) {
                window.open(`https://wa.me/91${number}`, '_system'); // _system for native app
            } else {
                alert("WhatsApp number not available.");
            }
        }

        function openInstagram(id) {
            if (id) {
                window.open(`https://instagram.com/${id}`, '_system'); // _system for native app
            } else {
                alert("Instagram ID not available.");
            }
        }

        function openURL(url) {
            try {
                const fullUrl = url.startsWith('http://') || url.startsWith('https://') ? url : `http://${url}`;
                window.open(fullUrl, '_system'); // Opens in external browser
            } catch (e) {
                console.error("Error opening URL:", e);
                alert("Could not open the link.");
            }
        }


        // --- Splash Screen & Initial Load ---
        // Get references to your elements
const splashScreen = document.getElementById('splash-screen');
const appContainer = document.getElementById('app-container');
const authScreen = document.getElementById('auth-screen');

// Function to show a specific screen
function showScreen(screenId) {
    // Hide all main screens first (if you have multiple)
    // For simplicity, we'll just show the target and hide the other main one.
    if (screenId === 'feed-screen') {
        appContainer.classList.remove('hidden');
        authScreen.classList.add('hidden'); // Ensure auth screen is hidden
        // Potentially show the specific feed-screen div within appContainer if needed
        document.getElementById('feed-screen').classList.remove('hidden'); // If feed-screen is also hidden initially
    } else if (screenId === 'auth-screen') {
        authScreen.classList.remove('hidden');
        appContainer.classList.add('hidden'); // Ensure app container is hidden
    }
}


window.addEventListener('load', () => {
    // Splash screen visible for 2 seconds (initial delay)
    setTimeout(() => {
        splashScreen.style.opacity = '0'; // Start fading out the splash screen

        // Wait for splash fade-out animation (1 second)
        setTimeout(() => {
            splashScreen.classList.add('hidden'); // Fully remove splash screen from layout

            // Check auth state and show correct screen after splash fades
            auth.onAuthStateChanged(user => {
                if (user) {
                    showScreen('feed-screen'); // User logged in, show feed
                } else {
                    showScreen('auth-screen'); // User not logged in, show auth screen
                }
            });
        }, 1000); // This should match the CSS transition duration for opacity
    }, 2000); // Splash screen remains fully opaque for 2 seconds
});

        // --- Authentication Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                fetchUserData(user.uid);
                fetchPosts(true); // Initial fetch when user logs in
                setupRealtimeListeners();
                fetchUserChats();
                checkAndShowDailyReward();
            } else {
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        toggleAuthFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (signinForm.classList.contains('hidden')) {
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleAuthFormLink.textContent = "Already have an account? Sign In";
            } else {
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                toggleAuthFormLink.textContent = "Don't have an account? Sign Up";
            }
            signinError.textContent = '';
            signinError.classList.add('hidden');
            signupError.textContent = '';
            signupError.classList.add('hidden');
            signupSuccess.textContent = '';
            signupSuccess.classList.add('hidden');
            // Clear inputs on toggle
            signinForm.reset();
            signupForm.reset();
        });

        // Username validation on signup form
        let usernameCheckTimeout;
        signupUsernameInput.addEventListener('input', () => {
            clearTimeout(usernameCheckTimeout);
            usernameCheckIcon.classList.add('hidden'); // Hide icon initially
            if (signupUsernameInput.value.length > 0) {
                usernameCheckTimeout = setTimeout(async () => {
                    const username = signupUsernameInput.value;
                    const usernameDoc = await db.collection('usernames').doc(username.toLowerCase()).get();
                    if (usernameDoc.exists) {
                        usernameCheckIcon.textContent = 'cancel';
                        usernameCheckIcon.classList.remove('hidden');
                        usernameCheckIcon.classList.add('red');
                        usernameCheckIcon.classList.remove('green');
                    } else {
                        usernameCheckIcon.textContent = 'check_circle';
                        usernameCheckIcon.classList.remove('hidden');
                        usernameCheckIcon.classList.add('green');
                        usernameCheckIcon.classList.remove('red');
                    }
                }, 500); // Debounce for 500ms
            }
        });

        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            signinError.textContent = '';
            signinError.classList.add('hidden');
            try {
                await auth.signInWithEmailAndPassword(signinEmailInput.value, signinPasswordInput.value);
            } catch (error) {
                signinError.textContent = `Sign-in failed: ${error.message.split(' (auth/')[0]}. Please check your email and password.`;
                signinError.classList.remove('hidden');
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            signupError.textContent = '';
            signupError.classList.add('hidden');
            signupSuccess.textContent = '';
            signupSuccess.classList.add('hidden');

            const name = signupNameInput.value.trim();
            const username = signupUsernameInput.value.trim().toLowerCase();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;
            const phone = signupPhoneInput.value.trim();
            const instagram = signupInstaInput.value.trim();

            if (password !== confirmPassword) {
                signupError.textContent = "Passwords do not match!";
                signupError.classList.remove('hidden');
                return;
            }
            if (!name || !username || !email || !password) {
                signupError.textContent = "Please fill in all required fields (Name, Username, Email, Password).";
                signupError.classList.remove('hidden');
                return;
            }
            if (!phone && !instagram) {
                signupError.textContent = "Please provide either a WhatsApp Number or an Instagram ID.";
                signupError.classList.remove('hidden');
                return;
            }

            try {
                // Check username availability again
                const usernameDoc = await db.collection('usernames').doc(username).get();
                if (usernameDoc.exists) {
                    signupError.textContent = "This username is already taken. Please choose another.";
                    signupError.classList.remove('hidden');
                    return;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Add username to the unique usernames collection
                await db.collection('usernames').doc(username).set({
                    userId: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create user profile
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    username: username,
                    email: email,
                    phone: phone,
                    instagram: instagram,
                    profileLogo: generateRandomProfileLogo(), // Assign a random logo
                    coins: 10,
                    limits: 2, // 1 free post per day
                    credits: 10,
                    followers: 0,
                    following: 0,
                    postCount: 0,
                    uid: user.uid,
                    lastDailyReward: 0 // Initialize last daily reward timestamp
                });
                
                signupSuccess.textContent = "Account created successfully! Please sign in.";
                signupSuccess.classList.remove('hidden');
                signupForm.reset();
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                toggleAuthFormLink.textContent = "Don't have an account? Sign Up";

            } catch (error) {
                signupError.textContent = `Sign-up failed: ${error.message.split(' (auth/')[0] || error.message}.`;
                signupError.classList.remove('hidden');
            }
        });
        
        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            const icon = input.nextElementSibling.querySelector('.material-symbols-outlined');
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'visibility';
            } else {
                input.type = 'password';
                icon.textContent = 'visibility_off';
            }
        }

        // --- App Navigation ---
        bottomNavBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                let screenId = btn.id.replace('-nav-btn', '-screen');
                if (screenId === 'profile-screen') {
                    screenId = 'my-profile-screen'; // Internal ID for my own profile screen
                }
                showScreen(screenId);
                bottomNavBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Toggle refresh button visibility based on screen
                if (screenId === 'feed-screen') {
                    refreshPostsBtn.classList.remove('hidden');
                } else {
                    refreshPostsBtn.classList.add('hidden');
                }
            });
        });
        
        openSideMenuBtn.addEventListener('click', () => {
            sideMenu.classList.add('open');
            menuOverlay.classList.remove('hidden');
        });

        closeSideMenuBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            menuOverlay.classList.add('hidden');
        });

        menuOverlay.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            menuOverlay.classList.add('hidden');
        });

        signoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                sideMenu.classList.remove('open');
                menuOverlay.classList.add('hidden');
                alert("You have been signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Error signing out. Please try again.");
            }
        });
        
        // Data Saver Toggle (Client-side simulation)
        dataSaverToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                alert("Data Saver ON. Images might load in lower quality or slower. (Simulated)");
                // Implement logic to reduce data usage, e.g., low-res images, less frequent updates
            } else {
                alert("Data Saver OFF. (Simulated)");
            }
        });

        // About Us / Privacy Policy Buttons (Placeholder for content)
        document.getElementById('about-us-btn').addEventListener('click', () => {
            alert("About AddMint:\n\nAddMint is a platform to connect with people, share your posts, and interact with others. Grow your network, earn rewards, and discover new content!");
        });
        document.getElementById('privacy-policy-btn').addEventListener('click', () => {
            alert("Privacy Policy:\n\nYour privacy is important to us. We collect minimal data for app functionality and do not share your personal information without consent. Ads may collect anonymized data as per their policies. For full details, please contact us.");
        });

        function showScreen(id) {
            mainScreens.forEach(screen => screen.classList.add('hidden'));
            if(id === 'my-profile-screen') {
                myProfileScreen.classList.remove('hidden');
            } else if (id === 'view-profile-screen') {
                viewProfileScreen.classList.remove('hidden');
            } else if (id === 'chat-screen') {
                chatScreen.classList.remove('hidden');
            } else {
                document.getElementById(id).classList.remove('hidden');
            }
        }
        
        // --- User Data Fetch & UI Update ---
        async function fetchUserData(uid) {
            const userRef = db.collection('users').doc(uid);
            userRef.onSnapshot(doc => {
                if (doc.exists) {
                    currentUserData = doc.data();
                    updateHeaderCurrency();
                    updateMyProfileScreen();
                } else {
                    console.warn("User data not found for UID:", uid);
                    // This could happen if a user account is created but not fully initialized
                    // Force sign out or prompt user to complete profile
                    auth.signOut();
                }
            }, error => {
                console.error("Error fetching user data:", error);
                // Handle permission denied or other errors
                auth.signOut(); // Force sign out on critical error
            });
        }
        
        function updateHeaderCurrency() {
            if (currentUserData) {
                headerCoins.textContent = formatNumber(currentUserData.coins);
                headerLimits.textContent = formatNumber(currentUserData.limits);
                headerCredits.textContent = formatNumber(currentUserData.credits);
                postCreationLimitText.textContent = formatNumber(currentUserData.limits);
                postCreationCoinsText.textContent = formatNumber(currentUserData.coins);
                document.getElementById('current-coins').textContent = `Current: ${formatNumber(currentUserData.coins)}`;
                document.getElementById('current-limits').textContent = `Current: ${formatNumber(currentUserData.limits)}`;
                document.getElementById('current-credits').textContent = `Current: ${formatNumber(currentUserData.credits)}`;
            }
        }
        
        function updateMyProfileScreen() {
            if (currentUserData) {
                myProfileName.textContent = currentUserData.name;
                myProfileEmail.textContent = currentUserData.email;
                myProfileUsername.textContent = `@${currentUserData.username}`;
                myProfileAvatar.innerHTML = currentUserData.profileLogo;
                myFollowerCount.textContent = formatNumber(currentUserData.followers);
                myFollowingCount.textContent = formatNumber(currentUserData.following);
                myPostCount.textContent = formatNumber(currentUserData.postCount);
                
                // Set initial values for edit profile form
                editUsernameInput.value = currentUserData.username;
                editPhoneInput.value = currentUserData.phone || '';
                editInstagramInput.value = currentUserData.instagram || '';
                
                // Update profile social buttons
                document.querySelector('#profile-screen .profile-actions-buttons button:nth-child(1)').onclick = () => openWhatsApp(currentUserData.phone);
                document.querySelector('#profile-screen .profile-actions-buttons button:nth-child(2)').onclick = () => openInstagram(currentUserData.instagram);

                fetchUserPosts(auth.currentUser.uid, myPostsGrid, true);
            }
        }

        editProfileBtn.addEventListener('click', () => {
            editProfileModal.classList.remove('hidden');
            // Generate logo options
            logoSelectionGrid.innerHTML = '';
            profileLogoOptions.forEach(logo => {
                const div = document.createElement('div');
                div.className = 'logo-option';
                div.innerHTML = logo;
                if (logo === currentUserData.profileLogo) {
                    div.classList.add('selected');
                }
                div.addEventListener('click', () => {
                    document.querySelectorAll('.logo-option').forEach(opt => opt.classList.remove('selected'));
                    div.classList.add('selected');
                });
                logoSelectionGrid.appendChild(div);
            });
        });

        cancelEditBtn.addEventListener('click', () => {
            editProfileModal.classList.add('hidden');
            editProfileMessage.classList.add('hidden');
            usernameValidationIcon.classList.add('hidden');
        });

        saveProfileBtn.addEventListener('click', async () => {
            const newUsername = editUsernameInput.value.trim().toLowerCase();
            const newPhone = editPhoneInput.value.trim();
            const newInstagram = editInstagramInput.value.trim();
            const selectedLogoElement = document.querySelector('.logo-option.selected');
            const newProfileLogo = selectedLogoElement ? selectedLogoElement.innerHTML : currentUserData.profileLogo; // Use innerHTML as the stored value

            if (!newPhone && !newInstagram) {
                editProfileMessage.textContent = "Please provide either a WhatsApp Number or an Instagram ID.";
                editProfileMessage.classList.remove('hidden');
                editProfileMessage.style.color = 'var(--red-color)';
                return;
            }

            try {
                // Check if username changed and is unique
                if (newUsername !== currentUserData.username) {
                    const usernameDoc = await db.collection('usernames').doc(newUsername).get();
                    if (usernameDoc.exists) {
                        editProfileMessage.textContent = "This username is already taken. Please choose another.";
                        editProfileMessage.classList.remove('hidden');
                        editProfileMessage.style.color = 'var(--red-color)';
                        return;
                    }
                    // Delete old username entry
                    await db.collection('usernames').doc(currentUserData.username).delete();
                    // Add new username entry
                    await db.collection('usernames').doc(newUsername).set({
                        userId: auth.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await db.collection('users').doc(auth.currentUser.uid).update({
                    username: newUsername,
                    phone: newPhone,
                    instagram: newInstagram,
                    profileLogo: newProfileLogo
                });

                editProfileMessage.textContent = "Profile updated successfully!";
                editProfileMessage.classList.remove('hidden');
                editProfileMessage.style.color = 'var(--primary-color)';
                // Re-fetch user data to update UI
                setTimeout(() => {
                    editProfileModal.classList.add('hidden');
                    editProfileMessage.classList.add('hidden');
                    usernameValidationIcon.classList.add('hidden');
                }, 1500);

            } catch (error) {
                console.error("Error updating profile:", error);
                editProfileMessage.textContent = `Error updating profile: ${error.message}`;
                editProfileMessage.classList.remove('hidden');
                editProfileMessage.style.color = 'var(--red-color)';
            }
        });

        // Generate profile logo options (50 unique Material Symbols)
        const profileLogoOptions = [];
        const possibleIcons = [
            'person', 'account_circle', 'face', 'diversity_3', 'pets', 'star', 'local_florist',
            'bolt', 'forest', 'beach_access', 'spa', 'auto_fix_high', 'lightbulb', 'brightness_low',
            'cookie', 'emoji_events', 'rocket_launch', 'deployed_code', 'laptop', 'brush', 'palette',
            'science', 'school', 'emoji_nature', 'emoji_objects', 'fitness_center', 'gamepad', 'toys',
            'mic', 'headphones', 'camera_alt', 'landscape', 'attractions', 'castle', 'travel_explore',
            'park', 'snowboarding', 'skateboarding', 'sports_baseball', 'sports_basketball', 'sports_soccer',
            'sailing', 'cruelty_free', 'eco', 'compost', 'recycling', 'nest_thermostat', 'smart_toy',
            'headphones', 'speaker', 'bluetooth', 'wifi', 'data_thresholding', 'cloud', 'sunny', 'rainy',
            'diamond', 'emoji_food_beverage', 'piano', 'directions_car', 'directions_bike', 'airplane_ticket'
        ]; // Added more icons to ensure 50 distinct ones
        const logoColors = ['#FFC107', '#4CAF50', '#2196F3', '#9C27B0', '#FF5722', '#00BCD4', '#E91E63', '#673AB7', '#795548', '#607D8B'];
        const usedIcons = new Set();
        while (profileLogoOptions.length < 50 && usedIcons.size < possibleIcons.length) {
            const randomIcon = possibleIcons[Math.floor(Math.random() * possibleIcons.length)];
            if (!usedIcons.has(randomIcon)) {
                const randomColor = logoColors[Math.floor(Math.random() * logoColors.length)];
                profileLogoOptions.push(`<span class="material-symbols-outlined" style="color: ${randomColor};">${randomIcon}</span>`);
                usedIcons.add(randomIcon);
            }
        }

        // --- Posts Management ---
        const postsCache = []; // To store all fetched posts
        let displayPostIndex = 0; // To track which post is next to display for "never ending" effect
        const postsPerBatch = 10; // Number of posts to show in a batch
        const layoutCycle = ['vertical', 'vertical', 'vertical', 'vertical', 'horizontal', 'table', 'vertical', 'vertical', 'horizontal']; // Cycle through layouts

        async function fetchPosts(clearExisting) {
            if (loadingPosts) return;
            loadingPosts = true;
            document.getElementById('feed-loading-spinner').classList.remove('hidden');

            if (clearExisting) {
                postsCache.length = 0; // Clear cache
                displayPostIndex = 0;
                feedScreen.innerHTML = '';
                lastVisiblePost = null;
            }

            try {
                let query = db.collection('posts').orderBy('timestamp', 'desc');
                if (lastVisiblePost) {
                    query = query.startAfter(lastVisiblePost);
                }
                const snapshot = await query.limit(50).get(); // Fetch a larger batch from Firestore to ensure variety for cycling

                if (snapshot.empty && postsCache.length === 0) {
                    feedScreen.innerHTML = '<p style="text-align: center; margin-top: 50px;">No posts available yet. Be the first to post!</p>';
                    loadingPosts = false;
                    document.getElementById('feed-loading-spinner').classList.add('hidden');
                    return;
                }

                snapshot.forEach(doc => {
                    const postData = { id: doc.id, ...doc.data() };
                    // Set default expiry if not present or 12 hours
                    if (!postData.expiry || postData.expiry.toDate() < new Date()) {
                        postData.expiry = firebase.firestore.Timestamp.fromMillis(Date.now() + 12 * 60 * 60 * 1000);
                    }
                    postsCache.push(postData);
                });
                lastVisiblePost = snapshot.docs[snapshot.docs.length - 1];

                // If no new posts and we've displayed all cached, reset for "never ending"
                if (snapshot.empty && displayPostIndex >= postsCache.length) {
                    displayPostIndex = 0; // Reset to loop through existing cached posts
                    console.log("Looping through cached posts again.");
                }
                
                displayNextBatchOfPosts();

            } catch (error) {
                console.error("Error fetching posts:", error);
                // Optionally display an error message on the feed screen
                const errorDiv = document.createElement('p');
                errorDiv.style.textAlign = 'center';
                errorDiv.style.color = 'var(--red-color)';
                errorDiv.textContent = 'Error loading posts. Please try refreshing.';
                feedScreen.appendChild(errorDiv);
            } finally {
                loadingPosts = false;
                document.getElementById('feed-loading-spinner').classList.add('hidden');
            }
        }

        function displayNextBatchOfPosts() {
            if (postsCache.length === 0) return;

            const fragment = document.createDocumentFragment();
            let addedCount = 0;
            let currentLayoutIndex = Math.floor(Math.random() * layoutCycle.length); // Start with a random layout type

            while (addedCount < postsPerBatch && postsCache.length > 0) {
                const layoutType = layoutCycle[currentLayoutIndex % layoutCycle.length];
                currentLayoutIndex++; // Move to next layout for next iteration

                if (layoutType === 'table') {
                    // For table layout, display 4-6 posts as items within one "table" card
                    const tableCard = document.createElement('div');
                    tableCard.className = 'post-card table-layout animate__animated animate__fadeInUp';
                    const numTableItems = Math.floor(Math.random() * 3) + 4; // 4-6 items
                    let itemsAddedToTable = 0;
                    
                    while(itemsAddedToTable < numTableItems && postsCache.length > 0) {
                        const post = postsCache[displayPostIndex % postsCache.length];
                        displayPostIndex++; // Advance index for next post
                        addedCount++; // Count as one of the 10 posts per batch
                        
                        if (post.expiry && post.expiry.toDate() < new Date()) {
                            // Skip expired posts from display. Real deletion needs backend.
                            continue;
                        }

                        const postItem = document.createElement('div');
                        postItem.className = 'post-item';
                        postItem.innerHTML = `
                            <h4 class="post-title"><a href="#" class="post-title-link" data-user-id="${post.userId}">${post.title}</a></h4>
                            <p class="post-area">${post.area}</p>
                        `;
                        postItem.addEventListener('click', (e) => {
                            if (e.target.classList.contains('post-title-link')) {
                                e.preventDefault();
                                showOtherUserProfile(e.target.dataset.userId);
                            }
                        });
                        tableCard.appendChild(postItem);
                        itemsAddedToTable++;
                    }
                    if (itemsAddedToTable > 0) { // Only add if it has content
                        fragment.appendChild(tableCard);
                    }
                } else {
                    // For vertical and horizontal layouts, display individual posts
                    const post = postsCache[displayPostIndex % postsCache.length];
                    displayPostIndex++; // Advance index for next post
                    addedCount++; // Count as one of the 10 posts per batch

                    if (post.expiry && post.expiry.toDate() < new Date()) {
                        // Skip expired posts from display. Real deletion needs backend.
                        continue;
                    }

                    const postCard = document.createElement('div');
                    let postStyleClass = 'post-card animate__animated animate__fadeInUp';
                    if (layoutType === 'horizontal') {
                        postStyleClass += ' horizontal-layout';
                    }
                    postCard.className = postStyleClass;

                    // Replace URLs with clickable links
                    const descriptionWithLinks = post.description.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/g, (match) => {
                        const url = match.startsWith('http') ? match : `http://${match}`;
                        return `<a href="#" onclick="openURL('${url}'); return false;" style="color: var(--link-color);">${match}</a>`;
                    });

                    postCard.innerHTML = `
                        <div class="post-extra-actions">
                            <button class="icon-button" onclick="toggleTranslation(this.closest('.post-card'))">
                                <span class="material-symbols-outlined">translate</span>
                            </button>
                            <button class="icon-button" onclick="playSoundEffect()"><span class="material-symbols-outlined">volume_up</span></button>
                            <button class="icon-button" onclick="togglePostOptionsMenu(this)">
                                <span class="material-symbols-outlined">more_vert</span>
                                <div class="post-options-menu hidden">
                                    <button onclick="reportPost('${post.id}')">Report</button>
                                    ${post.userId === auth.currentUser.uid ? `<button onclick="deletePost('${post.id}')">Delete</button>` : ''}
                                </div>
                            </button>
                        </div>
                        <div class="post-header">
                            <h3 class="post-title"><a href="#" class="post-title-link" data-user-id="${post.userId}">${post.title}</a></h3>
                            <div class="post-info">
                                <p>Area: ${post.area}</p>
                                <p>Expires: ${timeUntil(post.expiry.toDate())}</p>
                            </div>
                        </div>
                        <p class="post-description">${descriptionWithLinks}</p>
                        <div class="post-actions">
                            <div class="post-social-icons">
                                ${post.whatsapp ? `<button class="social-icon-btn" onclick="openWhatsApp('${post.whatsapp}')">${createSocialIcon('whatsapp')}</button>` : ''}
                                ${post.instagram ? `<button class="social-icon-btn" onclick="openInstagram('${post.instagram}')">${createSocialIcon('instagram')}</button>` : ''}
                                <button class="social-icon-btn" onclick="startChat('${post.userId}', '${post.userName}')">${createSocialIcon('chat')}</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button class="like-btn" data-post-id="${post.id}">
                                    <span class="material-symbols-outlined">favorite</span>
                                    <span class="like-count">${formatNumber(post.likes || 0)}</span>
                                </button>
                                <span class="post-views">
                                    <span class="material-symbols-outlined">visibility</span>
                                    <span class="views-count">${formatNumber(post.views || 0)}</span>
                                </span>
                            </div>
                        </div>
                        <div class="post-reactions-summary" data-post-id="${post.id}"></div>
                    `;
                    fragment.appendChild(postCard);

                    // Add event listeners for double click and long press for reactions
                    let doubleClickTimer = null;
                    postCard.addEventListener('click', () => {
                        if (doubleClickTimer === null) {
                            doubleClickTimer = setTimeout(() => {
                                doubleClickTimer = null;
                            }, 300); // 300ms for double-click window
                        } else {
                            clearTimeout(doubleClickTimer);
                            doubleClickTimer = null;
                            handleLike(post.id, postCard.querySelector('.like-btn'));
                        }
                        handlePostClick(postCard); // For neon glow
                    });

                    postCard.addEventListener('touchstart', (e) => {
                        longPressTimer = setTimeout(() => {
                            showEmojiReactionOptions(postCard, post.id);
                        }, 700); // Long press after 700ms
                    });

                    postCard.addEventListener('touchend', () => {
                        clearTimeout(longPressTimer);
                    });

                    postCard.addEventListener('touchmove', () => {
                        clearTimeout(longPressTimer);
                    });

                    // Mouse events for long press (for desktop testing)
                    postCard.addEventListener('mousedown', (e) => {
                        longPressTimer = setTimeout(() => {
                            showEmojiReactionOptions(postCard, post.id);
                        }, 700);
                    });
                    postCard.addEventListener('mouseup', () => {
                        clearTimeout(longPressTimer);
                    });
                    postCard.addEventListener('mouseleave', () => {
                        clearTimeout(longPressTimer);
                    });
                    
                    const titleLink = postCard.querySelector('.post-title-link');
                    if (titleLink) {
                        titleLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            showOtherUserProfile(e.target.dataset.userId);
                        });
                    }
                    
                    // Update views count
                    incrementPostView(post.id);
                    fetchPostReactions(post.id, postCard.querySelector('.post-reactions-summary'));
                }
            }
            feedScreen.appendChild(fragment);
            loadingPosts = false;

            // Pre-fetch more posts if we're running low on cached posts for continuous scroll
            if (postsCache.length - displayPostIndex < postsPerBatch * 2 && !isFetchingMore && lastVisiblePost) {
                isFetchingMore = true;
                fetchPosts(false).finally(() => isFetchingMore = false);
            }
        }
        
        // Simulating auto-deletion in client-side (backend is needed for real deletion)
        function timeUntil(date) {
            const now = new Date();
            const diffMs = date.getTime() - now.getTime();
            if (diffMs <= 0) return 'Expired';

            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}d ${diffHours % 24}h`;
            if (diffHours > 0) return `${diffHours}h ${diffMinutes % 60}m`;
            if (diffMinutes > 0) return `${diffMinutes}m`;
            return 'Now';
        }

        refreshPostsBtn.addEventListener('click', () => {
            fetchPosts(true); // Clear and re-fetch all posts
        });
        
        feedScreen.addEventListener('scroll', () => {
            if (feedScreen.scrollTop + feedScreen.clientHeight >= feedScreen.scrollHeight - 100 && !loadingPosts) {
                displayNextBatchOfPosts(); // Display more from cache/fetch if needed
            }
        });

        let currentNeonPost = null;
        function handlePostClick(postCardElement) {
            // Remove neon glow from previously clicked post
            if (currentNeonPost && currentNeonPost !== postCardElement) {
                currentNeonPost.classList.remove('neon-glow');
            }
            
            // Add neon glow to the current post
            postCardElement.classList.add('neon-glow');
            currentNeonPost = postCardElement;

            // Remove glow after 3-4 seconds
            setTimeout(() => {
                if (currentNeonPost === postCardElement) { // Only remove if it's still the active neon post
                    postCardElement.classList.remove('neon-glow');
                    currentNeonPost = null;
                }
            }, 3500); // 3.5 seconds
        }

        async function handleLike(postId, button) {
            if (!auth.currentUser) return;
            const userId = auth.currentUser.uid;
            const likeRef = db.collection('posts').doc(postId).collection('likes').doc(userId);
            const postRef = db.collection('posts').doc(postId);
            
            try {
                const likeDoc = await likeRef.get();
                if (likeDoc.exists) {
                    await likeRef.delete();
                    await postRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
                    button.classList.remove('liked');
                } else {
                    await likeRef.set({ likedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
                    button.classList.add('liked');
                }
            } catch (error) {
                console.error("Error liking post:", error);
                alert("An error occurred while liking. Please try again.");
            }
        }
        
        // Listen for real-time like updates
        db.collection('posts').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'modified') {
                    const postId = change.doc.id;
                    const newLikes = change.doc.data().likes || 0;
                    const postElement = feedScreen.querySelector(`.post-actions button.like-btn[data-post-id="${postId}"]`);
                    if (postElement) {
                        postElement.querySelector('.like-count').textContent = formatNumber(newLikes);
                    }
                }
            });
        }, error => console.error("Error listening to post changes:", error));

        // Views Count Logic
        async function incrementPostView(postId) {
            if (!auth.currentUser) return;
            const userId = auth.currentUser.uid;
            const viewRef = db.collection('posts').doc(postId).collection('views').doc(userId);
            
            try {
                const viewDoc = await viewRef.get();
                if (!viewDoc.exists) {
                    await viewRef.set({ viewedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection('posts').doc(postId).update({ views: firebase.firestore.FieldValue.increment(1) });
                }
            } catch (error) {
                console.error("Error incrementing view:", error);
            }
        }

        // Listen for real-time views updates
        db.collection('posts').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'modified') {
                    const postId = change.doc.id;
                    const newViews = change.doc.data().views || 0;
                    const postElement = feedScreen.querySelector(`.post-views .views-count[data-post-id="${postId}"]`);
                    if (postElement) {
                        postElement.textContent = formatNumber(newViews);
                    }
                }
            });
        }, error => console.error("Error listening to views changes:", error));


        function showEmojiReactionOptions(postCardElement, postId) {
            // Remove any existing reaction options
            document.querySelectorAll('.emoji-reaction-options').forEach(el => el.remove());

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'emoji-reaction-options';
            optionsDiv.setAttribute('data-post-id', postId);

            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-btn';
                button.textContent = emoji;
                button.addEventListener('click', () => {
                    addEmojiReaction(postId, emoji);
                    optionsDiv.remove(); // Remove options after selection
                });
                optionsDiv.appendChild(button);
            });
            
            postCardElement.appendChild(optionsDiv);
            
            // Remove options after a few seconds if no selection
            setTimeout(() => {
                if (postCardElement.contains(optionsDiv)) {
                    optionsDiv.remove();
                }
            }, 5000); // 5 seconds to select an emoji
        }

        async function addEmojiReaction(postId, emoji) {
            if (!auth.currentUser) return;
            const userId = auth.currentUser.uid;
            const reactionRef = db.collection('posts').doc(postId).collection('reactions').doc(userId);
            
            try {
                await reactionRef.set({ emoji: emoji, reactedAt: firebase.firestore.FieldValue.serverTimestamp() });
            } catch (error) {
                console.error("Error adding emoji reaction:", error);
                alert("An error occurred while adding reaction.");
            }
        }

        // Listen for real-time emoji reaction updates for a post
        function fetchPostReactions(postId, summaryElement) {
            db.collection('posts').doc(postId).collection('reactions').onSnapshot(snapshot => {
                const reactions = {};
                let totalReactions = 0;
                snapshot.forEach(doc => {
                    const emoji = doc.data().emoji;
                    reactions[emoji] = (reactions[emoji] || 0) + 1;
                    totalReactions++;
                });

                summaryElement.innerHTML = '';
                if (totalReactions > 0) {
                    const sortedEmojis = Object.keys(reactions).sort((a, b) => reactions[b] - reactions[a]);
                    
                    sortedEmojis.slice(0, 3).forEach(emoji => { // Show top 3 emojis
                        const item = document.createElement('span');
                        item.className = 'reaction-item';
                        item.innerHTML = `<span class="emoji-icon">${emoji}</span> ${formatNumber(reactions[emoji])}`;
                        summaryElement.appendChild(item);
                    });
                    
                    if (totalReactions > 3) {
                        const total = document.createElement('span');
                        total.className = 'total-reactions';
                        total.textContent = `Total: ${formatNumber(totalReactions)}`;
                        summaryElement.appendChild(total);
                    }
                }
            }, error => console.error("Error listening to reactions:", error));
        }

        function togglePostOptionsMenu(button) {
            const menu = button.querySelector('.post-options-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
            // Close other menus if open
            document.querySelectorAll('.post-options-menu').forEach(openMenu => {
                if (openMenu !== menu) {
                    openMenu.classList.add('hidden');
                }
            });
        }

        function reportPost(postId) {
            alert(`Post ${postId} reported. Thank you for your feedback!`);
            // Here you'd send a report to your Firebase backend / moderation system
        }


        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser || !currentUserData) return;
            
            const selectedDuration = document.querySelector('input[name="post-duration"]:checked').value;
            let adsRequired = 0;
            let postExpiryHours = 12;

            if (selectedDuration === '18') { adsRequired = 1; postExpiryHours = 18; }
            else if (selectedDuration === '24') { adsRequired = 2; postExpiryHours = 24; }
            else if (selectedDuration === '30') { adsRequired = 3; postExpiryHours = 30; }

            const hasLimit = currentUserData.limits >= 1;
            const hasCoins = currentUserData.coins >= 5;
            
            if (!hasLimit && !hasCoins) {
                postCreationError.textContent = "You don't have enough limits or coins to post. Please get more from the 'Add' section.";
                postCreationError.classList.remove('hidden');
                return;
            }
            
            if (adsRequired > 0) {
                // Simulate watching ads for boosting
                alert(`To boost your post for ${postExpiryHours} hours, you need to watch ${adsRequired} ad(s). (Simulated)`);
                // In a real app, trigger ad and wait for callback before proceeding
                // For now, we'll just allow it to proceed for demonstration purposes
            }

            const postData = {
                title: postTitleInput.value,
                description: postDescriptionInput.value,
                area: postAreaInput.value,
                whatsapp: postWhatsappInput.value,
                instagram: postInstagramInput.value,
                userId: auth.currentUser.uid,
                userName: currentUserData.username, // Use username
                likes: 0,
                views: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                expiry: firebase.firestore.Timestamp.fromMillis(Date.now() + postExpiryHours * 60 * 60 * 1000)
            };
            
            try {
                const batch = db.batch();
                const postRef = db.collection('posts').doc(); // Create a new doc reference first
                batch.set(postRef, postData);
                
                let update = {};
                if (hasLimit) {
                    update.limits = firebase.firestore.FieldValue.increment(-1);
                } else {
                    update.coins = firebase.firestore.FieldValue.increment(-5);
                }
                update.postCount = firebase.firestore.FieldValue.increment(1);
                
                const userRef = db.collection('users').doc(auth.currentUser.uid);
                batch.update(userRef, update);

                await batch.commit();
                
                alert('Post created successfully!');
                createPostForm.reset();
                postCreationError.classList.add('hidden');
                showScreen('feed-screen');
                document.getElementById('feed-nav-btn').classList.add('active');
                
            } catch (error) {
                postCreationError.textContent = `Error publishing post: ${error.message}`;
                postCreationError.classList.remove('hidden');
                console.error(error);
            }
        });
        
        async function fetchUserPosts(userId, container, isMyPosts = false) {
            container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>'; // Show spinner
            try {
                const snapshot = await db.collection('posts')
                                        .where('userId', '==', userId)
                                        .orderBy('timestamp', 'desc')
                                        .get();
                container.innerHTML = ''; // Clear spinner
                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #888;">No posts yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const post = doc.data();
                    if (post.expiry && post.expiry.toDate() < new Date()) {
                        // Skip expired posts from display
                        return;
                    }

                    const postCard = document.createElement('div');
                    postCard.className = 'profile-post-card';
                    postCard.innerHTML = `
                        <h4 class="post-title">${post.title}</h4>
                        <p style="font-size: 0.8rem; color: #B0B0B0;">${post.area}</p>
                        <p style="font-size: 0.75rem; color: #777;">Expires: ${timeUntil(post.expiry.toDate())}</p>
                        ${isMyPosts ? `
                        <div class="profile-post-actions">
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn" data-post-id="${doc.id}">Delete</button>
                        </div>
                        ` : ''}
                    `;
                    container.appendChild(postCard);
                    
                    if (isMyPosts) {
                        postCard.querySelector('.delete-btn').addEventListener('click', () => deletePost(doc.id));
                    }
                });
            } catch (error) {
                console.error("Error fetching user posts:", error);
                container.innerHTML = `<p style="text-align: center; color: var(--red-color);">Error loading posts: ${error.message}</p>`;
            }
        }
        
        async function deletePost(postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                try {
                    await db.collection('posts').doc(postId).delete();
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        postCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    // Refresh posts on profile
                    fetchUserPosts(auth.currentUser.uid, myPostsGrid, true);
                } catch (error) {
                    console.error("Error deleting post: ", error);
                    alert(`Error deleting post: ${error.message}`);
                }
            }
        }

        async function showOtherUserProfile(userId) {
            if (userId === auth.currentUser.uid) {
                showScreen('my-profile-screen');
                document.getElementById('profile-nav-btn').classList.add('active');
                return;
            }

            const userRef = db.collection('users').doc(userId);
            try {
                const userDoc = await userRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    viewProfileName.textContent = userData.name;
                    viewProfileEmail.textContent = userData.email;
                    viewProfileUsernameDisplay.textContent = `@${userData.username}`;
                    viewProfileAvatar.innerHTML = userData.profileLogo;
                    viewFollowerCount.textContent = formatNumber(userData.followers);
                    viewFollowingCount.textContent = formatNumber(userData.following);
                    viewPostCount.textContent = formatNumber(userData.postCount);

                    const isFollowing = (await db.collection('followers').doc(userId).collection('following_me').doc(auth.currentUser.uid).get()).exists;
                    followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                    followBtn.className = `profile-follow-btn ${isFollowing ? 'unfollow' : 'follow'}`;
                    followBtn.onclick = () => toggleFollow(userId, isFollowing);

                    viewProfileWhatsappBtn.onclick = () => openWhatsApp(userData.phone);
                    viewProfileInstagramBtn.onclick = () => openInstagram(userData.instagram);
                    viewProfileMessageBtn.onclick = () => startChat(userId, userData.username); // Use username for chat name

                    fetchUserPosts(userId, viewProfilePostsGrid);
                    showScreen('view-profile-screen');
                } else {
                    alert('User not found.');
                }
            } catch (error) {
                console.error("Error showing user profile:", error);
                alert(`An error occurred: ${error.message}`);
            }
        }
        
        async function toggleFollow(targetUserId, isFollowing) {
            if (!auth.currentUser) return;
            const myId = auth.currentUser.uid;
            
            if (myId === targetUserId) {
                alert("You cannot follow yourself.");
                return;
            }

            const targetUserRef = db.collection('users').doc(targetUserId);
            const myRef = db.collection('users').doc(myId);
            
            const batch = db.batch();

            if (isFollowing) {
                // Unfollow
                batch.delete(db.collection('followers').doc(targetUserId).collection('following_me').doc(myId));
                batch.delete(db.collection('following').doc(myId).collection('i_follow').doc(targetUserId));
                batch.update(targetUserRef, { followers: firebase.firestore.FieldValue.increment(-1) });
                batch.update(myRef, { following: firebase.firestore.FieldValue.increment(-1) });
            } else {
                // Follow
                batch.set(db.collection('followers').doc(targetUserId).collection('following_me').doc(myId), { timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                batch.set(db.collection('following').doc(myId).collection('i_follow').doc(targetUserId), { timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                batch.update(targetUserRef, { followers: firebase.firestore.FieldValue.increment(1) });
                batch.update(myRef, { following: firebase.firestore.FieldValue.increment(1) });
            }
            
            try {
                await batch.commit();
                showOtherUserProfile(targetUserId); // Refresh profile to show updated status
            } catch (error) {
                console.error("Error toggling follow:", error);
                alert(`An error occurred: ${error.message}`);
            }
        }

        async function showFollowerList(isViewingOtherUser = false) {
            const userId = isViewingOtherUser ? currentChatUser.id : auth.currentUser.uid; // Reuse currentChatUser for viewing profile
            const targetList = isViewingOtherUser ? followerListContent : followerListContent; // Same content div
            const popup = followerListPopup;
            targetList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            popup.classList.remove('hidden');

            try {
                const snapshot = await db.collection('followers').doc(userId).collection('following_me').get();
                targetList.innerHTML = '';
                if (snapshot.empty) {
                    targetList.innerHTML = '<p style="text-align: center; color: #888;">No followers yet.</p>';
                } else {
                    for (const doc of snapshot.docs) {
                        const followerId = doc.id;
                        const userDoc = await db.collection('users').doc(followerId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const listItem = document.createElement('div');
                            listItem.className = 'list-item';
                            listItem.innerHTML = `
                                <div class="chat-avatar generated-logo">${userData.profileLogo}</div>
                                <span class="user-name">${userData.username || userData.name}</span>
                                <button class="profile-follow-btn ${isViewingOtherUser ? 'hidden' : ''}" data-user-id="${followerId}">Follow</button>
                            `;
                            // Add click to view profile for any user in the list
                            listItem.querySelector('.user-name').addEventListener('click', () => {
                                showOtherUserProfile(followerId);
                                closeListPopup('follower');
                            });
                            const followBtnInList = listItem.querySelector('.profile-follow-btn');
                            if (followBtnInList) {
                                const isAlreadyFollowing = (await db.collection('following').doc(auth.currentUser.uid).collection('i_follow').doc(followerId).get()).exists;
                                followBtnInList.textContent = isAlreadyFollowing ? 'Unfollow' : 'Follow';
                                followBtnInList.classList.add(isAlreadyFollowing ? 'unfollow' : 'follow');
                                followBtnInList.onclick = (e) => {
                                    e.stopPropagation(); // Prevent opening profile
                                    toggleFollow(followerId, isAlreadyFollowing);
                                    // Refresh the list after toggling follow
                                    setTimeout(() => showFollowerList(isViewingOtherUser), 500);
                                };
                            }
                            targetList.appendChild(listItem);
                        }
                    }
                }
            } catch (error) {
                console.error("Error fetching follower list:", error);
                targetList.innerHTML = `<p style="text-align: center; color: var(--red-color);">Error loading list: ${error.message}</p>`;
            }
        }

        async function showFollowingList(isViewingOtherUser = false) {
            const userId = isViewingOtherUser ? currentChatUser.id : auth.currentUser.uid;
            const targetList = isViewingOtherUser ? followingListContent : followingListContent;
            const popup = followingListPopup;
            targetList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            popup.classList.remove('hidden');

            try {
                const snapshot = await db.collection('following').doc(userId).collection('i_follow').get();
                targetList.innerHTML = '';
                if (snapshot.empty) {
                    targetList.innerHTML = '<p style="text-align: center; color: #888;">Not following anyone yet.</p>';
                } else {
                    for (const doc of snapshot.docs) {
                        const followedId = doc.id;
                        const userDoc = await db.collection('users').doc(followedId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const listItem = document.createElement('div');
                            listItem.className = 'list-item';
                            listItem.innerHTML = `
                                <div class="chat-avatar generated-logo">${userData.profileLogo}</div>
                                <span class="user-name">${userData.username || userData.name}</span>
                                <button class="profile-follow-btn ${isViewingOtherUser ? 'hidden' : ''}" data-user-id="${followedId}">Unfollow</button>
                            `;
                            listItem.querySelector('.user-name').addEventListener('click', () => {
                                showOtherUserProfile(followedId);
                                closeListPopup('following');
                            });
                            const unfollowBtnInList = listItem.querySelector('.profile-follow-btn');
                            if (unfollowBtnInList) {
                                // Since we are in the 'i_follow' list, the button is always 'Unfollow' for the current user
                                unfollowBtnInList.textContent = 'Unfollow';
                                unfollowBtnInList.classList.add('unfollow');
                                unfollowBtnInList.onclick = (e) => {
                                    e.stopPropagation(); // Prevent opening profile
                                    toggleFollow(followedId, true); // True because we are already following
                                    setTimeout(() => showFollowingList(isViewingOtherUser), 500);
                                };
                            }
                            targetList.appendChild(listItem);
                        }
                    }
                }
            } catch (error) {
                console.error("Error fetching following list:", error);
                targetList.innerHTML = `<p style="text-align: center; color: var(--red-color);">Error loading list: ${error.message}</p>`;
            }
        }

        function closeListPopup(type) {
            if (type === 'follower') {
                followerListPopup.classList.add('hidden');
            } else if (type === 'following') {
                followingListPopup.classList.add('hidden');
            }
        }


        // --- Chat Functionality ---
        function startChat(userId, userName) {
            currentChatUser = { id: userId, name: userName };
            currentChatName.textContent = userName;
            chatMessagesContainer.classList.remove('hidden');
            chatList.classList.add('hidden');
            fetchMessages(auth.currentUser.uid, userId);
            showScreen('chat-screen');
            document.getElementById('chat-nav-btn').classList.add('active');
        }

        backToChatListBtn.addEventListener('click', () => {
            chatMessagesContainer.classList.add('hidden');
            chatList.classList.remove('hidden');
            currentChatUser = null;
        });

        chatInputForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!chatInput.value.trim() || !currentChatUser || !auth.currentUser) return;
            const myId = auth.currentUser.uid;
            const otherId = currentChatUser.id;
            
            if (currentUserData.credits < 1) {
                alert("You don't have enough credits to send a message. Watch an ad to get more.");
                return;
            }

            const chatId = myId < otherId ? `${myId}_${otherId}` : `${otherId}_${myId}`;
            
            const message = {
                senderId: myId,
                text: chatInput.value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false // Mark message as unread by default
            };
            
            try {
                const batch = db.batch();
                batch.collection('chats').doc(chatId).collection('messages').add(message);
                batch.update(db.collection('users').doc(myId), {
                    credits: firebase.firestore.FieldValue.increment(-1)
                });
                await batch.commit();
                chatInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                alert(`Error sending message: ${error.message}`);
            }
        });
        
        async function fetchUserChats() {
            if (!auth.currentUser) return;
            chatList.innerHTML = '<h2>Chats</h2>';
            noChatsMessage.classList.add('hidden');
            
            const myId = auth.currentUser.uid;
            
            try {
                // Fetch chats where the current user is a participant
                // This is a more complex query, typically requires indexing or a separate 'user_chats' collection
                // For simplicity, we'll iterate through all messages sent/received by the user and build chat list.
                // A better approach would be a 'user_chats' collection with last message info.
                
                const myMessagesSnapshot = await db.collectionGroup('messages')
                                                    .where('senderId', '==', myId)
                                                    .orderBy('timestamp', 'desc')
                                                    .limit(100) // Limit to recent messages
                                                    .get();
                
                const receivedMessagesSnapshot = await db.collectionGroup('messages')
                                                        .where('read', '==', false) // Find unread messages
                                                        .where('senderId', '!=', myId)
                                                        .get();

                const chatPartners = new Map(); // Map to store unique chat partners with their last message
                
                myMessagesSnapshot.forEach(doc => {
                    const chatId = doc.ref.parent.parent.id;
                    const participants = chatId.split('_');
                    const otherId = participants[0] === myId ? participants[1] : participants[0];
                    if (!chatPartners.has(otherId) || doc.data().timestamp > chatPartners.get(otherId).timestamp) {
                        chatPartners.set(otherId, { ...doc.data(), chatId: chatId });
                    }
                });

                receivedMessagesSnapshot.forEach(doc => {
                    const chatId = doc.ref.parent.parent.id;
                    const participants = chatId.split('_');
                    const otherId = participants[0] === myId ? participants[1] : participants[0];
                    if (!chatPartners.has(otherId) || doc.data().timestamp > chatPartners.get(otherId).timestamp) {
                        chatPartners.set(otherId, { ...doc.data(), chatId: chatId, unread: true });
                    }
                });

                if (chatPartners.size === 0) {
                    noChatsMessage.classList.remove('hidden');
                    return;
                }

                const sortedChatPartners = Array.from(chatPartners.entries())
                                                .sort((a, b) => b[1].timestamp.toDate() - a[1].timestamp.toDate());
                
                for (const [otherId, lastMessage] of sortedChatPartners) {
                    const userDoc = await db.collection('users').doc(otherId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const chatListItem = document.createElement('div');
                        chatListItem.className = 'chat-list-item';
                        chatListItem.onclick = () => startChat(otherId, userData.username || userData.name);
                        
                        let lastMsgText = lastMessage.text;
                        if (lastMsgText.length > 30) lastMsgText = lastMsgText.substring(0, 27) + '...';

                        chatListItem.innerHTML = `
                            <div class="chat-avatar generated-logo">${userData.profileLogo}</div>
                            <div class="chat-info">
                                <h3>${userData.username || userData.name} ${lastMessage.unread ? '<span style="color: var(--accent-color); font-weight: bold;"> (New)</span>' : ''}</h3>
                                <p>${lastMsgText}</p>
                            </div>
                        `;
                        chatList.appendChild(chatListItem);
                    }
                }

            } catch (error) {
                console.error("Error fetching chat list:", error);
                chatList.innerHTML += `<p style="text-align: center; color: var(--red-color);">Error loading chats: ${error.message}</p>`;
            }
        }

        function fetchMessages(myId, otherId) {
            chatMessages.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
            const chatId = myId < otherId ? `${myId}_${otherId}` : `${otherId}_${myId}`;
            
            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    chatMessages.innerHTML = '';
                    const now = Date.now();
                    const twelveHoursAgo = now - (12 * 60 * 60 * 1000);

                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const msgTimestamp = msg.timestamp.toDate().getTime();

                        // Only display messages sent within the last 12 hours
                        if (msgTimestamp > twelveHoursAgo) {
                            const messageElement = document.createElement('div');
                            messageElement.className = `chat-message ${msg.senderId === myId ? 'sent' : 'received'}`;
                            messageElement.textContent = msg.text;
                            chatMessages.appendChild(messageElement);
                        }
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
                    
                    // Mark all current user's *received* messages as read
                    // This should ideally be batched for performance
                    snapshot.forEach(async (doc) => {
                        const msg = doc.data();
                        if (msg.senderId !== myId && msg.read === false) {
                            await db.collection('chats').doc(chatId).collection('messages').doc(doc.id).update({ read: true });
                        }
                    });

                }, error => {
                    console.error("Error fetching messages:", error);
                    chatMessages.innerHTML = `<p style="text-align: center; color: var(--red-color);">Error loading messages: ${error.message}</p>`;
                });
        }
        
        // --- In-App Currency & Ads Logic ---
        function watchAdAndReward(type, amount) {
            alert(`Playing a video ad for ${type}. Please wait... (Simulated)`);
            
            // Simulate ad playback time
            setTimeout(async () => {
                rewardUser(type, amount); // Call the reward function after ad
            }, 5000); // Simulate 5 seconds for the ad
        }

        // This function would be called by your native app's WebView via JavaScript bridge
        // e.g., webview.RunJavaScript("rewardUser('coins', 10)"); in MIT App Inventor
        window.rewardUser = async function(type, amount) {
            if (!auth.currentUser) {
                console.error("No user logged in to reward.");
                return;
            }
            
            const update = {};
            update[type] = firebase.firestore.FieldValue.increment(amount);
            
            try {
                await db.collection('users').doc(auth.currentUser.uid).update(update);
                alert(`Ad watched! You have been rewarded with ${amount} ${type}.`);
                // Update UI immediately (onSnapshot will handle, but good to give feedback)
            } catch (error) {
                console.error('Error updating user currency:', error);
                alert(`Error rewarding ${type}: ${error.message}`);
            }
        };

        async function checkAndShowDailyReward() {
            if (!currentUserData || !auth.currentUser) return;

            const now = Date.now();
            const lastReward = currentUserData.lastDailyReward || 0;

            if (now - lastReward >= DAILY_REWARD_INTERVAL) {
                // It's time to show the reward
                rewardPopup.classList.remove('hidden');
                menuOverlay.classList.remove('hidden'); // Show overlay behind popup

                // Simulate notification
                setTimeout(() => {
                    if (!rewardPopup.classList.contains('hidden')) {
                        alert("Don't forget to claim your daily reward in AddMint!");
                    }
                }, 5 * 60 * 1000); // 5 minutes after popup shows
            } else {
                // Update gift button to show countdown
                updateGiftButtonCooldown();
            }
        }

        function updateGiftButtonCooldown() {
            if (!currentUserData) return;
            const now = Date.now();
            const lastReward = currentUserData.lastDailyReward || 0;
            const nextRewardTime = lastReward + DAILY_REWARD_INTERVAL;
            const timeLeftMs = nextRewardTime - now;

            if (timeLeftMs <= 0) {
                giftBtn.innerHTML = `<span class="material-symbols-outlined">redeem</span>`;
                // Animate gift button if ready
                giftBtn.style.animation = 'bounce 0.8s infinite alternate';
            } else {
                const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
                giftBtn.innerHTML = `<span class="material-symbols-outlined">timer</span><span style="font-size: 0.7rem; color: var(--accent-color); margin-left: 3px;">${hours}h ${minutes}m</span>`;
                giftBtn.style.animation = 'none'; // Stop animation
                setTimeout(updateGiftButtonCooldown, 60 * 1000); // Update every minute
            }
        }

        giftBtn.addEventListener('click', async () => {
            if (!currentUserData) return;
            const now = Date.now();
            const lastReward = currentUserData.lastDailyReward || 0;

            if (now - lastReward >= DAILY_REWARD_INTERVAL) {
                // Claim reward
                try {
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(10),
                        limits: firebase.firestore.FieldValue.increment(2),
                        credits: firebase.firestore.FieldValue.increment(10),
                        lastDailyReward: now
                    });
                    rewardPopup.classList.remove('hidden'); // Show reward popup
                    menuOverlay.classList.remove('hidden');
                    alert("Daily reward claimed! Check your balance.");
                } catch (error) {
                    console.error("Error claiming daily reward:", error);
                    alert("Error claiming reward. Please try again.");
                }
            } else {
                alert("You've already claimed your daily reward. Come back later!");
            }
        });

        claimRewardBtn.addEventListener('click', () => {
            rewardPopup.classList.add('hidden');
            menuOverlay.classList.add('hidden');
        });

        // --- Other Functions ---
        function setupRealtimeListeners() {
            if (!auth.currentUser) return;

            // Listen for changes in my own posts to update the count
            db.collection('posts').where('userId', '==', auth.currentUser.uid).onSnapshot(snapshot => {
                myPostCount.textContent = formatNumber(snapshot.size);
            }, error => console.error("Error listening to my posts:", error));
            
            // Listen for changes in my followers
            db.collection('followers').doc(auth.currentUser.uid).collection('following_me').onSnapshot(snapshot => {
                myFollowerCount.textContent = formatNumber(snapshot.size);
            }, error => console.error("Error listening to my followers:", error));
            
            // Listen for changes in who I'm following
            db.collection('following').doc(auth.currentUser.uid).collection('i_follow').onSnapshot(snapshot => {
                myFollowingCount.textContent = formatNumber(snapshot.size);
            }, error => console.error("Error listening to my following:", error));
        }

        // --- Search Functionality ---
        searchInput.addEventListener('input', debounce(async () => {
            const query = searchInput.value.trim().toLowerCase();
            searchResultsList.innerHTML = ''; // Clear previous results

            if (query.length === 0) {
                return;
            }

            try {
                // Search users by username (exact match or starts with)
                const userSnapshot = await db.collection('users')
                                            .where('username', '>=', query)
                                            .where('username', '<=', query + '\uf8ff')
                                            .limit(10) // Limit results for performance
                                            .get();

                if (userSnapshot.empty) {
                    searchResultsList.innerHTML = '<p style="text-align: center; color: #888;">No users found.</p>';
                } else {
                    for (const doc of userSnapshot.docs) {
                        const userData = doc.data();
                        if (userData.uid === auth.currentUser.uid) continue; // Don't show current user in search results
                        
                        const isFollowing = (await db.collection('followers').doc(userData.uid).collection('following_me').doc(auth.currentUser.uid).get()).exists;

                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.innerHTML = `
                            <div class="chat-avatar generated-logo">${userData.profileLogo}</div>
                            <div class="search-result-info">
                                <h3>${userData.name}</h3>
                                <p>@${userData.username}</p>
                            </div>
                            <button class="profile-follow-btn ${isFollowing ? 'unfollow' : 'follow'}" data-user-id="${userData.uid}">
                                ${isFollowing ? 'Unfollow' : 'Follow'}
                            </button>
                        `;
                        resultItem.addEventListener('click', (e) => {
                            // Only open profile if not clicking the follow button directly
                            if (!e.target.classList.contains('profile-follow-btn')) {
                                showOtherUserProfile(userData.uid);
                            }
                        });
                        resultItem.querySelector('.profile-follow-btn').addEventListener('click', async (e) => {
                            e.stopPropagation(); // Prevent opening profile when clicking follow button
                            await toggleFollow(userData.uid, isFollowing);
                            // Re-run search to update follow status in list
                            searchInput.dispatchEvent(new Event('input'));
                        });
                        searchResultsList.appendChild(resultItem);
                    }
                }
            } catch (error) {
                console.error("Error during search:", error);
                searchResultsList.innerHTML = `<p style="text-align: center; color: var(--red-color);">Error searching: ${error.message}</p>`;
            }
        }, 300)); // Debounce search input by 300ms

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        
        // --- Sound Effects ---
        let audioContext;
        function playSoundEffect() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.value = 440; // A4 note
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2); // Fade out over 0.2 seconds
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.warn('Web Audio API not supported or failed to initialize:', e);
            }
        }
        
        // Translate button (Placeholder for actual translation service)
        function toggleTranslation(postCardElement) {
            alert("Translation feature is coming soon! (Simulated)");
            // In a real app, you'd integrate with a translation API (e.g., Google Translate API)
            // and replace the text content of title/description with translated versions.
        }

        // Initial setup for the app (what to show first)
        // This is handled by auth.onAuthStateChanged on page load.
        // Make sure Firebase API Key is correctly set.
    </script>
</body>
</html>
