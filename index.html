<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FFC107; /* Amber */
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --button-hover: #45a049;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .text-center { text-align: center; }
        .full-width { width: 100%; }
        .padding-20 { padding: 20px; }
        .margin-top-20 { margin-top: 20px; }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), #2196F3); /* Blue */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        #splash-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        .app-logo-splash {
            width: 120px;
            height: 120px;
            background-color: #fff;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4em;
            font-weight: bold;
            color: var(--primary-color);
            box-shadow: 0 8px 20px var(--shadow-light);
            animation: bounceIn 1s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .splash-text {
            margin-top: 20px;
            font-size: 1.8em;
            font-weight: 500;
            animation: fadeIn 1s ease-in 0.5s forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Preloader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s ease-out;
        }
        #preloader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        header {
            background-color: var(--card-background);
            padding: 15px 20px;
            box-shadow: 0 2px 4px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 500;
            transition: background-color 0.3s ease;
        }
        .header-logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .header-logo-icon {
            width: 30px;
            height: 30px;
            background-color: var(--primary-color);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 8px;
            animation: pulse 2s infinite; /* Animation */
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .header-buttons button {
            background: none;
            border: none;
            font-size: 1.4em;
            color: var(--light-text-color);
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease;
        }
        .header-buttons button:hover {
            color: var(--primary-color);
        }

        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 20px;
            max-width: 900px;
            margin: 20px auto;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
        }

        /* Section Styling */
        .app-section {
            width: 100%;
            max-width: 450px; /* Max width for forms */
            padding: 0;
            box-sizing: border-box;
            text-align: center;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 500;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
            outline: none;
        }
        .password-toggle-group {
            position: relative;
        }
        .password-toggle-group input {
            padding-right: 40px;
        }
        .password-toggle-group .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--light-text-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-weight: 500;
        }
        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #a5d6a7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .message-box {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            line-height: 1.5;
            text-align: left;
        }
        .error-message {
            color: #d32f2f;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Post Creation Section */
        #create-post-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            box-sizing: border-box;
            max-width: 600px;
            width: 100%;
        }
        #create-post-section textarea {
            min-height: 80px;
            resize: vertical;
        }
        #post-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            object-fit: contain;
        }
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            color: var(--light-text-color);
            transition: border-color 0.3s ease;
        }
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        .upload-area input[type="file"] {
            display: none;
        }
        .upload-area i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        /* Posts Feed */
        #posts-feed {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr; /* Single column on mobile */
            width: 100%;
            max-width: 800px; /* Max width for post feed */
        }
        .post-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .post-info {
            flex-grow: 1;
        }
        .post-username {
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 2px;
            display: block;
        }
        .post-time {
            font-size: 0.85em;
            color: var(--light-text-color);
        }
        .post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            object-fit: cover;
            width: 100%;
            height: auto;
        }
        .post-text {
            margin-top: 15px;
            margin-bottom: 15px;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Break long words */
        }
        .post-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .post-actions button {
            background: none;
            border: none;
            color: var(--light-text-color);
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease, transform 0.1s ease;
            box-shadow: none;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .post-actions button:hover {
            color: var(--primary-color);
            background-color: rgba(76, 175, 80, 0.1);
            transform: translateY(-2px);
        }
        .post-actions button i {
            font-size: 1.2em;
        }
        .post-actions button.liked {
            color: #E91E63; /* Red for liked */
        }
        .contact-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .contact-buttons button {
            background-color: #f0f2f5; /* Light background for contact buttons */
            color: var(--text-color);
            font-size: 0.9em;
            padding: 8px 15px;
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width for buttons */
        }
        .contact-buttons button i {
            margin-right: 5px;
        }
        .contact-buttons .whatsapp-btn:hover { background-color: #25D366; color: white; }
        .contact-buttons .instagram-btn:hover { background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; }
        .contact-buttons .call-btn:hover { background-color: #007bff; color: white; }


        /* Profile Section */
        #profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }
        .profile-header {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 30px 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
            margin-bottom: 20px;
        }
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-color);
            margin: -60px auto 20px auto; /* Overlap with header */
            border: 4px solid var(--background-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #profile-username-display {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
        }
        #profile-email-display {
            font-size: 1em;
            color: var(--light-text-color);
            margin-bottom: 20px;
        }
        .profile-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .profile-info-item {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-color);
        }
        .profile-info-item i {
            font-size: 1.5em;
            color: var(--primary-color);
        }
        .profile-info-item span {
            font-size: 1.1em;
        }
        #logout-button {
            background-color: #f44336; /* Red for logout */
            margin-top: 30px;
            width: auto;
            align-self: center;
        }
        #logout-button:hover {
            background-color: #d32f2f;
        }
        #edit-profile-button {
            background-color: #03a9f4; /* Blue for edit */
            margin-top: 20px;
            width: auto;
            align-self: center;
        }
        #edit-profile-button:hover {
            background-color: #0288d1;
        }

        /* Edit Profile Section */
        #edit-profile-section {
            width: 100%;
            max-width: 450px;
            padding: 0;
            box-sizing: border-box;
        }

        /* Footer (Optional, can be removed if not needed) */
        footer {
            margin-top: auto; /* Push footer to bottom */
            padding: 15px 20px;
            background-color: var(--card-background);
            text-align: center;
            font-size: 0.9em;
            color: var(--light-text-color);
            box-shadow: 0 -2px 4px var(--shadow-light);
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            main {
                padding: 30px;
                margin: 30px auto;
            }
            #posts-feed {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* 2 columns on larger screens */
            }
            .header-buttons button {
                font-size: 1.6em;
            }
            .post-actions button {
                padding: 10px 15px;
                font-size: 1.05em;
            }
            .contact-buttons button {
                min-width: unset; /* Remove min-width on desktop */
                flex-grow: 0;
            }
            .profile-info-grid {
                grid-template-columns: repeat(2, 1fr); /* Two columns for profile info on wider screens */
            }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="app-logo-splash">A</div>
        <p class="splash-text">AddMint - Connect & Share</p>
    </div>

    <div id="preloader" class="hidden">
        <div class="spinner"></div>
    </div>

    <header id="app-header" class="hidden">
        <div class="header-logo" onclick="showSection('feed-section')">
            <div class="header-logo-icon">A</div>
            <span>AddMint</span>
        </div>
        <div class="header-buttons">
            <button id="home-btn" title="Home" onclick="showSection('feed-section'); fetchPosts()"><i class="fas fa-home"></i></button>
            <button id="create-post-btn" title="Create Post" onclick="showSection('create-post-section')"><i class="fas fa-plus-circle"></i></button>
            <button id="profile-btn" title="Profile" onclick="showSection('profile-section'); fetchUserProfile(currentUserId)"><i class="fas fa-user-circle"></i></button>
            <button id="refresh-btn" title="Refresh" onclick="fetchPosts()"><i class="fas fa-sync-alt"></i></button>
        </div>
    </header>

    <main id="main-content">
        <section id="signup-auth" class="app-section hidden">
            <h2>Create Your Account</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group password-toggle-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required minlength="6">
                    <span class="toggle-password" onclick="togglePasswordVisibility('signupPassword')"><i class="fa fa-eye"></i></span>
                </div>
                <div class="form-group password-toggle-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" required minlength="6">
                    <span class="toggle-password" onclick="togglePasswordVisibility('signupConfirmPassword')"><i class="fa fa-eye"></i></span>
                </div>
                <button type="submit" id="signupButton">Sign Up</button>
                <p class="error-message" id="signup-error-message"></p>
                <p class="margin-top-20">Already have an account? <a href="#" onclick="showSection('signin-auth')">Sign In</a></p>
            </form>
        </section>

        <section id="signin-auth" class="app-section hidden">
            <h2>Welcome Back!</h2>
            <form id="signin-form">
                <div class="form-group">
                    <label for="signinEmail">Email</label>
                    <input type="email" id="signinEmail" required>
                </div>
                <div class="form-group password-toggle-group">
                    <label for="signinPassword">Password</label>
                    <input type="password" id="signinPassword" required>
                    <span class="toggle-password" onclick="togglePasswordVisibility('signinPassword')"><i class="fa fa-eye"></i></span>
                </div>
                <button type="submit" id="signinButton">Sign In</button>
                <p class="error-message" id="signin-error-message"></p>
                <p class="margin-top-20">Don't have an account? <a href="#" onclick="showSection('signup-auth')">Sign Up</a></p>
            </form>
        </section>

        <section id="email-verify" class="app-section hidden">
            <h2>Verify Your Email</h2>
            <div class="message-box">
                <p id="verify-email-message"></p>
                <p>If you didn't receive the email, please check your spam folder or click the button below to resend.</p>
            </div>
            <button id="resend-verify-email-btn">Resend Verification Email</button>
            <button id="signout-after-verify-btn" class="margin-top-20">Sign Out & Try Again</button>
            <p class="error-message" id="verify-error-message"></p>
        </section>

        <section id="setup-profile" class="app-section hidden">
            <h2>Complete Your Profile</h2>
            <form id="setup-profile-form">
                <div class="form-group">
                    <label for="newUsername">Your Name</label>
                    <input type="text" id="newUsername" placeholder="Enter your display name" required>
                </div>
                <div class="form-group">
                    <label for="whatsappNumber">WhatsApp Number (Optional)</label>
                    <input type="number" id="whatsappNumber" placeholder="e.g., 919876543210 (include country code)">
                </div>
                <div class="form-group">
                    <label for="instagramHandle">Instagram Handle (Optional)</label>
                    <input type="text" id="instagramHandle" placeholder="e.g., @yourhandle">
                </div>
                <button type="submit" id="saveProfileButton">Save Profile</button>
                <p class="error-message" id="profile-setup-error-message"></p>
            </form>
        </section>

        <section id="feed-section" class="app-section hidden">
            <h2>Latest Posts</h2>
            <div id="posts-feed">
                <p class="text-center" id="no-posts-message">No posts available. Be the first to create one!</p>
            </div>
        </section>

        <section id="create-post-section" class="app-section hidden">
            <h2>Create New Post</h2>
            <form id="new-post-form">
                <div class="form-group">
                    <label for="postText">What's on your mind?</label>
                    <textarea id="postText" placeholder="Write your post here..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="postImage">Attach Image (Optional)</label>
                    <div class="upload-area" onclick="document.getElementById('postImage').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Click to upload image or drag and drop</span>
                        <input type="file" id="postImage" accept="image/*">
                    </div>
                    <img id="post-image-preview" src="#" alt="Image Preview">
                    <button type="button" id="removeImageButton" class="hidden margin-top-20" style="background-color: #f44336;">Remove Image</button>
                </div>
                <button type="submit" id="submitPostButton">Post Now</button>
                <p class="error-message" id="post-error-message"></p>
            </form>
        </section>

        <section id="profile-section" class="app-section hidden">
            <div class="profile-header full-width">
                </div>
            <div class="profile-avatar-large" id="profile-avatar-display">A</div>
            <p id="profile-username-display" class="full-width text-center"></p>
            <p id="profile-email-display" class="full-width text-center"></p>

            <div class="profile-info-grid">
                <div class="profile-info-item hidden" id="profile-whatsapp-item">
                    <i class="fab fa-whatsapp"></i> <span id="profile-whatsapp-display"></span>
                </div>
                <div class="profile-info-item hidden" id="profile-instagram-item">
                    <i class="fab fa-instagram"></i> <span id="profile-instagram-display"></span>
                </div>
            </div>

            <button id="edit-profile-button">Edit Profile</button>
            <button id="logout-button">Logout</button>
        </section>

        <section id="edit-profile-section" class="app-section hidden">
            <h2>Edit Your Profile</h2>
            <form id="edit-profile-form">
                <div class="form-group">
                    <label for="editUsername">Your Name</label>
                    <input type="text" id="editUsername" required>
                </div>
                <div class="form-group">
                    <label for="editWhatsappNumber">WhatsApp Number (Optional)</label>
                    <input type="number" id="editWhatsappNumber" placeholder="e.g., 919876543210 (include country code)">
                </div>
                <div class="form-group">
                    <label for="editInstagramHandle">Instagram Handle (Optional)</label>
                    <input type="text" id="editInstagramHandle" placeholder="e.g., @yourhandle">
                </div>
                <button type="submit" id="saveEditedProfileButton">Save Changes</button>
                <button type="button" class="margin-top-20" onclick="showSection('profile-section'); fetchUserProfile(currentUserId)" style="background-color: #6c757d;">Cancel</button>
                <p class="error-message" id="edit-profile-error-message"></p>
            </form>
        </section>

    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUserId = null;
        let currentUserData = {}; // To store current user's profile data

        // --- UI State Management ---
        const splashScreen = document.getElementById('splash-screen');
        const preloader = document.getElementById('preloader');
        const appHeader = document.getElementById('app-header');
        const sections = document.querySelectorAll('.app-section');

        function showPreloader() { preloader.classList.remove('hidden'); }
        function hidePreloader() { preloader.classList.add('hidden'); }

        function showSection(id) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            // Hide keyboard on section change
            if (document.activeElement && document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                document.activeElement.blur();
            }
        }

        function showMainAppUI() {
            appHeader.classList.remove('hidden');
            showSection('feed-section'); // Default to feed after login
            fetchPosts();
        }

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // --- Firebase Authentication ---

        // Signup
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorMessage = document.getElementById('signup-error-message');
            errorMessage.textContent = '';
            document.getElementById('signupButton').disabled = true;

            if (password !== confirmPassword) {
                errorMessage.textContent = "Passwords do not match.";
                document.getElementById('signupButton').disabled = false;
                return;
            }

            try {
                showPreloader();
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                errorMessage.textContent = '';
                alert('Account created! A verification link has been sent to your email. Please verify your email before signing in.');
                showSection('signin-auth'); // Go to sign-in after signup
            } catch (error) {
                console.error("Signup Error:", error.code, error.message);
                switch(error.code) {
                    case 'auth/email-already-in-use': errorMessage.textContent = 'This email is already in use.'; break;
                    case 'auth/invalid-email': errorMessage.textContent = 'Invalid email address.'; break;
                    case 'auth/weak-password': errorMessage.textContent = 'Password is too weak (min 6 characters).'; break;
                    default: errorMessage.textContent = 'Error: ' + error.message;
                }
            } finally {
                hidePreloader();
                document.getElementById('signupButton').disabled = false;
            }
        });

        // Signin
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const errorMessage = document.getElementById('signin-error-message');
            errorMessage.textContent = '';
            document.getElementById('signinButton').disabled = true;

            try {
                showPreloader();
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    errorMessage.textContent = 'Please verify your email address first. Check your inbox for the verification link.';
                    // Optionally, you can offer to resend the email here
                    await auth.signOut(); // Sign out unverified user
                    showSection('email-verify');
                    document.getElementById('verify-email-message').textContent = `Your email ${email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    return;
                }
                errorMessage.textContent = '';
                // auth.onAuthStateChanged will handle UI updates
            } catch (error) {
                console.error("Signin Error:", error.code, error.message);
                switch(error.code) {
                    case 'auth/invalid-email': errorMessage.textContent = 'Invalid email address.'; break;
                    case 'auth/user-disabled': errorMessage.textContent = 'Your account has been disabled.'; break;
                    case 'auth/user-not-found': errorMessage.textContent = 'No account found with this email.'; break;
                    case 'auth/wrong-password': errorMessage.textContent = 'Incorrect password.'; break;
                    default: errorMessage.textContent = 'Error: ' + error.message;
                }
            } finally {
                hidePreloader();
                document.getElementById('signinButton').disabled = false;
            }
        });

        // Email verification resend
        document.getElementById('resend-verify-email-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            const errorMessage = document.getElementById('verify-error-message');
            errorMessage.textContent = '';
            if (user) {
                try {
                    showPreloader();
                    await user.sendEmailVerification();
                    alert('Verification email sent! Please check your inbox.');
                } catch (error) {
                    console.error("Resend Email Error:", error);
                    errorMessage.textContent = 'Failed to send verification email. Try again later.';
                } finally {
                    hidePreloader();
                }
            } else {
                errorMessage.textContent = 'No active user to send verification email.';
            }
        });

        // Sign out from verification page
        document.getElementById('signout-after-verify-btn').addEventListener('click', async () => {
            try {
                showPreloader();
                await auth.signOut();
                showSection('signin-auth');
            } catch (error) {
                console.error("Signout Error:", error);
                alert('Error signing out. Please refresh and try again.');
            } finally {
                hidePreloader();
            }
        });


        // Profile Setup
        document.getElementById('setup-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const whatsapp = document.getElementById('whatsappNumber').value.trim();
            const instagram = document.getElementById('instagramHandle').value.trim();
            const errorMessage = document.getElementById('profile-setup-error-message');
            errorMessage.textContent = '';
            document.getElementById('saveProfileButton').disabled = true;

            if (!username) {
                errorMessage.textContent = "Please enter your name.";
                document.getElementById('saveProfileButton').disabled = false;
                return;
            }

            try {
                showPreloader();
                await db.collection('users').doc(currentUserId).set({
                    username: username,
                    email: auth.currentUser.email,
                    whatsapp: whatsapp || '', // Store empty string if not provided
                    instagram: instagram || '', // Store empty string if not provided
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge to update if document already exists
                currentUserData = { username, email: auth.currentUser.email, whatsapp, instagram };
                showMainAppUI();
            } catch (error) {
                console.error("Profile Setup Error:", error);
                errorMessage.textContent = 'Failed to save profile. Please try again.';
            } finally {
                hidePreloader();
                document.getElementById('saveProfileButton').disabled = false;
            }
        });

        // Fetch User Profile
        async function fetchUserProfile(userId) {
            showPreloader();
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    document.getElementById('profile-avatar-display').textContent = currentUserData.username ? currentUserData.username.charAt(0).toUpperCase() : 'A';
                    document.getElementById('profile-username-display').textContent = currentUserData.username || 'N/A';
                    document.getElementById('profile-email-display').textContent = currentUserData.email || 'N/A';

                    if (currentUserData.whatsapp) {
                        document.getElementById('profile-whatsapp-display').textContent = currentUserData.whatsapp;
                        document.getElementById('profile-whatsapp-item').classList.remove('hidden');
                    } else {
                        document.getElementById('profile-whatsapp-item').classList.add('hidden');
                    }

                    if (currentUserData.instagram) {
                        document.getElementById('profile-instagram-display').textContent = currentUserData.instagram;
                        document.getElementById('profile-instagram-item').classList.remove('hidden');
                    } else {
                        document.getElementById('profile-instagram-item').classList.add('hidden');
                    }

                    // Pre-fill edit profile form
                    document.getElementById('editUsername').value = currentUserData.username || '';
                    document.getElementById('editWhatsappNumber').value = currentUserData.whatsapp || '';
                    document.getElementById('editInstagramHandle').value = currentUserData.instagram || '';

                } else {
                    console.warn("User profile not found for ID:", userId);
                    currentUserData = { username: 'Guest', email: auth.currentUser.email };
                    document.getElementById('profile-avatar-display').textContent = 'G';
                    document.getElementById('profile-username-display').textContent = 'Guest User';
                    document.getElementById('profile-email-display').textContent = auth.currentUser.email;
                    document.getElementById('profile-whatsapp-item').classList.add('hidden');
                    document.getElementById('profile-instagram-item').classList.add('hidden');
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                alert('Error loading profile. Please try again.');
            } finally {
                hidePreloader();
            }
        }

        // Edit Profile
        document.getElementById('edit-profile-button').addEventListener('click', () => {
            showSection('edit-profile-section');
        });

        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('editUsername').value.trim();
            const whatsapp = document.getElementById('editWhatsappNumber').value.trim();
            const instagram = document.getElementById('editInstagramHandle').value.trim();
            const errorMessage = document.getElementById('edit-profile-error-message');
            errorMessage.textContent = '';
            document.getElementById('saveEditedProfileButton').disabled = true;

            if (!username) {
                errorMessage.textContent = "Please enter your name.";
                document.getElementById('saveEditedProfileButton').disabled = false;
                return;
            }

            try {
                showPreloader();
                await db.collection('users').doc(currentUserId).update({
                    username: username,
                    whatsapp: whatsapp || '',
                    instagram: instagram || ''
                });
                alert('Profile updated successfully!');
                currentUserData = { ...currentUserData, username, whatsapp, instagram }; // Update local data
                showSection('profile-section');
                fetchUserProfile(currentUserId); // Re-fetch to update UI
            } catch (error) {
                console.error("Edit Profile Error:", error);
                errorMessage.textContent = 'Failed to update profile. Please try again.';
            } finally {
                hidePreloader();
                document.getElementById('saveEditedProfileButton').disabled = false;
            }
        });


        // Logout
        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                showPreloader();
                await auth.signOut();
                appHeader.classList.add('hidden');
                currentUserId = null;
                currentUserData = {};
                showSection('signin-auth'); // Go back to sign-in page
            } catch (error) {
                console.error("Logout Error:", error);
                alert('Error logging out. Please try again.');
            } finally {
                hidePreloader();
            }
        });

        // --- Post Management ---

        // Image Upload Preview
        const postImageInput = document.getElementById('postImage');
        const postImagePreview = document.getElementById('post-image-preview');
        const removeImageButton = document.getElementById('removeImageButton');
        let selectedImageFile = null;

        postImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    postImagePreview.src = e.target.result;
                    postImagePreview.style.display = 'block';
                    removeImageButton.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                selectedImageFile = null;
                postImagePreview.style.display = 'none';
                postImagePreview.src = '#';
                removeImageButton.classList.add('hidden');
            }
        });

        removeImageButton.addEventListener('click', () => {
            selectedImageFile = null;
            postImageInput.value = ''; // Clear the file input
            postImagePreview.style.display = 'none';
            postImagePreview.src = '#';
            removeImageButton.classList.add('hidden');
        });

        // Create New Post
        document.getElementById('new-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const postText = document.getElementById('postText').value.trim();
            const errorMessage = document.getElementById('post-error-message');
            errorMessage.textContent = '';
            document.getElementById('submitPostButton').disabled = true;

            if (!postText && !selectedImageFile) {
                errorMessage.textContent = "Please write something or attach an image to your post.";
                document.getElementById('submitPostButton').disabled = false;
                return;
            }

            try {
                showPreloader();
                let imageUrl = '';
                if (selectedImageFile) {
                    const storageRef = storage.ref(`post_images/${currentUserId}/${Date.now()}_${selectedImageFile.name}`);
                    const uploadTask = await storageRef.put(selectedImageFile);
                    imageUrl = await uploadTask.ref.getDownloadURL();
                }

                // Calculate expiry time (12 hours from now)
                const expiryTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours in milliseconds

                await db.collection('posts').add({
                    userId: currentUserId,
                    username: currentUserData.username || 'Anonymous', // Use stored username
                    postText: postText,
                    imageUrl: imageUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: expiryTime, // Store expiry timestamp
                    likes: [], // Array of user UIDs who liked the post
                });

                alert('Post created successfully!');
                document.getElementById('postText').value = '';
                removeImageButton.click(); // Clear image preview
                fetchPosts(); // Refresh feed
                showSection('feed-section'); // Go back to feed
            } catch (error) {
                console.error("Create Post Error:", error);
                errorMessage.textContent = 'Failed to create post. Please try again.';
            } finally {
                hidePreloader();
                document.getElementById('submitPostButton').disabled = false;
            }
        });

        // Fetch and Display Posts
        async function fetchPosts() {
            showPreloader();
            const postsFeed = document.getElementById('posts-feed');
            postsFeed.innerHTML = ''; // Clear existing posts
            const noPostsMessage = document.getElementById('no-posts-message');
            noPostsMessage.classList.add('hidden');

            const now = Date.now(); // Current client time

            try {
                const snapshot = await db.collection('posts')
                                         .orderBy('createdAt', 'desc') // Order by latest posts
                                         .get();

                if (snapshot.empty) {
                    noPostsMessage.classList.remove('hidden');
                    return;
                }

                let postsHtml = '';
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;

                    // Client-side check for expiryTime
                    if (post.expiresAt && post.expiresAt < now) {
                        // This post is expired, do not display it.
                        // It will also be filtered by security rules for reads.
                        // We will rely on cleanupOldPosts to eventually delete it from Firestore.
                        console.log(`Post ${postId} expired, not displaying.`);
                        return;
                    }

                    const postCreatedAt = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Just now';
                    const isLiked = post.likes && post.likes.includes(currentUserId);
                    const likeCount = post.likes ? post.likes.length : 0;

                    let contactButtonsHtml = '';
                    if (post.userId === currentUserId) {
                        // User's own post, show delete option
                        contactButtonsHtml += `<button onclick="deletePost('${postId}', '${post.imageUrl}')" style="background-color: #f44336; color: white;"><i class="fas fa-trash"></i> Delete Post</button>`;
                    } else {
                        // Other user's post, show contact options based on their profile
                        if (post.userId && typeof post.userId === 'string') { // Ensure userId exists and is a string
                            db.collection('users').doc(post.userId).get().then(userDoc => {
                                if (userDoc.exists) {
                                    const userData = userDoc.data();
                                    let dynamicButtons = '';
                                    if (userData.whatsapp) {
                                        dynamicButtons += `<button class="whatsapp-btn" onclick="openWhatsApp('${userData.whatsapp}')"><i class="fab fa-whatsapp"></i> WhatsApp</button>`;
                                    }
                                    if (userData.instagram) {
                                        dynamicButtons += `<button class="instagram-btn" onclick="openInstagram('${userData.instagram}')"><i class="fab fa-instagram"></i> Instagram</button>`;
                                    }
                                    if (userData.whatsapp || userData.instagram) { // Assuming whatsapp number is also callable if needed
                                        dynamicButtons += `<button class="call-btn" onclick="makePhoneCall('${userData.whatsapp || ''}')"><i class="fas fa-phone"></i> Call</button>`;
                                    }

                                    if(dynamicButtons) {
                                        document.getElementById(`contact-buttons-${postId}`).innerHTML = dynamicButtons;
                                    } else {
                                        document.getElementById(`contact-buttons-container-${postId}`).classList.add('hidden'); // Hide if no contact info
                                    }
                                }
                            }).catch(err => console.error("Error fetching contact info for post:", postId, err));
                        }
                    }

                    postsHtml += `
                        <div class="post-card" id="post-${postId}">
                            <div class="post-header">
                                <div class="post-avatar">${post.username ? post.username.charAt(0).toUpperCase() : 'A'}</div>
                                <div class="post-info">
                                    <span class="post-username">${post.username || 'Anonymous'}</span>
                                    <span class="post-time">${postCreatedAt}</span>
                                </div>
                            </div>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image">` : ''}
                            <p class="post-text">${post.postText}</p>
                            <div class="post-actions">
                                <button onclick="toggleLike('${postId}', ${isLiked})">
                                    <i class="${isLiked ? 'fas fa-heart' : 'far fa-heart'}"></i>
                                    <span id="likes-count-${postId}">${likeCount}</span> Likes
                                </button>
                                <button onclick="copyPostText('${post.postText}')"><i class="fas fa-copy"></i> Copy Text</button>
                                <button onclick="showAdAndThenCopyLink('${post.imageUrl || ''}')"><i class="fas fa-share-alt"></i> Share Link</button>
                            </div>
                            <div class="contact-buttons" id="contact-buttons-${postId}">
                                </div>
                            <div id="contact-buttons-container-${postId}" class="text-center"></div>
                        </div>
                    `;
                });
                postsFeed.innerHTML = postsHtml;

            } catch (error) {
                console.error("Error fetching posts:", error);
                noPostsMessage.textContent = "Error loading posts. Please try again later.";
                noPostsMessage.classList.remove('hidden');
            } finally {
                hidePreloader();
            }
        }

        // Toggle Like on Post
        async function toggleLike(postId, isCurrentlyLiked) {
            if (!currentUserId) {
                alert('Please sign in to like posts.');
                return;
            }
            showPreloader();
            try {
                const postRef = db.collection('posts').doc(postId);
                if (isCurrentlyLiked) {
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUserId)
                    });
                } else {
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUserId)
                    });
                }
                // Refresh just the likes for this post (more efficient than re-fetching all posts)
                const postDoc = await postRef.get();
                if (postDoc.exists) {
                    const postData = postDoc.data();
                    const newLikesCount = postData.likes ? postData.likes.length : 0;
                    const likesBtn = document.querySelector(`#post-${postId} button[onclick*='toggleLike']`);
                    if (likesBtn) {
                        const icon = likesBtn.querySelector('i');
                        icon.classList.toggle('fas', !isCurrentlyLiked);
                        icon.classList.toggle('far', isCurrentlyLiked);
                        likesBtn.querySelector('span').textContent = newLikesCount;
                        likesBtn.classList.toggle('liked', !isCurrentlyLiked); // Add/remove 'liked' class for styling
                    }
                }
            } catch (error) {
                console.error("Error toggling like:", error);
                alert('Failed to update like. Please try again.');
            } finally {
                hidePreloader();
            }
        }


        // Delete Post
        async function deletePost(postId, imageUrl) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }
            showPreloader();
            try {
                // Delete image from storage if it exists
                if (imageUrl) {
                    const imageRef = storage.refFromURL(imageUrl);
                    await imageRef.delete();
                    console.log('Image deleted from storage.');
                }
                // Delete post document from Firestore
                await db.collection('posts').doc(postId).delete();
                alert('Post deleted successfully!');
                fetchPosts(); // Refresh feed
            } catch (error) {
                console.error("Error deleting post:", error);
                alert('Failed to delete post. Please try again.');
            } finally {
                hidePreloader();
            }
        }

        // --- Ad and Deep Link Integration (via App Inventor WebViewer String) ---

        // Function to call App Inventor with a message
        function callAppInventor(message) {
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                window.AppInventor.setWebViewString(message);
                console.log("Sent to App Inventor:", message);
            } else {
                console.warn("AppInventor.setWebViewString is not available. Running in browser or companion app without bridge.");
                alert("This feature requires the AddMint Android app.");
            }
        }

        // Functions for App Inventor to call back to JS
        window.adRequested = (status) => {
            console.log("Ad request status:", status);
            // Handle status if needed. For now, we assume App Inventor will handle showing the ad
        };

        window.adRequestedForExpiry = (status) => {
            console.log("Ad request for expiry status:", status);
            // Handle status if needed.
        };

        window.updateCoins = () => {
            alert('Congratulations! You received coins for watching the ad!');
            // Here you would typically update a user's coin balance in Firebase
            // For example: db.collection('users').doc(currentUserId).update({ coins: firebase.firestore.FieldValue.increment(5) });
            // Then update UI. For simplicity, just an alert for now.
        };

        window.updateCredits = () => {
            alert('Congratulations! You received credits for watching the ad!');
            // Similar to coins, update user's credit balance
        };

        window.adWatchedForPostExpiry = (postId) => {
            console.log(`Ad watched for post expiry. Attempting to copy link for post: ${postId}`);
            // Logic to fetch post link and copy to clipboard after ad
            // Note: This might be redundant if copyPostText already does the copying
            // For this setup, `showAdAndThenCopyLink` should handle the flow.
        };

        // --- Action Buttons ---

        function copyPostText(textToCopy) {
            callAppInventor("COPY_TEXT:" + textToCopy);
        }

        function showAdAndThenCopyLink(imageUrl) {
            if (!imageUrl) {
                alert("No image link to share for this post.");
                return;
            }
            // Request App Inventor to show an ad and then copy the URL
            callAppInventor("OPEN_AND_COPY_URL:" + imageUrl);
            // The App Inventor side will handle showing the ad and then copying.
            // No direct callback needed here in HTML for the copy part.
        }

        function openWhatsApp(number) {
            if (!number) {
                alert('WhatsApp number not available.');
                return;
            }
            callAppInventor("CONTACT:WHATSAPP:" + number);
        }

        function openInstagram(handle) {
            if (!handle) {
                alert('Instagram handle not available.');
                return;
            }
            callAppInventor("CONTACT:INSTAGRAM:" + handle);
        }

        function makePhoneCall(number) {
            if (!number) {
                alert('Phone number not available.');
                return;
            }
            callAppInventor("CONTACT:PHONE:" + number);
        }

        // --- Cleanup Expired Posts (Client-side) ---
        async function cleanupOldPosts() {
            if (!currentUserId) {
                console.log("Not logged in, skipping cleanup.");
                return;
            }

            console.log("Attempting to clean up old posts...");
            const now = Date.now();
            let cleanedUpCount = 0;

            try {
                // Fetch a small batch of posts that are likely expired.
                // We cannot use .where('expiryTime', '<', now) AND .orderBy() directly
                // without an index on both, which might be overkill for cleanup.
                // Instead, we'll fetch ordered by createdAt and filter client-side,
                // then apply batch delete for truly expired ones.
                const snapshot = await db.collection('posts')
                                         .orderBy('createdAt', 'desc') // Get recent posts first, hoping some expired are among them
                                         .limit(20) // Limit the number of posts to check at once
                                         .get();

                if (snapshot.empty) {
                    console.log("No posts found for cleanup in this batch.");
                    return;
                }

                const batch = db.batch();
                const deletePromises = [];

                snapshot.forEach(doc => {
                    const postData = doc.data();
                    const postId = doc.id;

                    // Ensure expiryTime exists and is a number before comparison
                    if (postData.expiresAt && typeof postData.expiresAt === 'number' && postData.expiresAt < now) {
                        console.log(`Scheduling post ${postId} for deletion (expired at ${new Date(postData.expiresAt).toLocaleString()}).`);
                        batch.delete(db.collection('posts').doc(postId));
                        cleanedUpCount++;

                        // Also delete image from storage if exists
                        if (postData.imageUrl && postData.imageUrl.includes('firebasestorage.googleapis.com')) {
                            const imageRef = storage.refFromURL(postData.imageUrl);
                            deletePromises.push(imageRef.delete().catch(err => console.error("Error deleting old post image:", err)));
                        }
                    }
                });

                if (cleanedUpCount > 0) {
                    await batch.commit();
                    await Promise.all(deletePromises);
                    console.log(`Cleaned up ${cleanedUpCount} expired posts.`);
                    // After cleanup, re-fetch posts to ensure UI is updated
                    fetchPosts();
                } else {
                    console.log("No actually expired posts found in this batch after checking.");
                }

            } catch (error) {
                console.error("Error during old post cleanup:", error);
            }
        }


        // --- Initial Load & Auth State Handling ---
        document.addEventListener('DOMContentLoaded', () => {
            // Splash screen logic
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                // Give time for fade-out animation before hiding completely
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    showPreloader(); // Show preloader while auth state is determined
                }, 500); // Matches fade-out transition duration
            }, 2000); // Splash screen visible for 2 seconds

            // Firebase Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                hidePreloader(); // Hide preloader once user state is determined

                if (user) {
                    currentUserId = user.uid;
                    if (user.emailVerified) {
                        const userDoc = await db.collection('users').doc(currentUserId).get();
                        if (!userDoc.exists || !userDoc.data().username) {
                            // If profile not set up, go to setup
                            showSection('setup-profile');
                            if (user.displayName) {
                                document.getElementById('newUsername').value = user.displayName;
                            }
                        } else {
                            // Profile exists, show main app
                            currentUserData = userDoc.data(); // Load current user data
                            showMainAppUI();
                            cleanupOldPosts(); // Call cleanup when user logs in/app starts
                        }
                    } else {
                        // Email not verified, show verification section
                        showSection('email-verify');
                        document.getElementById('verify-email-message').textContent = `Your email ${user.email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    }
                } else {
                    // No user logged in, show signin
                    showSection('signin-auth');
                }
            });
        });
    </script>
</body>
</html>
