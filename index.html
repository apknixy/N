<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddMint - Your Social Hub</title>
    <style>
        /* Global Styles & Dark Mode */
        :root {
            --background-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #BB86FC;
            --on-background: #E0E0E0;
            --on-surface: #E0E0E0;
            --text-color-light: #B0B0B0;
            --text-color-dark: #FFFFFF;
            --border-color: #333333;
            --button-bg: #BB86FC;
            --button-text: #000000;
            --input-bg: #2C2C2C;
            --input-border: #444444;
            --error-color: #CF6679;
            --success-color: #03DAC6;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --placeholder-color: #666;
            --ad-animation-color: #00BCD4; /* Cyan for ad animation */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--on-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .full-screen { width: 100vw; height: 100vh; }
        .fade-out { opacity: 0; transition: opacity 0.5s ease-out; }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
            animation: fadeIn 0.5s ease-in;
        }

        .splash-logo {
            font-family: 'Pacifico', cursive; /* Example: A fancy font for logo */
            font-size: 3em;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(187, 134, 252, 0.7);
            animation: pulse 2s infinite ease-in-out;
            margin-bottom: 20px;
        }
        .splash-tagline {
            font-size: 1em;
            color: var(--text-color-light);
            animation: slideUp 1s ease-out forwards;
            opacity: 0;
            animation-delay: 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Preloader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--primary-color);
            font-size: 1.2em;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Sections Styling */
        .app-section {
            background-color: var(--background-color);
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: none; /* Hidden by default */
            animation: slideInFromRight 0.5s ease-out;
            width: 100%;
            max-width: 800px; /* Max width for desktop */
            margin: 0 auto;
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .app-section.active {
            display: flex;
            flex-direction: column;
        }

        /* Headers */
        header {
            background-color: var(--surface-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 10;
            position: sticky;
            top: 0;
            width: 100%;
            box-sizing: border-box;
            max-width: 800px; /* Match app-section max-width */
            margin: 0 auto;
            border-bottom: 1px solid var(--border-color);
        }
        .header-logo {
            font-family: 'Pacifico', cursive; /* Example: A fancy font for logo */
            font-size: 1.8em;
            color: var(--primary-color);
            animation: adPulse 2s infinite alternate; /* Continuous animation */
        }
        @keyframes adPulse {
            0% { transform: scale(1); color: var(--primary-color); text-shadow: 0 0 5px var(--primary-color); }
            50% { transform: scale(1.03); color: var(--ad-animation-color); text-shadow: 0 0 10px var(--ad-animation-color); }
            100% { transform: scale(1); color: var(--primary-color); text-shadow: 0 0 5px var(--primary-color); }
        }
        .header-buttons button {
            background: none;
            border: none;
            color: var(--on-surface);
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s ease;
        }
        .header-buttons button:hover {
            color: var(--primary-color);
        }

        /* Forms Styling */
        .form-container {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin: auto; /* Center the form */
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-container h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .input-group {
            position: relative;
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--on-surface);
            font-size: 0.9em;
        }
        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group textarea {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--on-surface);
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(187, 134, 252, 0.3);
        }
        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: var(--placeholder-color);
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 70%; /* Adjust based on label and input height */
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-color-light);
            cursor: pointer;
            font-size: 1em;
            padding: 5px;
            z-index: 2;
        }
        .password-toggle:hover {
            color: var(--primary-color);
        }

        button.primary-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            font-weight: bold;
        }
        button.primary-btn:hover {
            background-color: #A06FEF; /* Slightly darker purple */
            transform: translateY(-2px);
        }
        button.primary-btn:active {
            transform: translateY(0);
        }
        .form-link {
            text-align: center;
            margin-top: 15px;
        }
        .form-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }
        .form-link a:hover {
            text-decoration: underline;
            color: #BB86FC;
        }
        .message {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .message.error {
            background-color: rgba(207, 102, 121, 0.2);
            color: var(--error-color);
        }
        .message.success {
            background-color: rgba(3, 218, 198, 0.2);
            color: var(--success-color);
        }

        /* Post Feed Styling */
        #post-feed {
            display: grid;
            gap: 20px;
            padding-bottom: 70px; /* Space for bottom navigation */
        }
        .post-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-5px);
        }
        .post-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color); /* Placeholder */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--button-text);
            margin-right: 10px;
        }
        .post-username {
            font-weight: bold;
            color: var(--on-surface);
        }
        .post-content {
            padding: 15px;
            color: var(--on-background);
            line-height: 1.6;
            word-wrap: break-word;
        }
        .post-image {
            width: 100%;
            max-height: 400px; /* Limit image height */
            object-fit: cover;
            display: block;
        }
        .post-actions {
            display: flex;
            justify-content: space-around;
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
        }
        .post-actions button {
            background: none;
            border: none;
            color: var(--text-color-light);
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        .post-actions button:hover {
            color: var(--primary-color);
        }
        .post-actions button.liked {
            color: var(--error-color); /* Red for liked */
        }
        .post-timestamp {
            font-size: 0.8em;
            color: var(--text-color-light);
            margin-left: auto;
        }

        /* Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: 80px; /* Above bottom nav */
            right: 20px;
            background-color: var(--primary-color);
            color: var(--button-text);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 2em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            cursor: pointer;
            z-index: 50;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .fab:hover {
            background-color: #A06FEF;
            transform: translateY(-2px);
        }

        /* Bottom Navigation */
        footer {
            background-color: var(--surface-color);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            box-sizing: border-box;
            max-width: 800px; /* Match app-section max-width */
            margin: 0 auto;
            border-top: 1px solid var(--border-color);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color-light);
            font-size: 0.7em;
            text-decoration: none;
            cursor: pointer;
            padding: 5px 10px;
            transition: color 0.3s ease;
        }
        .nav-item i {
            font-size: 1.4em;
            margin-bottom: 3px;
        }
        .nav-item:hover, .nav-item.active {
            color: var(--primary-color);
        }

        /* Modal / Dialog Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.7);
            width: 90%;
            max-width: 500px;
            animation: slideInFromTop 0.3s ease-out;
            box-sizing: border-box;
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.5em;
        }
        .close-button {
            color: var(--text-color-light);
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
            cursor: pointer;
        }
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-body .input-group {
            margin-bottom: 0; /* Override default margin */
        }
        .modal-body textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        .modal-footer button {
            background-color: var(--primary-color);
            color: var(--button-text);
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal-footer button:hover {
            background-color: #A06FEF;
        }

        /* AI Chat Specific Styles */
        #ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: var(--primary-color);
            color: var(--button-text);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .chat-message.ai {
            background-color: #444;
            color: var(--on-surface);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        #ai-chat-input-container {
            display: flex;
            gap: 10px;
        }
        #ai-chat-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 20px;
            background-color: var(--input-bg);
            color: var(--on-surface);
            font-size: 1em;
        }
        #ai-chat-send-btn {
            background-color: var(--primary-color);
            color: var(--button-text);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #ai-chat-send-btn:hover {
            background-color: #A06FEF;
        }

        /* Responsive Design (Desktop adjustments) */
        @media (min-width: 768px) {
            body {
                justify-content: center;
            }
            main {
                max-width: 800px; /* Limit content width on desktop */
                width: 100%;
                box-shadow: 0 0 20px rgba(0,0,0,0.5); /* Add subtle shadow to whole app */
                border-radius: 10px;
                overflow: hidden;
            }
            header, footer, .app-section {
                max-width: 100%; /* Occupy full width within main container */
                border-radius: 0;
            }
            .app-section {
                padding: 30px;
            }
            .form-container {
                padding: 40px;
            }
            .fab {
                right: calc(50% - 400px + 20px); /* Position relative to main container */
            }
            /* Adjust chat section for better desktop view */
            #ai-chat-section {
                flex-direction: column;
                height: 100%; /* Take full height for better scroll */
            }
            #ai-chat-messages {
                height: 500px; /* Fixed height for chat history on desktop */
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>

    <div id="splash-screen" class="full-screen">
        <div class="splash-logo">AddMint</div>
        <div class="splash-tagline">Connect. Share. Explore.</div>
    </div>

    <div id="preloader" class="full-screen hidden">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <main>
        <section id="signup-auth-section" class="app-section flex-center active">
            <div class="form-container">
                <h2>Create Account</h2>
                <p id="signup-status-message" class="message hidden"></p>
                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="your_email@example.com">
                </div>
                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Minimum 6 characters">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupPassword')"><i class="far fa-eye"></i></button>
                </div>
                <div class="input-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" placeholder="Re-enter password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupConfirmPassword')"><i class="far fa-eye"></i></button>
                </div>
                <button class="primary-btn" id="signupButton">Sign Up</button>
                <p class="form-link">Already have an account? <a href="#" onclick="showSection('signin-auth-section'); return false;">Sign In</a></p>
            </div>
        </section>

        <section id="signin-auth-section" class="app-section flex-center hidden">
            <div class="form-container">
                <h2>Welcome Back!</h2>
                <p id="auth-status-message" class="message hidden"></p>
                <div class="input-group">
                    <label for="signinEmail">Email</label>
                    <input type="email" id="signinEmail" placeholder="your_email@example.com">
                </div>
                <div class="input-group">
                    <label for="signinPassword">Password</label>
                    <input type="password" id="signinPassword" placeholder="Your password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signinPassword')"><i class="far fa-eye"></i></button>
                </div>
                <button class="primary-btn" id="signinButton">Sign In</button>
                <p class="form-link">Don't have an account? <a href="#" onclick="showSection('signup-auth-section'); return false;">Sign Up</a></p>
                <p class="form-link"><a href="#" onclick="showSection('reset-password-section'); return false;">Forgot Password?</a></p>
            </div>
        </section>

        <section id="email-verify-section" class="app-section flex-center hidden">
            <div class="form-container">
                <h2>Email Verification</h2>
                <p id="verify-email-message" class="message success"></p>
                <button class="primary-btn" id="resendVerifyEmailButton">Resend Verification Email</button>
                <p class="form-link">Already verified? <a href="#" onclick="showSection('signin-auth-section'); return false;">Sign In</a></p>
            </div>
        </section>

        <section id="reset-password-section" class="app-section flex-center hidden">
            <div class="form-container">
                <h2>Reset Password</h2>
                <p id="reset-password-message" class="message hidden"></p>
                <div class="input-group">
                    <label for="resetEmail">Email</label>
                    <input type="email" id="resetEmail" placeholder="your_email@example.com">
                </div>
                <button class="primary-btn" id="resetPasswordButton">Send Reset Link</button>
                <p class="form-link">Remembered your password? <a href="#" onclick="showSection('signin-auth-section'); return false;">Sign In</a></p>
            </div>
        </section>

        <section id="setup-profile-section" class="app-section flex-center hidden">
            <div class="form-container">
                <h2>Setup Your Profile</h2>
                <p id="profile-status-message" class="message hidden"></p>
                <div class="input-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" placeholder="Enter your unique username">
                </div>
                <div class="input-group">
                    <label for="whatsappNumber">WhatsApp Number (Optional)</label>
                    <input type="number" id="whatsappNumber" placeholder="e.g., +919876543210">
                </div>
                <div class="input-group">
                    <label for="instagramHandle">Instagram Handle (Optional)</label>
                    <input type="text" id="instagramHandle" placeholder="e.g., @yourhandle">
                </div>
                <div class="input-group">
                    <label for="phoneNumber">Contact Number (Optional)</label>
                    <input type="number" id="phoneNumber" placeholder="e.g., +919876543210">
                </div>
                <button class="primary-btn" id="saveProfileButton">Save Profile</button>
            </div>
        </section>

        <header id="main-header" class="hidden">
            <div class="header-logo">AddMint</div>
            <div class="header-buttons">
                <button id="refreshPostsBtn" title="Refresh Feed"><i class="fas fa-sync-alt"></i></button>
                <button id="adsButton" title="Show Ad (Test)"><i class="fas fa-ad"></i></button>
                <button id="profileButton" title="Your Profile"><i class="fas fa-user-circle"></i></button>
                <button id="logoutButton" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <section id="main-feed-section" class="app-section hidden">
            <div id="post-feed">
                <div class="message" id="feed-status-message">Loading posts...</div>
            </div>
            <div class="fab" id="createPostFab" title="Create New Post">
                <i class="fas fa-plus"></i>
            </div>
        </section>

        <section id="ai-chat-section" class="app-section hidden">
            <h2>AI Chat</h2>
            <div id="ai-chat-messages">
                <div class="chat-message ai">Hello! How can I assist you today?</div>
            </div>
            <div id="ai-chat-input-container">
                <input type="text" id="ai-chat-input" placeholder="Ask me anything...">
                <button id="ai-chat-send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <section id="view-profile-section" class="app-section hidden">
            <h2>Your Profile</h2>
            <p><strong>Username:</strong> <span id="displayUsername"></span></p>
            <p><strong>Email:</strong> <span id="displayEmail"></span></p>
            <p><strong>WhatsApp:</strong> <span id="displayWhatsapp">N/A</span> <button class="social-btn" id="whatsappShareBtn" title="Chat on WhatsApp"><i class="fab fa-whatsapp"></i></button></p>
            <p><strong>Instagram:</strong> <span id="displayInstagram">N/A</span> <button class="social-btn" id="instagramShareBtn" title="View Instagram Profile"><i class="fab fa-instagram"></i></button></p>
            <p><strong>Phone:</strong> <span id="displayPhone">N/A</span> <button class="social-btn" id="phoneCallBtn" title="Call User"><i class="fas fa-phone"></i></button></p>
            <button class="primary-btn" onclick="showSection('setup-profile-section')">Edit Profile</button>
        </section>

        <div id="newPostModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New Post</h3>
                    <span class="close-button" onclick="closeModal('newPostModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="postContent">What's on your mind?</label>
                        <textarea id="postContent" placeholder="Write your post here..."></textarea>
                    </div>
                    <p class="message" id="new-post-status-message"></p>
                </div>
                <div class="modal-footer">
                    <button id="submitPostButton">Post</button>
                </div>
            </div>
        </div>
    </main>

    <footer id="main-footer" class="hidden">
        <a href="#" class="nav-item active" onclick="showSection('main-feed-section'); return false;">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('ai-chat-section'); return false;">
            <i class="fas fa-robot"></i>
            <span>AI Chat</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('view-profile-section'); return false;">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </footer>

    <script>
        // Firebase Config (YOUR DETAILS HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize storage

        // AI API Key (YOURS)
        const AI_API_KEY = "AIzaSyCh6psPdamA8ygJz0qRoEEzMB9Dcd4YI_Q"; // Your Google AI Studio API Key

        let currentUserId = null;
        let currentUsername = null;
        let currentUserProfile = {}; // Store full user profile

        const SPLASH_SCREEN_DURATION = 2000; // 2 seconds
        const POST_EXPIRY_HOURS = 12; // Posts expire after 12 hours

        // --- UI Utility Functions ---
        function showPreloader() {
            document.getElementById('preloader').classList.remove('hidden');
        }

        function hidePreloader() {
            document.getElementById('preloader').classList.add('hidden');
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.app-section');
            sections.forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            // Handle active class for bottom navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            if (sectionId === 'main-feed-section') {
                document.querySelector('.nav-item i.fa-home').parentNode.classList.add('active');
            } else if (sectionId === 'ai-chat-section') {
                document.querySelector('.nav-item i.fa-robot').parentNode.classList.add('active');
            } else if (sectionId === 'view-profile-section') {
                document.querySelector('.nav-item i.fa-user').parentNode.classList.add('active');
            }

            // Hide/Show header/footer based on section
            const header = document.getElementById('main-header');
            const footer = document.getElementById('main-footer');
            if (['signup-auth-section', 'signin-auth-section', 'email-verify-section', 'reset-password-section', 'setup-profile-section'].includes(sectionId)) {
                header.classList.add('hidden');
                footer.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                footer.classList.remove('hidden');
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000); // Hide message after 5 seconds
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i'); // Assuming icon is direct child of button

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMainAppUI() {
            showSection('main-feed-section');
            fetchPosts(); // Load posts when main UI is shown
        }

        // --- Authentication Functions ---
        document.getElementById('signupButton').addEventListener('click', async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('signup-status-message', 'Passwords do not match.', 'error');
                return;
            }
            if (password.length < 6) {
                showMessage('signup-status-message', 'Password must be at least 6 characters.', 'error');
                return;
            }

            showPreloader();
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                showMessage('signup-status-message', 'Account created! Verification email sent. Please check your inbox.', 'success');
                showSection('email-verify-section');
                document.getElementById('verify-email-message').textContent = `A verification link has been sent to ${email}. Please check your inbox (and spam folder). After verifying, please sign in again.`;
            } catch (error) {
                console.error("Signup error:", error);
                showMessage('signup-status-message', error.message, 'error');
            } finally {
                hidePreloader();
            }
        });

        document.getElementById('signinButton').addEventListener('click', async () => {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;

            showPreloader();
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    showMessage('auth-status-message', 'Please verify your email first. A verification link was sent.', 'error');
                    showSection('email-verify-section');
                    document.getElementById('verify-email-message').textContent = `Your email ${email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    await auth.signOut(); // Log out unverified user
                    return;
                }
                currentUserId = userCredential.user.uid;
                // Check if profile is set up
                const userDoc = await db.collection('users').doc(currentUserId).get();
                if (!userDoc.exists || !userDoc.data().username) {
                    showSection('setup-profile-section');
                    // Pre-fill username if Google Display Name exists
                    if (userCredential.user.displayName) {
                        document.getElementById('newUsername').value = userCredential.user.displayName;
                    }
                } else {
                    await fetchUserProfile(currentUserId);
                    showMainAppUI();
                    cleanupOldPosts(); // Call cleanup on successful login
                }
            } catch (error) {
                console.error("Signin error:", error);
                showMessage('auth-status-message', error.message, 'error');
            } finally {
                hidePreloader();
            }
        });

        document.getElementById('resendVerifyEmailButton').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                showPreloader();
                try {
                    await user.sendEmailVerification();
                    showMessage('verify-email-message', 'Verification email resent! Please check your inbox.', 'success');
                } catch (error) {
                    console.error("Resend verification email error:", error);
                    showMessage('verify-email-message', error.message, 'error');
                } finally {
                    hidePreloader();
                }
            }
        });

        document.getElementById('resetPasswordButton').addEventListener('click', async () => {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                showMessage('reset-password-message', 'Please enter your email.', 'error');
                return;
            }
            showPreloader();
            try {
                await auth.sendPasswordResetEmail(email);
                showMessage('reset-password-message', 'Password reset email sent! Please check your inbox.', 'success');
            } catch (error) {
                console.error("Password reset error:", error);
                showMessage('reset-password-message', error.message, 'error');
            } finally {
                hidePreloader();
            }
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
            showPreloader();
            try {
                await auth.signOut();
                currentUserId = null;
                currentUsername = null;
                currentUserProfile = {};
                showMessage('auth-status-message', 'Logged out successfully!', 'success');
                showSection('signin-auth-section'); // Go back to sign-in screen
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('auth-status-message', 'Failed to log out.', 'error');
            } finally {
                hidePreloader();
            }
        });

        // --- Profile Management ---
        document.getElementById('saveProfileButton').addEventListener('click', async () => {
            const username = document.getElementById('newUsername').value.trim();
            const whatsapp = document.getElementById('whatsappNumber').value.trim();
            const instagram = document.getElementById('instagramHandle').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();

            if (!username) {
                showMessage('profile-status-message', 'Username is required!', 'error');
                return;
            }

            showPreloader();
            try {
                await db.collection('users').doc(currentUserId).set({
                    username: username,
                    email: auth.currentUser.email, // Store email for easier lookup
                    whatsapp: whatsapp,
                    instagram: instagram,
                    phone: phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge to update existing fields or create new

                showMessage('profile-status-message', 'Profile saved successfully!', 'success');
                await fetchUserProfile(currentUserId); // Refresh profile data
                showMainAppUI(); // Go to main feed
            } catch (error) {
                console.error("Error saving profile:", error);
                showMessage('profile-status-message', error.message, 'error');
            } finally {
                hidePreloader();
            }
        });

        async function fetchUserProfile(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    currentUserProfile = doc.data();
                    currentUsername = currentUserProfile.username; // Set global username
                    document.getElementById('displayUsername').textContent = currentUserProfile.username || 'N/A';
                    document.getElementById('displayEmail').textContent = auth.currentUser.email || 'N/A';
                    document.getElementById('displayWhatsapp').textContent = currentUserProfile.whatsapp || 'N/A';
                    document.getElementById('displayInstagram').textContent = currentUserProfile.instagram || 'N/A';
                    document.getElementById('displayPhone').textContent = currentUserProfile.phone || 'N/A';

                    // Update button visibility based on data
                    document.getElementById('whatsappShareBtn').style.display = currentUserProfile.whatsapp ? 'inline-block' : 'none';
                    document.getElementById('instagramShareBtn').style.display = currentUserProfile.instagram ? 'inline-block' : 'none';
                    document.getElementById('phoneCallBtn').style.display = currentUserProfile.phone ? 'inline-block' : 'none';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
        }

        // --- Post Feed Management ---
        document.getElementById('createPostFab').addEventListener('click', () => {
            openModal('newPostModal');
            document.getElementById('postContent').value = ''; // Clear previous content
            document.getElementById('new-post-status-message').classList.add('hidden'); // Clear status
        });

        document.getElementById('submitPostButton').addEventListener('click', async () => {
            const postContent = document.getElementById('postContent').value.trim();
            if (!postContent) {
                showMessage('new-post-status-message', 'Post content cannot be empty!', 'error');
                return;
            }

            if (!currentUserId || !currentUsername) {
                showMessage('new-post-status-message', 'Please log in to post.', 'error');
                return;
            }

            showPreloader();
            try {
                const now = Date.now();
                const expiryTime = now + (POST_EXPIRY_HOURS * 60 * 60 * 1000); // 12 hours from now

                await db.collection('posts').add({
                    userId: currentUserId,
                    username: currentUsername, // Store username for display
                    content: postContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Firestore server timestamp
                    expiryTime: expiryTime, // Milliseconds timestamp for client-side check
                    likes: 0,
                    likedBy: [] // Array to store UIDs of users who liked
                    // imageUrl: 'URL_TO_IMAGE_IF_UPLOADED' // Add this when image upload is enabled
                });
                showMessage('new-post-status-message', 'Post created successfully!', 'success');
                closeModal('newPostModal');
                fetchPosts(); // Refresh posts after new post
            } catch (error) {
                console.error("Error creating post:", error);
                showMessage('new-post-status-message', error.message, 'error');
            } finally {
                hidePreloader();
            }
        });

        async function fetchPosts() {
            const postFeed = document.getElementById('post-feed');
            postFeed.innerHTML = '<div class="message" id="feed-status-message">Loading posts...</div>';
            
            if (!currentUserId) {
                postFeed.innerHTML = '<div class="message error">Please log in to view posts.</div>';
                return;
            }

            try {
                const now = Date.now(); // Client-side check for display
                const snapshot = await db.collection('posts')
                                         .orderBy('timestamp', 'desc') // Latest posts first
                                         .get();
                postFeed.innerHTML = ''; // Clear loading message

                if (snapshot.empty) {
                    postFeed.innerHTML = '<div class="message">No posts yet. Be the first to post!</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    
                    // Client-side check based on expiryTime
                    if (post.expiryTime && post.expiryTime < now) {
                        // This post is expired. It should not be displayed.
                        // Firebase Security Rules should already prevent reading this,
                        // but this is an extra layer.
                        console.log(`Skipping expired post: ${postId}`);
                        return;
                    }

                    const postElement = document.createElement('div');
                    postElement.classList.add('post-card');
                    postElement.setAttribute('data-post-id', postId);

                    const isLiked = post.likedBy && post.likedBy.includes(currentUserId);
                    const likeButtonClass = isLiked ? 'liked' : '';
                    const likeIconClass = isLiked ? 'fas' : 'far'; // Solid for liked, regular for not

                    const postTimestamp = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'Just now';

                    postElement.innerHTML = `
                        <div class="post-header">
                            <div class="post-avatar">${post.username ? post.username[0].toUpperCase() : 'U'}</div>
                            <span class="post-username">${post.username || 'Anonymous'}</span>
                            <span class="post-timestamp">${postTimestamp}</span>
                        </div>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image">` : ''}
                        <div class="post-content">
                            <p>${escapeHTML(post.content)}</p>
                        </div>
                        <div class="post-actions">
                            <button class="like-button ${likeButtonClass}" data-post-id="${postId}">
                                <i class="${likeIconClass} fa-heart"></i>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="share-button" data-content="${escapeHTML(post.content)}" data-post-id="${postId}">
                                <i class="fas fa-share-alt"></i>
                                <span>Share</span>
                            </button>
                            ${post.userId === currentUserId ? `<button class="delete-button" data-post-id="${postId}"><i class="fas fa-trash-alt"></i><span>Delete</span></button>` : ''}
                        </div>
                    `;
                    postFeed.appendChild(postElement);
                });

                // Add event listeners for new buttons
                document.querySelectorAll('.like-button').forEach(button => {
                    button.addEventListener('click', handleLike);
                });
                document.querySelectorAll('.share-button').forEach(button => {
                    button.addEventListener('click', handleShare);
                });
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', handleDeletePost);
                });

            } catch (error) {
                console.error("Error fetching posts:", error);
                postFeed.innerHTML = `<div class="message error">Error loading posts: ${error.message}</div>`;
            }
        }

        async function handleLike(event) {
            const button = event.currentTarget;
            const postId = button.dataset.postId;
            const postRef = db.collection('posts').doc(postId);

            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(postRef);
                    if (!doc.exists) {
                        throw "Document does not exist!";
                    }

                    let likes = doc.data().likes || 0;
                    let likedBy = doc.data().likedBy || [];
                    const isLiked = likedBy.includes(currentUserId);

                    if (isLiked) {
                        // Unlike post
                        likes--;
                        likedBy = likedBy.filter(uid => uid !== currentUserId);
                    } else {
                        // Like post
                        likes++;
                        likedBy.push(currentUserId);
                    }

                    transaction.update(postRef, { likes: likes, likedBy: likedBy });
                    
                    // Update UI immediately (optimistic update)
                    button.querySelector('span').textContent = likes;
                    if (isLiked) {
                        button.classList.remove('liked');
                        button.querySelector('i').classList.replace('fas', 'far');
                    } else {
                        button.classList.add('liked');
                        button.querySelector('i').classList.replace('far', 'fas');
                    }
                });
            } catch (error) {
                console.error("Error liking post:", error);
                alert("Failed to update like: " + error.message);
                // Re-fetch posts to revert UI if transaction failed
                fetchPosts();
            }
        }

        async function handleShare(event) {
            const button = event.currentTarget;
            const postId = button.dataset.postId;
            const postContent = button.dataset.content;
            
            // This is where we call App Inventor to use its sharing capabilities
            // The string format should be consistent with what you expect in App Inventor
            const shareString = `SHARE_POST:${postId}|${postContent.substring(0, 100)}... (Read more on AddMint!)`;
            window.AppInventor.setWebViewString(shareString);
            alert("Share options opened via App!"); // User feedback
        }

        async function handleDeletePost(event) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            const button = event.currentTarget;
            const postId = button.dataset.postId;
            
            showPreloader();
            try {
                // First, get the post to check for image URL
                const postDoc = await db.collection('posts').doc(postId).get();
                if (postDoc.exists && postDoc.data().imageUrl) {
                    const imageUrl = postDoc.data().imageUrl;
                    const imageRef = storage.refFromURL(imageUrl);
                    await imageRef.delete();
                    console.log("Image deleted from storage.");
                }

                await db.collection('posts').doc(postId).delete();
                showMessage('feed-status-message', 'Post deleted successfully!', 'success');
                fetchPosts(); // Refresh posts
            } catch (error) {
                console.error("Error deleting post:", error);
                showMessage('feed-status-message', 'Failed to delete post: ' + error.message, 'error');
            } finally {
                hidePreloader();
            }
        }

        document.getElementById('refreshPostsBtn').addEventListener('click', fetchPosts);

        // --- Post Cleanup Function (from previous discussion) ---
        async function cleanupOldPosts() {
            if (!currentUserId) {
                console.log("Not logged in, skipping cleanup.");
                return;
            }

            console.log("Attempting to clean up old posts...");
            const now = Date.now();
            let cleanedUpCount = 0;

            try {
                const snapshot = await db.collection('posts')
                                         .where('expiryTime', '<', now)
                                         .limit(50) // Limit to 50 for a batch cleanup
                                         .get();

                if (snapshot.empty) {
                    console.log("No expired posts found for cleanup in this batch.");
                    return;
                }

                const batch = db.batch();
                const deleteImagePromises = [];

                snapshot.forEach(doc => {
                    const postData = doc.data();
                    const postId = doc.id;

                    if (postData.expiryTime && postData.expiryTime < now) {
                        console.log(`Scheduling post ${postId} for deletion (expired at ${new Date(postData.expiryTime).toLocaleString()}).`);
                        batch.delete(db.collection('posts').doc(postId));
                        cleanedUpCount++;

                        // Schedule image deletion if imageUrl exists
                        if (postData.imageUrl && postData.imageUrl.includes('firebasestorage.googleapis.com')) {
                            try {
                                const imageRef = storage.refFromURL(postData.imageUrl);
                                deleteImagePromises.push(imageRef.delete().catch(err => console.warn("Could not delete old post image:", err)));
                            } catch (e) {
                                console.warn("Invalid image URL for deletion:", postData.imageUrl, e);
                            }
                        }
                    }
                });

                if (cleanedUpCount > 0) {
                    await batch.commit();
                    await Promise.all(deleteImagePromises); // Wait for all image deletions
                    console.log(`Cleaned up ${cleanedUpCount} expired posts.`);
                    fetchPosts(); // Refresh UI after cleanup
                } else {
                    console.log("No actually expired posts found in this batch after checking.");
                }

            } catch (error) {
                console.error("Error during old post cleanup:", error);
            }
        }


        // --- AI Chat Functionality ---
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiChatSendBtn = document.getElementById('ai-chat-send-btn');
        const aiChatMessages = document.getElementById('ai-chat-messages');

        aiChatSendBtn.addEventListener('click', sendAIChatMessage);
        aiChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendAIChatMessage();
            }
        });

        async function sendAIChatMessage() {
            const userMessage = aiChatInput.value.trim();
            if (!userMessage) return;

            appendMessage(userMessage, 'user');
            aiChatInput.value = '';
            aiChatInput.disabled = true;
            aiChatSendBtn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: userMessage }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`AI API error: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                const aiResponse = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] ? data.candidates[0].content.parts[0].text : 'No response from AI.';
                appendMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Error fetching AI response:", error);
                appendMessage("Sorry, I couldn't get a response. Please try again later.", 'ai');
            } finally {
                aiChatInput.disabled = false;
                aiChatSendBtn.disabled = false;
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight; // Scroll to bottom
                aiChatInput.focus();
            }
        }

        function appendMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender);
            msgDiv.textContent = message;
            aiChatMessages.appendChild(msgDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }

        // --- App Inventor Communication ---
        // Functions to be called by App Inventor (e.g., after ad completion)
        window.adRequested = function(status) {
            console.log("Ad requested status from App Inventor:", status);
            // You can add logic here if needed, e.g., show a message to the user
            // based on ad readiness.
        };

        window.adRequestedForExpiry = function(status) {
            console.log("Ad requested for expiry from App Inventor:", status);
        };

        // Example: If a rewarded ad completes successfully, App Inventor could call this:
        window.adCompletedSuccessfully = function(rewardType, rewardAmount) {
            console.log(`Ad completed! Rewarded ${rewardAmount} ${rewardType}.`);
            // Here, you could update a user's balance in Firestore, e.g.:
            /*
            if (currentUserId) {
                db.collection('users').doc(currentUserId).update({
                    coins: firebase.firestore.FieldValue.increment(parseInt(rewardAmount))
                }).then(() => {
                    alert(`You received ${rewardAmount} coins!`);
                    fetchUserProfile(currentUserId); // Update UI
                }).catch(err => console.error("Error updating user coins:", err));
            }
            */
        };

        // --- Social/Contact Sharing ---
        document.getElementById('whatsappShareBtn').addEventListener('click', () => {
            const number = currentUserProfile.whatsapp;
            if (number) {
                window.AppInventor.setWebViewString(`CONTACT:WHATSAPP:${number}`);
            } else {
                alert('WhatsApp number not available.');
            }
        });

        document.getElementById('instagramShareBtn').addEventListener('click', () => {
            const handle = currentUserProfile.instagram;
            if (handle) {
                window.AppInventor.setWebViewString(`CONTACT:INSTAGRAM:${handle}`);
            } else {
                alert('Instagram handle not available.');
            }
        });

        document.getElementById('phoneCallBtn').addEventListener('click', () => {
            const number = currentUserProfile.phone;
            if (number) {
                window.AppInventor.setWebViewString(`CONTACT:PHONE:${number}`);
            } else {
                alert('Phone number not available.');
            }
        });
        
        // --- Ad Button (for testing Unity Ads via WebViewer String) ---
        document.getElementById('adsButton').addEventListener('click', () => {
            // This will tell App Inventor to show a rewarded ad.
            // You can customize the 'coins' part to send different data.
            window.AppInventor.setWebViewString('SHOW_AD:coins');
            // This will trigger the UnityAds logic in App Inventor.
        });

        // --- Helpers ---
        function escapeHTML(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // --- Initial Load & Auth State Handling ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial splash screen animation
            const splashScreen = document.getElementById('splash-screen');
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                splashScreen.addEventListener('transitionend', () => {
                    splashScreen.classList.add('hidden');
                    showPreloader(); // Show preloader after splash
                }, { once: true });
            }, SPLASH_SCREEN_DURATION);

            // Firebase Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                // hidePreloader will be called later, after profile check or initial signin screen
                if (user) {
                    currentUserId = user.uid;
                    if (user.emailVerified) {
                        const userDoc = await db.collection('users').doc(currentUserId).get();
                        if (!userDoc.exists || !userDoc.data().username) {
                            hidePreloader();
                            showSection('setup-profile-section');
                            if (user.displayName) {
                                document.getElementById('newUsername').value = user.displayName;
                            }
                        } else {
                            await fetchUserProfile(currentUserId);
                            hidePreloader();
                            showMainAppUI();
                            cleanupOldPosts(); // Call cleanup when user logs in/app starts
                        }
                    } else {
                        hidePreloader();
                        showSection('email-verify-section');
                        document.getElementById('verify-email-message').textContent = `Your email ${user.email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                    }
                } else {
                    hidePreloader();
                    showSection('signin-auth-section'); // Default to sign-in
                }
            });
        });
    </script>
</body>
</html>
