 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddMint - Social App</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e1e1e, #0a0a0a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            color: #00ffcc; /* Neon green */
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffcc, 0 0 30px #00ffcc;
            animation: pulse 1.5s infinite alternate;
        }

        .splash-text {
            margin-top: 15px;
            font-size: 1.2em;
            letter-spacing: 2px;
            color: #99ffdd;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.8; }
        }

        /* App Container */
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            display: none; /* Hidden until splash screen fades */
        }

        /* Header */
        header {
            background-color: #121212;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 5px #00ffcc;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            cursor: pointer;
            width: 24px;
            height: 24px;
            color: #e0e0e0;
            transition: color 0.3s ease;
        }
        .header-icon:hover {
            color: #00ffcc;
        }

        /* CSS-generated Menu Icon (Three Lines) */
        .menu-icon {
            width: 24px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }
        .menu-icon span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: #e0e0e0;
            border-radius: 2px;
            transition: background-color 0.3s ease;
        }
        .menu-icon:hover span {
            background-color: #00ffcc;
        }

        /* CSS-generated Gift Icon */
        .gift-icon {
            position: relative;
            width: 24px;
            height: 24px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            transform: rotate(45deg);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .gift-icon::before, .gift-icon::after {
            content: '';
            position: absolute;
            background-color: #e0e0e0;
        }
        .gift-icon::before { /* Top bow part */
            width: 2px;
            height: 12px;
            top: -6px;
            left: 50%;
            transform: translateX(-50%) rotate(-45deg);
        }
        .gift-icon::after { /* Side bow part */
            width: 12px;
            height: 2px;
            left: -6px;
            top: 50%;
            transform: translateY(-50%) rotate(-45deg);
        }
        .gift-icon:hover {
            border-color: #00ffcc;
            box-shadow: 0 0 10px #00ffcc;
        }
        .gift-icon:hover::before, .gift-icon:hover::after {
            background-color: #00ffcc;
        }


        /* Main Content */
        main {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Auth Forms */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background-color: #2a2a2a;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            margin: 50px auto;
        }
        .auth-container h2 {
            color: #00ffcc;
            margin-bottom: 25px;
            text-shadow: 0 0 8px #00ffcc;
        }
        .auth-container input {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .auth-container input:focus {
            border-color: #00ffcc;
            box-shadow: 0 0 8px #00ffcc;
        }
        .auth-container button {
            width: 100%;
            padding: 12px;
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .auth-container button:hover {
            background-color: #00e6b8;
            transform: translateY(-2px);
        }
        .auth-container p {
            margin-top: 20px;
            color: #bbb;
        }
        .auth-container a {
            color: #00ffcc;
            text-decoration: none;
            transition: text-decoration 0.3s ease;
        }
        .auth-container a:hover {
            text-decoration: underline;
        }

        /* Profile Setup Form */
        #profile-setup-form {
            display: none; /* Hidden until user signs up/in for the first time */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background-color: #2a2a2a;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            margin: 50px auto;
        }
        #profile-setup-form h2 {
            color: #00ffcc;
            margin-bottom: 25px;
            text-shadow: 0 0 8px #00ffcc;
        }
        .form-group {
            width: calc(100% - 20px);
            margin-bottom: 15px;
            position: relative;
        }
        .form-group input {
            width: 100%; /* Adjust to fill form-group */
            padding: 12px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus {
            border-color: #00ffcc;
            box-shadow: 0 0 8px #00ffcc;
        }
        .validation-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            font-size: 0.8em;
        }
        .validation-icon.green {
            background-color: #00e676; /* Green checkmark */
        }
        .validation-icon.red {
            background-color: #ff1744; /* Red cross */
        }
        .validation-icon::before {
            content: '✓'; /* Checkmark */
            display: block;
        }
        .validation-icon.red::before {
            content: '✕'; /* Cross */
        }
        .profile-setup-buttons {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }
        #profile-setup-form button {
            padding: 12px 25px;
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #profile-setup-form button:hover {
            background-color: #00e6b8;
            transform: translateY(-2px);
        }

        /* Profile Avatar selection */
        .avatar-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease, transform 0.2s ease;
        }
        .avatar-option:hover {
            border-color: #00ffcc;
            transform: scale(1.1);
        }
        .avatar-option.selected {
            border-color: #00ffcc;
            box-shadow: 0 0 10px #00ffcc;
            transform: scale(1.1);
        }

        /* Main Content Sections (Feed, Post Upload, Profile, Search, Messages) */
        .content-section {
            display: none; /* Controlled by JS based on active tab */
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Post Feed */
        #post-feed {
            /* flex-direction: column; for vertical scroll */
            gap: 15px;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        .post-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
            border: 2px solid transparent; /* For neon effect */
            position: relative;
        }
        .post-card.neon-glow {
            border-color: #00ffcc;
            box-shadow: 0 0 15px #00ffcc, inset 0 0 5px #00ffcc;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            margin-right: 10px;
            color: #fff;
        }
        .post-username {
            font-weight: bold;
            color: #00ffcc;
        }
        .post-content {
            margin-bottom: 10px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .post-content a {
            color: #3498db; /* Blue for links */
            text-decoration: none;
        }
        .post-content a:hover {
            text-decoration: underline;
        }
        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        .post-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .action-button {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        .action-button.like-button .heart-icon {
            color: #e0e0e0;
            font-size: 1.5em;
            transition: color 0.3s ease, transform 0.2s ease;
        }
        .action-button.like-button .heart-icon.liked {
            color: #ff007f; /* Red for liked */
            transform: scale(1.2);
            animation: bounce 0.3s ease;
        }
        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .post-views {
            color: #aaa;
            font-size: 0.9em;
        }

        /* Reaction Emojis */
        .reaction-container {
            position: absolute;
            bottom: 0px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 50;
        }
        .post-card.show-reactions .reaction-container {
            opacity: 1;
            transform: translateX(-50%) translateY(-50px); /* Move up */
            pointer-events: auto;
        }
        .reaction-emoji {
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .reaction-emoji:hover {
            transform: scale(1.2);
        }
        .reactions-summary {
            margin-top: 5px;
            font-size: 0.9em;
            color: #bbb;
            text-align: center;
        }

        /* Post Upload */
        #post-upload-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #post-upload-section textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
            font-size: 1em;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #post-upload-section textarea:focus {
            border-color: #00ffcc;
            box-shadow: 0 0 8px #00ffcc;
        }
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
        }
        .upload-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: #e0e0e0;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .upload-option:hover {
            background-color: #3a3a3a;
        }
        .upload-option input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #00ffcc;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
        }
        .upload-option input[type="radio"]:checked::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #00ffcc;
        }
        .upload-button {
            padding: 12px 25px;
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .upload-button:hover {
            background-color: #00e6b8;
            transform: translateY(-2px);
        }

        /* Profile Section */
        #profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .profile-header {
            text-align: center;
        }
        .profile-avatar-display {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #00ffcc; /* Placeholder background */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: #1a1a1a;
            margin: 0 auto 10px;
            box-shadow: 0 0 15px #00ffcc, inset 0 0 5px #00ffcc;
        }
        .profile-username-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 5px;
        }
        .profile-stats {
            display: flex;
            gap: 25px;
            margin-top: 15px;
        }
        .profile-stat {
            text-align: center;
            cursor: pointer;
        }
        .profile-stat-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ffcc;
        }
        .profile-stat-label {
            font-size: 0.9em;
            color: #bbb;
        }
        .profile-actions-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .profile-action-button {
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .profile-action-button.follow {
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
        }
        .profile-action-button.follow:hover {
            background-color: #00e6b8;
            transform: translateY(-2px);
        }
        .profile-action-button.unfollow {
            background-color: #ff3366;
            color: #fff;
            border: none;
        }
        .profile-action-button.unfollow:hover {
            background-color: #e62e5c;
            transform: translateY(-2px);
        }
        .profile-action-button.message,
        .profile-action-button.social {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        .profile-action-button.message:hover,
        .profile-action-button.social:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px);
        }

        /* Social Media Logos (CSS-generated) */
        .social-logo {
            width: 30px;
            height: 30px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            font-size: 1.2em;
            color: #fff;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .social-logo:hover {
            transform: scale(1.1);
        }

        /* Instagram Logo (CSS) */
        .social-logo.instagram {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.7);
        }
        .social-logo.instagram::before { /* Inner circle */
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid #fff;
            border-radius: 50%;
        }
        .social-logo.instagram::after { /* Small dot */
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #fff;
            border-radius: 50%;
            top: 5px;
            right: 5px;
        }

        /* YouTube Logo (CSS) */
        .social-logo.youtube {
            background-color: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
        }
        .social-logo.youtube::before { /* Play button */
            content: '';
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 14px solid #fff;
            margin-left: 2px;
        }

        /* WhatsApp Logo (CSS) */
        .social-logo.whatsapp {
            background-color: #25d366;
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.7);
        }
        .social-logo.whatsapp::before { /* Speech bubble */
            content: '';
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #fff;
            display: block;
            position: relative;
        }
        .social-logo.whatsapp::after { /* Tail */
            content: '';
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid #fff;
            border-top: 5px solid #fff;
            position: absolute;
            bottom: 3px;
            left: 5px;
            transform: rotate(-45deg);
        }
        .social-logo.whatsapp .inner-phone {
            position: absolute;
            width: 10px;
            height: 14px;
            border: 2px solid #25d366;
            border-radius: 2px;
            background-color: #fff;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .social-logo.whatsapp .inner-phone::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: #25d366;
            border-radius: 50%;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
        }


        /* Search Section */
        #search-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #search-input {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #search-input:focus {
            border-color: #00ffcc;
            box-shadow: 0 0 8px #00ffcc;
        }
        #search-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .search-result-item:hover {
            background-color: #3a3a3a;
        }
        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00ffcc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: #1a1a1a;
            margin-right: 10px;
        }
        .search-result-info {
            flex-grow: 1;
        }
        .search-result-username {
            font-weight: bold;
            color: #e0e0e0;
        }
        .search-result-follow-button {
            padding: 8px 15px;
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .search-result-follow-button:hover {
            background-color: #00e6b8;
        }
        .search-result-follow-button.following {
            background-color: #444;
            color: #bbb;
        }

        /* Message Section */
        #message-section {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px); /* Adjust based on header/footer height */
        }
        .chat-header {
            display: flex;
            align-items: center;
            background-color: #2a2a2a;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            border-radius: 8px 8px 0 0;
        }
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00ffcc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: #1a1a1a;
            margin-right: 10px;
        }
        .chat-header-username {
            font-weight: bold;
            color: #e0e0e0;
        }
        .message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #1e1e1e;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            align-self: flex-end;
            background-color: #00ffcc;
            color: #1a1a1a;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.received {
            align-self: flex-start;
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-bottom-left-radius: 5px;
        }
        .message-timestamp {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            display: block;
            text-align: right;
        }
        .message-bubble.received .message-timestamp {
            text-align: left;
        }
        .message-input-area {
            display: flex;
            padding: 10px 15px;
            background-color: #2a2a2a;
            border-top: 1px solid #333;
            gap: 10px;
            border-radius: 0 0 8px 8px;
        }
        .message-input-area input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
            outline: none;
        }
        .message-input-area button {
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .message-input-area button:hover {
            background-color: #00e6b8;
        }

        /* Follow/Following List Popup */
        .follow-list-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .follow-list-content {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            position: relative;
        }
        .follow-list-content h3 {
            color: #00ffcc;
            margin-bottom: 20px;
            text-align: center;
        }
        .follow-list-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .follow-list-item:last-child {
            border-bottom: none;
        }
        .follow-list-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #00ffcc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: #1a1a1a;
            margin-right: 10px;
        }
        .follow-list-item-username {
            font-weight: bold;
            color: #e0e0e0;
            flex-grow: 1;
        }
        .close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            color: #e0e0e0;
            cursor: pointer;
        }

        /* Bottom Navigation */
        footer {
            background-color: #121212;
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #333;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 100;
            min-height: 50px; /* Adjusted for better phone height */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #888;
            font-size: 0.8em;
            cursor: pointer;
            transition: color 0.3s ease;
            text-decoration: none; /* Important for anchor tags acting as buttons */
        }
        .nav-item.active {
            color: #00ffcc;
        }
        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 3px;
        }
        .nav-item.active .nav-icon {
            text-shadow: 0 0 8px #00ffcc;
        }

        /* CSS-generated Bottom Nav Icons */
        /* Home Icon */
        .nav-icon.home-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .nav-icon.home-icon::before { /* Base */
            content: '';
            position: absolute;
            width: 16px;
            height: 12px;
            border: 2px solid currentColor;
            border-bottom: none;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        .nav-icon.home-icon::after { /* Roof */
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 8px solid currentColor;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Search Icon */
        .nav-icon.search-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .nav-icon.search-icon::before { /* Magnifying glass circle */
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            top: 2px;
            left: 2px;
        }
        .nav-icon.search-icon::after { /* Handle */
            content: '';
            position: absolute;
            width: 2px;
            height: 8px;
            background-color: currentColor;
            bottom: 4px;
            right: 4px;
            transform: rotate(-45deg);
            transform-origin: bottom right;
        }

        /* Upload Icon */
        .nav-icon.upload-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .nav-icon.upload-icon::before { /* Arrow body */
            content: '';
            position: absolute;
            width: 4px;
            height: 16px;
            background-color: currentColor;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
        .nav-icon.upload-icon::after { /* Arrow head */
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid currentColor;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
        }
        .nav-icon.upload-icon .base {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background-color: currentColor;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Message Icon */
        .nav-icon.message-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .nav-icon.message-icon::before { /* Main bubble */
            content: '';
            position: absolute;
            width: 20px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 4px;
            top: 0;
            left: 0;
        }
        .nav-icon.message-icon::after { /* Tail */
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-top: 6px solid currentColor;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            bottom: 4px;
            left: 4px;
        }

        /* Profile Icon */
        .nav-icon.profile-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .nav-icon.profile-icon::before { /* Head */
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
        }
        .nav-icon.profile-icon::after { /* Body */
            content: '';
            position: absolute;
            width: 22px;
            height: 10px;
            border: 2px solid currentColor;
            border-top: none;
            border-radius: 0 0 10px 10px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Side Menu (Drawer) */
        #side-menu {
            position: fixed;
            top: 0;
            right: -300px; /* Hidden by default */
            width: 280px;
            height: 100%;
            background-color: #1a1a1a;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease-in-out;
            z-index: 200;
            padding-top: 60px; /* Space for header */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #side-menu.open {
            right: 0;
        }
        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #e0e0e0;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-decoration: none; /* For links */
        }
        .menu-item:hover {
            background-color: #2a2a2a;
            color: #00ffcc;
        }
        .menu-item .icon {
            font-size: 1.4em;
        }
        .menu-social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto; /* Pushes to bottom */
            padding-bottom: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }
        .menu-social-links .social-logo {
            width: 40px;
            height: 40px;
            font-size: 1.5em;
        }

        /* Overlay for side menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
        }
        .overlay.active {
            display: block;
        }

        /* Modals and Popups (General Styling) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001; /* Above side menu */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1e1e1e;
            margin: auto;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            width: 90%;
            max-width: 450px;
            position: relative;
            color: #e0e0e0;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #00ffcc;
        }
        .modal-content h3 {
            color: #00ffcc;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 5px #00ffcc;
        }
        .modal-content p {
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .modal-content button {
            background-color: #00ffcc;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: block;
            width: 100%;
            margin-top: 20px;
        }
        .modal-content button:hover {
            background-color: #00e6b8;
        }

        /* Reward Modal */
        #reward-modal .reward-amount {
            font-size: 2em;
            color: #00ffcc;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ffcc;
        }
        #reward-modal .countdown-timer {
            text-align: center;
            font-size: 1.2em;
            color: #bbb;
            margin-top: 10px;
        }

        /* General Utility Classes */
        .hidden {
            display: none !important;
        }
        .text-center {
            text-align: center;
        }
        .error-message {
            color: #ff3366;
            margin-top: 10px;
            text-align: center;
            font-size: 0.9em;
        }
        .success-message {
            color: #00e676;
            margin-top: 10px;
            text-align: center;
            font-size: 0.9em;
        }
        .balance-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
        }
        .balance-item {
            text-align: center;
        }
        .balance-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ffcc;
        }
        .balance-label {
            font-size: 0.8em;
            color: #bbb;
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">AddMint</div>
        <div class="splash-text">Connecting the World...</div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-left">
                <div class="logo">AddMint</div>
            </div>
            <div class="header-right">
                <div class="header-icon refresh-icon" id="refresh-posts-button" title="Refresh Posts">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.5 13H1v8h8"></path>
                        <path d="M21 11h-2v11h-8"></path>
                        <path d="M16 16v-3l-4 4 4 4v-3z"></path>
                        <path d="M8 8v3l4-4-4-4v3z"></path>
                    </svg>
                </div>
                <div class="gift-icon" id="gift-button" title="Daily Rewards"></div>
                <div class="menu-icon" id="menu-button">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </header>

        <main>
            <div id="auth-section" class="auth-container">
                <h2>Welcome to AddMint</h2>
                <input type="email" id="auth-email" placeholder="Email">
                <input type="password" id="auth-password" placeholder="Password">
                <button id="auth-signup-button">Sign Up</button>
                <p>Already have an account? <a href="#" id="auth-login-link">Login</a></p>
                <p class="error-message" id="auth-error-message"></p>
            </div>

            <div id="login-section" class="auth-container hidden">
                <h2>Login to AddMint</h2>
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-password" placeholder="Password">
                <button id="login-button">Login</button>
                <p>Don't have an account? <a href="#" id="login-signup-link">Sign Up</a></p>
                <p class="error-message" id="login-error-message"></p>
            </div>

            <div id="profile-setup-form" class="content-section">
                <h2>Complete Your Profile</h2>
                <div class="form-group">
                    <input type="text" id="setup-username" placeholder="Choose a Unique Username" required>
                    <span id="username-validation-icon" class="validation-icon hidden"></span>
                </div>
                <input type="tel" id="setup-whatsapp" placeholder="WhatsApp Number (Optional)">
                <input type="text" id="setup-instagram" placeholder="Instagram ID (Optional)">
                <div class="avatar-selection-container" id="avatar-options-container">
                    </div>
                <p style="font-size: 0.9em; color: #bbb; margin-top: 15px;">Choose at least one of WhatsApp or Instagram.</p>
                <p class="error-message" id="profile-setup-error-message"></p>
                <div class="profile-setup-buttons">
                    <button id="complete-profile-button">Complete Profile</button>
                </div>
            </div>

            <section id="feed-section" class="content-section">
                <div id="post-feed">
                    <p class="text-center" id="no-posts-message">No posts yet. Be the first to share something!</p>
                </div>
            </section>

            <section id="upload-section" class="content-section">
                <h2>Create New Post</h2>
                <div class="balance-info">
                    <div class="balance-item">
                        <div class="balance-value" id="upload-coins-display">0</div>
                        <div class="balance-label">Coins</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-value" id="upload-limit-display">0</div>
                        <div class="balance-label">Limit</div>
                    </div>
                </div>
                <textarea id="post-content-input" placeholder="What's on your mind?"></textarea>

                <div class="upload-options">
                    <h3>Post Boost Hours:</h3>
                    <label class="upload-option">
                        <input type="radio" name="boost-hours" value="12" checked>
                        <span>12 Hours (Free)</span>
                    </label>
                    <label class="upload-option">
                        <input type="radio" name="boost-hours" value="18">
                        <span>18 Hours (+1 Ad)</span>
                    </label>
                    <label class="upload-option">
                        <input type="radio" name="boost-hours" value="24">
                        <span>24 Hours (+2 Ads)</span>
                    </label>
                    <label class="upload-option">
                        <input type="radio" name="boost-hours" value="30">
                        <span>30 Hours (+3 Ads)</span>
                    </label>
                </div>

                <button id="publish-post-button">Publish Post</button>
                <p class="error-message" id="post-upload-error-message"></p>
                <p class="success-message" id="post-upload-success-message"></p>
            </section>

            <section id="my-profile-section" class="content-section">
                <div id="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar-display" id="my-profile-avatar"></div>
                        <div class="profile-username-display" id="my-profile-username"></div>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat" id="my-followers-stat">
                            <div class="profile-stat-number" id="my-followers-count">0</div>
                            <div class="profile-stat-label">Followers</div>
                        </div>
                        <div class="profile-stat" id="my-following-stat">
                            <div class="profile-stat-number" id="my-following-count">0</div>
                            <div class="profile-stat-label">Following</div>
                        </div>
                    </div>
                    <div class="profile-actions-buttons">
                        <button class="profile-action-button message" id="my-edit-profile-button">Edit Profile</button>
                        <a href="#" target="_blank" class="profile-action-button social hidden" id="my-profile-whatsapp-button">
                            <div class="social-logo whatsapp">
                                <div class="inner-phone"></div>
                            </div>
                        </a>
                        <a href="#" target="_blank" class="profile-action-button social hidden" id="my-profile-instagram-button">
                            <div class="social-logo instagram"></div>
                        </a>
                    </div>
                    <p style="font-size: 0.9em; color: #bbb; margin-top: 15px;">Your Posts:</p>
                    <div id="my-profile-posts" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
                        </div>
                </div>
            </section>

            <section id="other-user-profile-section" class="content-section">
                <div id="other-profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar-display" id="other-profile-avatar"></div>
                        <div class="profile-username-display" id="other-profile-username"></div>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat" id="other-followers-stat">
                            <div class="profile-stat-number" id="other-followers-count">0</div>
                            <div class="profile-stat-label">Followers</div>
                        </div>
                        <div class="profile-stat" id="other-following-stat">
                            <div class="profile-stat-number" id="other-following-count">0</div>
                            <div class="profile-stat-label">Following</div>
                        </div>
                    </div>
                    <div class="profile-actions-buttons">
                        <button class="profile-action-button follow" id="other-follow-button">Follow</button>
                        <button class="profile-action-button unfollow hidden" id="other-unfollow-button">Unfollow</button>
                        <button class="profile-action-button message" id="other-message-button">Message</button>
                        <a href="#" target="_blank" class="profile-action-button social hidden" id="other-profile-whatsapp-button">
                            <div class="social-logo whatsapp">
                                <div class="inner-phone"></div>
                            </div>
                        </a>
                        <a href="#" target="_blank" class="profile-action-button social hidden" id="other-profile-instagram-button">
                            <div class="social-logo instagram"></div>
                        </a>
                    </div>
                    <p style="font-size: 0.9em; color: #bbb; margin-top: 15px;">User's Posts:</p>
                    <div id="other-profile-posts" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
                        </div>
                </div>
            </section>

            <section id="search-section" class="content-section">
                <h2>Search Users & Posts</h2>
                <input type="text" id="search-input" placeholder="Search by username or content...">
                <div id="search-results">
                    <p class="text-center" id="no-search-results">Start typing to search...</p>
                </div>
            </section>

            <section id="messages-list-section" class="content-section">
                <h2>Chats</h2>
                <div id="conversations-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <p class="text-center" id="no-conversations-message">No active chats yet.</p>
                </div>
            </section>

            <section id="chat-section" class="content-section hidden" style="padding: 0; display: flex; flex-direction: column;">
                <div class="chat-header">
                    <div class="chat-header-avatar" id="chat-header-avatar"></div>
                    <div class="chat-header-username" id="chat-header-username"></div>
                </div>
                <div class="message-list" id="message-list">
                    </div>
                <div class="message-input-area">
                    <input type="text" id="chat-message-input" placeholder="Type a message...">
                    <button id="send-message-button">Send</button>
                </div>
            </section>

        </main>

        <footer>
            <a href="#" class="nav-item active" data-target="feed-section" id="nav-feed">
                <div class="nav-icon home-icon"></div>
                <span>Feed</span>
            </a>
            <a href="#" class="nav-item" data-target="search-section" id="nav-search">
                <div class="nav-icon search-icon"></div>
                <span>Search</span>
            </a>
            <a href="#" class="nav-item" data-target="upload-section" id="nav-upload">
                <div class="nav-icon upload-icon"><div class="base"></div></div>
                <span>Upload</span>
            </a>
            <a href="#" class="nav-item" data-target="messages-list-section" id="nav-messages">
                <div class="nav-icon message-icon"></div>
                <span>Messages</span>
            </a>
            <a href="#" class="nav-item" data-target="my-profile-section" id="nav-profile">
                <div class="nav-icon profile-icon"></div>
                <span>Profile</span>
            </a>
        </footer>
    </div>

    <div id="side-menu">
        <a href="#" class="menu-item" id="menu-data-saver">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-battery">
                <rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect>
                <line x1="23" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Data Saver <span id="data-saver-status">(Off)</span></span>
        </a>
        <a href="https://www.instagram.com/addmint__/" target="_blank" class="menu-item">
            <div class="social-logo instagram" style="width: 24px; height: 24px; font-size: 1.1em; border-radius: 4px;"></div>
            <span>Instagram: @addmint__</span>
        </a>
        <a href="https://www.youtube.com/@add_mintmint" target="_blank" class="menu-item">
            <div class="social-logo youtube" style="width: 24px; height: 24px; font-size: 1.1em; border-radius: 4px;"></div>
            <span>YouTube: @add_mintmint</span>
        </a>
        <a href="#" class="menu-item" id="menu-about">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-info">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>About</span>
        </a>
        <a href="#" class="menu-item" id="menu-privacy-policy">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-shield">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            <span>Privacy Policy</span>
        </a>
        <a href="#" class="menu-item" id="menu-logout">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-log-out">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
        </a>
        <div class="menu-social-links">
            <a href="https://www.instagram.com/addmint__/" target="_blank" class="social-logo instagram"></a>
            <a href="https://www.youtube.com/@add_mintmint" target="_blank" class="social-logo youtube"></a>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div id="about-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="about-modal">&times;</span>
            <h3>About AddMint</h3>
            <p>AddMint is a vibrant social platform designed to connect people through shared interests and experiences.</p>
            <p>Our mission is to provide a seamless and engaging environment for users to create, discover, and interact with content.</p>
            <p>Built with passion and powered by modern web technologies.</p>
        </div>
    </div>

    <div id="privacy-policy-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="privacy-policy-modal">&times;</span>
            <h3>Privacy Policy</h3>
            <p>Your privacy is important to us. This policy explains how we collect, use, and protect your information.</p>
            <p>We collect basic profile information (username, avatar, optional social links) to personalize your experience. We do not share your personal data with third parties without your explicit consent.</p>
            <p>Post content, likes, and reactions are public. Messages are private and deleted after 12 hours.</p>
            <p>By using AddMint, you agree to this Privacy Policy.</p>
        </div>
    </div>

    <div id="reward-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="reward-modal">&times;</span>
            <h3>Daily Reward!</h3>
            <p class="text-center">Congratulations! You've received:</p>
            <div class="reward-amount" id="reward-display"></div>
            <p class="countdown-timer" id="reward-countdown"></p>
            <button id="claim-reward-button">Claim Reward</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>

    <script>
        // Your Firebase Configuration (From your prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
            authDomain: "addmint-7ab6b.firebaseapp.com",
            databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app", // This is RTDB, Firestore is preferred
            projectId: "addmint-7ab6b",
            storageBucket: "addmint-7ab6b.firebasestorage.app",
            messagingSenderId: "504015450137",
            appId: "1:504015450137:web:694b176313582cce1e7a88",
            measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const analytics = app.analytics(); // For analytics, if you need it
        const functions = app.functions('asia-southeast1'); // Specify your region

        // --- GLOBAL VARIABLES & STATE ---
        let currentUser = null;
        let lastVisiblePost = null; // For infinite scrolling
        let currentActiveSection = 'feed-section';
        let currentChatRecipientId = null;
        let unsubscribeMessages = null; // To unsubscribe from real-time message updates
        let dataSaverMode = false; // State for data saver

        // List of random avatars (emojis/letters)
        const profileAvatars = [
            '😊', '🌟', '🚀', '🌈', '🔥', '💡', '🌻', '🦁', '💖', '🍀',
            '🍎', '🌊', '⚡', '🌙', '🦋', '🐢', '🐼', '🎶', '💎', '👑',
            'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',
            'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',
            'U', 'V', 'W', 'X', 'Y', 'Z', '😎', '😇', '🥳', '🌸'
        ];

        // --- UI ELEMENTS ---
        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');

        const authSection = document.getElementById('auth-section');
        const loginSection = document.getElementById('login-section');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSignupButton = document.getElementById('auth-signup-button');
        const authLoginLink = document.getElementById('auth-login-link');
        const authErrorMessage = document.getElementById('auth-error-message');

        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginSignupLink = document.getElementById('login-signup-link');
        const loginErrorMessage = document.getElementById('login-error-message');

        const profileSetupForm = document.getElementById('profile-setup-form');
        const setupUsernameInput = document.getElementById('setup-username');
        const usernameValidationIcon = document.getElementById('username-validation-icon');
        const setupWhatsappInput = document.getElementById('setup-whatsapp');
        const setupInstagramInput = document.getElementById('setup-instagram');
        const avatarOptionsContainer = document.getElementById('avatar-options-container');
        const completeProfileButton = document.getElementById('complete-profile-button');
        const profileSetupErrorMessage = document.getElementById('profile-setup-error-message');
        let selectedAvatar = null;

        const feedSection = document.getElementById('feed-section');
        const postFeed = document.getElementById('post-feed');
        const noPostsMessage = document.getElementById('no-posts-message');
        const refreshPostsButton = document.getElementById('refresh-posts-button');

        const uploadSection = document.getElementById('upload-section');
        const uploadCoinsDisplay = document.getElementById('upload-coins-display');
        const uploadLimitDisplay = document.getElementById('upload-limit-display');
        const postContentInput = document.getElementById('post-content-input');
        const publishPostButton = document.getElementById('publish-post-button');
        const postUploadErrorMessage = document.getElementById('post-upload-error-message');
        const postUploadSuccessMessage = document.getElementById('post-upload-success-message');

        const myProfileSection = document.getElementById('my-profile-section');
        const myProfileAvatar = document.getElementById('my-profile-avatar');
        const myProfileUsername = document.getElementById('my-profile-username');
        const myFollowersCount = document.getElementById('my-followers-count');
        const myFollowingCount = document.getElementById('my-following-count');
        const myEditProfileButton = document.getElementById('my-edit-profile-button');
        const myProfileWhatsappButton = document.getElementById('my-profile-whatsapp-button');
        const myProfileInstagramButton = document.getElementById('my-profile-instagram-button');
        const myProfilePosts = document.getElementById('my-profile-posts');
        const myFollowersStat = document.getElementById('my-followers-stat');
        const myFollowingStat = document.getElementById('my-following-stat');

        const otherUserProfileSection = document.getElementById('other-user-profile-section');
        const otherProfileAvatar = document.getElementById('other-profile-avatar');
        const otherProfileUsername = document.getElementById('other-profile-username');
        const otherFollowersCount = document.getElementById('other-followers-count');
        const otherFollowingCount = document.getElementById('other-following-count');
        const otherFollowButton = document.getElementById('other-follow-button');
        const otherUnfollowButton = document.getElementById('other-unfollow-button');
        const otherMessageButton = document.getElementById('other-message-button');
        const otherProfileWhatsappButton = document.getElementById('other-profile-whatsapp-button');
        const otherProfileInstagramButton = document.getElementById('other-profile-instagram-button');
        const otherProfilePosts = document.getElementById('other-profile-posts');
        const otherFollowersStat = document.getElementById('other-followers-stat');
        const otherFollowingStat = document.getElementById('other-following-stat');


        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const noSearchResults = document.getElementById('no-search-results');

        const messagesListSection = document.getElementById('messages-list-section');
        const conversationsList = document.getElementById('conversations-list');
        const noConversationsMessage = document.getElementById('no-conversations-message');

        const chatSection = document.getElementById('chat-section');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const chatHeaderUsername = document.getElementById('chat-header-username');
        const messageList = document.getElementById('message-list');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendMessageButton = document.getElementById('send-message-button');

        const navItems = document.querySelectorAll('.nav-item');

        const sideMenu = document.getElementById('side-menu');
        const menuButton = document.getElementById('menu-button');
        const overlay = document.getElementById('overlay');
        const menuDataSaver = document.getElementById('menu-data-saver');
        const dataSaverStatus = document.getElementById('data-saver-status');
        const menuAbout = document.getElementById('menu-about');
        const menuPrivacyPolicy = document.getElementById('menu-privacy-policy');
        const menuLogout = document.getElementById('menu-logout');

        const aboutModal = document.getElementById('about-modal');
        const privacyPolicyModal = document.getElementById('privacy-policy-modal');
        const rewardModal = document.getElementById('reward-modal');
        const rewardDisplay = document.getElementById('reward-display');
        const rewardCountdown = document.getElementById('reward-countdown');
        const giftButton = document.getElementById('gift-button');
        const claimRewardButton = document.getElementById('claim-reward-button');
        const closeButtons = document.querySelectorAll('.close-button');

        const followListPopup = document.querySelector('.follow-list-popup');
        const followListContent = document.querySelector('.follow-list-content');
        const closeFollowListPopup = document.querySelector('.follow-list-popup .close-button');


        // --- UTILITY FUNCTIONS ---
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            currentActiveSection = sectionId;

            // Manage header refresh button visibility
            if (sectionId === 'feed-section') {
                refreshPostsButton.style.display = 'block';
            } else {
                refreshPostsButton.style.display = 'none';
            }
        }

        function setActiveNav(navId) {
            navItems.forEach(item => item.classList.remove('active'));
            document.getElementById(navId).classList.add('active');
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            }
            return num;
        }

        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            if (isError) {
                element.classList.remove('success-message');
                element.classList.add('error-message');
            } else {
                element.classList.remove('error-message');
                element.classList.add('success-message');
            }
            setTimeout(() => {
                element.classList.add('hidden');
                element.textContent = '';
            }, 3000);
        }

        function generateRandomAvatar() {
            return profileAvatars[Math.floor(Math.random() * profileAvatars.length)];
        }

        function createAvatarElement(avatarChar, size = 40) {
            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('profile-avatar-display');
            avatarDiv.style.width = `${size}px`;
            avatarDiv.style.height = `${size}px`;
            avatarDiv.style.fontSize = `${size * 0.75}px`; // Adjust font size based on avatar size
            avatarDiv.textContent = avatarChar;
            return avatarDiv;
        }

        // --- AUTHENTICATION LOGIC ---
        authSignupButton.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                showMessage(authErrorMessage, 'Please enter email and password.');
                return;
            }
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                showMessage(authErrorMessage, 'Account created successfully! Please complete your profile.', false);
                // Transition to profile setup
                authSection.classList.add('hidden');
                profileSetupForm.classList.remove('hidden');
                setupProfileAvatars();
            } catch (error) {
                showMessage(authErrorMessage, `Error: ${error.message}`);
            }
        });

        authLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            authSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            authErrorMessage.classList.add('hidden');
        });

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showMessage(loginErrorMessage, 'Please enter email and password.');
                return;
            }
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                showMessage(loginErrorMessage, 'Logged in successfully!', false);
                // Check if profile exists, if not, go to profile setup
                checkUserProfileAndNavigate();
            } catch (error) {
                showMessage(loginErrorMessage, `Error: ${error.message}`);
            }
        });

        loginSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            loginErrorMessage.classList.add('hidden');
        });

        // --- PROFILE SETUP LOGIC ---
        function setupProfileAvatars() {
            avatarOptionsContainer.innerHTML = ''; // Clear previous
            profileAvatars.forEach(char => {
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar-option');
                avatarDiv.textContent = char;
                avatarDiv.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                    avatarDiv.classList.add('selected');
                    selectedAvatar = char;
                });
                avatarOptionsContainer.appendChild(avatarDiv);
            });
            // Auto-select a random one initially
            const randomIndex = Math.floor(Math.random() * profileAvatars.length);
            avatarOptionsContainer.children[randomIndex].classList.add('selected');
            selectedAvatar = profileAvatars[randomIndex];
        }

        setupUsernameInput.addEventListener('input', async () => {
            const username = setupUsernameInput.value.trim();
            if (username.length === 0) {
                usernameValidationIcon.classList.add('hidden');
                return;
            }
            // Simple client-side check, true uniqueness needs Cloud Function
            const userRef = db.collection('users').where('username', '==', username);
            const snapshot = await userRef.get();
            if (snapshot.empty) {
                usernameValidationIcon.classList.remove('hidden', 'red');
                usernameValidationIcon.classList.add('green');
            } else {
                usernameValidationIcon.classList.remove('hidden', 'green');
                usernameValidationIcon.classList.add('red');
            }
        });

        completeProfileButton.addEventListener('click', async () => {
            const username = setupUsernameInput.value.trim();
            const whatsapp = setupWhatsappInput.value.trim();
            const instagram = setupInstagramInput.value.trim();

            if (!username) {
                showMessage(profileSetupErrorMessage, 'Username is required.');
                return;
            }
            if (!selectedAvatar) {
                showMessage(profileSetupErrorMessage, 'Please select an avatar.');
                return;
            }
            if (!whatsapp && !instagram) {
                showMessage(profileSetupErrorMessage, 'Please provide either a WhatsApp number or Instagram ID.');
                return;
            }
            if (usernameValidationIcon.classList.contains('red')) {
                showMessage(profileSetupErrorMessage, 'Username is not unique or invalid.');
                return;
            }

            try {
                // This is where you'd call a Cloud Function for true username uniqueness
                // For now, client-side check, but a race condition is possible without backend.
                await db.collection('users').doc(currentUser.uid).set({
                    username: username,
                    avatar: selectedAvatar,
                    whatsapp: whatsapp || null,
                    instagram: instagram || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    followersCount: 0,
                    followingCount: 0,
                    // Initial balance for new users
                    coins: 100,
                    limit: 1,
                    credit: 10
                }, { merge: true }); // Use merge if user might already exist from auth

                // Also initialize user balance collection
                await db.collection('userBalance').doc(currentUser.uid).set({
                    coins: 100,
                    limit: 1,
                    credit: 10,
                    lastRewardClaimed: null // To track daily rewards
                });

                showMessage(profileSetupErrorMessage, 'Profile created successfully!', false);
                checkUserProfileAndNavigate(); // Go to app
            } catch (error) {
                showMessage(profileSetupErrorMessage, `Error creating profile: ${error.message}`);
            }
        });

        // --- APP NAVIGATION & INITIALIZATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                checkUserProfileAndNavigate();
            } else {
                currentUser = null;
                appContainer.style.display = 'none'; // Hide app
                authSection.classList.remove('hidden'); // Show auth
                loginSection.classList.add('hidden');
                profileSetupForm.classList.add('hidden');
                splashScreen.classList.remove('hidden'); // Keep splash for a moment if coming from logout
                setTimeout(() => splashScreen.classList.add('hidden'), 1000); // Hide splash after a short delay
            }
        });

        async function checkUserProfileAndNavigate() {
            if (!currentUser) return;

            splashScreen.classList.add('hidden'); // Hide splash once auth is determined
            const userDoc = await db.collection('users').doc(currentUser.uid).get();

            if (userDoc.exists && userDoc.data().username) {
                // User has a profile, show the app and default to feed
                appContainer.style.display = 'flex';
                showSection('feed-section');
                setActiveNav('nav-feed');
                loadPosts(); // Load initial posts
                updateProfileDisplay(userDoc.data()); // Update current user's profile info
                setupRealtimeBalanceListener(); // Listen to user balance
                checkDailyReward(); // Check for daily reward on login
            } else {
                // User is authenticated but no profile, show profile setup
                appContainer.style.display = 'none'; // Hide app
                authSection.classList.add('hidden');
                loginSection.classList.add('hidden');
                profileSetupForm.classList.remove('hidden');
                setupProfileAvatars();
            }
        }

        // Handle navigation clicks
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = item.dataset.target;
                if (targetId) {
                    showSection(targetId);
                    setActiveNav(item.id);
                }
            });
        });

        // Hide splash screen after a delay
        window.addEventListener('load', () => {
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                // If user is already authenticated, the auth.onAuthStateChanged will handle displaying the app.
                // If not, the auth/login forms will be visible.
            }, 2000); // 2-second splash screen
        });


        // --- POST FEED & SCROLLING ---
        let postsPerPage = 10; // Number of posts to load initially/per scroll
        let currentFeedPosts = []; // To keep track of loaded posts for infinite scroll and duplication

        async function loadPosts(refresh = false) {
            if (!currentUser) return;

            let query = db.collection('posts')
                          .orderBy('createdAt', 'desc')
                          .limit(postsPerPage);

            if (!refresh && lastVisiblePost) {
                query = query.startAfter(lastVisiblePost);
            }

            try {
                const snapshot = await query.get();
                if (snapshot.empty && refresh) {
                    noPostsMessage.classList.remove('hidden');
                    postFeed.innerHTML = ''; // Clear existing posts if refreshing and no new ones
                    currentFeedPosts = [];
                    lastVisiblePost = null;
                    return;
                } else if (snapshot.empty && !refresh) {
                    // No more posts to load during infinite scroll
                    console.log("No more posts to load.");
                    return;
                }

                noPostsMessage.classList.add('hidden'); // Hide "no posts" message if posts are loaded

                lastVisiblePost = snapshot.docs[snapshot.docs.length - 1];

                const newPosts = [];
                snapshot.docs.forEach(doc => {
                    const postData = { id: doc.id, ...doc.data() };
                    newPosts.push(postData);
                });

                if (refresh) {
                    postFeed.innerHTML = ''; // Clear existing posts on refresh
                    currentFeedPosts = [];
                }

                // Add variety: mix vertical, horizontal, and table layouts
                newPosts.forEach((post, index) => {
                    // Introduce horizontal/table sections every X posts
                    if ((currentFeedPosts.length + index) > 0 && (currentFeedPosts.length + index) % 5 === 0) { // Every 5th post group
                        // Placeholder for horizontal/table layout
                        const layoutDiv = document.createElement('div');
                        layoutDiv.classList.add('mixed-layout-section');
                        layoutDiv.style.cssText = `
                            background-color: #222;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                            display: flex;
                            overflow-x: auto;
                            gap: 10px;
                            scroll-snap-type: x mandatory;
                            -webkit-overflow-scrolling: touch;
                        `;
                        // Example: Add 3 small posts horizontally
                        for (let i = 0; i < 3; i++) {
                             // Pick a random post from newPosts or currentFeedPosts for the horizontal view
                            const randomPostIndex = Math.floor(Math.random() * (newPosts.length > 0 ? newPosts.length : currentFeedPosts.length));
                            const postToDisplay = newPosts[randomPostIndex] || currentFeedPosts[randomPostIndex];

                            if (postToDisplay) {
                                const smallPostCard = createPostCard(postToDisplay, true); // true for small/summary version
                                smallPostCard.style.cssText = `
                                    flex: 0 0 calc(50% - 5px); /* Two items per row on small screens */
                                    scroll-snap-align: start;
                                    max-width: 200px;
                                    padding: 10px;
                                    font-size: 0.9em;
                                `;
                                smallPostCard.querySelector('.post-content').style.maxHeight = '50px';
                                smallPostCard.querySelector('.post-content').style.overflow = 'hidden';
                                layoutDiv.appendChild(smallPostCard);
                            }
                        }
                        postFeed.appendChild(layoutDiv);
                    }
                    postFeed.appendChild(createPostCard(post));
                    currentFeedPosts.push(post); // Add to the array for potential duplication later
                });

                // Implement the "posts never end, repeat" logic
                // After loading all fresh posts, if less than N posts, or on continuous scroll,
                // randomly re-insert posts from `currentFeedPosts` to simulate endless feed.
                // This requires careful management to avoid UI performance issues with too many elements.
                if (currentFeedPosts.length < 30) { // If fewer than 30 unique posts, start duplicating
                     for (let i = 0; i < 5; i++) { // Add 5 random duplicates
                         if (currentFeedPosts.length > 0) {
                             const randomPost = currentFeedPosts[Math.floor(Math.random() * currentFeedPosts.length)];
                             postFeed.appendChild(createPostCard(randomPost));
                         }
                     }
                }

            } catch (error) {
                console.error("Error loading posts:", error);
                if (refresh) showMessage(postFeed, 'Failed to refresh posts. Please try again.', true);
            }
        }

        // Infinite scroll observer
        const feedObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && currentUser) {
                // Only load more if not already loading and if we have a lastVisiblePost
                loadPosts();
            }
        }, {
            root: null, // viewport
            rootMargin: '0px 0px 200px 0px', // Load when 200px from bottom
            threshold: 0.1
        });

        // Observe the last post element (or a dummy element at the bottom of the feed)
        // You'll need to dynamically add a marker element or observe the last actual post added.
        // For simplicity, let's just trigger loadPosts when feed section is active and user scrolls.
        feedSection.addEventListener('scroll', () => {
            if (feedSection.scrollTop + feedSection.clientHeight >= feedSection.scrollHeight - 50 && currentActiveSection === 'feed-section') {
                loadPosts();
            }
        });

        refreshPostsButton.addEventListener('click', () => {
            lastVisiblePost = null; // Reset for a full refresh
            postFeed.innerHTML = '';
            loadPosts(true); // Load posts and force refresh
        });

        function createPostCard(post, isSmall = false) {
            const postCard = document.createElement('div');
            postCard.classList.add('post-card');
            postCard.dataset.postId = post.id; // Store post ID

            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${post.avatar || generateRandomAvatar()}</div>
                    <div class="post-username">${post.username}</div>
                </div>
                <div class="post-content">${formatContentWithLinks(post.content)}</div>
                <div class="post-footer">
                    <div class="post-actions">
                        <button class="action-button like-button">
                            <span class="heart-icon">&#x2665;</span> <span class="like-count">${formatNumber(post.likes || 0)}</span>
                        </button>
                        <span class="reaction-summary">
                            <span class="emoji-icons"></span>
                            <span class="total-reactions"></span>
                        </span>
                    </div>
                    <div class="post-views">${formatNumber(post.views || 0)} Views</div>
                </div>
                <div class="reaction-container hidden">
                    <span class="reaction-emoji" data-emoji="👍">👍</span>
                    <span class="reaction-emoji" data-emoji="❤️">❤️</span>
                    <span class="reaction-emoji" data-emoji="😂">😂</span>
                    <span class="reaction-emoji" data-emoji="😢">😢</span>
                    <span class="reaction-emoji" data-emoji="🔥">🔥</span>
                </div>
            `;

            // Neon effect on click
            let neonTimeout;
            postCard.addEventListener('click', () => {
                // Remove neon from all other posts
                document.querySelectorAll('.post-card.neon-glow').forEach(card => {
                    card.classList.remove('neon-glow');
                    clearTimeout(card.neonTimeout); // Clear any pending timeouts
                });

                postCard.classList.add('neon-glow');
                // Auto-turn off neon after 3-4 seconds
                neonTimeout = setTimeout(() => {
                    postCard.classList.remove('neon-glow');
                }, 3500); // 3.5 seconds
                postCard.neonTimeout = neonTimeout; // Store timeout ID on the element
            });


            // Double click to like
            let lastClickTime = 0;
            postCard.addEventListener('click', (event) => {
                const clickTime = new Date().getTime();
                if (clickTime - lastClickTime < 300) { // 300ms for double click
                    const likeButton = postCard.querySelector('.like-button');
                    handleLikePost(post.id, likeButton);
                }
                lastClickTime = clickTime;
            });

            // Long press for emoji reactions
            let pressTimer;
            postCard.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    postCard.classList.add('show-reactions');
                }, 500); // 0.5 second long press
            }, { passive: true }); // Use passive listener for touchstart
            postCard.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
            postCard.addEventListener('touchmove', () => {
                clearTimeout(pressTimer);
                postCard.classList.remove('show-reactions');
            });
            postCard.addEventListener('mousedown', (e) => {
                pressTimer = setTimeout(() => {
                    postCard.classList.add('show-reactions');
                }, 500); // 0.5 second long press
            });
            postCard.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            postCard.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                postCard.classList.remove('show-reactions');
            });


            // Handle emoji reaction clicks
            postCard.querySelectorAll('.reaction-emoji').forEach(emojiButton => {
                emojiButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent post click/like
                    const emoji = emojiButton.dataset.emoji;
                    handlePostReaction(post.id, emoji, postCard);
                    postCard.classList.remove('show-reactions'); // Hide after selection
                });
            });

            // Initial like state based on current user (requires fetching user's likes)
            // This is simplified; in a real app, you'd fetch user's likes for each post on load
            db.collection('posts').doc(post.id).collection('likes').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    postCard.querySelector('.heart-icon').classList.add('liked');
                }
            }).catch(error => console.error("Error checking like status:", error));

            // Initial reaction state
            db.collection('posts').doc(post.id).collection('reactions').where('userId', '==', currentUser.uid).get().then(snapshot => {
                if (!snapshot.empty) {
                    const reactionData = snapshot.docs[0].data();
                    // You might want to visually indicate the user's current reaction here
                }
            }).catch(error => console.error("Error checking reaction status:", error));


            // Listen for real-time updates to likes and reactions (optional, but good for real-time UI)
            db.collection('posts').doc(post.id).collection('likes').onSnapshot(snapshot => {
                postCard.querySelector('.like-count').textContent = formatNumber(snapshot.size);
            });

            db.collection('posts').doc(post.id).collection('reactions').onSnapshot(snapshot => {
                const reactionCounts = {};
                snapshot.forEach(doc => {
                    const emoji = doc.data().emoji;
                    reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                });

                const emojiIconsSpan = postCard.querySelector('.emoji-icons');
                const totalReactionsSpan = postCard.querySelector('.total-reactions');
                emojiIconsSpan.innerHTML = ''; // Clear previous emojis

                let topEmojis = Object.entries(reactionCounts)
                                    .sort(([, countA], [, countB]) => countB - countA)
                                    .slice(0, 3); // Get top 3 emojis

                topEmojis.forEach(([emoji, count]) => {
                    emojiIconsSpan.innerHTML += `${emoji}`; // Only show the emoji, count is in total
                });

                totalReactionsSpan.textContent = `${formatNumber(snapshot.size)}`;
            });

            // Update views (only 1-3 views per user)
            // This needs a Cloud Function to reliably count unique views per user and reset periodically.
            // Client-side can trigger a view increment, but a backend function should enforce the "1-3 views per user" rule.
            incrementPostView(post.id);

            return postCard;
        }

        function formatContentWithLinks(content) {
            // Regex to find URLs (http, https, www, or ending with common domains)
            const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;
            return content.replace(urlRegex, (url) => {
                let formattedUrl = url;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    formattedUrl = 'http://' + url; // Prepend http if missing
                }
                return `<a href="${formattedUrl}" target="_blank" style="color: #3498db; text-decoration: none;">${url}</a>`;
            });
        }

        async function handleLikePost(postId, likeButtonElement) {
            if (!currentUser) {
                showMessage(feedSection, 'Please login to like posts.', true);
                return;
            }

            const likeRef = db.collection('posts').doc(postId).collection('likes').doc(currentUser.uid);
            try {
                const doc = await likeRef.get();
                if (doc.exists) {
                    // Already liked, so unlike
                    await likeRef.delete();
                    likeButtonElement.querySelector('.heart-icon').classList.remove('liked');
                    // Decrement like count visually (Firestore snapshot listener will update for real)
                } else {
                    // Not liked, so like
                    await likeRef.set({
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    likeButtonElement.querySelector('.heart-icon').classList.add('liked');
                    // Increment like count visually (Firestore snapshot listener will update for real)
                }
            } catch (error) {
                console.error("Error liking/unliking post:", error);
                showMessage(feedSection, 'Error liking/unliking post. Please try again.', true);
            }
        }

        async function handlePostReaction(postId, emoji, postCardElement) {
            if (!currentUser) {
                showMessage(feedSection, 'Please login to react to posts.', true);
                return;
            }

            const reactionCollectionRef = db.collection('posts').doc(postId).collection('reactions');
            try {
                // Check if user already reacted to this post
                const existingReactions = await reactionCollectionRef.where('userId', '==', currentUser.uid).get();

                if (!existingReactions.empty) {
                    // User already reacted, update their reaction
                    const reactionDoc = existingReactions.docs[0];
                    await reactionDoc.ref.update({
                        emoji: emoji,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMessage(postCardElement, 'Reaction updated!', false);
                } else {
                    // No existing reaction, add new one
                    await reactionCollectionRef.add({
                        userId: currentUser.uid,
                        emoji: emoji,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showMessage(postCardElement, 'Reaction added!', false);
                }
            } catch (error) {
                console.error("Error adding/updating reaction:", error);
                showMessage(postCardElement, 'Error adding reaction. Please try again.', true);
            }
        }

        async function incrementPostView(postId) {
            if (!currentUser) return; // Only count views for logged-in users

            const viewRef = db.collection('posts').doc(postId).collection('views').doc(currentUser.uid);
            try {
                const viewDoc = await viewRef.get();
                let currentViews = viewDoc.exists ? (viewDoc.data().count || 0) : 0;

                if (currentViews < 3) { // Only count up to 3 views per user
                    await viewRef.set({
                        count: firebase.firestore.FieldValue.increment(1),
                        lastViewed: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    // Update total views on the post (requires a Cloud Function for reliable counting across users)
                    // For now, client-side update for immediate feedback, but this can be inaccurate
                    await db.collection('posts').doc(postId).update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                }
            } catch (error) {
                console.warn("Error incrementing view count:", error);
                // Don't show error to user for views, it's background
            }
        }

        // --- POST UPLOAD LOGIC ---
        publishPostButton.addEventListener('click', async () => {
            if (!currentUser) {
                showMessage(postUploadErrorMessage, 'Please login to publish posts.', true);
                return;
            }

            const postContent = postContentInput.value.trim();
            if (postContent.length === 0) {
                showMessage(postUploadErrorMessage, 'Post content cannot be empty.', true);
                return;
            }

            const selectedBoostHours = document.querySelector('input[name="boost-hours"]:checked').value;
            let adsNeeded = 0;
            if (selectedBoostHours === '18') adsNeeded = 1;
            if (selectedBoostHours === '24') adsNeeded = 2;
            if (selectedBoostHours === '30') adsNeeded = 3;

            try {
                const userBalanceRef = db.collection('userBalance').doc(currentUser.uid);
                const userBalanceDoc = await userBalanceRef.get();
                const balanceData = userBalanceDoc.data();

                if (!balanceData || balanceData.coins < 5 || balanceData.limit < 1) {
                    showMessage(postUploadErrorMessage, 'Insufficient coins (5) or limit (1) to upload post. Watch an ad to get more.', true);
                    return;
                }

                if (adsNeeded > 0) {
                    // Simulate ad watching. In a real app, this would integrate with an ad network.
                    // This is a placeholder: user would actually watch an ad.
                    const confirmed = confirm(`To boost your post for ${selectedBoostHours} hours, you need to watch ${adsNeeded} ad(s). Continue?`);
                    if (!confirmed) {
                        showMessage(postUploadErrorMessage, 'Post upload cancelled.', true);
                        return;
                    }
                    // For now, let's assume ad watching is successful if confirmed
                    // In real app, this would involve a server-side callback from ad network to Cloud Function
                    // which would then update user's balance and allow post.
                    showMessage(postUploadSuccessMessage, `Simulating ad watch for ${adsNeeded} ads.`, false);
                    // For demonstration, let's just proceed assuming ad watched successfully.
                    // A real implementation would involve a more robust reward mechanism.
                }

                // Decrement coins and limit (backend Cloud Function is safer for this)
                await userBalanceRef.update({
                    coins: firebase.firestore.FieldValue.increment(-5),
                    limit: firebase.firestore.FieldValue.increment(-1)
                });

                // Fetch user's current profile for username and avatar
                const userProfileDoc = await db.collection('users').doc(currentUser.uid).get();
                const userProfileData = userProfileDoc.data();
                if (!userProfileData) {
                    showMessage(postUploadErrorMessage, 'User profile not found. Please complete your profile.', true);
                    return;
                }

                await db.collection('posts').add({
                    userId: currentUser.uid,
                    username: userProfileData.username,
                    avatar: userProfileData.avatar,
                    content: postContent,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0,
                    views: 0, // Initial views
                    boostHours: parseInt(selectedBoostHours), // Store boost duration
                    expiresAt: firebase.firestore.Timestamp.fromMillis(Date.now() + parseInt(selectedBoostHours) * 60 * 60 * 1000) // Calculate expiration
                });

                postContentInput.value = ''; // Clear input
                showMessage(postUploadSuccessMessage, 'Post published successfully!', false);
                loadPosts(true); // Refresh feed to show new post

            } catch (error) {
                console.error("Error publishing post:", error);
                showMessage(postUploadErrorMessage, `Error publishing post: ${error.message}`, true);
            }
        });

        // --- MANAGE USER BALANCE & ADS ---
        function setupRealtimeBalanceListener() {
            if (!currentUser) return;
            db.collection('userBalance').doc(currentUser.uid)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        uploadCoinsDisplay.textContent = formatNumber(data.coins || 0);
                        uploadLimitDisplay.textContent = formatNumber(data.limit || 0);
                        // Potentially update credit display here too
                    } else {
                        // If balance document doesn't exist, create it (should be created on profile setup)
                        db.collection('userBalance').doc(currentUser.uid).set({
                            coins: 0, limit: 0, credit: 0, lastRewardClaimed: null
                        });
                    }
                }, error => {
                    console.error("Error listening to user balance:", error);
                });
        }

        // Placeholder for ad logic (requires actual ad network integration)
        async function showAdAndGrantReward(type) {
            // In a real app, this would trigger an ad display.
            // On ad completion, the ad network would send a server-side callback to your Cloud Function.
            // The Cloud Function would then update the user's balance in Firestore.
            // For now, simulate success:
            console.log(`Simulating ad for ${type} reward...`);
            await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate ad loading time

            try {
                const userBalanceRef = db.collection('userBalance').doc(currentUser.uid);
                let rewardAmount;
                if (type === 'limit') {
                    await userBalanceRef.update({ limit: firebase.firestore.FieldValue.increment(1) });
                    rewardAmount = '1 Limit';
                } else if (type === 'coins') {
                    await userBalanceRef.update({ coins: firebase.firestore.FieldValue.increment(10) });
                    rewardAmount = '10 Coins';
                } else if (type === 'credit') {
                    await userBalanceRef.update({ credit: firebase.firestore.FieldValue.increment(10) });
                    rewardAmount = '10 Credits';
                }
                // Update UI visually for reward
                rewardDisplay.textContent = `+${rewardAmount}`;
                rewardModal.classList.add('active'); // Show reward confirmation modal

            } catch (error) {
                console.error("Error granting ad reward:", error);
                alert('Failed to grant reward after ad. Please try again.');
            }
        }

        // --- DAILY REWARD SYSTEM ---
        const DAILY_REWARD_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        let rewardCountdownInterval;

        async function checkDailyReward() {
            if (!currentUser) return;

            const userBalanceRef = db.collection('userBalance').doc(currentUser.uid);
            const userBalanceDoc = await userBalanceRef.get();
            const data = userBalanceDoc.data();

            const lastClaimedTime = data && data.lastRewardClaimed ? data.lastRewardClaimed.toMillis() : 0;
            const currentTime = Date.now();
            const timeSinceLastClaim = currentTime - lastClaimedTime;

            if (timeSinceLastClaim >= DAILY_REWARD_INTERVAL) {
                // Reward is available
                giftButton.style.animation = 'pulse 1s infinite alternate'; // Animate gift button
                // Show notification if app is open
                if (document.visibilityState === 'visible') {
                    showRewardModal('Your daily reward is ready!');
                } else {
                    // Send notification (requires service worker for real push notifications)
                    // For now, log it:
                    console.log('Notification: Your daily reward is ready!');
                }
            } else {
                // Reward not yet available, start countdown
                giftButton.style.animation = 'none';
                startRewardCountdown(lastClaimedTime);
            }
        }

        function showRewardModal(message) {
            rewardDisplay.textContent = message; // Initial message
            claimRewardButton.classList.remove('hidden');
            rewardCountdown.textContent = ''; // Clear countdown initially
            rewardModal.style.display = 'flex'; // Show modal
        }

        function startRewardCountdown(lastClaimedTime) {
            clearInterval(rewardCountdownInterval); // Clear any existing interval

            rewardCountdownInterval = setInterval(() => {
                const currentTime = Date.now();
                const nextClaimTime = lastClaimedTime + DAILY_REWARD_INTERVAL;
                const timeLeft = nextClaimTime - currentTime;

                if (timeLeft <= 0) {
                    clearInterval(rewardCountdownInterval);
                    checkDailyReward(); // Re-check if reward is now available
                    return;
                }

                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                rewardCountdown.textContent = `Next reward in: ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }

        giftButton.addEventListener('click', () => {
            checkDailyReward(); // Manually check on click
            rewardModal.style.display = 'flex'; // Always show modal, it will show reward or countdown
            if (giftButton.style.animation !== 'none') {
                 // If animating, it means reward is ready
                 rewardDisplay.textContent = 'Claim your 2 Limit, 10 Coins, 10 Credit!';
                 claimRewardButton.classList.remove('hidden');
                 rewardCountdown.textContent = '';
            } else {
                // If not animating, show countdown (handled by checkDailyReward already)
                claimRewardButton.classList.add('hidden');
            }
        });

        claimRewardButton.addEventListener('click', async () => {
            if (!currentUser) {
                alert('Please login to claim rewards.');
                return;
            }

            try {
                const userBalanceRef = db.collection('userBalance').doc(currentUser.uid);
                await userBalanceRef.update({
                    limit: firebase.firestore.FieldValue.increment(2),
                    coins: firebase.firestore.FieldValue.increment(10),
                    credit: firebase.firestore.FieldValue.increment(10),
                    lastRewardClaimed: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage(rewardModal.querySelector('.modal-content'), 'Reward claimed successfully!', false);
                rewardModal.style.display = 'none'; // Hide modal
                giftButton.style.animation = 'none'; // Stop animation
                checkDailyReward(); // Restart countdown
            } catch (error) {
                console.error("Error claiming reward:", error);
                showMessage(rewardModal.querySelector('.modal-content'), 'Error claiming reward. Please try again.', true);
            }
        });

        // --- USER PROFILE LOGIC ---
        async function updateProfileDisplay(userData) {
            myProfileAvatar.textContent = userData.avatar || generateRandomAvatar();
            myProfileUsername.textContent = userData.username;
            myFollowersCount.textContent = formatNumber(userData.followersCount || 0);
            myFollowingCount.textContent = formatNumber(userData.followingCount || 0);

            if (userData.whatsapp) {
                myProfileWhatsappButton.href = `https://wa.me/${userData.whatsapp.replace(/\+/g, '')}`; // Remove + for direct link
                myProfileWhatsappButton.classList.remove('hidden');
            } else {
                myProfileWhatsappButton.classList.add('hidden');
            }
            if (userData.instagram) {
                myProfileInstagramButton.href = `https://instagram.com/${userData.instagram.replace(/^@/, '')}`; // Remove @ if present
                myProfileInstagramButton.classList.remove('hidden');
            } else {
                myProfileInstagramButton.classList.add('hidden');
            }

            // Load user's own posts
            loadUserPosts(currentUser.uid, myProfilePosts);
        }

        async function loadUserPosts(userId, containerElement) {
            containerElement.innerHTML = ''; // Clear previous posts
            try {
                const snapshot = await db.collection('posts')
                                         .where('userId', '==', userId)
                                         .orderBy('createdAt', 'desc')
                                         .limit(10) // Load first 10 user posts
                                         .get();
                if (snapshot.empty) {
                    containerElement.innerHTML = '<p class="text-center">No posts yet.</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    containerElement.appendChild(createPostCard({ id: doc.id, ...doc.data() }));
                });
                // Implement infinite scroll for profile posts if needed
            } catch (error) {
                console.error("Error loading user posts:", error);
                containerElement.innerHTML = '<p class="text-center error-message">Failed to load posts.</p>';
            }
        }

        // View other user's profile
        async function viewUserProfile(userId) {
            if (!currentUser || currentUser.uid === userId) {
                showSection('my-profile-section'); // If it's my own profile
                setActiveNav('nav-profile');
                return;
            }

            showSection('other-user-profile-section');
            // Remove active nav, as this is a dynamic view
            navItems.forEach(item => item.classList.remove('active'));

            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    alert('User not found.');
                    showSection('feed-section'); // Go back to feed if user not found
                    setActiveNav('nav-feed');
                    return;
                }

                const userData = userDoc.data();
                otherProfileAvatar.textContent = userData.avatar || generateRandomAvatar();
                otherProfileUsername.textContent = userData.username;
                otherFollowersCount.textContent = formatNumber(userData.followersCount || 0);
                otherFollowingCount.textContent = formatNumber(userData.followingCount || 0);

                if (userData.whatsapp) {
                    otherProfileWhatsappButton.href = `https://wa.me/${userData.whatsapp.replace(/\+/g, '')}`;
                    otherProfileWhatsappButton.classList.remove('hidden');
                } else {
                    otherProfileWhatsappButton.classList.add('hidden');
                }
                if (userData.instagram) {
                    otherProfileInstagramButton.href = `https://instagram.com/${userData.instagram.replace(/^@/, '')}`;
                    otherProfileInstagramButton.classList.remove('hidden');
                } else {
                    otherProfileInstagramButton.classList.add('hidden');
                }

                // Check follow status
                const followDoc = await db.collection('users').doc(currentUser.uid).collection('following').doc(userId).get();
                if (followDoc.exists) {
                    otherFollowButton.classList.add('hidden');
                    otherUnfollowButton.classList.remove('hidden');
                } else {
                    otherFollowButton.classList.remove('hidden');
                    otherUnfollowButton.classList.add('hidden');
                }

                loadUserPosts(userId, otherProfilePosts);
                currentChatRecipientId = userId; // Set for messaging
            } catch (error) {
                console.error("Error viewing user profile:", error);
                alert('Failed to load user profile.');
                showSection('feed-section'); // Go back to feed on error
                setActiveNav('nav-feed');
            }
        }

        // Follow/Unfollow logic
        otherFollowButton.addEventListener('click', async () => {
            if (!currentUser || !currentChatRecipientId) return; // currentChatRecipientId holds the other user's ID
            try {
                // Add to my 'following'
                await db.collection('users').doc(currentUser.uid).collection('following').doc(currentChatRecipientId).set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Add to other user's 'followers' (ideally via Cloud Function to keep consistent)
                await db.collection('users').doc(currentChatRecipientId).collection('followers').doc(currentUser.uid).set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update counts (again, Cloud Function is better for atomic updates)
                await db.collection('users').doc(currentUser.uid).update({
                    followingCount: firebase.firestore.FieldValue.increment(1)
                });
                await db.collection('users').doc(currentChatRecipientId).update({
                    followersCount: firebase.firestore.FieldValue.increment(1)
                });

                otherFollowButton.classList.add('hidden');
                otherUnfollowButton.classList.remove('hidden');
                // Update counts on UI immediately for feedback
                otherFollowersCount.textContent = formatNumber(parseInt(otherFollowersCount.textContent) + 1);
                // My own following count will update via listener on my profile section
                showMessage(otherUserProfileSection, 'User followed!', false);
            } catch (error) {
                console.error("Error following user:", error);
                showMessage(otherUserProfileSection, `Error following: ${error.message}. Please try again.`, true);
            }
        });

        otherUnfollowButton.addEventListener('click', async () => {
            if (!currentUser || !currentChatRecipientId) return;
            try {
                await db.collection('users').doc(currentUser.uid).collection('following').doc(currentChatRecipientId).delete();
                await db.collection('users').doc(currentChatRecipientId).collection('followers').doc(currentUser.uid).delete();

                await db.collection('users').doc(currentUser.uid).update({
                    followingCount: firebase.firestore.FieldValue.increment(-1)
                });
                await db.collection('users').doc(currentChatRecipientId).update({
                    followersCount: firebase.firestore.FieldValue.increment(-1)
                });

                otherFollowButton.classList.remove('hidden');
                otherUnfollowButton.classList.add('hidden');
                otherFollowersCount.textContent = formatNumber(parseInt(otherFollowersCount.textContent) - 1);
                showMessage(otherUserProfileSection, 'User unfollowed.', false);
            } catch (error) {
                console.error("Error unfollowing user:", error);
                showMessage(otherUserProfileSection, `Error unfollowing: ${error.message}. Please try again.`, true);
            }
        });

        myEditProfileButton.addEventListener('click', () => {
             // For simplicity, re-use the profile setup form logic for editing
             // In a real app, you'd pre-fill the fields with current user data
             showSection('profile-setup-form');
             setupUsernameInput.value = myProfileUsername.textContent; // Pre-fill username
             // You'd also need to load and pre-select the current avatar
             // And pre-fill WhatsApp/Instagram
        });

        // Event listeners for Followers/Following count to open list
        myFollowersStat.addEventListener('click', () => showFollowList('followers', currentUser.uid));
        myFollowingStat.addEventListener('click', () => showFollowList('following', currentUser.uid));
        otherFollowersStat.addEventListener('click', () => showFollowList('followers', currentChatRecipientId));
        otherFollowingStat.addEventListener('click', () => showFollowList('following', currentChatRecipientId));

        async function showFollowList(type, userId) {
            if (!currentUser) return;
            followListPopup.style.display = 'flex';
            followListContent.innerHTML = `
                <span class="close-button" onclick="document.querySelector('.follow-list-popup').style.display='none';">&times;</span>
                <h3>${type === 'followers' ? 'Followers' : 'Following'}</h3>
                <div id="follow-list-items"></div>
            `;
            const listContainer = document.getElementById('follow-list-items');

            try {
                const snapshot = await db.collection('users').doc(userId).collection(type).get();
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center">No users found.</p>';
                    return;
                }

                for (const doc of snapshot.docs) {
                    const followedOrFollowerId = doc.id;
                    const userDoc = await db.collection('users').doc(followedOrFollowerId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const listItem = document.createElement('div');
                        listItem.classList.add('follow-list-item');
                        listItem.innerHTML = `
                            <div class="follow-list-item-avatar">${userData.avatar || generateRandomAvatar()}</div>
                            <div class="follow-list-item-username">${userData.username}</div>
                        `;
                        listItem.addEventListener('click', () => {
                            viewUserProfile(followedOrFollowerId);
                            followListPopup.style.display = 'none';
                        });
                        listContainer.appendChild(listItem);
                    }
                }

            } catch (error) {
                console.error(`Error fetching ${type} list:`, error);
                listContainer.innerHTML = '<p class="text-center error-message">Failed to load list.</p>';
            }
        }
        closeFollowListPopup.addEventListener('click', () => followListPopup.style.display = 'none');


        // --- SEARCH FUNCTIONALITY ---
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 500); // Debounce search
        });

        async function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            searchResults.innerHTML = ''; // Clear previous results
            noSearchResults.classList.add('hidden');

            if (query.length === 0) {
                noSearchResults.textContent = 'Start typing to search...';
                noSearchResults.classList.remove('hidden');
                return;
            }

            try {
                // Search for users
                // Note: Firestore does not support 'contains' queries for partial matches efficiently.
                // For real "starts with" or "fuzzy" search, you need a dedicated search service like Algolia or a Cloud Function + full-text search index.
                // This will only find exact matches or very specific "starts with" if using a range query.
                const userSnapshot = await db.collection('users')
                                            .where('username', '>=', query)
                                            .where('username', '<=', query + '\uf8ff')
                                            .limit(10)
                                            .get();

                if (userSnapshot.empty) {
                    searchResults.innerHTML += '<p class="text-center">No users found.</p>';
                } else {
                    userSnapshot.docs.forEach(async doc => {
                        const userData = doc.data();
                        const isFollowing = currentUser ? (await db.collection('users').doc(currentUser.uid).collection('following').doc(doc.id).get()).exists : false;

                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-result-item');
                        resultItem.innerHTML = `
                            <div class="search-result-avatar">${userData.avatar || generateRandomAvatar()}</div>
                            <div class="search-result-info">
                                <div class="search-result-username">${userData.username}</div>
                            </div>
                            ${currentUser && currentUser.uid !== doc.id ?
                                `<button class="search-result-follow-button ${isFollowing ? 'following' : ''}" data-user-id="${doc.id}">
                                    ${isFollowing ? 'Following' : 'Follow'}
                                </button>` : ''
                            }
                        `;
                        resultItem.addEventListener('click', () => {
                            viewUserProfile(doc.id);
                        });
                        searchResults.appendChild(resultItem);

                        // Attach follow/unfollow listener to the button if it exists
                        const followBtn = resultItem.querySelector('.search-result-follow-button');
                        if (followBtn) {
                            followBtn.addEventListener('click', async (e) => {
                                e.stopPropagation(); // Prevent opening profile
                                const targetUserId = e.target.dataset.userId;
                                if (e.target.classList.contains('following')) {
                                    // Unfollow logic
                                    await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).delete();
                                    await db.collection('users').doc(targetUserId).collection('followers').doc(currentUser.uid).delete();
                                    e.target.classList.remove('following');
                                    e.target.textContent = 'Follow';
                                    showMessage(searchResults, `Unfollowed ${userData.username}`, false);
                                } else {
                                    // Follow logic
                                    await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                                    await db.collection('users').doc(targetUserId).collection('followers').doc(currentUser.uid).set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                                    e.target.classList.add('following');
                                    e.target.textContent = 'Following';
                                    showMessage(searchResults, `Followed ${userData.username}!`, false);
                                }
                                // Trigger re-render of current user's profile if active
                                if (currentActiveSection === 'my-profile-section') {
                                    const myUserDoc = await db.collection('users').doc(currentUser.uid).get();
                                    if (myUserDoc.exists) updateProfileDisplay(myUserDoc.data());
                                }
                            });
                        }
                    });
                }
                // No search for posts here, as the user wants user list first.
                // For post search, you'd repeat a similar query on 'posts' collection for 'content'.

            } catch (error) {
                console.error("Error during search:", error);
                noSearchResults.textContent = 'Error during search. Please try again.';
                noSearchResults.classList.remove('hidden');
            }
        }


        // --- MESSAGING ---
        otherMessageButton.addEventListener('click', async () => {
            if (!currentUser || !currentChatRecipientId) {
                showMessage(otherUserProfileSection, 'Please select a user to message.', true);
                return;
            }
            // Navigate to chat section and load messages
            await openChatWithUser(currentChatRecipientId);
        });

        async function openChatWithUser(recipientId) {
            showSection('chat-section');
            // Remove active nav, as this is a dynamic view
            navItems.forEach(item => item.classList.remove('active'));

            const recipientDoc = await db.collection('users').doc(recipientId).get();
            if (!recipientDoc.exists) {
                showMessage(chatSection, 'Recipient not found.', true);
                showSection('messages-list-section');
                return;
            }
            const recipientData = recipientDoc.data();
            chatHeaderAvatar.textContent = recipientData.avatar || generateRandomAvatar();
            chatHeaderUsername.textContent = recipientData.username;
            currentChatRecipientId = recipientId; // Ensure this is set

            // Clear previous messages
            messageList.innerHTML = '';

            // Stop listening to previous chat
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            // Listen for new messages in real-time
            unsubscribeMessages = db.collection('messages')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('timestamp') // Order by timestamp
                .where('timestamp', '>', new Date(Date.now() - 12 * 60 * 60 * 1000)) // Only messages within last 12 hours
                .onSnapshot(snapshot => {
                    messageList.innerHTML = ''; // Clear to re-render all filtered messages
                    snapshot.docs.forEach(doc => {
                        const message = doc.data();
                        // Filter for current conversation
                        const isMyMessage = message.senderId === currentUser.uid;
                        const isRelevant = (message.senderId === currentUser.uid && message.receiverId === currentChatRecipientId) ||
                                           (message.senderId === currentChatRecipientId && message.receiverId === currentUser.uid);

                        if (isRelevant) {
                            const messageBubble = document.createElement('div');
                            messageBubble.classList.add('message-bubble', isMyMessage ? 'sent' : 'received');
                            messageBubble.innerHTML = `
                                <span>${message.content}</span>
                                <span class="message-timestamp">${new Date(message.timestamp.toMillis()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            `;
                            messageList.appendChild(messageBubble);
                        }
                    });
                    // Scroll to bottom
                    messageList.scrollTop = messageList.scrollHeight;
                }, error => {
                    console.error("Error getting messages:", error);
                    showMessage(chatSection, 'Error loading messages.', true);
                });
        }


        sendMessageButton.addEventListener('click', async () => {
            if (!currentUser || !currentChatRecipientId) {
                showMessage(chatSection, 'Cannot send message. Recipient not set.', true);
                return;
            }

            const messageContent = chatMessageInput.value.trim();
            if (messageContent.length === 0) return;

            try {
                const userBalanceRef = db.collection('userBalance').doc(currentUser.uid);
                const userBalanceDoc = await userBalanceRef.get();
                const balanceData = userBalanceDoc.data();

                if (!balanceData || balanceData.credit < 1) {
                    showMessage(chatSection, 'Insufficient message credits. Watch an ad to get more.', true);
                    return;
                }

                await db.collection('messages').add({
                    senderId: currentUser.uid,
                    receiverId: currentChatRecipientId,
                    content: messageContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    participants: [currentUser.uid, currentChatRecipientId] // For easier query
                });

                // Decrement credit (backend Cloud Function is safer for this)
                await userBalanceRef.update({
                    credit: firebase.firestore.FieldValue.increment(-1)
                });

                chatMessageInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage(chatSection, `Error sending message: ${error.message}`, true);
            }
        });

        // --- CONVERSATIONS LIST ---
        async function loadConversationsList() {
            if (!currentUser) return;
            conversationsList.innerHTML = '';
            noConversationsMessage.classList.add('hidden');

            try {
                // Get all messages where current user is sender or receiver
                const querySent = db.collection('messages').where('senderId', '==', currentUser.uid).orderBy('timestamp', 'desc');
                const queryReceived = db.collection('messages').where('receiverId', '==', currentUser.uid).orderBy('timestamp', 'desc');

                const [sentSnapshot, receivedSnapshot] = await Promise.all([querySent.get(), queryReceived.get()]);

                const uniqueChatPartners = new Set();
                const lastMessageMap = new Map(); // Map to store the latest message for each chat partner

                sentSnapshot.docs.forEach(doc => {
                    const message = doc.data();
                    const partnerId = message.receiverId;
                    if (partnerId !== currentUser.uid) { // Exclude self-messages if any
                        uniqueChatPartners.add(partnerId);
                        if (!lastMessageMap.has(partnerId) || message.timestamp.toMillis() > lastMessageMap.get(partnerId).timestamp.toMillis()) {
                            lastMessageMap.set(partnerId, message);
                        }
                    }
                });

                receivedSnapshot.docs.forEach(doc => {
                    const message = doc.data();
                    const partnerId = message.senderId;
                     if (partnerId !== currentUser.uid) {
                        uniqueChatPartners.add(partnerId);
                        if (!lastMessageMap.has(partnerId) || message.timestamp.toMillis() > lastMessageMap.get(partnerId).timestamp.toMillis()) {
                            lastMessageMap.set(partnerId, message);
                        }
                     }
                });

                if (uniqueChatPartners.size === 0) {
                    noConversationsMessage.classList.remove('hidden');
                    return;
                }

                // Fetch details for each unique chat partner
                const partnerPromises = Array.from(uniqueChatPartners).map(id => db.collection('users').doc(id).get());
                const partnerDocs = await Promise.all(partnerPromises);

                const conversationsData = [];
                partnerDocs.forEach(doc => {
                    if (doc.exists) {
                        const partnerData = doc.data();
                        const lastMessage = lastMessageMap.get(doc.id);
                        if (lastMessage) { // Ensure there's a last message for this partner
                            conversationsData.push({
                                id: doc.id,
                                username: partnerData.username,
                                avatar: partnerData.avatar,
                                lastMessageContent: lastMessage.content,
                                lastMessageTimestamp: lastMessage.timestamp.toMillis()
                            });
                        }
                    }
                });

                // Sort conversations by latest message
                conversationsData.sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);

                conversationsData.forEach(conv => {
                    const convItem = document.createElement('div');
                    convItem.classList.add('search-result-item'); // Re-using styling
                    convItem.innerHTML = `
                        <div class="search-result-avatar">${conv.avatar || generateRandomAvatar()}</div>
                        <div class="search-result-info">
                            <div class="search-result-username">${conv.username}</div>
                            <div style="font-size: 0.9em; color: #aaa; max-width: 80%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conv.lastMessageContent}</div>
                        </div>
                    `;
                    convItem.addEventListener('click', () => openChatWithUser(conv.id));
                    conversationsList.appendChild(convItem);
                });


            } catch (error) {
                console.error("Error loading conversations:", error);
                noConversationsMessage.textContent = 'Failed to load conversations.';
                noConversationsMessage.classList.remove('hidden');
            }
        }

        // --- SIDE MENU & MODALS ---
        menuButton.addEventListener('click', () => {
            sideMenu.classList.toggle('open');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

        menuLogout.addEventListener('click', async () => {
            try {
                await auth.signOut();
                sideMenu.classList.remove('open');
                overlay.classList.remove('active');
                // The onAuthStateChanged listener will handle redirecting to login.
                window.location.reload(); // Hard refresh to ensure full state reset
            } catch (error) {
                console.error("Error logging out:", error);
                alert("Logout failed. Please try again.");
            }
        });

        menuDataSaver.addEventListener('click', () => {
            dataSaverMode = !dataSaverMode;
            dataSaverStatus.textContent = dataSaverMode ? '(On)' : '(Off)';
            alert(`Data Saver is now ${dataSaverMode ? 'On' : 'Off'}. (Feature not fully implemented)`);
            // In a real app, this would change how images/videos load (e.g., lower quality, only on tap)
        });

        menuAbout.addEventListener('click', () => {
            aboutModal.style.display = 'flex';
            sideMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

        menuPrivacyPolicy.addEventListener('click', () => {
            privacyPolicyModal.style.display = 'flex';
            sideMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                if (modalId) {
                    document.getElementById(modalId).style.display = 'none';
                }
            });
        });

        // --- EVENT LISTENERS FOR SECTION CHANGES (to load data) ---
        // This is a simplified way. For a larger app, consider a routing library.
        document.getElementById('nav-feed').addEventListener('click', () => loadPosts(true));
        document.getElementById('nav-messages').addEventListener('click', loadConversationsList);
        document.getElementById('nav-profile').addEventListener('click', async () => {
            // Reload user profile data to ensure it's fresh
            if (currentUser) {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    updateProfileDisplay(userDoc.data());
                }
            }
        });

    </script>
</body>
</html>
