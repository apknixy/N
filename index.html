<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AddMint</title>
    <style>
        /* ========================================================= */
        /* == Global Styles, Variables & Resets ==================== */
        /* ========================================================= */
        :root {
            --dark-bg: #0d0d0d;
            --dark-fg: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #00aaff;
            --primary-dark: #0077c2;
            --accent-color: #ffcc00;
            --accent-dark: #cc9900;
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --success-color: #4CAF50;
            --error-color: #E53935;
            --info-color: #2196F3;
            --transition-speed: 0.4s ease;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 18px;
            --font-family: 'Poppins', 'Segoe UI', 'Roboto', sans-serif;
            
            /* NEON Colors */
            --neon-blue: #00aaff;
            --neon-blue-shadow: rgba(0, 170, 255, 0.8);
            --neon-pink: #ff00ff;
            --neon-pink-shadow: rgba(255, 0, 255, 0.8);
            --neon-green: #00ff00;
            --neon-green-shadow: rgba(0, 255, 0, 0.8);
            --neon-yellow: #ffff00;
            --neon-yellow-shadow: rgba(255, 255, 0, 0.8);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg), #121212);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed); }
        a:hover { color: var(--accent-color); text-decoration: underline; }

        button, input[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        button:hover, input[type="submit"]:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
        }
        button:active, input[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        }
        
        input[type="email"], input[type="password"], input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.6);
            appearance: none;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.6);
        }
        
        .container {
            width: 90%;
            max-width: 500px;
            margin: 20px auto;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
        }

        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            word-wrap: break-word;
            border: 1px solid transparent;
            animation: slideInUp 0.4s ease-out;
        }
        .message.success { background-color: rgba(76, 175, 80, 0.2); color: var(--success-color); border-color: var(--success-color); }
        .message.error { background-color: rgba(229, 57, 53, 0.2); color: var(--error-color); border-color: var(--error-color); }
        .message.info { background-color: rgba(33, 150, 243, 0.2); color: var(--info-color); border-color: var(--info-color); }

        .hidden { display: none !important; }

        /* ========================================================= */
        /* == App Layout & Structure =============================== */
        /* ========================================================= */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            transition: opacity 0.5s ease;
        }

        header {
            background-color: var(--dark-fg);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 3px 20px var(--shadow-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99;
            animation: slideDown 0.5s ease-out;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .app-logo {
            display: flex;
            align-items: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.6);
            letter-spacing: 1px;
            position: relative;
        }
        .app-logo .shape {
            width: 40px; height: 40px;
            background: linear-gradient(45deg, var(--accent-color), #ffdb58);
            transform: rotate(45deg);
            border-radius: 10px;
            margin-right: 15px;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.6);
            animation: headerLogoSpin 4s infinite linear, headerLogoBounce 2s infinite alternate;
        }
        .header-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .stat-item:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .stat-item .icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        .header-menu-btn, .header-refresh-btn {
            font-size: 1.5rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .header-menu-btn:hover, .header-refresh-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }


        /* Scrollable Main Content */
        main {
            flex-grow: 1;
            padding: 20px;
            padding-top: 80px;
            padding-bottom: 80px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        section {
            display: none;
            padding: 30px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px var(--shadow-color);
            animation: fadeIn 0.6s ease-out;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        section.active { display: block; }
        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
            letter-spacing: 1px;
        }
        
        footer {
            background-color: var(--dark-fg);
            padding: 10px 0; /* Reduced height */
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -3px 20px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 99;
            animation: slideUp 0.5s ease-out;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color var(--transition-speed), transform 0.2s ease;
            padding: 5px 8px; /* Reduced padding */
            border-radius: var(--border-radius-sm);
            flex: 1;
            max-width: 100px;
        }
        .nav-item.active { color: var(--primary-color); transform: translateY(-3px); background-color: rgba(0, 170, 255, 0.1); }
        .nav-item:hover { color: var(--primary-color); background-color: rgba(0, 170, 255, 0.05); }
        .nav-item .icon {
            font-size: 1.5rem; /* Reduced icon size */
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }
        .nav-item:hover .icon { transform: scale(1.1); }


        /* ========================================================= */
        /* == Section Specific Styles ============================== */
        /* ========================================================= */
        
        .password-input-container { position: relative; margin-bottom: 15px; }
        .password-input-container input { padding-right: 50px; }
        .toggle-password {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--border-color);
            font-size: 1.3rem;
            transition: color var(--transition-speed);
            padding: 5px;
            border-radius: 5px;
        }
        .toggle-password:hover { color: var(--primary-color); }
        
        .username-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        .username-input-group input {
            padding-right: 40px; /* Space for the icon */
            margin-bottom: 0;
        }
        .username-status-icon {
            position: absolute;
            right: 10px;
            font-size: 1.2rem;
        }
        .username-status-icon.available { color: var(--success-color); }
        .username-status-icon.unavailable { color: var(--error-color); }

        /* Post Display Section */
        #posts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        #posts-container > .post-card {
            margin-bottom: 0;
        }
        .horizontal-scroll-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            background-color: rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.6s ease-out;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            max-width: 100%;
        }
        .horizontal-scroll-container .post-card {
            min-width: 280px;
            flex-shrink: 0;
            padding: 20px;
        }

        .post-card {
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: 0 8px 20px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
            animation: slideInUp 0.6s ease-out;
        }
        .post-card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.9); border-color: var(--primary-color); }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .post-header h3 { color: var(--accent-color); font-size: 1.4rem; font-weight: 700; text-shadow: 0 0 5px rgba(255, 204, 0, 0.4); cursor: pointer; }
        .post-actions-icons {
            display: flex;
            gap: 10px;
            position: relative;
        }
        .action-icon-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .action-icon-btn:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        .action-icon-btn.liked {
            color: var(--error-color); /* Red for liked heart */
            animation: heartBeat 0.5s ease-in-out;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--dark-fg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
            min-width: 150px;
            overflow: hidden;
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .dropdown-menu.visible {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .dropdown-menu button {
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            font-size: 1rem;
            border-radius: 0;
            box-shadow: none;
            transition: background-color 0.2s ease;
        }
        .dropdown-menu button:hover {
            background-color: var(--border-color);
        }
        
        .post-card p { font-size: 1.05rem; margin-bottom: 20px; flex-grow: 1; word-wrap: break-word; color: var(--text-color); }
        .post-card p a { color: var(--primary-color); text-decoration: underline; }
        .post-meta { font-size: 0.88rem; color: #aaa; margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); }
        .post-likes-count { margin-left: 5px; }

        .reaction-bar {
            position: absolute;
            bottom: -50px; /* Hidden below the card */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid var(--primary-color);
            border-radius: 25px;
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: bottom 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 5;
        }

        .post-card.show-reactions .reaction-bar {
            bottom: 5px; /* Visible above the card */
            opacity: 1;
            visibility: visible;
        }

        .reaction-emoji {
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .reaction-emoji:hover {
            transform: scale(1.2);
        }

        .post-reactions-summary {
            font-size: 0.8rem;
            color: #bbb;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }
        .post-reactions-summary .top-emoji {
            font-size: 1.1rem;
        }


        /* Neon Post Styles with different colors */
        .post-card.neon-blue {
            box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-blue) inset;
            border-color: var(--neon-blue);
            /* animation: neonBlueGlow 1.5s infinite alternate ease-in-out; Remove infinite animation */
        }
        .post-card.neon-blue h3, .post-card.neon-blue p, .post-card.neon-blue .post-meta { text-shadow: 0 0 10px var(--neon-blue-shadow), 0 0 20px var(--neon-blue-shadow); }

        .post-card.neon-pink {
            box-shadow: 0 0 15px var(--neon-pink), 0 0 25px var(--neon-pink) inset;
            border-color: var(--neon-pink);
            /* animation: neonPinkGlow 1.5s infinite alternate ease-in-out; */
        }
        .post-card.neon-pink h3, .post-card.neon-pink p, .post-card.neon-pink .post-meta { text-shadow: 0 0 10px var(--neon-pink-shadow), 0 0 20px var(--neon-pink-shadow); }

        .post-card.neon-green {
            box-shadow: 0 0 15px var(--neon-green), 0 0 25px var(--neon-green) inset;
            border-color: var(--neon-green);
            /* animation: neonGreenGlow 1.5s infinite alternate ease-in-out; */
        }
        .post-card.neon-green h3, .post-card.neon-green p, .post-card.neon-green .post-meta { text-shadow: 0 0 10px var(--neon-green-shadow), 0 0 20px var(--neon-green-shadow); }

        .post-card.neon-yellow {
            box-shadow: 0 0 15px var(--neon-yellow), 0 0 25px var(--neon-yellow) inset;
            border-color: var(--neon-yellow);
            /* animation: neonYellowGlow 1.5s infinite alternate ease-in-out; */
        }
        .post-card.neon-yellow h3, .post-card.neon-yellow p, .post-card.neon-yellow .post-meta { text-shadow: 0 0 10px var(--neon-yellow-shadow), 0 0 20px var(--neon-yellow-shadow); }
        
        .url-link { color: var(--primary-color); text-decoration: underline; }

        /* Profile Section */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--dark-fg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.6s ease-out;
        }

        .profile-image-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            position: relative;
            margin: 0 auto 20px auto;
            animation: profilePulse 2s infinite ease-out;
        }
        .profile-image {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--neon-blue) 0%, var(--neon-pink) 100%);
            animation: profileImageGlow 3s infinite alternate ease-in-out;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem; /* For the generated character icon */
            color: white;
            font-weight: bold;
        }

        .profile-info h3 {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-shadow: 0 0 8px rgba(255, 204, 0, 0.5);
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 25px;
        }
        .profile-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .profile-stat-item:hover {
            color: var(--primary-color);
            transform: scale(1.05);
        }
        .profile-stat-item strong {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .profile-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .profile-buttons button {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        #user-profile-details, #other-user-profile-details {
            margin-top: 30px;
            background-color: var(--dark-fg);
            padding: 25px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border-color);
        }
        #user-profile-details p, #other-user-profile-details p {
            margin-bottom: 10px;
            font-size: 1.05rem;
        }
        #user-profile-details p strong, #other-user-profile-details p strong {
            color: var(--primary-color);
            margin-right: 5px;
        }

        .profile-posts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        /* Search Section */
        #search-results-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--dark-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
            animation: fadeIn 0.4s ease-out;
        }
        .search-result-item .user-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--primary-color);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: white;
            font-weight: bold;
        }
        .search-result-item .user-info {
            flex-grow: 1;
        }
        .search-result-item h4 {
            font-size: 1.2rem;
            color: var(--accent-color);
        }
        .search-result-item button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Daily Reward Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .popup-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background: linear-gradient(145deg, var(--dark-fg), #282828);
            padding: 40px 30px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color);
            max-width: 90%;
            width: 400px;
            transform: scale(0.8);
            opacity: 0;
            animation: popUpAnimation 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .popup-content h3 {
            color: var(--accent-color);
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.6);
        }
        .popup-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 30px;
        }
        .popup-content li {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content li .icon {
            font-size: 1.3rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        .popup-content button {
            padding: 10px 25px;
        }

        /* Side Menu */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none;
        }
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--dark-fg);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8);
            z-index: 101;
            transition: right 0.3s ease-out;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }
        .side-menu.visible {
            right: 0;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .menu-header h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .menu-close-btn {
            font-size: 2rem;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 1rem;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .menu-item:hover {
            background-color: rgba(0, 170, 255, 0.1);
        }
        .menu-item .icon {
            margin-right: 15px;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            margin-left: auto;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Messaging styles */
        #chat-window {
            height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--dark-bg);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
        }

        .chat-message.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
            animation: slideInRight 0.3s ease-out;
        }

        .chat-message.received {
            align-self: flex-start;
            background-color: var(--border-color);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
            animation: slideInLeft 0.3s ease-out;
        }

        .chat-message .timestamp {
            display: block;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
            text-align: right;
        }
        .chat-message.received .timestamp {
            text-align: left;
        }

        /* Chat reactions */
        .chat-message .reaction-bar {
            bottom: unset;
            top: -40px; /* Position above message bubble */
            left: 50%;
            transform: translateX(-50%);
        }
        .chat-message.show-reactions .reaction-bar {
            opacity: 1;
            visibility: visible;
        }

        /* ========================================================= */
        /* == ANIMATIONS =========================================== */
        /* ========================================================= */

        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0d0d0d, #080808);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
            color: white;
            font-size: 2rem;
            flex-direction: column;
            gap: 20px;
        }
        .splash-logo {
            width: 150px;
            height: 150px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border-radius: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 15px var(--primary-color);
            box-shadow: 0 0 30px var(--primary-color);
            animation: splashLogoAnimation 2s infinite alternate ease-in-out;
        }
        .splash-text {
            font-size: 1.8rem;
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--primary-color);
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes neonBlueGlow { 0% { box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue) inset; } 50% { box-shadow: 0 0 25px var(--neon-blue), 0 0 40px var(--neon-blue) inset; } 100% { box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue) inset; } }
        @keyframes neonPinkGlow { 0% { box-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink) inset; } 50% { box-shadow: 0 0 25px var(--neon-pink), 0 0 40px var(--neon-pink) inset; } 100% { box-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink) inset; } }
        @keyframes neonGreenGlow { 0% { box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green) inset; } 50% { box-shadow: 0 0 25px var(--neon-green), 0 0 40px var(--neon-green) inset; } 100% { box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green) inset; } }
        @keyframes neonYellowGlow { 0% { box-shadow: 0 0 10px var(--neon-yellow), 0 0 20px var(--neon-yellow) inset; } 50% { box-shadow: 0 0 25px var(--neon-yellow), 0 0 40px var(--neon-yellow) inset; } 100% { box-shadow: 0 0 10px var(--neon-yellow), 0 0 20px var(--neon-yellow) inset; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes profilePulse { 0%, 100% { box-shadow: 0 0 0 0px rgba(0, 170, 255, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(0, 170, 255, 0); } }
        @keyframes profileImageGlow { from { filter: brightness(1) contrast(1); } to { filter: brightness(1.2) contrast(1.1); } }
        @keyframes heartBeat { 0% { transform: scale(1); } 25% { transform: scale(1.2); } 50% { transform: scale(1); } 75% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes popUpAnimation { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes splashLogoAnimation {
            0% { transform: scale(1) rotate(0deg); border-radius: 30px; }
            50% { transform: scale(1.05) rotate(5deg); border-radius: 50%; }
            100% { transform: scale(1) rotate(0deg); border-radius: 30px; }
        }
        @keyframes headerLogoSpin {
            0% { transform: rotate(45deg); }
            100% { transform: rotate(405deg); }
        }
        @keyframes headerLogoBounce {
            0%, 100% { transform: rotate(45deg) translateY(0); }
            50% { transform: rotate(45deg) translateY(-5px); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">A</div>
        <div class="splash-text">AddMint</div>
    </div>

    <div id="app-container" class="hidden">
        
        <header>
            <div class="header-left">
                <button class="header-menu-btn" onclick="App.UI.toggleSideMenu()">☰</button>
                <div class="app-logo">
                    <span class="shape"></span> AddMint
                </div>
            </div>
            <div class="header-right">
                <button class="header-refresh-btn" onclick="App.Posts.fetch(true)">↻</button>
                <div class="header-stats">
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">💰</span>
                        <span id="header-coins">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">❖</span>
                        <span id="header-limit">0</span>
                    </div>
                    <div class="stat-item" onclick="App.UI.showSection('ad-rewards-section');">
                        <span class="icon">💡</span>
                        <span id="header-credits">0</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="side-menu-overlay" class="side-menu-overlay" onclick="App.UI.toggleSideMenu()"></div>
        <div id="side-menu" class="side-menu">
            <div class="menu-header">
                <h3>Menu</h3>
                <button class="menu-close-btn" onclick="App.UI.toggleSideMenu()">×</button>
            </div>
            <a href="#" class="menu-item" onclick="App.UI.toggleDataSaver(); return false;">
                <span class="icon">☀</span> Data Saver
                <label class="toggle-switch">
                    <input type="checkbox" id="data-saver-toggle">
                    <span class="slider"></span>
                </label>
            </a>
            <a href="https://www.instagram.com/addmint__" target="_blank" class="menu-item">
                <span class="icon">&#x1F4F8;</span> Instagram
            </a>
            <a href="https://www.youtube.com/@add_mint" target="_blank" class="menu-item">
                <span class="icon">&#x25B6;</span> YouTube
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('about-section'); App.UI.toggleSideMenu(); return false;">
                <span class="icon">ℹ</span> About
            </a>
            <a href="#" class="menu-item" onclick="App.UI.showSection('privacy-policy-section'); App.UI.toggleSideMenu(); return false;">
                <span class="icon">🔒</span> Privacy Policy
            </a>
        </div>


        <main id="main-content">
            <section id="signin-auth" class="container active">
                <h2>Welcome Back!</h2>
                <div id="auth-status-message" class="message hidden"></div>
                <form id="signin-form">
                    <input type="email" id="signin-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signin-password" placeholder="Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signin-password', this)">👁</span>
                    </div>
                    <button type="submit">Sign In</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="App.UI.showSection('signup-auth'); return false;">Sign Up Here</a></p>
                </form>
            </section>

            <section id="signup-auth" class="container">
                <h2>Join AddMint Today!</h2>
                <div id="signup-status-message" class="message hidden"></div>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Your Email" required>
                    <div class="password-input-container">
                        <input type="password" id="signup-password" placeholder="Create Password (min 6 chars)" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-password', this)">👁</span>
                    </div>
                    <div class="password-input-container">
                        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
                        <span class="toggle-password" onclick="App.UI.togglePasswordVisibility('signup-confirm-password', this)">👁</span>
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="App.UI.showSection('signin-auth'); return false;">Sign In</a></p>
                </form>
            </section>

            <section id="email-verify" class="container">
                <h2>Verify Your Email</h2>
                <div id="verify-email-message" class="message error"></div>
                <p class="text-center mb-4">A verification link has been sent. Please check your inbox.</p>
                <button onclick="App.Auth.sendVerificationEmail()">Resend Verification Email</button>
                <button onclick="App.Auth.logout()" class="mt-4" style="background-color: var(--error-color);">Sign Out</button>
            </section>

            <section id="setup-profile" class="container">
                <h2>Complete Your Profile</h2>
                <div id="profile-setup-message" class="message hidden"></div>
                <form id="profile-setup-form">
                    <p class="mb-4 text-center" style="color: #ccc;">Choose a username and at least one contact method.</p>
                    <label for="profileUsername">Choose a Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="profileUsername" placeholder="e.g., AddMintUser" required>
                        <span id="username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="profileWhatsApp">WhatsApp Number (Optional):</label>
                    <input type="text" id="profileWhatsApp" placeholder="e.g., 919876543210 (without +)">
                    <label for="profileInstagram">Instagram Handle (Optional):</label>
                    <input type="text" id="profileInstagram" placeholder="e.g., yourhandle">
                    <button type="submit" class="mt-4">Save Profile & Continue</button>
                </form>
            </section>

            <section id="home-posts">
                <h2>Recent Updates</h2>
                <div id="posts-container">
                    <p class="text-center" id="no-posts-message" style="margin-top: 30px; font-style: italic; color: #aaa;">Fetching exciting posts...</p>
                </div>
                <div id="loading-spinner" class="text-center hidden" style="padding: 20px;">
                    <div class="spinner"></div>
                </div>
            </section>
            
            <section id="search-section" class="container">
                <h2>Find Users & Posts</h2>
                <div id="search-message" class="message hidden"></div>
                <div class="username-input-group mb-4">
                    <input type="text" id="search-input" placeholder="Search users or posts..." oninput="App.Search.unifiedSearch()">
                </div>
                <h3>Users</h3>
                <div id="search-results-list-users">
                    </div>
                <h3 class="mt-4">Posts</h3>
                <div id="search-results-list-posts">
                    </div>
            </section>

            <section id="create-post-section">
                <h2>Share Your Thoughts</h2>
                <div id="create-post-message" class="message hidden"></div>
                <form id="create-post-form" class="mt-4">
                    <label for="post-content">What's on your mind today?</label>
                    <textarea id="post-content" placeholder="Type your message here..." required></textarea>
                    
                    <label class="mt-4">Post Boost (Auto-Delete after...):</label>
                    <div class="mt-2">
                        <select id="post-boost-option" class="form-control">
                            <option value="12">12 Hours (Free)</option>
                            <option value="18">18 Hours (1 Ad)</option>
                            <option value="24">24 Hours (2 Ads)</option>
                            <option value="30">30 Hours (3 Ads)</option>
                        </select>
                    </div>

                    <button type="submit" class="mt-4">Publish Post</button>
                    <p class="text-center mt-2">Cost: 1 Limit & 5 Coins</p>
                </form>
            </section>
            
            <section id="ad-rewards-section" class="container">
                <h2>Get More!</h2>
                <div id="ad-rewards-message" class="message hidden"></div>
                <p class="text-center mb-4">Watch an ad to get more coins, credits, or post limits.</p>
                <div class="reward-buttons">
                    <button onclick="App.Monetization.requestAd('coins');"><span class="icon">💰</span> Get 10 Coins</button>
                    <button onclick="App.Monetization.requestAd('credits');"><span class="icon">💡</span> Get 10 Credits</button>
                    <button onclick="App.Monetization.requestAd('limits');"><span class="icon">❖</span> Get 1 Post Limit</button>
                </div>
            </section>
            
            <div id="daily-reward-popup" class="popup-overlay hidden">
                <div class="popup-content">
                    <h3>Daily Rewards! 🎉</h3>
                    <p>You've received your rewards for today!</p>
                    <ul>
                        <li><span class="icon">💰</span> 10 Coins</li>
                        <li><span class="icon">❖</span> 1 Post Limit</li>
                        <li><span class="icon">💡</span> 10 Credits</li>
                    </ul>
                    <button onclick="App.Monetization.hideDailyRewardPopup()">Claim</button>
                </div>
            </div>
            
            <section id="about-section" class="container">
                <h2>About AddMint</h2>
                <p>Welcome to AddMint! Our goal is to create a fun and engaging social platform where you can share your thoughts and connect with others. We believe in providing a seamless user experience while giving creators the tools they need to grow. Join our community and start sharing today!</p>
            </section>

            <section id="privacy-policy-section" class="container">
                <h2>Privacy Policy</h2>
                <p>Your privacy is important to us. This policy explains how we collect, use, and protect your information. By using our app, you agree to the collection and use of information in accordance with this policy.</p>
                <p>We may collect information such as your name, email, and social media handles to provide and improve our service. We do not share your personal information with third parties without your consent.</p>
                <p>We take reasonable measures to protect your information from unauthorized access or disclosure. However, no method of transmission over the internet or electronic storage is 100% secure.</p>
                <p>If you have any questions about this Privacy Policy, please contact us through the app.</p>
            </section>

            <section id="user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <div class="profile-image" id="profile-image-own"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('posts');">
                                <strong id="profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('followers');">
                                <strong id="profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('following');">
                                <strong id="profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button onclick="App.UI.showSection('edit-profile-section');">Edit Profile</button>
                            <button onclick="App.Auth.logout()" style="background-color: var(--error-color);">Sign Out</button>
                        </div>
                    </div>
                </div>
                <div id="user-profile-details" class="container" style="background: none; box-shadow: none;">
                    <p><strong>Email:</strong> <span id="profile-email"></span></p>
                    <p><strong>WhatsApp:</strong> <span id="profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="profile-instagram-handle">N/A</span></p>
                </div>
                <h4 style="margin-top: 30px; text-align: center;">Active Posts</h4>
                <div id="profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>

            <section id="edit-profile-section" class="container">
                <h2>Update Your Profile Details</h2>
                <div id="edit-profile-message" class="message hidden"></div>
                <form id="edit-profile-form">
                    <label for="editUsername">Username:</label>
                    <div class="username-input-group mb-4">
                        <input type="text" id="editUsername" required>
                        <span id="edit-username-status-icon" class="username-status-icon hidden"></span>
                    </div>
                    <label for="editWhatsApp" class="mt-4">WhatsApp Number (Optional):</label>
                    <input type="text" id="editWhatsApp">
                    <label for="editInstagram" class="mt-4">Instagram Handle (Optional):</label>
                    <input type="text" id="editInstagram">
                    <button type="submit" class="mt-4">Save Changes</button>
                    <button type="button" onclick="App.UI.showSection('user-profile-section')" class="mt-4" style="background-color: #6c757d;">Cancel</button>
                </form>
            </section>
            
            <section id="follow-list-section" class="container">
                <h2 id="follow-list-title"></h2>
                <div id="follow-list-content">
                    </div>
                <button onclick="App.UI.showSection('user-profile-section')" class="mt-4">Back to Profile</button>
            </section>

            <section id="other-user-profile-section">
                <div class="profile-header">
                    <div class="profile-image-container">
                        <div class="profile-image" id="profile-image-other"></div>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-username" id="other-profile-display-name">Loading...</h3>
                        <div class="profile-stats">
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('posts', App.profileToView);">
                                <strong id="other-profile-posts-count">0</strong>
                                <span>Posts</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('followers', App.profileToView);">
                                <strong id="other-profile-followers-count">0</strong>
                                <span>Followers</span>
                            </div>
                            <div class="profile-stat-item" onclick="App.Profile.showFollowList('following', App.profileToView);">
                                <strong id="other-profile-following-count">0</strong>
                                <span>Following</span>
                            </div>
                        </div>
                        <div class="profile-buttons">
                            <button id="other-follow-btn" onclick="App.Profile.toggleFollow()">Follow</button>
                            <button id="other-whatsapp-btn" onclick="App.UI.openWhatsAppProfile()"><span class="icon">&#x2709;</span> WhatsApp</button>
                            <button id="other-instagram-btn" onclick="App.UI.openInstagramProfile()"><span class="icon">&#x1F4F8;</span> Instagram</button>
                            <button id="other-message-btn" onclick="App.Messages.startNewChat()"><span class="icon">💬</span> Message</button>
                        </div>
                    </div>
                </div>
                <div id="other-user-profile-details" class="container" style="background: none; box-shadow: none;">
                    <p><strong>Email:</strong> <span id="other-profile-email"></span></p>
                    <p><strong>WhatsApp:</strong> <span id="other-profile-whatsapp-number">N/A</span></p>
                    <p><strong>Instagram:</strong> <span id="other-profile-instagram-handle">N/A</span></p>
                </div>
                <h4 style="margin-top: 30px; text-align: center;">Posts</h4>
                <div id="other-profile-posts-grid" class="profile-posts-grid">
                    </div>
            </section>
            
            <section id="message-section" class="container">
                <h2 id="message-recipient-name">Message User</h2>
                <div id="message-status-message" class="message hidden"></div>
                <div id="chat-window">
                    </div>
                <form id="send-message-form" class="mt-4">
                    <textarea id="message-content" placeholder="Type your message here..." required></textarea>
                    <button type="submit" class="mt-4">Send Message (1 Credit)</button>
                </form>
            </section>
        </main>

        <footer>
            <div class="nav-item active" data-section="home-posts">
                <span class="icon">⌂</span>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="search-section">
                <span class="icon">⌕</span>
                <span>Search</span>
            </div>
            <div class="nav-item" data-section="create-post-section">
                <span class="icon">➕</span>
                <span>Create</span>
            </div>
            <div class="nav-item" data-section="user-profile-section">
                <span class="icon">◉</span>
                <span>Profile</span>
            </div>
        </footer>
    </div>
    
    <script>
        const App = {};
        
        App.firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // Replace with your actual API Key
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };
        firebase.initializeApp(App.firebaseConfig);
        App.auth = firebase.auth();
        App.db = firebase.firestore();

        App.currentUserId = null;
        App.currentUsername = null;
        App.userProfileData = {};
        App.profileToView = null;
        App.neonColors = ['neon-blue', 'neon-pink', 'neon-green', 'neon-yellow'];
        
        App.lastPost = null; // For pagination of posts feed
        App.isLoadingPosts = false;
        App.postsCache = []; // Cache for infinite scroll
        App.isDataSaver = false;
        
        App.activeNeonPost = null; // Track the currently neon post
        App.emojiReactions = ['😂', '❤️', '👍', '🔥', '🎉']; // Available emojis
        
        App.Utils = {
            formatNumber: (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num;
            },
            generateRandomChar: () => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                return chars.charAt(Math.floor(Math.random() * chars.length));
            }
        };

        App.UI = {
            showSection: (sectionId) => {
                document.querySelectorAll('section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.section === sectionId) {
                        item.classList.add('active');
                    }
                });
                
                if (sectionId === 'home-posts') {
                    document.getElementById('main-content').scrollTop = 0;
                }
            },
            showMessage: (elementId, message, type = 'info') => {
                const element = document.getElementById(elementId);
                element.innerHTML = message;
                element.className = `message ${type}`;
                element.classList.remove('hidden');
            },
            hideMessage: (elementId) => {
                document.getElementById(elementId).classList.add('hidden');
            },
            togglePasswordVisibility: (inputId, iconElement) => {
                const input = document.getElementById(inputId);
                if (input.type === "password") {
                    input.type = "text";
                    iconElement.innerHTML = '👀';
                } else {
                    input.type = "password";
                    iconElement.innerHTML = '👁';
                }
            },
            updateHeaderStats: (coins, limits, credits) => {
                document.getElementById('header-coins').textContent = App.Utils.formatNumber(coins);
                document.getElementById('header-limit').textContent = App.Utils.formatNumber(limits);
                document.getElementById('header-credits').textContent = App.Utils.formatNumber(credits);
            },
            hidePreloader: () => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    document.getElementById('app-container').classList.remove('hidden');
                }, 500);
            },
            playPostSound: (postContent) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(postContent);
                    utterance.lang = 'hi-IN'; // Set language to Hindi
                    speechSynthesis.speak(utterance);
                } else {
                    alert("Your browser does not support Text-to-Speech.");
                }
            },
            openWhatsAppProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.whatsapp) {
                        window.open(`https://wa.me/${profile.whatsapp}`, '_blank');
                    } else {
                        alert('No WhatsApp number available for this user.');
                    }
                });
            },
            openInstagramProfile: () => {
                if (!App.profileToView) return;
                App.db.collection('users').doc(App.profileToView).get().then(doc => {
                    const profile = doc.data();
                    if (profile && profile.instagram) {
                        window.open(`https://www.instagram.com/${profile.instagram}`, '_blank');
                    } else {
                        alert('No Instagram handle available for this user.');
                    }
                });
            },
            toggleDropdown: (postId) => {
                const dropdown = document.getElementById(`dropdown-${postId}`);
                if (dropdown) {
                    dropdown.classList.toggle('visible');
                    document.querySelectorAll('.dropdown-menu').forEach(d => {
                        if (d.id !== `dropdown-${postId}`) {
                            d.classList.remove('visible');
                        }
                    });
                }
            },
            hideAllDropdowns: () => {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('visible'));
            },
            generateUserLogo: (uid) => {
                const colorPalette = [
                    '#ff00ff', '#00ff00', '#00aaff', '#ffff00',
                    '#ff5500', '#8800ff', '#ff0055', '#00ffaa',
                    '#ff9900', '#00ffff', '#cc00ff', '#ff0088'
                ];
                const hash = Array.from(uid).reduce((sum, char) => sum + char.charCodeAt(0), 0);
                const color1 = colorPalette[hash % colorPalette.length];
                const color2 = colorPalette[(hash + 3) % colorPalette.length];
                const gradient = `linear-gradient(135deg, ${color1}, ${color2})`;
                const initial = App.Utils.generateRandomChar(); // Random character for the logo
                return { background: gradient, initial: initial };
            },
            toggleSideMenu: () => {
                const menu = document.getElementById('side-menu');
                const overlay = document.getElementById('side-menu-overlay');
                menu.classList.toggle('visible');
                overlay.style.display = menu.classList.contains('visible') ? 'block' : 'none';
            },
            toggleDataSaver: () => {
                App.isDataSaver = document.getElementById('data-saver-toggle').checked;
                // For now, it mainly affects mixed post layout. Could expand to image loading.
                alert(`Data Saver is now ${App.isDataSaver ? 'ON' : 'OFF'}.`);
                App.Posts.fetch(true); // Re-fetch posts to apply data saver changes
            },
            togglePostNeonEffect: (postElement) => {
                if (App.activeNeonPost && App.activeNeonPost !== postElement) {
                    App.activeNeonPost.classList.remove(...App.neonColors);
                }
                const randomColorClass = App.neonColors[Math.floor(Math.random() * App.neonColors.length)];
                postElement.classList.toggle(randomColorClass);
                App.activeNeonPost = postElement.classList.contains(randomColorClass) ? postElement : null;

                if (App.activeNeonPost) {
                    setTimeout(() => {
                        if (App.activeNeonPost === postElement) {
                            postElement.classList.remove(randomColorClass);
                            App.activeNeonPost = null;
                        }
                    }, 3000); // Remove neon effect after 3 seconds
                }
            }
        };

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.post-actions-icons')) {
                App.UI.hideAllDropdowns();
            }
        });
        
        App.Auth = {
            signup: async (email, password, confirmPassword) => {
                App.UI.hideMessage('signup-status-message');
                if (password !== confirmPassword) {
                    App.UI.showMessage('signup-status-message', 'Passwords do not match.', 'error');
                    return;
                }
                if (password.length < 6) {
                    App.UI.showMessage('signup-status-message', 'Password must be at least 6 characters long.', 'error');
                    return;
                }
                
                try {
                    const userCredential = await App.auth.createUserWithEmailAndPassword(email, password);
                    await App.Auth.sendVerificationEmail();
                    App.UI.showMessage('signup-status-message', 'Successfully signed up! Please check your email for a verification link.', 'success');
                    App.UI.showSection('email-verify');
                } catch (error) {
                    App.UI.showMessage('signup-status-message', `Error: ${error.message}`, 'error');
                    console.error("Signup error:", error);
                }
            },
            signin: async (email, password) => {
                App.UI.hideMessage('auth-status-message');
                try {
                    await App.auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    App.UI.showMessage('auth-status-message', `Error: ${error.message}`, 'error');
                    console.error("Signin error:", error);
                }
            },
            logout: async () => {
                try {
                    await App.auth.signOut();
                    App.currentUserId = null;
                    App.UI.showSection('signin-auth');
                } catch (error) {
                    console.error("Logout error:", error);
                }
            },
            sendVerificationEmail: async () => {
                const user = App.auth.currentUser;
                if (user) {
                    try {
                        await user.sendEmailVerification();
                        App.UI.showMessage('verify-email-message', 'Verification link sent! Please check your inbox.', 'info');
                    } catch (error) {
                        App.UI.showMessage('verify-email-message', `Error sending verification email: ${error.message}`, 'error');
                        console.error("Verification email error:", error);
                    }
                }
            }
        };

        App.Profile = {
            checkUsernameAvailability: async (username, isEdit = false) => {
                const icon = document.getElementById(isEdit ? 'edit-username-status-icon' : 'username-status-icon');
                if (!username || username.length < 3) {
                    icon.classList.add('hidden');
                    return false;
                }
                
                const usersRef = App.db.collection('users').where('username', '==', username.toLowerCase());
                const snapshot = await usersRef.get();
                
                let isAvailable = true;
                if (!snapshot.empty) {
                    if (isEdit && snapshot.docs[0].id === App.currentUserId) {
                        isAvailable = true; // Same user, same username is okay
                    } else {
                        isAvailable = false; // Different user has this username
                    }
                }
                
                if (isAvailable) {
                    icon.classList.remove('hidden', 'unavailable');
                    icon.classList.add('available');
                    icon.innerHTML = '✔'; // Green tick
                    return true;
                } else {
                    icon.classList.remove('hidden', 'available');
                    icon.classList.add('unavailable');
                    icon.innerHTML = '✖'; // Red cross
                    return false;
                }
            },
            setup: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('profile-setup-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('profile-setup-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                if (!username || (!whatsapp && !instagram)) {
                    App.UI.showMessage('profile-setup-message', 'Please provide a username and at least one contact method.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).set({
                        username: username.toLowerCase(),
                        email: App.auth.currentUser.email,
                        whatsapp: whatsapp || null,
                        instagram: instagram || null,
                        coins: 10,
                        credits: 10,
                        postLimit: 1,
                        lastRewardDate: new Date().toDateString()
                    });
                    App.UI.showMessage('profile-setup-message', 'Profile saved successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (error) {
                    App.UI.showMessage('profile-setup-message', `Error saving profile: ${error.message}`, 'error');
                    console.error("Profile setup error:", error);
                }
            },
            edit: async (username, whatsapp, instagram) => {
                App.UI.hideMessage('edit-profile-message');
                const isUsernameAvailable = await App.Profile.checkUsernameAvailability(username, true);
                if (!isUsernameAvailable) {
                    App.UI.showMessage('edit-profile-message', 'This username is already taken. Please choose another.', 'error');
                    return;
                }
                
                try {
                    await App.db.collection('users').doc(App.currentUserId).update({
                        username: username.toLowerCase(),
                        whatsapp: whatsapp || null,
                        instagram: instagram || null,
                    });
                    App.UI.showMessage('edit-profile-message', 'Profile updated successfully!', 'success');
                    setTimeout(() => {
                        App.UI.showSection('user-profile-section');
                        App.Profile.fetch(App.currentUserId, true);
                    }, 1000);
                } catch (error) {
                    App.UI.showMessage('edit-profile-message', `Error updating profile: ${error.message}`, 'error');
                    console.error("Profile edit error:", error);
                }
            },
            fetch: async (uid, isCurrentUser = false) => {
                try {
                    const userDoc = await App.db.collection('users').doc(uid).get();
                    if (!userDoc.exists) {
                        if (isCurrentUser) {
                            App.UI.showSection('setup-profile');
                            return;
                        }
                        return null;
                    }
                    const data = userDoc.data();
                    
                    const postsSnapshot = await App.db.collection('posts').where('userId', '==', uid).get();
                    const followersSnapshot = await App.db.collection('users').doc(uid).collection('followers').get();
                    const followingSnapshot = await App.db.collection('users').doc(uid).collection('following').get();
                    
                    data.postsCount = postsSnapshot.size;
                    data.followersCount = followersSnapshot.size;
                    data.followingCount = followingSnapshot.size;
                    data.uid = uid;
                    
                    if (isCurrentUser) {
                        App.userProfileData = data;
                        App.currentUsername = data.username;
                        App.UI.updateHeaderStats(data.coins || 0, data.postLimit || 0, data.credits || 0);
                        App.Profile.renderCurrentUserProfile(data, postsSnapshot.docs);
                    } else {
                        App.Profile.renderOtherUserProfile(data, postsSnapshot.docs);
                    }
                    return data;
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    return null;
                }
            },
            renderCurrentUserProfile: (profile, posts) => {
                document.getElementById('profile-display-name').textContent = profile.username;
                document.getElementById('profile-posts-count').textContent = App.Utils.formatNumber(profile.postsCount);
                document.getElementById('profile-followers-count').textContent = App.Utils.formatNumber(profile.followersCount);
                document.getElementById('profile-following-count').textContent = App.Utils.formatNumber(profile.followingCount);
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('profile-instagram-handle').textContent = profile.instagram || 'N/A';
                const userLogo = App.UI.generateUserLogo(profile.uid);
                document.getElementById('profile-image-own').style.background = userLogo.background;
                document.getElementById('profile-image-own').textContent = userLogo.initial;
                
                document.getElementById('editUsername').value = profile.username || '';
                document.getElementById('editWhatsApp').value = profile.whatsapp || '';
                document.getElementById('editInstagram').value = profile.instagram || '';
                
                App.Posts.renderAll(posts, 'profile-posts-grid', true);
            },
            renderOtherUserProfile: (profile, posts) => {
                document.getElementById('other-profile-display-name').textContent = profile.username;
                document.getElementById('other-profile-posts-count').textContent = App.Utils.formatNumber(profile.postsCount);
                document.getElementById('other-profile-followers-count').textContent = App.Utils.formatNumber(profile.followersCount);
                document.getElementById('other-profile-following-count').textContent = App.Utils.formatNumber(profile.followingCount);
                document.getElementById('other-profile-email').textContent = profile.email;
                document.getElementById('other-profile-whatsapp-number').textContent = profile.whatsapp || 'N/A';
                document.getElementById('other-profile-instagram-handle').textContent = profile.instagram || 'N/A';
                const userLogo = App.UI.generateUserLogo(profile.uid);
                document.getElementById('profile-image-other').style.background = userLogo.background;
                document.getElementById('profile-image-other').textContent = userLogo.initial;
                
                App.db.collection('users').doc(App.currentUserId).collection('following').doc(profile.uid).get().then(doc => {
                    const followBtn = document.getElementById('other-follow-btn');
                    if (doc.exists) {
                        followBtn.textContent = 'Following';
                    } else {
                        followBtn.textContent = 'Follow';
                    }
                });
                
                document.getElementById('other-whatsapp-btn').style.display = profile.whatsapp ? 'inline-flex' : 'none';
                document.getElementById('other-instagram-btn').style.display = profile.instagram ? 'inline-flex' : 'none';

                App.Posts.renderAll(posts, 'other-profile-posts-grid', false);
            },
            toggleFollow: async (targetUserId = App.profileToView) => {
                if (!targetUserId || targetUserId === App.currentUserId) {
                    alert('You cannot follow yourself.');
                    return;
                }
                
                const followRef = App.db.collection('users').doc(App.currentUserId).collection('following').doc(targetUserId);
                const followerRef = App.db.collection('users').doc(targetUserId).collection('followers').doc(App.currentUserId);
                
                try {
                    const doc = await followRef.get();
                    if (doc.exists) {
                        await followRef.delete();
                        await followerRef.delete();
                        alert('Unfollowed user.');
                    } else {
                        await followRef.set({ followedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        await followerRef.set({ followedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        alert('Followed user!');
                    }
                    App.Profile.fetch(targetUserId, false); // Refresh target user's profile
                    App.Profile.fetch(App.currentUserId, true); // Refresh current user's profile to update counts
                } catch (error) {
                    console.error("Error toggling follow:", error);
                    alert("An error occurred. Please try again.");
                }
            },
            showFollowList: async (type, userId = App.currentUserId) => {
                const titleElement = document.getElementById('follow-list-title');
                const contentElement = document.getElementById('follow-list-content');
                contentElement.innerHTML = '<p class="text-center"><div class="spinner"></div> Loading...</p>';
                App.UI.showSection('follow-list-section');

                try {
                    let snapshot;
                    let users = [];

                    if (type === 'posts') {
                        titleElement.textContent = `${userId === App.currentUserId ? 'My' : (await App.db.collection('users').doc(userId).get()).data().username + "'s"} Posts`;
                        snapshot = await App.db.collection('posts').where('userId', '==', userId).orderBy('timestamp', 'desc').get();
                        App.Posts.renderAll(snapshot.docs, 'follow-list-content', true); // Reuse post rendering
                        return;
                    } else if (type === 'followers') {
                        titleElement.textContent = `${userId === App.currentUserId ? 'My' : (await App.db.collection('users').doc(userId).get()).data().username + "'s"} Followers`;
                        snapshot = await App.db.collection('users').doc(userId).collection('followers').get();
                        for (const doc of snapshot.docs) {
                            const userDoc = await App.db.collection('users').doc(doc.id).get();
                            if (userDoc.exists) users.push({ id: userDoc.id, ...userDoc.data() });
                        }
                    } else if (type === 'following') {
                        titleElement.textContent = `${userId === App.currentUserId ? 'My' : (await App.db.collection('users').doc(userId).get()).data().username + "'s"} Following`;
                        snapshot = await App.db.collection('users').doc(userId).collection('following').get();
                        for (const doc of snapshot.docs) {
                            const userDoc = await App.db.collection('users').doc(doc.id).get();
                            if (userDoc.exists) users.push({ id: userDoc.id, ...userDoc.data() });
                        }
                    }

                    if (users.length === 0) {
                        contentElement.innerHTML = `<p class="text-center" style="font-style: italic; color: #aaa;">No ${type} found.</p>`;
                        return;
                    }

                    contentElement.innerHTML = '';
                    users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'search-result-item'; // Reuse search item style
                        userItem.onclick = () => {
                            App.profileToView = user.id;
                            App.Profile.fetch(user.id, user.id === App.currentUserId);
                            App.UI.showSection(user.id === App.currentUserId ? 'user-profile-section' : 'other-user-profile-section');
                        };

                        const userLogoData = App.UI.generateUserLogo(user.id);
                        const userLogo = document.createElement('div');
                        userLogo.className = 'user-logo';
                        userLogo.style.background = userLogoData.background;
                        userLogo.textContent = userLogoData.initial;
                        
                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info';
                        userInfo.innerHTML = `<h4>${user.username}</h4>`;
                        
                        const followButton = document.createElement('button');
                        if (user.id !== App.currentUserId) {
                             App.db.collection('users').doc(App.currentUserId).collection('following').doc(user.id).get().then(doc => {
                                 followButton.textContent = doc.exists ? 'Following' : 'Follow';
                                 followButton.onclick = (e) => {
                                     e.stopPropagation(); // Prevent opening profile when clicking follow
                                     App.Profile.toggleFollow(user.id);
                                     // Re-render this specific button's text immediately after toggle
                                     followButton.textContent = doc.exists ? 'Follow' : 'Following';
                                 };
                             });
                        } else {
                            followButton.style.display = 'none'; // Hide follow button for self
                        }
                        
                        userItem.appendChild(userLogo);
                        userItem.appendChild(userInfo);
                        if (user.id !== App.currentUserId) userItem.appendChild(followButton);
                        contentElement.appendChild(userItem);
                    });

                } catch (error) {
                    console.error("Error fetching follow list:", error);
                    contentElement.innerHTML = '<p class="text-center message error">Error loading list.</p>';
                }
            }
        };

        App.Search = {
            unifiedSearch: async () => {
                const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                const usersResultsContainer = document.getElementById('search-results-list-users');
                const postsResultsContainer = document.getElementById('search-results-list-posts');
                usersResultsContainer.innerHTML = '';
                postsResultsContainer.innerHTML = '';
                
                if (searchTerm.length < 2) {
                    App.UI.showMessage('search-message', 'Please enter at least 2 characters to search users or posts.', 'info');
                    return;
                }

                App.UI.hideMessage('search-message');

                try {
                    // Search Users
                    const usersRef = App.db.collection('users').where('username', '>=', searchTerm).where('username', '<=', searchTerm + '\uf8ff').limit(10);
                    const usersSnapshot = await usersRef.get();
                    
                    if (usersSnapshot.empty) {
                        usersResultsContainer.innerHTML = '<p class="text-center" style="font-style: italic; color: #aaa;">No users found.</p>';
                    } else {
                        usersSnapshot.docs.forEach(doc => {
                            const user = doc.data();
                            if (doc.id === App.currentUserId) return;
                            
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.onclick = () => {
                                App.profileToView = doc.id;
                                App.Profile.fetch(doc.id, false);
                                App.UI.showSection('other-user-profile-section');
                            };
                            
                            const userLogoData = App.UI.generateUserLogo(doc.id);
                            const userLogo = document.createElement('div');
                            userLogo.className = 'user-logo';
                            userLogo.style.background = userLogoData.background;
                            userLogo.textContent = userLogoData.initial;
                            
                            const userInfo = document.createElement('div');
                            userInfo.className = 'user-info';
                            userInfo.innerHTML = `<h4>${user.username}</h4>`;
                            
                            const followButton = document.createElement('button');
                            App.db.collection('users').doc(App.currentUserId).collection('following').doc(doc.id).get().then(followDoc => {
                                followButton.textContent = followDoc.exists ? 'Following' : 'Follow';
                                followButton.onclick = (e) => {
                                    e.stopPropagation();
                                    App.Profile.toggleFollow(doc.id);
                                    followButton.textContent = followDoc.exists ? 'Follow' : 'Following'; // Optimistic update
                                };
                            });

                            resultItem.appendChild(userLogo);
                            resultItem.appendChild(userInfo);
                            resultItem.appendChild(followButton);
                            usersResultsContainer.appendChild(resultItem);
                        });
                    }

                    // Search Posts (by content)
                    const postsRef = App.db.collection('posts').where('content', '>=', searchTerm).where('content', '<=', searchTerm + '\uf8ff').limit(10);
                    const postsSnapshot = await postsRef.get();
                    
                    if (postsSnapshot.empty) {
                        postsResultsContainer.innerHTML = '<p class="text-center" style="font-style: italic; color: #aaa;">No posts found.</p>';
                    } else {
                        App.Posts.renderAll(postsSnapshot.docs, 'search-results-list-posts', false);
                    }

                } catch (error) {
                    App.UI.showMessage('search-message', `Error searching: ${error.message}`, 'error');
                    console.error("Search error:", error);
                }
            }
        };

        App.Posts = {
            create: async (content) => {
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    App.UI.showMessage('create-post-message', 'User profile not found.', 'error');
                    return;
                }
                const userData = userDoc.data();
                
                const postsLimit = userData.postLimit || 0;
                const coins = userData.coins || 0;
                const boostDuration = document.getElementById('post-boost-option').value;

                let requiredAds = 0;
                if (boostDuration === '18') requiredAds = 1;
                else if (boostDuration === '24') requiredAds = 2;
                else if (boostDuration === '30') requiredAds = 3;

                // Check for both limit and coins
                if (postsLimit <= 0 || coins < 5) {
                    App.UI.showMessage('create-post-message', 'You need at least 1 post limit and 5 coins to post. Please get more to post.', 'error');
                    return;
                }
                
                // If boost needs ads, request ad completion first
                if (requiredAds > 0) {
                     App.UI.showMessage('create-post-message', `This boost option requires ${requiredAds} ad(s). Please watch ad(s) first.`, 'info');
                     // In App Inventor, trigger ad here and call handleAdCompletion from there
                     // window.AppInventor.requestAd(`post_boost_${boostDuration}`);
                     return;
                }

                await App.Posts.submitNewPost(content, userData, userRef, boostDuration);
            },
            submitNewPost: async (content, userData, userRef, boostDuration = '12') => {
                const newPostRef = App.db.collection('posts').doc();
                const updateData = {
                    postLimit: firebase.firestore.FieldValue.increment(-1),
                    coins: firebase.firestore.FieldValue.increment(-5)
                };
                
                const neonColor = App.Posts.getRandomPostStyle();
                const expiryTime = new Date(Date.now() + (parseInt(boostDuration) * 60 * 60 * 1000));

                try {
                    await App.db.runTransaction(async (transaction) => {
                        transaction.set(newPostRef, {
                            content,
                            userId: App.currentUserId,
                            username: userData.username,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            likes: 0,
                            views: 0,
                            style: neonColor,
                            expiryTime: expiryTime.getTime()
                        });
                        transaction.update(userRef, updateData);
                    });

                    App.UI.showMessage('create-post-message', 'Post published successfully!', 'success');
                    document.getElementById('post-content').value = '';
                    await App.Profile.fetch(App.currentUserId, true);
                    App.Posts.fetch(true); // Refresh posts after upload
                } catch (error) {
                    App.UI.showMessage('create-post-message', `Error publishing post: ${error.message}`, 'error');
                    console.error("Post creation error:", error);
                }
            },
            fetch: async (forceRefresh = false, targetDivId = 'posts-container', userId = null) => {
                const container = document.getElementById(targetDivId);
                const spinner = document.getElementById('loading-spinner');

                if (App.isLoadingPosts && !forceRefresh) return;
                App.isLoadingPosts = true;

                if (forceRefresh) {
                    App.lastPost = null;
                    container.innerHTML = '';
                    App.postsCache = [];
                }

                if (App.lastPost === null) {
                    spinner.classList.remove('hidden');
                }

                let query = App.db.collection('posts').orderBy('timestamp', 'desc').limit(25);
                if (App.lastPost) {
                    query = query.startAfter(App.lastPost);
                }
                if (userId) {
                    query = query.where('userId', '==', userId);
                }

                try {
                    const snapshot = await query.get();
                    let postDocs = [];

                    for (const doc of snapshot.docs) {
                        const postData = doc.data();
                        const expiry = postData.expiryTime;
                        const isExpired = expiry && expiry < Date.now();
                        
                        if (isExpired) {
                            await doc.ref.delete().catch(e => console.error("Error deleting expired post:", e));
                        } else {
                            postDocs.push(doc);
                        }
                    }

                    if (postDocs.length === 0) {
                        if (App.postsCache.length === 0) {
                            container.innerHTML = '<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>';
                        } else {
                            // If no new posts, shuffle the existing cache and re-render
                            const shuffledCache = App.postsCache.slice().sort(() => Math.random() - 0.5); // Use slice to avoid modifying original
                            App.Posts.renderAll(shuffledCache, targetDivId, userId !== null, true, true); // Pass true for shuffle
                        }
                        spinner.classList.add('hidden');
                        return;
                    }

                    App.lastPost = snapshot.docs[snapshot.docs.length - 1];
                    
                    if (forceRefresh) {
                         App.postsCache = postDocs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                         App.postsCache.push(...postDocs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                    
                    App.Posts.renderAll(postDocs, targetDivId, userId !== null, !forceRefresh);

                } catch (error) {
                    container.innerHTML = '<p class="text-center message error">Error loading posts. Please try again.</p>';
                    console.error("Error fetching posts:", error);
                } finally {
                    spinner.classList.add('hidden');
                    App.isLoadingPosts = false;
                }
            },
            renderAll: async (postDocs, containerId, isProfileView, append = false, isShuffling = false) => {
                const container = document.getElementById(containerId);
                const tempDiv = document.createElement('div'); // Use a temp div to build content

                if (!append || isShuffling) container.innerHTML = ''; // Clear only if not appending or if shuffling

                if (postDocs.length === 0 && !append) {
                    container.innerHTML = `<p class="text-center" style="margin-top: 30px; font-style: italic; color: #aaa;">No posts to display.</p>`;
                    return;
                }
                
                let verticalPostsCount = 0;
                let horizontalPostsBuffer = [];
                const postsToRender = isShuffling ? postDocs : postDocs; // If shuffling, use the shuffled list

                for (const postData of postsToRender) {
                    const postId = postData.id;
                    const postElement = await App.Posts.createPostElement(postId, postData, isProfileView);

                    // Add long press listener for reactions
                    let pressTimer;
                    postElement.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // Prevent default touch behavior
                        pressTimer = setTimeout(() => {
                            postElement.classList.add('show-reactions');
                        }, 500); // 500ms for long press
                    });
                    postElement.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                        // If it's a tap (not long press), and not for reactions, toggle neon effect
                        if (!postElement.classList.contains('show-reactions')) {
                             App.UI.togglePostNeonEffect(postElement);
                        }
                    });
                    postElement.addEventListener('touchcancel', () => clearTimeout(pressTimer));

                    // Double click for like
                    postElement.addEventListener('dblclick', async () => {
                        const likeButton = postElement.querySelector('.like-btn');
                        if (likeButton) {
                            await App.Posts.like(postId, likeButton);
                        }
                    });

                    // Add a one-time view count
                    await App.Posts.recordView(postId, App.currentUserId);


                    if (!isProfileView && !App.isDataSaver) { // Only mix horizontal posts if not in profile view and data saver is off
                        if (verticalPostsCount >= 5 && Math.random() > 0.5 && horizontalPostsBuffer.length < 10) { // Limit horizontal buffer size
                            horizontalPostsBuffer.push(postElement);
                            if (horizontalPostsBuffer.length >= 4 && Math.random() > 0.3) { // Create horizontal block if buffer is full enough
                                const horizontalContainer = document.createElement('div');
                                horizontalContainer.className = 'horizontal-scroll-container';
                                horizontalPostsBuffer.forEach(el => horizontalContainer.appendChild(el));
                                tempDiv.appendChild(horizontalContainer);
                                horizontalPostsBuffer = [];
                                verticalPostsCount = 0; // Reset vertical count after horizontal block
                            }
                        } else {
                            tempDiv.appendChild(postElement);
                            verticalPostsCount++;
                        }
                    } else {
                        tempDiv.appendChild(postElement);
                    }
                }
                
                // Append any remaining horizontal posts
                if (horizontalPostsBuffer.length > 0) {
                     const horizontalContainer = document.createElement('div');
                     horizontalContainer.className = 'horizontal-scroll-container';
                     horizontalPostsBuffer.forEach(el => horizontalContainer.appendChild(el));
                     tempDiv.appendChild(horizontalContainer);
                }
                
                container.appendChild(tempDiv); // Append once to avoid reflows
            },
            createPostElement: async (postId, postData, isProfilePost = false) => {
                const postElement = document.createElement('div');
                postElement.className = `post-card ${postData.style || ''}`;
                postElement.dataset.postId = postId;
                postElement.dataset.userId = postData.userId;
                
                const isOwner = postData.userId === App.currentUserId;
                const likedDoc = await App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId).get();
                postData.hasLiked = likedDoc.exists;

                // Fetch reactions
                const reactionsSnapshot = await App.db.collection('posts').doc(postId).collection('reactions').get();
                const reactionsMap = {}; // { emoji: count }
                let userReaction = null;
                reactionsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    reactionsMap[data.emoji] = (reactionsMap[data.emoji] || 0) + 1;
                    if (doc.id === App.currentUserId) {
                        userReaction = data.emoji;
                    }
                });

                const postHeader = document.createElement('div');
                postHeader.className = 'post-header';
                
                const postTitle = document.createElement('h3');
                postTitle.textContent = postData.username;
                postTitle.onclick = () => {
                    App.profileToView = postData.userId;
                    App.Profile.fetch(postData.userId, isOwner);
                    App.UI.showSection(isOwner ? 'user-profile-section' : 'other-user-profile-section');
                };
                
                const actionIcons = document.createElement('div');
                actionIcons.className = 'post-actions-icons';
                
                const likeButton = document.createElement('span');
                likeButton.innerHTML = postData.hasLiked ? '❤' : '♡'; // Heart icon
                likeButton.className = `like-btn action-icon-btn ${postData.hasLiked ? 'liked' : ''}`;
                likeButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.like(postId, likeButton);
                };
                
                const soundButton = document.createElement('span');
                soundButton.innerHTML = '🔊';
                soundButton.className = 'action-icon-btn';
                soundButton.onclick = (e) => {
                    e.stopPropagation();
                    App.UI.playPostSound(postData.content);
                };

                const translateButton = document.createElement('span');
                translateButton.innerHTML = '🌐'; // Earth icon
                translateButton.className = 'action-icon-btn';
                translateButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.translate(postData.content);
                };

                const optionsButton = document.createElement('span');
                optionsButton.innerHTML = '⋮'; // Three dots
                optionsButton.className = 'action-icon-btn';
                optionsButton.onclick = (e) => {
                    e.stopPropagation();
                    App.UI.toggleDropdown(postId);
                };

                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = `dropdown-${postId}`;
                dropdownMenu.className = 'dropdown-menu';

                const reportButton = document.createElement('button');
                reportButton.textContent = 'Report Post';
                reportButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.report(postId);
                    App.UI.hideAllDropdowns();
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Post';
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    App.Posts.delete(postId);
                    App.UI.hideAllDropdowns();
                };

                dropdownMenu.appendChild(reportButton);
                if (isOwner) {
                    dropdownMenu.appendChild(deleteButton);
                }
                
                actionIcons.appendChild(likeButton);
                actionIcons.appendChild(translateButton);
                actionIcons.appendChild(soundButton);
                actionIcons.appendChild(optionsButton);
                actionIcons.appendChild(dropdownMenu);
                
                postHeader.appendChild(postTitle);
                postHeader.appendChild(actionIcons);
                
                const postBody = document.createElement('p');
                postBody.innerHTML = App.Posts.formatTextWithLinks(postData.content);
                
                const postMeta = document.createElement('div');
                postMeta.className = 'post-meta';
                postMeta.innerHTML = `
                    <span>Likes: <span id="likes-count-${postId}">${App.Utils.formatNumber(postData.likes)}</span></span>
                    <span>Views: <span id="views-count-${postId}">${App.Utils.formatNumber(postData.views)}</span></span>
                    <span>${postData.timestamp ? new Date(postData.timestamp.toDate()).toLocaleString() : 'N/A'}</span>
                `;
                
                // Reaction bar (hidden by default)
                const reactionBar = document.createElement('div');
                reactionBar.className = 'reaction-bar';
                App.emojiReactions.forEach(emoji => {
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'reaction-emoji';
                    emojiSpan.textContent = emoji;
                    emojiSpan.onclick = async (e) => {
                        e.stopPropagation();
                        await App.Posts.addReaction(postId, emoji);
                        postElement.classList.remove('show-reactions'); // Hide bar after selecting
                    };
                    reactionBar.appendChild(emojiSpan);
                });

                // Reaction summary
                const reactionSummary = document.createElement('div');
                reactionSummary.className = 'post-reactions-summary';
                App.Posts.updateReactionSummary(reactionSummary, reactionsMap, userReaction);

                postElement.appendChild(postHeader);
                postElement.appendChild(postBody);
                postElement.appendChild(postMeta);
                postElement.appendChild(reactionSummary);
                postElement.appendChild(reactionBar); // Add reaction bar to the post element
                
                return postElement;
            },
            getRandomPostStyle: () => {
                const styles = App.neonColors;
                return styles[Math.floor(Math.random() * styles.length)];
            },
            formatTextWithLinks: (text) => {
                const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+|\b\w+\.(?:com|org|net|in|co|us|gov)\b(?:\/\S*)?)/g;
                return text.replace(urlRegex, (url) => {
                    let fullUrl = url;
                    if (!url.startsWith('http')) {
                        fullUrl = `https://${url}`;
                    }
                    return `<a href="${fullUrl}" target="_blank" class="url-link">${url}</a>`;
                });
            },
            like: async (postId, likeButton) => {
                const likeRef = App.db.collection('posts').doc(postId).collection('likes').doc(App.currentUserId);
                const postRef = App.db.collection('posts').doc(postId);
                
                try {
                    const doc = await likeRef.get();
                    const likesCountElement = document.getElementById(`likes-count-${postId}`);
                    
                    if (doc.exists) {
                        await likeRef.delete();
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(-1) });
                        if (likesCountElement) likesCountElement.textContent = App.Utils.formatNumber(parseInt(likesCountElement.textContent) - 1);
                        likeButton.innerHTML = '♡'; // White heart
                        likeButton.classList.remove('liked');
                    } else {
                        await likeRef.set({ likedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        await postRef.update({ likes: firebase.firestore.FieldValue.increment(1) });
                        if (likesCountElement) likesCountElement.textContent = App.Utils.formatNumber(parseInt(likesCountElement.textContent) + 1);
                        likeButton.innerHTML = '❤'; // Red heart
                        likeButton.classList.add('liked');
                    }
                } catch (error) {
                    console.error("Error liking post:", error);
                    alert('Error liking post. Please try again.');
                }
            },
            delete: async (postId) => {
                if (confirm('Are you sure you want to delete this post?')) {
                    try {
                        const postRef = App.db.collection('posts').doc(postId);
                        await postRef.delete();
                        alert('Post deleted.');
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) postElement.remove();
                        App.Profile.fetch(App.currentUserId, true); // Refresh profile posts
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        alert('Error deleting post. Please try again.');
                    }
                }
            },
            translate: (postContent) => {
                const encodedContent = encodeURIComponent(postContent);
                const translateUrl = `https://translate.google.com/?sl=auto&tl=hi&text=${encodedContent}`;
                window.open(translateUrl, '_blank');
            },
            report: async (postId) => {
                if (confirm('Are you sure you want to report this post for inappropriate content?')) {
                    try {
                        const reportRef = App.db.collection('posts').doc(postId).collection('reports').doc(App.currentUserId);
                        await reportRef.set({
                            reportedBy: App.currentUserId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Post reported. Thank you for your feedback.');
                    } catch (error) {
                        console.error("Error reporting post:", error);
                        alert('Error reporting post. Please try again.');
                    }
                }
            },
            recordView: async (postId, userId) => {
                const viewRef = App.db.collection('posts').doc(postId).collection('views').doc(userId);
                try {
                    const doc = await viewRef.get();
                    if (!doc.exists) {
                        // Count a view only if the user hasn't viewed this post before
                        await viewRef.set({ viewedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        await App.db.collection('posts').doc(postId).update({
                            views: firebase.firestore.FieldValue.increment(1)
                        });
                        const viewsCountElement = document.getElementById(`views-count-${postId}`);
                        if (viewsCountElement) {
                             viewsCountElement.textContent = App.Utils.formatNumber(parseInt(viewsCountElement.textContent) + 1);
                        }
                    }
                } catch (error) {
                    console.error("Error recording view:", error);
                }
            },
            addReaction: async (postId, emoji) => {
                const reactionRef = App.db.collection('posts').doc(postId).collection('reactions').doc(App.currentUserId);
                
                try {
                    const doc = await reactionRef.get();
                    let currentEmoji = doc.exists ? doc.data().emoji : null;

                    if (currentEmoji === emoji) {
                        // User clicked the same emoji, remove it
                        await reactionRef.delete();
                        currentEmoji = null; // Mark as removed
                    } else {
                        // Add or change emoji
                        await reactionRef.set({ emoji: emoji, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                        currentEmoji = emoji; // Update current emoji
                    }

                    // Re-fetch reactions to update counts
                    const reactionsSnapshot = await App.db.collection('posts').doc(postId).collection('reactions').get();
                    const reactionsMap = {};
                    reactionsSnapshot.docs.forEach(d => {
                        const data = d.data();
                        reactionsMap[data.emoji] = (reactionsMap[data.emoji] || 0) + 1;
                    });

                    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                    if (postElement) {
                        const reactionSummaryElement = postElement.querySelector('.post-reactions-summary');
                        App.Posts.updateReactionSummary(reactionSummaryElement, reactionsMap, currentEmoji);
                    }
                } catch (error) {
                    console.error("Error adding reaction:", error);
                    alert('Error adding reaction. Please try again.');
                }
            },
            updateReactionSummary: (element, reactionsMap, userReaction) => {
                element.innerHTML = '';
                const sortedReactions = Object.entries(reactionsMap).sort(([, countA], [, countB]) => countB - countA);

                // Add top 3 emojis
                sortedReactions.slice(0, 3).forEach(([emoji]) => {
                    const span = document.createElement('span');
                    span.className = 'top-emoji';
                    span.textContent = emoji;
                    element.appendChild(span);
                });

                // Add total count
                const totalReactions = Object.values(reactionsMap).reduce((sum, count) => sum + count, 0);
                if (totalReactions > 0) {
                    const countSpan = document.createElement('span');
                    countSpan.textContent = App.Utils.formatNumber(totalReactions);
                    element.appendChild(countSpan);
                }

                // Show user's current reaction if any
                if (userReaction) {
                    const userReactionSpan = document.createElement('span');
                    userReactionSpan.textContent = ` (Your: ${userReaction})`;
                    userReactionSpan.style.marginLeft = '5px';
                    userReactionSpan.style.color = '#777';
                    element.appendChild(userReactionSpan);
                }
            }
        };

        App.Monetization = {
            checkDailyRewards: async () => {
                if (!App.currentUserId) return;
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                
                const lastRewardDate = userData.lastRewardDate;
                const today = new Date().toDateString();
                
                if (lastRewardDate !== today) {
                    try {
                        await userRef.update({
                            coins: firebase.firestore.FieldValue.increment(10),
                            credits: firebase.firestore.FieldValue.increment(10),
                            postLimit: firebase.firestore.FieldValue.increment(1),
                            lastRewardDate: today
                        });
                        App.UI.updateHeaderStats(
                            (userData.coins || 0) + 10,
                            (userData.postLimit || 0) + 1,
                            (userData.credits || 0) + 10
                        );
                        document.getElementById('daily-reward-popup').classList.add('visible');
                    } catch (error) {
                        console.error("Error giving daily reward:", error);
                    }
                }
            },
            hideDailyRewardPopup: () => {
                document.getElementById('daily-reward-popup').classList.remove('visible');
            },
            requestAd: (rewardType) => {
                alert(`Triggering ad for ${rewardType}. Once the ad is complete, we'll give you the reward.`);
                // In a real App Inventor app, you would use this to call an ad component
                // For example: window.AppInventor.runAd('rewarded', rewardType);
            },
            handleAdCompletion: async (rewardType) => {
                // This function should be called by App Inventor after an ad completes successfully
                if (!App.currentUserId) {
                    console.error("Ad callback received but user is not logged in.");
                    return;
                }
                const userRef = App.db.collection('users').doc(App.currentUserId);
                
                try {
                    let updateData = {};
                    let rewardMessage = '';

                    // Handle ad completion for post boosting
                    if (rewardType.startsWith('post_boost_')) {
                        const duration = rewardType.split('_')[2];
                        // This implies the post was pending. You'd need a way to pass the postId here.
                        // For simplicity, we just confirm the boost verbally.
                        alert(`Your post has been boosted for ${duration} hours!`);
                        // In a real scenario, you'd mark the pending post as boosted or directly submit it.
                        App.UI.showMessage('create-post-message', `Your post is boosted for ${duration} hours!`, 'success');
                    } else if (rewardType === 'coins') {
                        updateData = { coins: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Coins';
                    } else if (rewardType === 'credits') {
                        updateData = { credits: firebase.firestore.FieldValue.increment(10) };
                        rewardMessage = '10 Credits';
                    } else if (rewardType === 'limits') {
                        updateData = { postLimit: firebase.firestore.FieldValue.increment(1) };
                        rewardMessage = '1 Post Limit';
                    }
                    
                    if (Object.keys(updateData).length > 0) {
                        await userRef.update(updateData);
                        App.UI.showMessage('ad-rewards-message', `Success! You received your reward: ${rewardMessage}.`, 'success');
                    }
                    
                    App.Profile.fetch(App.currentUserId, true); // Refresh header stats
                } catch (error) {
                    App.UI.showMessage('ad-rewards-message', `Error processing reward: ${error.message}`, 'error');
                    console.error("Reward processing error:", error);
                }
            }
        };

        App.Messages = {
            currentChatRecipientId: null,
            chatListener: null, // To store the Firestore listener
            startNewChat: async () => {
                const credits = App.userProfileData.credits || 0;
                if (credits < 1) {
                    alert('You do not have enough credits to send a message. Please get more credits.');
                    return;
                }
                
                const recipientName = document.getElementById('other-profile-display-name').textContent;
                document.getElementById('message-recipient-name').textContent = `Message to ${recipientName}`;
                App.UI.showSection('message-section');
                App.Messages.currentChatRecipientId = App.profileToView;
                App.Messages.loadMessages(); // Start loading messages for this chat
            },
            send: async (message) => {
                if (!App.Messages.currentChatRecipientId) return;
                
                const userRef = App.db.collection('users').doc(App.currentUserId);
                const userData = (await userRef.get()).data();
                
                if (userData.credits < 1) {
                    App.UI.showMessage('message-status-message', 'You do not have enough credits.', 'error');
                    return;
                }
                
                try {
                    await App.db.runTransaction(async (transaction) => {
                        const newMsgRef = App.db.collection('messages').doc();
                        transaction.set(newMsgRef, {
                            senderId: App.currentUserId,
                            senderName: App.currentUsername,
                            recipientId: App.Messages.currentChatRecipientId,
                            content: message,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        transaction.update(userRef, {
                            credits: firebase.firestore.FieldValue.increment(-1)
                        });
                    });
                    
                    App.UI.showMessage('message-status-message', 'Message sent successfully! 1 credit deducted.', 'success');
                    document.getElementById('message-content').value = '';
                    App.Profile.fetch(App.currentUserId, true); // Update credits in header
                } catch (error) {
                    App.UI.showMessage('message-status-message', `Error sending message: ${error.message}`, 'error');
                    console.error("Message send error:", error);
                }
            },
            loadMessages: () => {
                const chatWindow = document.getElementById('chat-window');
                chatWindow.innerHTML = '<p class="text-center" style="color: #aaa;">Loading messages...</p>';

                // Detach previous listener if any
                if (App.Messages.chatListener) {
                    App.Messages.chatListener();
                }

                const now = Date.now();
                const twelveHoursAgo = now - (12 * 60 * 60 * 1000); // 12 hours in milliseconds

                // Query messages where current user is sender AND recipient is target, OR vice versa
                // And messages are not older than 12 hours
                const query1 = App.db.collection('messages')
                    .where('senderId', '==', App.currentUserId)
                    .where('recipientId', '==', App.Messages.currentChatRecipientId)
                    .where('timestamp', '>', new Date(twelveHoursAgo));

                const query2 = App.db.collection('messages')
                    .where('senderId', '==', App.Messages.currentChatRecipientId)
                    .where('recipientId', '==', App.currentUserId)
                    .where('timestamp', '>', new Date(twelveHoursAgo));

                // Limitations: Firestore does not allow OR queries across different fields easily.
                // For a real-time chat, you would typically use a single chat document
                // with a sub-collection for messages, or combine results in client.
                // For this example, we'll fetch two queries and merge them client-side.
                // A better approach for scaling would be Firebase Cloud Functions that manage a chat document for two users.

                const fetchAndRenderMessages = async () => {
                    const [snapshot1, snapshot2] = await Promise.all([query1.get(), query2.get()]);
                    let messages = [];
                    snapshot1.docs.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                    snapshot2.docs.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));

                    messages.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));

                    chatWindow.innerHTML = ''; // Clear previous messages
                    if (messages.length === 0) {
                        chatWindow.innerHTML = '<p class="text-center" style="color: #aaa;">No messages in this chat (or messages are older than 12 hours).</p>';
                        return;
                    }

                    messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${msg.senderId === App.currentUserId ? 'sent' : 'received'}`;
                        messageElement.textContent = msg.content;
                        
                        const timestampSpan = document.createElement('span');
                        timestampSpan.className = 'timestamp';
                        timestampSpan.textContent = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString() : '';
                        messageElement.appendChild(timestampSpan);

                        // Add long press for reactions to chat messages
                        let pressTimer;
                        messageElement.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            pressTimer = setTimeout(() => {
                                messageElement.classList.add('show-reactions');
                            }, 500);
                        });
                        messageElement.addEventListener('touchend', () => {
                            clearTimeout(pressTimer);
                            messageElement.classList.remove('show-reactions'); // Hide reaction bar after touch ends
                        });
                        messageElement.addEventListener('touchcancel', () => clearTimeout(pressTimer));

                        // For chat messages, you'd fetch reactions per message if needed
                        // For simplicity in this example, we'll just add the reaction bar structure
                        const reactionBar = document.createElement('div');
                        reactionBar.className = 'reaction-bar';
                        App.emojiReactions.forEach(emoji => {
                            const emojiSpan = document.createElement('span');
                            emojiSpan.className = 'reaction-emoji';
                            emojiSpan.textContent = emoji;
                            emojiSpan.onclick = async (e) => {
                                e.stopPropagation();
                                // Store reactions in a sub-collection of the message for simplicity
                                await App.db.collection('messages').doc(msg.id).collection('reactions').doc(App.currentUserId).set({
                                    emoji: emoji, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                messageElement.classList.remove('show-reactions');
                                alert(`Reacted to message with ${emoji}!`); // For demonstration
                            };
                            reactionBar.appendChild(emojiSpan);
                        });
                        messageElement.appendChild(reactionBar);

                        chatWindow.appendChild(messageElement);
                    });
                    chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
                };

                // Set up real-time listener for messages between these two users
                // Note: Firestore listeners work per query. For complex chat, a Cloud Function
                // merging and triggering updates is more efficient.
                App.Messages.chatListener = App.db.collection('messages')
                    .where('senderId', 'in', [App.currentUserId, App.Messages.currentChatRecipientId])
                    .where('recipientId', 'in', [App.currentUserId, App.Messages.currentChatRecipientId])
                    .where('timestamp', '>', new Date(twelveHoursAgo))
                    .orderBy('timestamp')
                    .onSnapshot(fetchAndRenderMessages, err => {
                        console.error("Chat listener error:", err);
                        chatWindow.innerHTML = '<p class="text-center message error">Error loading chat.</p>';
                    });
            },
            stopChatListener: () => {
                if (App.Messages.chatListener) {
                    App.Messages.chatListener(); // Unsubscribe
                    App.Messages.chatListener = null;
                }
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners for forms and navigation
            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                App.Auth.signup(email, password, confirmPassword);
            });

            document.getElementById('signin-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                App.Auth.signin(email, password);
            });
            
            // Username availability check on input
            let usernameCheckTimer;
            document.getElementById('profileUsername').addEventListener('input', (e) => {
                clearTimeout(usernameCheckTimer);
                usernameCheckTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value);
                }, 500);
            });
            document.getElementById('editUsername').addEventListener('input', (e) => {
                clearTimeout(usernameCheckTimer);
                usernameCheckTimer = setTimeout(() => {
                    App.Profile.checkUsernameAvailability(e.target.value, true);
                }, 500);
            });

            document.getElementById('profile-setup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('profileUsername').value;
                const whatsapp = document.getElementById('profileWhatsApp').value;
                const instagram = document.getElementById('profileInstagram').value;
                App.Profile.setup(username, whatsapp, instagram);
            });
            
            document.getElementById('edit-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('editUsername').value;
                const whatsapp = document.getElementById('editWhatsApp').value;
                const instagram = document.getElementById('editInstagram').value;
                App.Profile.edit(username, whatsapp, instagram);
            });
            
            document.getElementById('create-post-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const content = document.getElementById('post-content').value;
                if (content.trim() !== '') {
                    App.Posts.create(content);
                }
            });
            
            document.getElementById('send-message-form').addEventListener('submit', (e) => {
                 e.preventDefault();
                 const message = document.getElementById('message-content').value;
                 if (message.trim() !== '') {
                     App.Messages.send(message);
                 }
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    App.UI.showSection(sectionId);
                    if (sectionId === 'home-posts') {
                        App.Posts.fetch(true); // Force refresh home posts
                    } else if (sectionId === 'user-profile-section') {
                        App.Profile.fetch(App.currentUserId, true);
                    } else if (sectionId === 'search-section') {
                        document.getElementById('search-input').value = '';
                        document.getElementById('search-results-list-users').innerHTML = '';
                        document.getElementById('search-results-list-posts').innerHTML = '';
                    }
                    if (sectionId !== 'message-section') {
                        App.Messages.stopChatListener(); // Stop chat listener if navigating away from chat
                    }
                });
            });

            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('scroll', () => {
                const activeSection = document.querySelector('section.active');
                if (!activeSection) return;

                const sectionId = activeSection.id;
                // Check if scroll is near bottom AND current section is home-posts AND not already loading
                if (sectionId === 'home-posts' && mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 200 && !App.isLoadingPosts) {
                    App.Posts.fetch();
                }
            });
        });

        App.auth.onAuthStateChanged(async (user) => {
            if (user) {
                App.currentUserId = user.uid;
                if (user.emailVerified) {
                    App.db.collection('users').doc(App.currentUserId).get().then(doc => {
                        if (doc.exists && doc.data().username) {
                            App.UI.showSection('home-posts');
                            App.Profile.fetch(App.currentUserId, true);
                            App.Monetization.checkDailyRewards();
                            App.Posts.fetch(true); // Initial fetch of posts
                        } else {
                            App.UI.showSection('setup-profile');
                        }
                    }).catch(error => {
                        console.error("Error fetching user profile:", error);
                        App.UI.showSection('setup-profile');
                    });
                } else {
                    App.UI.showSection('email-verify');
                }
            } else {
                App.currentUserId = null;
                App.UI.showSection('signin-auth');
            }
            App.UI.hidePreloader();
        });
        
        // Expose handleAdCompletion to global scope if needed by App Inventor or other external calls
        window.handleAdCompletion = (rewardType) => {
            if (rewardType) {
                App.Monetization.handleAdCompletion(rewardType);
            }
        };

    </script>
</body>
</html>
