 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Addmint Pro</title>
    <style>
        /* Base Styles - Dark Mode */
        :root {
            --bg-dark: #121212;
            --surface-dark: #1e1e1e;
            --card-dark: #2a2a2a;
            --text-light: #e0e0e0;
            --primary-color: #00e676; /* Addmint Green */
            --accent-color: #00b0ff; /* Blue */
            --danger-color: #ff1744; /* Red */
            --warning-color: #ffea00; /* Yellow */
            --border-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            position: relative; /* For splash screen positioning */
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none; /* Disable interaction during fade */
        }
        .splash-logo {
            font-size: 4em; /* Larger logo for splash */
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.7);
            letter-spacing: 2px;
            animation: bounce 2s infinite ease-in-out;
        }
        .splash-tagline {
            font-size: 1.2em;
            color: #ccc;
            margin-top: 15px;
            opacity: 0;
            animation: fadeIn 1s forwards 0.5s; /* Fade in after logo */
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }


        /* Header */
        header {
            background-color: var(--surface-dark);
            width: 100%;
            padding: 10px 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        header .logo-section {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 5px rgba(0, 230, 118, 0.5);
            letter-spacing: 1px;
        }
        .header-right {
            display: flex;
            align-items: center;
        }
        .header-stats {
            display: flex;
            margin-right: 15px;
        }
        .stat-item-header {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .stat-item-header span {
            margin-right: 5px;
            color: var(--primary-color);
            font-weight: bold;
        }
        .stat-item-header .plus-icon {
            font-size: 1.2em;
            color: var(--primary-color);
            cursor: pointer;
            margin-left: 5px;
            transition: transform 0.2s;
        }
        .stat-item-header .plus-icon:hover {
            transform: scale(1.1);
        }
        .search-container {
            position: relative;
            margin-left: 15px;
        }
        .search-container input {
            background-color: #333;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            color: var(--text-light);
            font-size: 0.9em;
            width: 120px;
            transition: width 0.3s ease-in-out;
        }
        .search-container input:focus {
            width: 180px;
            outline: none;
            border-color: var(--primary-color);
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--card-dark);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-shadow: 0 4px 10px var(--shadow-color);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        .search-results div {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .search-results div:last-child {
            border-bottom: none;
        }
        .search-results div:hover {
            background-color: var(--surface-dark);
        }
        .search-results .profile-pic-placeholder {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #555; /* Placeholder background */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            color: #bbb;
        }
        .search-results p {
            margin: 0;
            font-size: 0.9em;
        }


        /* Navigation */
        nav {
            background-color: var(--surface-dark);
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 8px var(--shadow-color);
            position: sticky;
            bottom: 0;
            z-index: 1000;
        }
        nav button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.9em;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        nav button .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #eee; /* Default icon color */
        }
        nav button.active {
            color: var(--primary-color);
            background-color: #3a3a3a;
        }
        nav button.active .nav-icon {
            color: var(--primary-color); /* Active icon color */
        }


        /* Main Content Area */
        #app-container {
            flex-grow: 1;
            width: 100%;
            max-width: 650px;
            padding: 20px 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .section {
            background-color: var(--card-dark);
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            margin-bottom: 20px;
            padding: 20px;
        }
        .section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.6em;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-size: 1.1em;
        }
        .empty-state .empty-icon {
            font-size: 60px;
            opacity: 0.6;
            margin-bottom: 15px;
            display: block;
        }
        .scroll-top-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2em;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px var(--shadow-color);
            cursor: pointer;
            transition: background-color 0.3s;
            display: none; /* Hidden by default */
        }
        .scroll-top-button:hover {
            background-color: #0088cc;
        }


        /* Post Card Specifics */
        .post-container {
            background-color: var(--surface-dark);
            border-radius: 10px;
            box-shadow: 0 2px 6px var(--shadow-color);
            margin-bottom: 20px;
            padding: 15px;
            transition: transform 0.2s ease-in-out;
        }
        .post-container:hover {
            transform: translateY(-3px);
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .profile-pic-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: #555;
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1em;
            color: #ccc;
            font-weight: bold;
            overflow: hidden; /* Ensure text doesn't spill out */
        }
        .post-header span {
            font-weight: 600;
            color: var(--text-light);
            font-size: 1.1em;
        }
        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: #333;
        }
        .post-content {
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .post-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .action-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
            flex-grow: 1;
        }
        .action-button .button-icon {
            font-size: 20px;
            margin-right: 8px;
        }
        .action-button.whatsapp { background-color: #25D366; }
        .action-button.instagram { background-color: #E1306C; }
        .action-button.message { background-color: #007bff; }
        .action-button.edit { background-color: #ffc107; color: #333; }
        .action-button.edit .button-icon { color: #333; }
        .action-button.delete { background-color: var(--danger-color); }
        .action-button:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }
        .action-button:active {
            transform: translateY(0);
        }
        .like-button {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            flex-grow: 1;
        }
        .like-button.liked {
            background-color: #e74c3c;
        }
        .like-button:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }
        .like-button:active {
            transform: translateY(0);
        }
        .like-button span {
            margin-left: 5px;
        }
        .sound-button {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            margin-left: auto;
        }
        .sound-button.playing {
            background-color: var(--primary-color);
        }
        .sound-button:hover {
            opacity: 0.95;
        }


        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 500;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #333;
            color: var(--text-light);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0, 230, 118, 0.3);
        }
        .submit-button {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%;
            box-shadow: 0 2px 6px rgba(0, 230, 118, 0.3);
        }
        .submit-button:hover {
            background-color: #00c75b;
            transform: translateY(-1px);
        }
        .submit-button:active {
            transform: translateY(0);
        }
        .link-button {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            text-decoration: underline;
        }
        .link-button:hover {
            color: #0088cc;
        }
        .social-signin-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #4285F4; /* Google Blue */
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .social-signin-button .social-icon {
            font-size: 24px;
            margin-right: 10px;
            color: white; /* For Unicode/text icons */
        }
        .social-signin-button:hover {
            background-color: #357ae8;
        }


        /* Profile Specifics */
        .profile-details p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .profile-details span {
            color: var(--primary-color);
            font-weight: 600;
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .stat-item {
            text-align: center;
            flex: 1;
            padding: 0 10px;
        }
        .stat-item span {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-color);
        }
        .stat-item small {
            color: #bbb;
            font-size: 0.9em;
        }

        /* Message Specifics (Placeholder) */
        .message-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #1a1a1a;
        }
        .message-item {
            background-color: #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .message-item.from-me {
            background-color: #004d40; /* Darker green for own messages */
            align-self: flex-end;
            margin-left: auto;
            border-radius: 8px 8px 0 8px;
        }
        .message-item.from-other {
            background-color: #424242;
            align-self: flex-start;
            margin-right: auto;
            border-radius: 8px 8px 8px 0;
        }
        .message-sender {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .message-content {
            color: var(--text-light);
            line-height: 1.5;
        }
        .message-time {
            font-size: 0.7em;
            color: #888;
            text-align: right;
            margin-top: 5px;
        }
        .message-input-group {
            display: flex;
            gap: 10px;
        }
        .message-input-group input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background-color: #333;
            color: var(--text-light);
            font-size: 1em;
            box-sizing: border-box;
        }
        .message-input-group button {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .message-input-group button:hover {
            background-color: #00c75b;
        }

        /* Preloader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998; /* Below splash */
            transition: opacity 0.5s ease-out;
            pointer-events: none; /* Allow clicks to pass through when hidden */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Authentication Section */
        #auth-section, #signup-section, #forgot-password-section, #email-verify-section {
            background-color: var(--card-dark);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            width: 90%;
            max-width: 400px;
            margin: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80vh;
        }
        #auth-section h2, #signup-section h2, #forgot-password-section h2, #email-verify-section h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
        }
        #auth-section p, #signup-section p, #forgot-password-section p, #email-verify-section p {
            margin-bottom: 20px;
            color: #aaa;
        }
        #auth-section .auth-message, #signup-section .auth-message, #forgot-password-section .auth-message, #email-verify-section .auth-message {
            color: var(--primary-color);
            margin-top: 15px;
            font-size: 0.95em;
        }

        #setup-profile-section {
            display: none;
            background-color: var(--card-dark);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-color);
            width: 90%;
            max-width: 400px;
            margin: auto;
            min-height: 80vh;
            justify-content: center;
            flex-direction: column;
        }
        #setup-profile-section h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">Addmint</div>
        <div class="splash-tagline">Connect, Share, Grow.</div>
        <div class="spinner" style="margin-top: 40px;"></div>
    </div>

    <div id="preloader" style="display: none;">
        <div class="spinner"></div>
    </div>

    <div id="auth-section" style="display: none;">
        <h2>Welcome to Addmint!</h2>
        <p>Sign in to connect with others and share your moments.</p>
        
        <form id="signin-form">
            <div class="form-group">
                <label for="signinEmail">Email</label>
                <input type="email" id="signinEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="signinPassword">Password</label>
                <input type="password" id="signinPassword" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="submit-button">Sign In</button>
        </form>
        <button class="link-button" onclick="showSection('forgot-password-auth')">Forgot Password?</button>
        <p class="auth-message" id="auth-status-message"></p>
        <p style="margin-top: 20px; color: #bbb;">Don't have an account? <button class="link-button" onclick="showSection('signup-auth')">Sign Up</button></p>
        
        <button class="social-signin-button" onclick="signInWithGoogle()">
            <span class="social-icon">G</span> Sign In with Google
        </button>
    </div>

    <div id="signup-section" style="display: none;">
        <h2>Create Account</h2>
        <p>Join Addmint and start sharing!</p>
        <form id="signup-form">
            <div class="form-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="Choose a password (min 6 chars)" required>
            </div>
            <button type="submit" class="submit-button">Sign Up</button>
        </form>
        <p class="auth-message" id="signup-status-message"></p>
        <p style="margin-top: 20px; color: #bbb;">Already have an account? <button class="link-button" onclick="showSection('signin-auth')">Sign In</button></p>
    </div>

    <div id="email-verify-section" style="display: none;">
        <h2>Verify Your Email</h2>
        <p id="verify-email-message">A verification email has been sent to your inbox. Please click the link in the email to verify your account.</p>
        <p>After verifying, please sign in again.</p>
        <button class="submit-button" onclick="signOutUser()">Sign In Again / Log Out</button>
        <p class="auth-message" id="verify-status-message"></p>
    </div>


    <div id="forgot-password-section" style="display: none;">
        <h2>Forgot Password?</h2>
        <p>Enter your email to receive a password reset link.</p>
        <form id="forgot-password-form">
            <div class="form-group">
                <label for="resetEmail">Email</label>
                <input type="email" id="resetEmail" placeholder="Enter your email" required>
            </div>
            <button type="submit" class="submit-button">Send Reset Email</button>
        </form>
        <p class="auth-message" id="forgot-password-status-message"></p>
        <p style="margin-top: 20px; color: #bbb;"><button class="link-button" onclick="showSection('signin-auth')">Back to Sign In</button></p>
    </div>

    <div id="setup-profile-section" style="display: none;">
        <h2>Complete Your Profile</h2>
        <p>This information will be visible to other users. Choose a unique username!</p>
        <form id="complete-profile-form">
            <div class="form-group">
                <label for="newUsername">Username</label>
                <input type="text" id="newUsername" placeholder="Enter your display name" required>
            </div>
            <div class="form-group">
                <label for="newWhatsappNum">WhatsApp Number (Optional, e.g., +919876543210)</label>
                <input type="text" id="newWhatsappNum" placeholder="+91xxxxxxxxxx">
            </div>
            <div class="form-group">
                <label for="newInstagramHandle">Instagram Handle (Optional, e.g., @yourhandle)</label>
                <input type="text" id="newInstagramHandle" placeholder="@yourhandle">
            </div>
            <p id="profile-setup-status" style="color: var(--primary-color);"></p>
            <button type="submit" class="submit-button">Save Profile & Enter App</button>
        </form>
    </div>


    <header id="main-header" style="display: none;">
        <div class="logo-section">
            Addmint
        </div>
        <div class="header-right">
            <div class="header-stats">
                <div class="stat-item-header">
                    <span id="header-coins">0</span> Coins
                    <span class="plus-icon" onclick="requestAd('coins')">➕</span>
                </div>
                <div class="stat-item-header">
                    <span id="header-credits">0</span> Credits
                    <span class="plus-icon" onclick="requestAd('credits')">➕</span>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="userSearchInput" placeholder="Search users...">
                <div id="searchResults" class="search-results">
                    </div>
            </div>
        </div>
    </header>

    <div id="app-container" style="display: none;">
        <div id="feed-section" class="section">
            <h2>Recent Posts</h2>
            <div id="posts-list">
                <p class="empty-state">
                    <span class="empty-icon">📰</span>
                    No posts found yet. Be the first to share something amazing!
                </p>
            </div>
        </div>

        <div id="create-post-section" class="section" style="display: none;">
            <h2>Create New Post</h2>
            <form id="new-post-form">
                <div class="form-group">
                    <label for="postContent">What's on your mind?</label>
                    <textarea id="postContent" rows="6" placeholder="Write your post here..." minlength="50" maxlength="1000" required></textarea>
                    <small style="color: #888;">Min: 50, Max: 1000 characters.</small>
                </div>
                <div class="form-group">
                    <label for="postImageUpload">Upload Image (Optional)</label>
                    <input type="file" id="postImageUpload" accept="image/*">
                </div>
                <p id="upload-status" style="color: var(--primary-color); font-size: 0.9em; margin-top: -10px; margin-bottom: 15px; display: none;">Uploading image...</p>
                <div class="form-group">
                    <label for="contactOption">Choose a contact option (at least one is required)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="postWhatsappNum" placeholder="WhatsApp (e.g., +91xxxxxx)">
                        <input type="text" id="postInstagramHandle" placeholder="Instagram (e.g., @yourhandle)">
                    </div>
                </div>
                <p id="contact-validation-message" style="color: var(--danger-color); font-size: 0.9em; margin-top: -10px; display: none;">Please provide either WhatsApp or Instagram ID.</p>
                <div class="form-group">
                    <label>Boost Post Visibility (Optional)</label>
                    <div style="display: flex; justify-content: space-around; gap: 10px;">
                        <button type="button" class="action-button" onclick="requestAdForPostExpiry(1)">
                            ➕ +6 Hrs (1 Ad)
                        </button>
                        <button type="button" class="action-button" onclick="requestAdForPostExpiry(2)">
                            ✨ +12 Hrs (2 Ads)
                        </button>
                        <button type="button" class="action-button" onclick="requestAdForPostExpiry(3)">
                            🚀 +18 Hrs (3 Ads)
                        </button>
                    </div>
                    <p style="font-size:0.8em; color:#bbb; text-align:center; margin-top:10px;">Base expiry: 12 hours. Max expiry: 30 hours (with 3 ads).</p>
                    <p id="ad-count-display" style="font-size:0.9em; color:var(--primary-color); text-align:center;">Ads watched for this post: 0</p>
                </div>
                <button type="submit" class="submit-button">Post Now</button>
            </form>
        </div>

        <div id="profile-section" class="section" style="display: none;">
            <h2>My Profile</h2>
            <div id="profile-details">
                <p><strong>Username:</strong> <span id="profile-username">Loading...</span></p>
                <p><strong>Email:</strong> <span id="profile-email">Loading...</span></p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <span id="stat-posts">0</span>
                        <small>Posts</small>
                    </div>
                    <div class="stat-item">
                        <span id="stat-coins">0</span>
                        <small>Coins</small>
                    </div>
                    <div class="stat-item">
                        <span id="stat-credits">0</span>
                        <small>Credits</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="whatsappNumInput">WhatsApp Number (e.g., +919876543210)</label>
                    <input type="text" id="whatsappNumInput" placeholder="+91xxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label for="instagramHandleInput">Instagram Handle (e.g., @yourhandle)</label>
                    <input type="text" id="instagramHandleInput" placeholder="@yourhandle">
                </div>
                <button onclick="updateProfile()" class="submit-button">Update Profile</button>
            </div>
            <button onclick="signOutUser()" class="submit-button" style="background-color: var(--danger-color); margin-top: 20px;">Sign Out</button>
        </div>

        <div id="messages-section" class="section" style="display: none;">
            <h2>Messages</h2>
            <div id="messages-list" class="message-list-container">
                <p class="empty-state">
                    <span class="empty-icon">💬</span>
                    Start a conversation by contacting a user!
                </p>
            </div>
            <div class="message-input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button id="sendMessageBtn" disabled>Send</button>
            </div>
            <p id="current-chat-status" style="font-size:0.9em; color:#bbb; text-align:center; margin-top:10px;">Select a user to chat.</p>
        </div>
    </div>

    <button class="scroll-top-button" id="scrollTopBtn">⬆️</button>

    <nav id="main-nav" style="display: none;">
        <button id="nav-feed" class="active" onclick="showSection('feed')">
            <span class="nav-icon">🏠</span>
            Feed
        </button>
        <button id="nav-create-post" onclick="showSection('create-post')">
            <span class="nav-icon">➕</span>
            New Post
        </button>
        <button id="nav-profile" onclick="showSection('profile')">
            <span class="nav-icon">👤</span>
            Profile
        </button>
        <button id="nav-messages" onclick="showSection('messages')">
            <span class="nav-icon">✉️</span>
            Messages
        </button>
    </nav>


    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // REPLACE WITH YOUR ACTUAL API KEY
            authDomain: "YOUR_FIREBASE_PROJECT_ID.firebaseapp.com", // REPLACE WITH YOUR ACTUAL AUTH DOMAIN
            databaseURL: "https://YOUR_FIREBASE_PROJECT_ID-default-rtdb.asia-southeast1.firebasedatabase.app", // REPLACE WITH YOUR ACTUAL DATABASE URL
            projectId: "YOUR_FIREBASE_PROJECT_ID", // REPLACE WITH YOUR ACTUAL PROJECT ID
            storageBucket: "YOUR_FIREBASE_PROJECT_ID.appspot.com", // REPLACE WITH YOUR ACTUAL STORAGE BUCKET
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID", // REPLACE WITH YOUR ACTUAL SENDER ID
            appId: "YOUR_FIREBASE_APP_ID", // REPLACE WITH YOUR ACTUAL APP ID
            measurementId: "YOUR_FIREBASE_MEASUREMENT_ID" // REPLACE WITH YOUR ACTUAL MEASUREMENT ID (optional)
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const googleProvider = new firebase.auth.GoogleAuthProvider(); // Initialize Google Auth Provider

        let currentUserId = null;
        let currentUserData = { username: 'Guest', coins: 0, credits: 0, whatsappNumber: '', instagramHandle: '', profilePicture: '' };
        let allFetchedPosts = [];
        let displayedPostIds = new Set();
        const postsPerLoad = 5;

        let adsWatchedForCurrentPost = 0;
        const BASE_EXPIRY_HOURS = 12;
        const HOURS_PER_AD = 6;
        const MAX_ADS_FOR_POST = 3;

        let currentChatUser = null;

        let currentSpeakingUtterance = null;

        // --- UI Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const preloader = document.getElementById('preloader');
        const authSection = document.getElementById('auth-section');
        const signupSection = document.getElementById('signup-section');
        const forgotPasswordSection = document.getElementById('forgot-password-section');
        const emailVerifySection = document.getElementById('email-verify-section');
        const setupProfileSection = document.getElementById('setup-profile-section');

        const mainHeader = document.getElementById('main-header');
        const appContainer = document.getElementById('app-container');
        const mainNav = document.getElementById('main-nav');
        const postsListDiv = document.getElementById('posts-list');
        const adCountDisplay = document.getElementById('ad-count-display');
        const messagesListDiv = document.getElementById('messages-list');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const currentChatStatus = document.getElementById('current-chat-status');

        // --- Preloader & Splash Screen Logic ---
        function showPreloader() { preloader.style.display = 'flex'; preloader.style.opacity = '1'; }
        function hidePreloader() {
            preloader.style.opacity = '0';
            setTimeout(() => { preloader.style.display = 'none'; }, 500);
        }

        // --- UI Navigation ---
        const sections = ['feed', 'create-post', 'profile', 'messages'];
        const authForms = {
            'signin-auth': authSection,
            'signup-auth': signupSection,
            'forgot-password-auth': forgotPasswordSection,
            'email-verify': emailVerifySection,
            'setup-profile': setupProfileSection
        };
        const navButtons = {
            'feed': document.getElementById('nav-feed'),
            'create-post': document.getElementById('nav-create-post'),
            'profile': document.getElementById('nav-profile'),
            'messages': document.getElementById('nav-messages')
        };

        function showSection(id) {
            sections.forEach(sectionId => {
                document.getElementById(sectionId + '-section').style.display = 'none';
                if (navButtons[sectionId]) navButtons[sectionId].classList.remove('active');
            });

            Object.values(authForms).forEach(formSection => {
                formSection.style.display = 'none';
            });

            if (sections.includes(id)) {
                document.getElementById(id + '-section').style.display = 'block';
                if (navButtons[id]) navButtons[id].classList.add('active');
                
                if (id === 'feed') {
                    if (allFetchedPosts.length === 0) fetchPosts(); // Initial fetch if empty
                    displayRandomPosts(true); // Always re-display feed on navigation
                } else if (id === 'create-post') {
                    adsWatchedForCurrentPost = 0;
                    updateAdCountDisplay();
                    document.getElementById('postWhatsappNum').value = currentUserData.whatsappNumber || '';
                    document.getElementById('postInstagramHandle').value = currentUserData.instagramHandle || '';
                } else if (id === 'profile') {
                    fetchUserProfile(currentUserId);
                } else if (id === 'messages') {
                    messagesListDiv.innerHTML = `
                        <p class="empty-state">
                            <span class="empty-icon">💬</span>
                            Select a user from a post to start chatting!
                        </p>`;
                    messageInput.disabled = true;
                    sendMessageBtn.disabled = true;
                    currentChatStatus.textContent = "Select a user to chat.";
                    currentChatUser = null; // Reset current chat
                    if (chatUnsubscribe) { // Unsubscribe from previous chat listener
                        chatUnsubscribe();
                    }
                }

            } else if (authForms[id]) {
                authForms[id].style.display = 'flex';
            }
        }

        function showMainAppUI() {
            Object.values(authForms).forEach(formSection => {
                formSection.style.display = 'none';
            });
            mainHeader.style.display = 'flex';
            appContainer.style.display = 'block';
            mainNav.style.display = 'flex';
            showSection('feed');
        }

        // --- Authentication (Email/Password & Google) ---
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');

        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            document.getElementById('auth-status-message').textContent = 'Signing in...';
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (!userCredential.user.emailVerified) {
                    document.getElementById('auth-status-message').textContent = 'Please verify your email to log in.';
                    await auth.signOut();
                    showSection('email-verify');
                    document.getElementById('verify-email-message').textContent = `Your email ${email} is not verified. Please check your inbox for the verification link.`;
                    return;
                }
                currentUserId = userCredential.user.uid;
                const userDoc = await db.collection('users').doc(currentUserId).get();
                if (!userDoc.exists || !userDoc.data().username) {
                    showSection('setup-profile');
                } else {
                    await fetchUserProfile(currentUserId);
                    showMainAppUI();
                }
            } catch (error) {
                console.error("Sign-in error:", error);
                document.getElementById('auth-status-message').textContent = 'Sign-in failed: ' + error.message;
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            document.getElementById('signup-status-message').textContent = 'Creating account...';
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.sendEmailVerification();
                document.getElementById('signup-status-message').textContent = 'Account created. Verification email sent.';
                alert('Account created. Verification email sent. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in.');
                await auth.signOut();
                showSection('email-verify');
                document.getElementById('verify-email-message').textContent = `A verification email has been sent to ${email}. Please click the link in the email to verify your account. After verifying, you can sign in.`;
            } catch (error) {
                console.error("Sign-up error:", error);
                document.getElementById('signup-status-message').textContent = 'Sign-up failed: ' + error.message;
            }
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            document.getElementById('forgot-password-status-message').textContent = 'Sending reset email...';
            try {
                await auth.sendPasswordResetEmail(email);
                document.getElementById('forgot-password-status-message').textContent = 'Password reset email sent. Check your inbox!';
                alert('Password reset email sent. Check your inbox!');
            } catch (error) {
                console.error("Forgot password error:", error);
                document.getElementById('forgot-password-status-message').textContent = 'Error: ' + error.message;
            }
        });

        async function signInWithGoogle() {
            document.getElementById('auth-status-message').textContent = 'Signing in with Google...';
            try {
                // Use signInWithRedirect for WebView compatibility
                await auth.signInWithRedirect(googleProvider);
                // The result will be handled on page load via getRedirectResult()
            } catch (error) {
                console.error("Google sign-in error:", error);
                document.getElementById('auth-status-message').textContent = 'Google Sign-in failed: ' + error.message;
            }
        }


        // Complete Profile after initial login/signup
        const completeProfileForm = document.getElementById('complete-profile-form');
        completeProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const whatsappNum = document.getElementById('newWhatsappNum').value.trim();
            const instagramHandle = document.getElementById('newInstagramHandle').value.trim();

            if (!username) {
                document.getElementById('profile-setup-status').textContent = 'Username is required.';
                return;
            }
            if (!currentUserId) {
                document.getElementById('profile-setup-status').textContent = 'Authentication error. Please sign in again.';
                return;
            }

            try {
                // A simple placeholder for profile picture if none exists
                const defaultProfilePic = 'https://via.placeholder.com/150/00e676/000000?text=' + username.substring(0,1).toUpperCase(); // Placeholder image with first letter of username

                await db.collection('users').doc(currentUserId).set({
                    username: username,
                    email: auth.currentUser.email,
                    whatsappNumber: whatsappNum,
                    instagramHandle: instagramHandle,
                    coins: currentUserData.coins || 0,
                    credits: currentUserData.credits || 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    profilePicture: defaultProfilePic // Using a simple placeholder
                }, { merge: true });
                await fetchUserProfile(currentUserId);
                showMainAppUI();
                alert('Profile setup complete!');
            } catch (error) {
                console.error("Error completing profile:", error);
                document.getElementById('profile-setup-status').textContent = 'Error setting up profile: ' + error.message;
            }
        });

        // Sign Out
        async function signOutUser() {
            try {
                if (currentSpeakingUtterance) {
                    speechSynthesis.cancel();
                    currentSpeakingUtterance = null;
                    document.querySelectorAll('.sound-button.playing').forEach(btn => btn.classList.remove('playing'));
                }
                await auth.signOut();
                currentUserId = null;
                currentUserData = { username: 'Guest', coins: 0, credits: 0, whatsappNumber: '', instagramHandle: '', profilePicture: '' };
                updateHeaderStats();
                alert('You have been signed out.');
                showSection('signin-auth');
            } catch (error) {
                console.error("Error signing out:", error);
                alert('Sign out failed: ' + error.message);
            }
        }


        // --- Header Stats Update ---
        function updateHeaderStats() {
            document.getElementById('header-coins').textContent = currentUserData.coins || 0;
            document.getElementById('header-credits').textContent = currentUserData.credits || 0;
        }

        // --- Post Display Logic ---
        const observer = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting) {
                displayRandomPosts();
            }
        }, { threshold: 0.1 });

        const infiniteScrollSentinel = document.createElement('div');
        infiniteScrollSentinel.id = 'infinite-scroll-sentinel';
        postsListDiv.parentNode.appendChild(infiniteScrollSentinel);
        observer.observe(infiniteScrollSentinel);


        async function fetchPosts() {
            if (allFetchedPosts.length === 0 && postsListDiv.innerHTML.includes('No posts found')) {
                 postsListDiv.innerHTML = '<p class="empty-state"><div class="spinner"></div> Loading posts...</p>';
            }
            try {
                const snapshot = await db.collection('posts').orderBy('timestamp', 'desc').get();
                allFetchedPosts = [];
                snapshot.forEach(doc => {
                    const postData = doc.data();
                    if (postData.expiryTime && postData.expiryTime < Date.now()) {
                        console.log("Skipping expired post (client-side):", doc.id);
                    } else {
                        allFetchedPosts.push({ id: doc.id, data: postData });
                    }
                });
                console.log("Total non-expired posts fetched:", allFetchedPosts.length);
                if (allFetchedPosts.length > 0) {
                     displayRandomPosts(true);
                } else {
                     postsListDiv.innerHTML = '<p class="empty-state"><span class="empty-icon">📰</span>No posts found yet. Be the first to share something amazing!</p>';
                }
            } catch (error) {
                console.error("Error fetching posts:", error);
                postsListDiv.innerHTML = '<p class="empty-state error-message"><span class="empty-icon">❌</span>Error loading posts: ' + error.message + '</p>';
            }
        }

        function displayRandomPosts(clearAll = false) {
            if (clearAll) {
                postsListDiv.innerHTML = '';
                displayedPostIds.clear();
                // Clear any ongoing speech if refreshing posts
                if (currentSpeakingUtterance) {
                    speechSynthesis.cancel();
                    currentSpeakingUtterance = null;
                }
                document.querySelectorAll('.sound-button.playing').forEach(btn => btn.classList.remove('playing'));
            }

            if (allFetchedPosts.length === 0) {
                if (postsListDiv.innerHTML === '' || postsListDiv.innerHTML.includes('spinner')) {
                   postsListDiv.innerHTML = '<p class="empty-state"><span class="empty-icon">📰</span>No posts found yet. Be the first to share something amazing!</p>';
                }
                return;
            }

            let availablePosts = allFetchedPosts.filter(p => !displayedPostIds.has(p.id));
            if (availablePosts.length < postsPerLoad / 2 && allFetchedPosts.length > 0) {
                console.log("Resetting displayed posts for more variety.");
                displayedPostIds.clear();
                availablePosts = allFetchedPosts;
            }

            const shuffledAvailablePosts = shuffleArray([...availablePosts]);
            const postsToRender = [];
            for (let i = 0; i < shuffledAvailablePosts.length && postsToRender.length < postsPerLoad; i++) {
                const post = shuffledAvailablePosts[i];
                if (!displayedPostIds.has(post.id)) {
                    postsToRender.push(post);
                    displayedPostIds.add(post.id);
                }
            }

            if (postsToRender.length === 0 && allFetchedPosts.length > 0) {
                for (let i = 0; i < postsPerLoad && i < allFetchedPosts.length; i++) {
                    postsToRender.push(allFetchedPosts[Math.floor(Math.random() * allFetchedPosts.length)]);
                }
            }

            postsToRender.forEach(postDoc => {
                const postData = postDoc.data;
                const postId = postDoc.id;
                const postUserId = postData.userId;

                const postDiv = document.createElement('div');
                postDiv.className = 'post-container';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'post-header';

                const profilePicPlaceholder = document.createElement('div');
                profilePicPlaceholder.className = 'profile-pic-placeholder';
                profilePicPlaceholder.textContent = postData.profileName ? postData.profileName.substring(0, 1).toUpperCase() : 'U'; // First letter of username
                headerDiv.appendChild(profilePicPlaceholder);

                const profileName = document.createElement('span');
                profileName.textContent = postData.profileName || 'Loading User...';
                if (!postData.profileName) {
                    db.collection('users').doc(postUserId).get().then(userDoc => {
                        if (userDoc.exists) {
                            profileName.textContent = userDoc.data().username || 'Unknown User';
                            profilePicPlaceholder.textContent = userDoc.data().username.substring(0, 1).toUpperCase();
                        } else {
                            profileName.textContent = 'User Removed';
                            profilePicPlaceholder.textContent = 'X';
                        }
                    }).catch(err => console.error("Error fetching post creator's name:", err));
                }
                headerDiv.appendChild(profileName);
                
                const soundButton = document.createElement('button');
                soundButton.className = 'sound-button';
                soundButton.innerHTML = '🔊';
                soundButton.onclick = (event) => toggleSpeech(event.target, postData.postContent.replace(/'/g, "\\'"));
                headerDiv.appendChild(soundButton);

                postDiv.appendChild(headerDiv);

                if (postData.imageUrl && postData.imageUrl !== "") {
                    const postImage = document.createElement('img');
                    postImage.src = postData.imageUrl;
                    postImage.alt = 'Post Image';
                    postImage.className = 'post-image';
                    postDiv.appendChild(postImage);
                }

                const postContent = document.createElement('p');
                postContent.className = 'post-content';
                postContent.textContent = postData.postContent;
                
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                postContent.innerHTML = postContent.textContent.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" onclick="event.stopPropagation(); sendCommandToAppInventor('OPEN_AND_COPY_URL:${url}');">${url}</a>`;
                });


                postDiv.appendChild(postContent);

                const footerDiv = document.createElement('div');
                footerDiv.className = 'post-footer';

                const likeButton = document.createElement('button');
                likeButton.className = 'like-button';
                const isLiked = postData.likes && postData.likes.includes(currentUserId);
                likeButton.classList.toggle('liked', isLiked);
                likeButton.innerHTML = `❤️ <span id="like-count-${postId}">${(postData.likes ? postData.likes.length : 0)}</span>`;
                likeButton.onclick = () => toggleLike(postId, likeButton);
                footerDiv.appendChild(likeButton);


                if (currentUserId && postUserId === currentUserId) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-button edit';
                    editBtn.innerHTML = '<span class="button-icon">✏️</span> Edit';
                    editBtn.onclick = () => alert('Edit Post functionality to be implemented.');
                    footerDiv.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-button delete';
                    deleteBtn.innerHTML = '<span class="button-icon">🗑️</span> Delete';
                    deleteBtn.onclick = () => {
                        if (confirm('Are you sure you want to delete this post?')) {
                            deletePost(postId);
                        }
                    };
                    footerDiv.appendChild(deleteBtn);
                } else {
                    db.collection('users').doc(postUserId).get().then(userDoc => {
                        if (userDoc.exists) {
                            const contactData = userDoc.data();
                            const whatsappNum = contactData.whatsappNumber;
                            const instagramHandle = contactData.instagramHandle;

                            if (whatsappNum) {
                                const whatsappBtn = document.createElement('button');
                                whatsappBtn.className = 'action-button whatsapp';
                                whatsappBtn.innerHTML = '<span class="button-icon">💬</span> WhatsApp';
                                whatsappBtn.onclick = () => sendCommandToAppInventor('CONTACT:WHATSAPP', whatsappNum);
                                footerDiv.appendChild(whatsappBtn);
                            }
                            if (instagramHandle) {
                                const instagramBtn = document.createElement('button');
                                instagramBtn.className = 'action-button instagram';
                                instagramBtn.innerHTML = '<span class="button-icon">📸</span> Instagram';
                                instagramBtn.onclick = () => sendCommandToAppInventor('CONTACT:INSTAGRAM', instagramHandle);
                                footerDiv.appendChild(instagramBtn);
                            }
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'action-button message';
                            messageBtn.innerHTML = '<span class="button-icon">✉️</span> Message';
                            messageBtn.onclick = () => startChatWithUser(postUserId, contactData.username || 'User');
                            footerDiv.appendChild(messageBtn);
                        } else {
                            console.log("Contact details not found for user:", postUserId);
                            const msgBtn = document.createElement('button');
                            msgBtn.className = 'action-button message';
                            msgBtn.textContent = 'User Not Found';
                            footerDiv.appendChild(msgBtn);
                        }
                    }).catch(err => console.error("Error fetching contact details:", err));
                }

                postDiv.appendChild(footerDiv);
                postsListDiv.appendChild(postDiv);
            });
        }

        // --- Like Post Functionality ---
        async function toggleLike(postId, buttonElement) {
            if (!currentUserId) {
                alert('Please sign in to like posts!');
                return;
            }
            const postRef = db.collection('posts').doc(postId);
            try {
                await db.runTransaction(async (transaction) => {
                    const postDoc = await transaction.get(postRef);
                    if (!postDoc.exists) {
                        throw "Post does not exist!";
                    }
                    let likes = postDoc.data().likes || [];
                    const likeCountSpan = document.getElementById(`like-count-${postId}`);

                    if (likes.includes(currentUserId)) {
                        likes = likes.filter(uid => uid !== currentUserId);
                        buttonElement.classList.remove('liked');
                    } else {
                        likes.push(currentUserId);
                        buttonElement.classList.add('liked');
                    }
                    transaction.update(postRef, { likes: likes });
                    if (likeCountSpan) {
                         likeCountSpan.textContent = likes.length;
                    }
                });
            } catch (error) {
                console.error("Error toggling like:", error);
                alert("Failed to like/unlike post: " + error.message);
            }
        }


        // --- Speech Synthesis (Text-to-Speech) ---
        function toggleSpeech(button, text) {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    document.querySelectorAll('.sound-button.playing').forEach(btn => btn.classList.remove('playing'));
                    if (currentSpeakingUtterance && currentSpeakingUtterance.text === text) {
                        currentSpeakingUtterance = null;
                        return;
                    }
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;

                utterance.onstart = () => {
                    button.classList.add('playing');
                    currentSpeakingUtterance = utterance;
                };
                utterance.onend = () => {
                    button.classList.remove('playing');
                    currentSpeakingUtterance = null;
                };
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    alert('Text-to-speech failed: ' + event.error);
                    button.classList.remove('playing');
                    currentSpeakingUtterance = null;
                };

                speechSynthesis.speak(utterance);
            } else {
                alert('Your device/browser does not support text-to-speech.');
            }
        }


        async function deletePost(postId) {
            try {
                const postDoc = await db.collection('posts').doc(postId).get();
                if (postDoc.exists && postDoc.data().imageUrl) {
                    const imageUrl = postDoc.data().imageUrl;
                    // Note: If you used a simple placeholder image for profile,
                    // ensure you're not trying to delete Firebase Storage hosted images.
                    // This assumes imageUrl points to a Firebase Storage path.
                    if (imageUrl.includes('firebasestorage.googleapis.com')) {
                        const imageRef = storage.refFromURL(imageUrl);
                        await imageRef.delete();
                        console.log("Image deleted from storage:", imageUrl);
                    }
                }

                await db.collection('posts').doc(postId).delete();
                alert('Post deleted successfully!');
                fetchPosts();
                fetchUserProfile(currentUserId);
            } catch (error) {
                console.error("Error deleting post:", error);
                alert('Failed to delete post: ' + error.message);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- New Post Creation Logic ---
        const newPostForm = document.getElementById('new-post-form');
        const postImageUploadInput = document.getElementById('postImageUpload');
        const uploadStatusText = document.getElementById('upload-status');
        const contactValidationMessage = document.getElementById('contact-validation-message');
        const postContentInput = document.getElementById('postContent');

        postContentInput.addEventListener('input', () => {
            const currentLength = postContentInput.value.length;
            const minLength = parseInt(postContentInput.minLength);
            const maxLength = parseInt(postContentInput.maxLength);
            
            if (currentLength < minLength || currentLength > maxLength) {
                postContentInput.style.borderColor = 'var(--danger-color)';
                postContentInput.style.boxShadow = '0 0 5px rgba(255, 23, 68, 0.3)';
            } else {
                postContentInput.style.borderColor = 'var(--border-color)';
                postContentInput.style.boxShadow = 'none';
            }
        });

        function updateAdCountDisplay() {
            adCountDisplay.textContent = `Ads watched for this post: ${adsWatchedForCurrentPost}`;
        }

        function requestAdForPostExpiry(adNumber) {
            if (adsWatchedForCurrentPost >= adNumber) {
                alert(`You have already watched ${adNumber} ads for this post. Cannot watch more for this post creation.`);
                return;
            }
            sendCommandToAppInventor('SHOW_AD_POST_EXPIRY', adNumber);
        }

        window.adWatchedForPostExpiry = function(watchedAdNumber) {
            if (watchedAdNumber > adsWatchedForCurrentPost) {
                 adsWatchedForCurrentPost = watchedAdNumber;
                 updateAdCountDisplay();
                 alert(`Ad ${watchedAdNumber} watched! Post expiry extended.`);
            }
        };

        newPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postContent = document.getElementById('postContent').value.trim();
            const imageFile = postImageUploadInput.files[0];
            const postWhatsappNum = document.getElementById('postWhatsappNum').value.trim();
            const postInstagramHandle = document.getElementById('postInstagramHandle').value.trim();

            contactValidationMessage.style.display = 'none';

            const minLength = parseInt(postContentInput.minLength);
            const maxLength = parseInt(postContentInput.maxLength);
            if (postContent.length < minLength || postContent.length > maxLength) {
                alert(`Post content must be between ${minLength} and ${maxLength} characters.`);
                return;
            }

            if (!postContent) {
                alert('Post content cannot be empty!');
                return;
            }
            if (!currentUserId) {
                alert('Please sign in to post!');
                return;
            }
            if (!postWhatsappNum && !postInstagramHandle) {
                contactValidationMessage.style.display = 'block';
                return;
            }

            let imageUrl = '';
            if (imageFile) {
                uploadStatusText.style.display = 'block';
                uploadStatusText.textContent = 'Uploading image...';
                try {
                    const storageRef = storage.ref('post_images/' + currentUserId + '/' + Date.now() + '_' + imageFile.name);
                    const snapshot = await storageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                    uploadStatusText.textContent = 'Image uploaded!';
                } catch (error) {
                    console.error("Error uploading image:", error);
                    uploadStatusText.textContent = 'Image upload failed!';
                    alert('Image upload failed: ' + error.message);
                    return;
                } finally {
                    setTimeout(() => uploadStatusText.style.display = 'none', 3000);
                }
            }

            let expiryHours = BASE_EXPIRY_HOURS + (adsWatchedForCurrentPost * HOURS_PER_AD);
            if (expiryHours > 30) expiryHours = 30;
            const expiryTime = Date.now() + (expiryHours * 60 * 60 * 1000);

            try {
                const profileName = currentUserData.username || 'Anonymous User';
                // Use stored profilePicture from currentUserData if it exists, otherwise a simple placeholder
                const profilePicture = currentUserData.profilePicture || `https://via.placeholder.com/150/00e676/000000?text=${profileName.substring(0,1).toUpperCase()}`;


                await db.collection('posts').add({
                    userId: currentUserId,
                    profileName: profileName,
                    profilePicture: profilePicture,
                    postContent: postContent,
                    imageUrl: imageUrl,
                    whatsappNumber: postWhatsappNum,
                    instagramHandle: postInstagramHandle,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    expiryTime: expiryTime,
                    likes: []
                });
                alert('Post created successfully! It will expire in ' + expiryHours + ' hours.');
                newPostForm.reset();
                adsWatchedForCurrentPost = 0;
                updateAdCountDisplay();
                showSection('feed');
                fetchPosts();
                fetchUserProfile(currentUserId);
            } catch (error) {
                console.error("Error creating post:", error);
                alert('Failed to create post: ' + error.message);
            }
        });

        // --- User Profile Logic ---
        async function fetchUserProfile(uid) {
            if (!uid) { return; }
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    document.getElementById('profile-username').textContent = currentUserData.username || 'N/A';
                    document.getElementById('profile-email').textContent = auth.currentUser ? auth.currentUser.email : 'N/A';
                    document.getElementById('stat-coins').textContent = currentUserData.coins || 0;
                    document.getElementById('stat-credits').textContent = currentUserData.credits || 0;
                    document.getElementById('whatsappNumInput').value = currentUserData.whatsappNumber || '';
                    document.getElementById('instagramHandleInput').value = currentUserData.instagramHandle || '';

                    updateHeaderStats();

                    const userPostsSnapshot = await db.collection('posts').where('userId', '==', uid).get();
                    let activeUserPosts = 0;
                    userPostsSnapshot.forEach(doc => {
                        const postData = doc.data();
                        if (!postData.expiryTime || postData.expiryTime >= Date.now()) {
                            activeUserPosts++;
                        }
                    });
                    document.getElementById('stat-posts').textContent = activeUserPosts;
                } else {
                    console.warn("User profile not found in Firestore. Showing setup.");
                    showSection('setup-profile');
                    document.getElementById('profile-setup-status').textContent = 'Your profile needs to be set up.';
                    if (auth.currentUser && auth.currentUser.displayName) {
                        document.getElementById('newUsername').value = auth.currentUser.displayName;
                    }
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                document.getElementById('profile-details').innerHTML = '<p class="empty-state error-message"><span class="empty-icon">❌</span>Error loading profile: ' + error.message + '</p>';
            }
        }

        async function updateProfile() {
            if (!currentUserId) {
                alert('Please sign in to update profile!');
                return;
            }
            const whatsappNum = document.getElementById('whatsappNumInput').value.trim();
            const instagramHandle = document.getElementById('instagramHandleInput').value.trim();

            try {
                await db.collection('users').doc(currentUserId).update({
                    whatsappNumber: whatsappNum,
                    instagramHandle: instagramHandle
                });
                alert('Profile updated successfully!');
                fetchUserProfile(currentUserId);
            } catch (error) {
                console.error("Error updating profile:", error);
                alert('Failed to update profile: ' + error.message);
            }
        }

        // --- Messaging Logic ---
        let chatUnsubscribe = null;

        async function startChatWithUser(targetUserId, targetUsername) {
            if (!currentUserId) {
                alert('Please sign in to start a chat!');
                return;
            }
            if (currentUserId === targetUserId) {
                alert("You cannot chat with yourself.");
                return;
            }

            showSection('messages');
            currentChatUser = { id: targetUserId, username: targetUsername };
            currentChatStatus.textContent = `Chatting with: ${targetUsername}`;
            messagesListDiv.innerHTML = '<p class="empty-state"><div class="spinner"></div> Loading messages...</p>';
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;

            if (chatUnsubscribe) {
                chatUnsubscribe();
            }

            const chatPath = [currentUserId, targetUserId].sort().join('_');

            const chatDocRef = db.collection('chats').doc(chatPath);
            const chatDoc = await chatDocRef.get();
            if (!chatDoc.exists) {
                await chatDocRef.set({
                    userId1: [currentUserId, targetUserId].sort()[0],
                    userId2: [currentUserId, targetUserId].sort()[1],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            chatUnsubscribe = chatDocRef.collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    messagesListDiv.innerHTML = '';
                    if (snapshot.empty) {
                        messagesListDiv.innerHTML = '<p class="empty-state">No messages yet. Send your first message!</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            const messageDiv = document.createElement('div');
                            messageDiv.classList.add('message-item');
                            messageDiv.classList.add(msg.senderId === currentUserId ? 'from-me' : 'from-other');
                            messageDiv.innerHTML = `
                                <div class="message-sender">${msg.senderId === currentUserId ? 'You' : msg.senderName}:</div>
                                <div class="message-content">${msg.content}</div>
                                <div class="message-time">${msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleString() : 'N/A'}</div>
                            `;
                            messagesListDiv.appendChild(messageDiv);
                        });
                        messagesListDiv.scrollTop = messagesListDiv.scrollHeight;
                    }
                }, error => {
                    console.error("Error fetching chat messages:", error);
                    messagesListDiv.innerHTML = '<p class="empty-state error-message">Error loading chat: ' + error.message + '</p>';
                });
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const messageContent = messageInput.value.trim();
            if (!messageContent || !currentChatUser) {
                return;
            }

            const chatPath = [currentUserId, currentChatUser.id].sort().join('_');
            
            try {
                await db.collection('chats').doc(chatPath).collection('messages').add({
                    senderId: currentUserId,
                    senderName: currentUserData.username,
                    receiverId: currentChatUser.id,
                    receiverName: currentChatUser.username,
                    content: messageContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('chats').doc(chatPath).update({
                    lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                alert('Failed to send message: ' + error.message);
            }
        }


        // --- Search User Logic ---
        const userSearchInput = document.getElementById('userSearchInput');
        const searchResultsDiv = document.getElementById('searchResults');
        let searchTimeout;

        userSearchInput.addEventListener('keyup', () => {
            clearTimeout(searchTimeout);
            const query = userSearchInput.value.trim();
            if (query.length > 1) {
                searchTimeout = setTimeout(() => searchUsers(query), 300);
            } else {
                searchResultsDiv.style.display = 'none';
                searchResultsDiv.innerHTML = '';
            }
        });

        document.addEventListener('click', (event) => {
            if (!userSearchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                searchResultsDiv.style.display = 'none';
            }
        });

        async function searchUsers(query) {
            searchResultsDiv.innerHTML = '<p class="empty-state" style="padding:10px; font-size:0.9em;">Searching...</p>';
            searchResultsDiv.style.display = 'block';
            try {
                const snapshot = await db.collection('users')
                                        .where('username', '>=', query)
                                        .where('username', '<=', query + '\uf8ff')
                                        .limit(5)
                                        .get();
                
                if (snapshot.empty) {
                    searchResultsDiv.innerHTML = '<p class="empty-state" style="padding:10px; font-size:0.9em;">No users found.</p>';
                    return;
                }

                searchResultsDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (doc.id === currentUserId) return;

                    const userResultDiv = document.createElement('div');
                    userResultDiv.innerHTML = `
                        <div class="profile-pic-placeholder">${userData.username.substring(0,1).toUpperCase()}</div>
                        <p>${userData.username}</p>
                    `;
                    userResultDiv.onclick = () => {
                        startChatWithUser(doc.id, userData.username);
                        searchResultsDiv.style.display = 'none';
                        userSearchInput.value = '';
                    };
                    searchResultsDiv.appendChild(userResultDiv);
                });

            } catch (error) {
                console.error("Error searching users:", error);
                searchResultsDiv.innerHTML = '<p class="empty-state error-message" style="padding:10px; font-size:0.9em;">Search error.</p>';
            }
        }


        // --- Communication with App Inventor ---
        function sendCommandToAppInventor(command, data = '') {
            if (window.AppInventor) {
                window.AppInventor.setWebViewString(command + ':' + data);
            } else {
                console.warn("App Inventor interface not found. Cannot send command:", command, data);
            }
        }

        window.updateCoins = function(amount) {
            if (currentUserId) {
                db.collection('users').doc(currentUserId).update({
                    coins: firebase.firestore.FieldValue.increment(amount)
                }).then(() => {
                    currentUserData.coins += amount;
                    updateHeaderStats();
                    alert(`+${amount} Coins!`);
                }).catch(err => console.error("Error updating coins:", err));
            } else {
                alert("Please log in to earn coins!");
            }
        };

        window.updateCredits = function(amount) {
            if (currentUserId) {
                db.collection('users').doc(currentUserId).update({
                    credits: firebase.firestore.FieldValue.increment(amount)
                }).then(() => {
                    currentUserData.credits += amount;
                    updateHeaderStats();
                    alert(`+${amount} Credits!`);
                }).catch(err => console.error("Error updating credits:", err));
            } else {
                alert("Please log in to earn credits!");
            }
        };

        function requestAd(type) {
             sendCommandToAppInventor('SHOW_AD', type);
        }
        window.adWatched = function(adType) {
            if (adType === 'coins') {
                window.updateCoins(5);
            } else if (adType === 'credits') {
                window.updateCredits(1);
            }
        };


        // --- Scroll to Top Button Logic ---
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const appContainerScroll = document.getElementById('app-container');

        appContainerScroll.addEventListener('scroll', () => {
            if (appContainerScroll.scrollTop > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });

        scrollTopBtn.addEventListener('click', () => {
            appContainerScroll.scrollTo({ top: 0, behavior: 'smooth' });
        });


        // --- Initial Load & Auth State Handling ---
        document.addEventListener('DOMContentLoaded', () => {
            // Hide preloader first, splash screen will be visible
            preloader.style.display = 'none';
            splashScreen.style.display = 'flex';

            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                // Allow some time for splash to fade before checking auth
                setTimeout(() => {
                    splashScreen.style.display = 'none';

                    // Firebase Auth State Listener
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            // **Handle Redirect Result for Google Sign-in**
                            firebase.auth().getRedirectResult().then(function(result) {
                                if (result.credential) {
                                    // Google Sign-in via Redirect successful!
                                    console.log("Google Sign-in via Redirect successful!", result.user);
                                    // This means `user` object is already correctly populated.
                                    // No need to set `currentUserId` again as it's set by onAuthStateChanged.
                                    // Just proceed with the normal flow.
                                }
                                // Whether it was a redirect result or normal login, check email verification.
                                if (user.emailVerified) {
                                    const userDoc = await db.collection('users').doc(currentUserId).get();
                                    if (!userDoc.exists || !userDoc.data().username) {
                                        showSection('setup-profile');
                                        if (user.displayName) {
                                            document.getElementById('newUsername').value = user.displayName;
                                        }
                                    } else {
                                        await fetchUserProfile(currentUserId);
                                        showMainAppUI();
                                    }
                                } else {
                                    showSection('email-verify');
                                    document.getElementById('verify-email-message').textContent = `Your email ${user.email} is not verified. Please check your inbox (and spam folder) for the verification link. After verifying, please sign in again.`;
                                }
                            }).catch(function(error) {
                                console.error("Error during redirect result or initial auth check:", error);
                                document.getElementById('auth-status-message').textContent = 'Authentication failed: ' + error.message;
                                showSection('signin-auth'); // Go to sign-in on error
                            });

                        } else {
                            // No user signed in, show sign-in screen.
                            showSection('signin-auth');
                        }
                    });

                }, 1000); // Wait for splash fade-out (1s) + a little buffer
            }, 2000); // Display splash for 2 seconds before fading
        });

    </script>
</body>
</html>
