 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Addmint - Connect & Share</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #1a1a2e; /* Dark background for neon */
            --card-background: #2a2a4a;
            --text-color: #f0f0f0;
            --neon-glow-color: #00ffff;
            --neon-red: #ff007f;
            --neon-green: #00ff7f;
            --border-radius: 12px;
            --header-height: 60px;
            --bottom-nav-height: 60px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1a1a2e, #0a0a1a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out;
            animation: fadeInOut 3s forwards; /* For fade in and then out */
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-logo {
            font-size: 3em;
            font-weight: bold;
            color: var(--neon-glow-color);
            text-shadow: 0 0 10px var(--neon-glow-color), 0 0 20px var(--neon-glow-color), 0 0 30px var(--neon-glow-color);
            animation: pulse 1.5s infinite alternate;
        }

        .splash-tagline {
            margin-top: 10px;
            font-size: 1.2em;
            color: var(--text-color);
            opacity: 0.8;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; pointer-events: none; }
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.9; }
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background-color: var(--card-background);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
        }

        .header-logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--neon-glow-color);
            text-shadow: 0 0 5px var(--neon-glow-color);
        }

        .header-icon {
            font-size: 1.5em;
            color: var(--text-color);
            margin-left: 20px;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .header-icon:hover {
            color: var(--neon-glow-color);
            transform: scale(1.1);
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            right: -280px; /* Hidden by default */
            width: 250px;
            height: 100%;
            background-color: var(--card-background);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            padding-top: var(--header-height);
            display: flex;
            flex-direction: column;
        }

        .side-menu.open {
            right: 0;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            color: var(--text-color);
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--neon-glow-color);
        }

        .menu-item i {
            margin-right: 15px;
            font-size: 1.3em;
        }

        .menu-item .toggle-switch {
            margin-left: auto;
        }

        /* Toggle switch for data saver */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--neon-green);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--neon-green);
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Main Content Area */
        .main-content {
            padding-top: var(--header-height); /* Space for fixed header */
            padding-bottom: var(--bottom-nav-height); /* Space for fixed bottom nav */
            overflow-y: auto;
            height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .page-content {
            display: none; /* Hide all pages by default */
            padding: 15px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Post Card */
        .post-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden; /* For neon effect */
            transition: transform 0.2s ease-out;
        }

        .post-card.neon-active {
            box-shadow: 0 0 15px var(--neon-glow-color), 0 0 30px var(--neon-glow-color);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .profile-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--primary-color); /* Default color for generated avatars */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            margin-right: 12px;
            overflow: hidden; /* For generated avatars */
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            border: 2px solid var(--neon-glow-color);
        }

        /* CSS for generated user logos (examples) */
        .avatar-pattern-1 { background: repeating-linear-gradient(45deg, #f06, #f06 10px, #3cf 10px, #3cf 20px); }
        .avatar-pattern-2 { background: radial-gradient(circle at top left, #ff0, #f0f); }
        /* Add more .avatar-pattern-N for 50 variations */

        .username {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--neon-glow-color);
            cursor: pointer;
        }

        .post-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .post-content a {
            color: var(--neon-green);
            text-decoration: underline;
            word-break: break-all;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .action-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-color);
            cursor: pointer;
            user-select: none; /* Prevent text selection on double click */
        }

        .action-item i {
            margin-right: 5px;
            font-size: 1.3em;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .like-button i.fa-heart.liked {
            color: var(--neon-red);
            transform: scale(1.2);
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .reaction-container {
            position: relative;
            display: inline-block;
        }

        .emoji-reaction-icons {
            display: none;
            position: absolute;
            bottom: 40px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-background);
            border-radius: 25px;
            padding: 5px 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            z-index: 10;
        }

        .emoji-reaction-icons span {
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }

        .emoji-summary {
            margin-top: 10px;
            display: flex;
            align-items: center;
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }

        .emoji-summary span {
            margin-right: 5px;
        }

        .emoji-summary .count {
            font-weight: bold;
            color: var(--neon-glow-color);
        }


        /* Horizontal Post Section (Example) */
        .horizontal-posts-section {
            margin: 20px 0;
            padding: 15px 0;
            background-color: #2a2a4a;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .horizontal-posts-section h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--neon-glow-color);
            text-shadow: 0 0 5px var(--neon-glow-color);
        }

        .horizontal-scroll-wrapper {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px; /* For scrollbar */
        }

        .horizontal-post-card {
            flex: 0 0 auto; /* Prevent shrinking */
            width: 200px; /* Fixed width for horizontal items */
            background-color: #3a3a5a;
            border-radius: var(--border-radius);
            margin: 0 10px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .horizontal-post-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .horizontal-post-card .username {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .horizontal-post-card .post-content {
            font-size: 0.8em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }

        /* Table Post Section (Example) */
        .table-posts-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a4a;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .table-posts-section h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--neon-glow-color);
            text-shadow: 0 0 5px var(--neon-glow-color);
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* 2-4 columns */
            gap: 15px;
        }

        .table-post-card {
            background-color: #3a3a5a;
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .table-post-card .username {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .table-post-card .post-content {
            font-size: 0.8em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Limit to 4 lines */
            -webkit-box-orient: vertical;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bottom-nav-height);
            background-color: var(--card-background);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.8em;
            padding: 5px;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 1.6em;
            margin-bottom: 3px;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .nav-item.active {
            color: var(--neon-glow-color);
        }

        .nav-item.active i {
            color: var(--neon-glow-color);
            transform: scale(1.1);
        }

        /* Custom SVG/CSS Icons (Example for Search, Upload, Message) */
        .icon-search, .icon-upload, .icon-message {
            width: 25px;
            height: 25px;
            display: inline-block;
            vertical-align: middle;
            position: relative;
        }

        .icon-search::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-radius: 50%;
        }
        .icon-search::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 8px;
            height: 2px;
            background-color: currentColor;
            transform: rotate(45deg);
            transform-origin: bottom right;
        }

        .icon-upload::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background-color: currentColor;
        }
        .icon-upload::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%) rotate(90deg);
            width: 10px;
            height: 2px;
            background-color: currentColor;
        }

        .icon-message::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 0;
            width: 25px;
            height: 15px;
            border: 2px solid currentColor;
            border-radius: 5px;
        }
        .icon-message::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 5px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid currentColor;
        }

        /* Forms & Buttons */
        .auth-container, .profile-edit-container, .post-upload-container, .message-send-container {
            max-width: 400px;
            margin: 30px auto;
            background-color: var(--card-background);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .auth-container h2, .profile-edit-container h2, .post-upload-container h2, .message-send-container h2 {
            color: var(--neon-glow-color);
            margin-bottom: 25px;
            text-shadow: 0 0 5px var(--neon-glow-color);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 0.9em;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background-color: #3a3a5a;
            color: var(--text-color);
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            border-color: var(--neon-glow-color);
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
            outline: none;
        }

        .input-feedback {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .input-feedback.valid { color: var(--neon-green); }
        .input-feedback.invalid { color: var(--neon-red); }

        button {
            background-color: var(--neon-glow-color);
            color: var(--background-color);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        button:hover {
            background-color: var(--neon-green);
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.7);
        }

        button:active {
            transform: translateY(0);
        }

        .link-text {
            color: var(--neon-glow-color);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 15px;
            display: inline-block;
            font-size: 0.9em;
        }

        /* Profile Page */
        .user-profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .user-profile-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px auto;
        }

        .user-profile-name {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--neon-glow-color);
            margin-bottom: 5px;
        }

        .user-profile-stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .stat-number {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--neon-green);
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .profile-action-button {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            background-color: var(--neon-glow-color);
            color: var(--background-color);
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .profile-action-button.follow { background-color: var(--neon-green); }
        .profile-action-button.following { background-color: var(--secondary-color); } /* Grey for following */

        .profile-social-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .social-button {
            background-color: transparent;
            border: 2px solid var(--neon-glow-color);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: var(--neon-glow-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .social-button:hover {
            background-color: var(--neon-glow-color);
            color: var(--background-color);
            transform: scale(1.1);
        }

        /* Search Page */
        .search-bar {
            margin-bottom: 20px;
            display: flex;
        }

        .search-bar input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .user-search-result {
            display: flex;
            align-items: center;
            background-color: #3a3a5a;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-search-result:hover {
            background-color: #4a4a6a;
        }

        .user-search-result .profile-avatar {
            width: 40px;
            height: 40px;
            font-size: 1em;
        }

        .user-search-info {
            flex-grow: 1;
            margin-left: 15px;
        }

        .user-search-info .username {
            font-size: 1.1em;
            color: var(--neon-glow-color);
        }

        .user-search-result .follow-button {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        /* Message Page (Thread List) */
        .message-thread-item {
            display: flex;
            align-items: center;
            background-color: #3a3a5a;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .message-thread-item:hover {
            background-color: #4a4a6a;
        }

        .message-thread-item .profile-avatar {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .thread-info {
            flex-grow: 1;
        }

        .thread-info .username {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--neon-glow-color);
        }

        .thread-info .last-message {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Message Chat View */
        .chat-view-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--card-background);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: var(--header-height);
            z-index: 50;
        }

        .chat-view-header .back-arrow {
            font-size: 1.5em;
            margin-right: 15px;
            cursor: pointer;
        }

        .chat-messages-container {
            padding: 15px;
            overflow-y: auto;
            max-height: calc(100vh - var(--header-height) - var(--bottom-nav-height) - 120px); /* Adjust based on chat header/input */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
        }

        .chat-message.sent {
            align-self: flex-end;
            background-color: var(--neon-glow-color);
            color: var(--background-color);
            border-bottom-right-radius: 0;
        }

        .chat-message.received {
            align-self: flex-start;
            background-color: #3a3a5a;
            color: var(--text-color);
            border-bottom-left-radius: 0;
        }

        .chat-input-area {
            display: flex;
            padding: 10px 15px;
            background-color: var(--card-background);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            bottom: var(--bottom-nav-height);
        }

        .chat-input-area input {
            flex-grow: 1;
            margin-right: 10px;
            border-radius: 25px;
            padding: 10px 15px;
            background-color: #4a4a6a;
            border: none;
            color: var(--text-color);
        }

        .chat-input-area button {
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            box-shadow: none; /* Override default button shadow */
        }

        /* Popup/Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 400px;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            color: var(--neon-glow-color);
            margin-bottom: 20px;
        }

        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-content button {
            margin: 0 10px;
        }

        .claim-reward-animation {
            font-size: 3em;
            animation: bounce 0.8s infinite alternate;
            color: var(--neon-green);
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        /* General Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }

        /* Scrollbar styles (for WebKit browsers) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-glow-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-green);
        }

    </style>
</head>
<body>

    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">Addmint</div>
        <div class="splash-tagline">Connect, Share, Discover.</div>
    </div>

    <div id="appContainer" class="hidden">
        <header class="header">
            <div class="header-left">
                <span class="header-logo">Addmint</span>
            </div>
            <div class="header-right">
                <i class="fas fa-gift header-icon" id="giftButton"></i>
                <i class="fas fa-sync-alt header-icon" id="refreshPostsButton" style="display: none;"></i> <i class="fas fa-ellipsis-v header-icon" id="menuButton"></i>
            </div>
        </header>

        <div class="side-menu" id="sideMenu">
            <div class="menu-item" id="dataSaverToggle">
                <i class="fas fa-leaf"></i> Data Saver
                <label class="switch toggle-switch">
                    <input type="checkbox" id="dataSaverCheckbox">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="menu-item" id="aboutApp">
                <i class="fas fa-info-circle"></i> About Addmint
            </div>
            <div class="menu-item" id="privacyPolicy">
                <i class="fas fa-file-alt"></i> Privacy Policy
            </div>
            <div class="menu-item" id="instagramLink">
                <i class="fab fa-instagram"></i> Addmint Instagram
            </div>
            <div class="menu-item" id="youtubeLink">
                <i class="fab fa-youtube"></i> Addmint YouTube
            </div>
        </div>

        <main class="main-content">
            <section id="homePage" class="page-content active">
                <div id="postsContainer">
                    <div class="horizontal-posts-section hidden" id="horizontalPostsSection">
                        <h3>Trending Stories</h3>
                        <div class="horizontal-scroll-wrapper" id="horizontalPostsWrapper">
                            </div>
                    </div>

                    <div class="table-posts-section hidden" id="tablePostsSection">
                        <h3>Curated Collections</h3>
                        <div class="table-grid" id="tablePostsGrid">
                            </div>
                    </div>

                </div>
            </section>

            <section id="searchPage" class="page-content">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search users, posts...">
                    <button id="searchButton">Search</button>
                </div>
                <div id="searchResults">
                    <p id="noSearchResults" class="text-center hidden">No results found.</p>
                </div>
            </section>

            <section id="uploadPage" class="page-content">
                <div class="post-upload-container">
                    <h2>Create New Post</h2>
                    <div class="input-group">
                        <label for="postContent">What's on your mind?</label>
                        <textarea id="postContent" rows="6" placeholder="Share your thoughts..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="postBoostHours">Boost Post For:</label>
                        <select id="postBoostHours">
                            <option value="12">12 Hours (Free)</option>
                            <option value="18">18 Hours (1 Ad)</option>
                            <option value="24">24 Hours (2 Ads)</option>
                            <option value="30">30 Hours (3 Ads)</option>
                        </select>
                    </div>
                    <button id="publishPostButton">Publish Post</button>
                    <p id="uploadMessage" class="mt-20"></p>
                </div>
            </section>

            <section id="messagesPage" class="page-content">
                <h2>Chats</h2>
                <div id="messageThreadsList">
                    </div>
                <div id="chatView" class="hidden">
                    <div class="chat-view-header">
                        <i class="fas fa-arrow-left back-arrow" id="backToThreads"></i>
                        <div class="profile-avatar user-profile-avatar" id="chatPartnerAvatar"></div>
                        <span class="username" id="chatPartnerUsername"></span>
                    </div>
                    <div class="chat-messages-container" id="chatMessagesContainer">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatMessageInput" placeholder="Type your message...">
                        <button id="sendMessageButton">Send</button>
                        <div class="reaction-container">
                            <i class="far fa-smile chat-emoji-button"></i>
                            <div class="emoji-reaction-icons chat-emoji-popup hidden">
                                <span>👍</span><span>❤️</span><span>😂</span><span>😮</span><span>😢</span><span>😡</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="profilePage" class="page-content">
                <div class="user-profile-header">
                    <div class="profile-avatar user-profile-avatar" id="profilePageAvatar"></div>
                    <h2 class="user-profile-name" id="profilePageName"></h2>
                    <p class="username" id="profilePageUsername"></p>
                    <div class="user-profile-stats">
                        <div class="stat-item" id="followersStat">
                            <span class="stat-number" id="followersCount">0</span>
                            <span>Followers</span>
                        </div>
                        <div class="stat-item" id="followingStat">
                            <span class="stat-number" id="followingCount">0</span>
                            <span>Following</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="profile-action-button follow" id="profileFollowButton">Follow</button>
                        <button class="profile-action-button" id="editProfileButton">Edit Profile</button>
                    </div>
                    <div class="profile-social-buttons">
                        <button class="social-button" id="profileWhatsAppButton"><i class="fab fa-whatsapp"></i></button>
                        <button class="social-button" id="profileInstagramButton"><i class="fab fa-instagram"></i></button>
                        <button class="social-button" id="profileMessageButton"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <h3>Posts by <span id="profilePostsUsername"></span></h3>
                <div id="profilePostsContainer">
                    <p id="noProfilePosts" class="text-center hidden">No posts yet.</p>
                </div>
            </section>

            <section id="authPage" class="page-content">
                <div class="auth-container">
                    <h2 id="authModeHeading">Sign In</h2>
                    <div class="input-group">
                        <label for="authEmail">Email</label>
                        <input type="email" id="authEmail" placeholder="your@example.com">
                    </div>
                    <div class="input-group">
                        <label for="authPassword">Password</label>
                        <input type="password" id="authPassword" placeholder="password">
                    </div>
                    <button id="authButton">Sign In</button>
                    <p class="link-text" id="toggleAuthMode">Don't have an account? Sign Up</p>
                    <p id="authError" style="color: var(--neon-red); margin-top: 10px;"></p>
                </div>
            </section>

            <section id="profileSetupPage" class="page-content">
                <div class="profile-edit-container">
                    <h2>Complete Your Profile</h2>
                    <p>Tell us a bit about yourself to get started!</p>
                    <div class="input-group">
                        <label for="setupName">Full Name</label>
                        <input type="text" id="setupName" placeholder="Your Name">
                    </div>
                    <div class="input-group">
                        <label for="setupUsername">Username <span id="usernameCheckFeedback" class="input-feedback"></span></label>
                        <input type="text" id="setupUsername" placeholder="Unique Username">
                    </div>
                    <div class="input-group">
                        <label for="setupWhatsApp">WhatsApp Number (Optional)</label>
                        <input type="tel" id="setupWhatsApp" placeholder="+1234567890">
                    </div>
                    <div class="input-group">
                        <label for="setupInstagram">Instagram Handle (Optional)</label>
                        <input type="text" id="setupInstagram" placeholder="@yourinstagram">
                    </div>
                    <button id="completeProfileButton">Complete Profile</button>
                    <p id="profileSetupError" style="color: var(--neon-red); margin-top: 10px;"></p>
                </div>
            </section>

             <section id="editProfilePage" class="page-content">
                <div class="profile-edit-container">
                    <h2>Edit Your Profile</h2>
                    <div class="input-group">
                        <label for="editName">Full Name</label>
                        <input type="text" id="editName">
                    </div>
                    <div class="input-group">
                        <label for="editUsername">Username <span id="editUsernameCheckFeedback" class="input-feedback"></span></label>
                        <input type="text" id="editUsername">
                    </div>
                    <div class="input-group">
                        <label for="editWhatsApp">WhatsApp Number</label>
                        <input type="tel" id="editWhatsApp">
                    </div>
                    <div class="input-group">
                        <label for="editInstagram">Instagram Handle</label>
                        <input type="text" id="editInstagram">
                    </div>
                    <button id="saveProfileButton">Save Changes</button>
                    <p id="editProfileMessage" style="color: var(--neon-red); margin-top: 10px;"></p>
                </div>
            </section>

        </main>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-page="homePage">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-page="searchPage">
                <i class="icon-search"></i>
                <span>Search</span>
            </a>
            <a href="#" class="nav-item" data-page="uploadPage">
                <i class="icon-upload"></i>
                <span>Upload</span>
            </a>
            <a href="#" class="nav-item" data-page="messagesPage">
                <i class="icon-message"></i>
                <span>Messages</span>
            </a>
            <a href="#" class="nav-item" data-page="profilePage">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>

        <div class="modal-overlay" id="rewardModal">
            <div class="modal-content">
                <h3 id="rewardModalTitle">Daily Reward!</h3>
                <p id="rewardModalMessage">Claim your daily rewards!</p>
                <i class="fas fa-gift claim-reward-animation"></i>
                <button id="claimRewardButton">Claim Now</button>
                <button id="closeRewardModalButton" class="hidden">Close</button>
            </div>
        </div>

        <div class="modal-overlay" id="adWatchModal">
            <div class="modal-content">
                <h3>Watch Ad for Rewards!</h3>
                <p>Watch a short advertisement to earn more coins/limits/credits.</p>
                <button id="startAdButton">Watch Ad (Simulated)</button>
                <button id="skipAdButton">No Thanks</button>
            </div>
        </div>

        <div class="modal-overlay" id="errorModal">
            <div class="modal-content">
                <h3 style="color: var(--neon-red);">Error!</h3>
                <p id="errorMessage"></p>
                <button id="closeErrorModal">OK</button>
            </div>
        </div>

        <div class="modal-overlay" id="infoModal">
            <div class="modal-content">
                <h3 id="infoModalTitle"></h3>
                <p id="infoModalContent"></p>
                <button id="closeInfoModal">Close</button>
            </div>
        </div>
    </div>


    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDlZA4grzF3fx95-11E4s7ASXwkIij1k1w",
  authDomain: "addmint-7ab6b.firebaseapp.com",
  databaseURL: "https://addmint-7ab6b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "addmint-7ab6b",
  storageBucket: "addmint-7ab6b.firebasestorage.app",
  messagingSenderId: "504015450137",
  appId: "1:504015450137:web:694b176313582cce1e7a88",
  measurementId: "G-H7J7M23Z82"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splashScreen');
        const appContainer = document.getElementById('appContainer');

        const header = document.querySelector('.header');
        const menuButton = document.getElementById('menuButton');
        const sideMenu = document.getElementById('sideMenu');
        const giftButton = document.getElementById('giftButton');
        const refreshPostsButton = document.getElementById('refreshPostsButton');

        const navItems = document.querySelectorAll('.nav-item');
        const pageContents = document.querySelectorAll('.page-content');

        // Auth Page
        const authPage = document.getElementById('authPage');
        const authModeHeading = document.getElementById('authModeHeading');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const authButton = document.getElementById('authButton');
        const toggleAuthModeLink = document.getElementById('toggleAuthMode');
        const authErrorDisplay = document.getElementById('authError');
        let isSignInMode = true;

        // Profile Setup Page
        const profileSetupPage = document.getElementById('profileSetupPage');
        const setupNameInput = document.getElementById('setupName');
        const setupUsernameInput = document.getElementById('setupUsername');
        const setupWhatsAppInput = document.getElementById('setupWhatsApp');
        const setupInstagramInput = document.getElementById('setupInstagram');
        const completeProfileButton = document.getElementById('completeProfileButton');
        const profileSetupErrorDisplay = document.getElementById('profileSetupError');
        const usernameCheckFeedback = document.getElementById('usernameCheckFeedback');

        // Edit Profile Page
        const editProfilePage = document.getElementById('editProfilePage');
        const editNameInput = document.getElementById('editName');
        const editUsernameInput = document.getElementById('editUsername');
        const editWhatsAppInput = document.getElementById('editWhatsApp');
        const editInstagramInput = document.getElementById('editInstagram');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const editProfileMessage = document.getElementById('editProfileMessage');
        const editUsernameCheckFeedback = document.getElementById('editUsernameCheckFeedback');

        // Home Page
        const postsContainer = document.getElementById('postsContainer');
        const horizontalPostsSection = document.getElementById('horizontalPostsSection');
        const horizontalPostsWrapper = document.getElementById('horizontalPostsWrapper');
        const tablePostsSection = document.getElementById('tablePostsSection');
        const tablePostsGrid = document.getElementById('tablePostsGrid');

        // Post Upload Page
        const postContentInput = document.getElementById('postContent');
        const postBoostHoursSelect = document.getElementById('postBoostHours');
        const publishPostButton = document.getElementById('publishPostButton');
        const uploadMessageDisplay = document.getElementById('uploadMessage');

        // Search Page
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const noSearchResultsText = document.getElementById('noSearchResults');

        // Messages Page
        const messagesPage = document.getElementById('messagesPage');
        const messageThreadsList = document.getElementById('messageThreadsList');
        const chatView = document.getElementById('chatView');
        const backToThreadsButton = document.getElementById('backToThreads');
        const chatPartnerAvatar = document.getElementById('chatPartnerAvatar');
        const chatPartnerUsername = document.getElementById('chatPartnerUsername');
        const chatMessagesContainer = document.getElementById('chatMessagesContainer');
        const chatMessageInput = document.getElementById('chatMessageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const chatEmojiButton = document.querySelector('.chat-emoji-button');
        const chatEmojiPopup = document.querySelector('.chat-emoji-popup');

        // Profile Page (Other User's Profile & Current User's Profile)
        const profilePage = document.getElementById('profilePage');
        const profilePageAvatar = document.getElementById('profilePageAvatar');
        const profilePageName = document.getElementById('profilePageName');
        const profilePageUsername = document.getElementById('profilePageUsername');
        const followersCountSpan = document.getElementById('followersCount');
        const followingCountSpan = document.getElementById('followingCount');
        const profileFollowButton = document.getElementById('profileFollowButton');
        const editProfileButton = document.getElementById('editProfileButton');
        const profileWhatsAppButton = document.getElementById('profileWhatsAppButton');
        const profileInstagramButton = document.getElementById('profileInstagramButton');
        const profileMessageButton = document.getElementById('profileMessageButton');
        const profilePostsUsername = document.getElementById('profilePostsUsername');
        const profilePostsContainer = document.getElementById('profilePostsContainer');
        const noProfilePostsText = document.getElementById('noProfilePosts');

        // Modals
        const rewardModal = document.getElementById('rewardModal');
        const rewardModalTitle = document.getElementById('rewardModalTitle');
        const rewardModalMessage = document.getElementById('rewardModalMessage');
        const claimRewardButton = document.getElementById('claimRewardButton');
        const closeRewardModalButton = document.getElementById('closeRewardModalButton');

        const adWatchModal = document.getElementById('adWatchModal');
        const startAdButton = document.getElementById('startAdButton');
        const skipAdButton = document.getElementById('skipAdButton');

        const errorModal = document.getElementById('errorModal');
        const errorMessageDisplay = document.getElementById('errorMessage');
        const closeErrorModalButton = document.getElementById('closeErrorModal');

        const infoModal = document.getElementById('infoModal');
        const infoModalTitle = document.getElementById('infoModalTitle');
        const infoModalContent = document.getElementById('infoModalContent');
        const closeInfoModalButton = document.getElementById('closeInfoModal');


        // --- Global State Variables ---
        let currentUser = null;
        let lastVisiblePost = null; // For infinite scrolling
        let fetchingPosts = false;
        let currentNeonPost = null; // To track which post is currently neon
        let profileVisitUserId = null; // To track which user's profile is being viewed
        let currentChatPartnerId = null;

        const POSTS_PER_LOAD = 5; // Number of posts to load at once
        const USER_AVATAR_COLORS = [
            '#FF6347', '#4682B4', '#32CD32', '#FFD700', '#DA70D6', '#8A2BE2', '#00CED1', '#FF4500', '#ADFF2F', '#9370DB',
            '#F08080', '#20B2AA', '#87CEEB', '#FF69B4', '#BA55D3', '#7B68EE', '#F4A460', '#BDB76B', '#5F9EA0', '#FF7F50',
            '#6A5ACD', '#D2B48C', '#ADD8E6', '#F0E68C', '#EE82EE', '#90EE90', '#FFB6C1', '#00FA9A', '#808000', '#6495ED',
            '#DC143C', '#2F4F4F', '#483D8B', '#008B8B', '#B0C4DE', '#F5DEB3', '#9ACD32', '#FFA07A', '#4169E1', '#8B008B',
            '#A0522D', '#DDA0DD', '#7FFFD4', '#CD5C5C', '#8B4513', '#66CDAA', '#DEB887', '#9932CC', '#F0F8FF', '#A52A2A'
        ]; // 50 distinct colors

        // --- Helper Functions ---

        function showPage(pageId) {
            pageContents.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Show/hide refresh button based on page
            if (pageId === 'homePage') {
                refreshPostsButton.style.display = 'block';
            } else {
                refreshPostsButton.style.display = 'none';
            }

            // Handle specific page behaviors
            if (pageId === 'messagesPage') {
                loadMessageThreads();
                chatView.classList.add('hidden'); // Ensure chat view is hidden initially
                messageThreadsList.classList.remove('hidden');
            } else if (pageId === 'profilePage' && currentUser) {
                displayUserProfile(currentUser.uid); // Show current user's profile by default
            } else if (pageId === 'searchPage') {
                searchResultsDiv.innerHTML = ''; // Clear search results on page switch
                noSearchResultsText.classList.add('hidden');
            }
        }

        function generateAvatar(username) {
            if (!username) return 'UN'; // Default if no username
            const initial = username.charAt(0).toUpperCase();
            const colorIndex = username.charCodeAt(0) % USER_AVATAR_COLORS.length;
            const bgColor = USER_AVATAR_COLORS[colorIndex];
            const className = `avatar-pattern-${(username.length % 10) + 1}`; // Simple pattern variation

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `profile-avatar ${className}`;
            avatarDiv.style.backgroundColor = bgColor;
            avatarDiv.textContent = initial;
            return avatarDiv.outerHTML;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num;
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showErrorMessage(message) {
            errorMessageDisplay.textContent = message;
            showModal('errorModal');
        }

        function showInfoMessage(title, message) {
            infoModalTitle.textContent = title;
            infoModalContent.textContent = message;
            showModal('infoModal');
        }

        function applyNeonEffect(postId) {
            // Remove neon from previously active post
            if (currentNeonPost && currentNeonPost !== postId) {
                const prevPostCard = document.querySelector(`.post-card[data-post-id="${currentNeonPost}"]`);
                if (prevPostCard) {
                    prevPostCard.classList.remove('neon-active');
                }
            }

            const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
            if (postCard) {
                postCard.classList.add('neon-active');
                currentNeonPost = postId;

                // Remove neon after 3-4 seconds
                setTimeout(() => {
                    if (currentNeonPost === postId) { // Ensure it's still the same post
                        postCard.classList.remove('neon-active');
                        currentNeonPost = null;
                    }
                }, 3500); // 3.5 seconds
            }
        }

        function parseAndHighlightUrls(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, (url) => {
                let displayUrl = url;
                if (displayUrl.length > 50) { // Truncate long URLs for display
                    displayUrl = displayUrl.substring(0, 47) + '...';
                }
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${displayUrl}</a>`;
            });
        }


        // --- Authentication Logic ---

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().username) {
                    appContainer.classList.remove('hidden');
                    splashScreen.classList.add('hidden');
                    showPage('homePage');
                    loadPosts(); // Load posts after user is logged in
                    checkAndShowDailyReward();
                } else {
                    // User signed up but profile not completed
                    showPage('profileSetupPage');
                    appContainer.classList.remove('hidden');
                    splashScreen.classList.add('hidden');
                }
            } else {
                currentUser = null;
                showPage('authPage');
                appContainer.classList.remove('hidden');
                splashScreen.classList.add('hidden');
            }
        });

        toggleAuthModeLink.addEventListener('click', () => {
            isSignInMode = !isSignInMode;
            authModeHeading.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            authButton.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            toggleAuthModeLink.textContent = isSignInMode ? "Don't have an account? Sign Up" : "Already have an account? Sign In";
            authErrorDisplay.textContent = ''; // Clear previous errors
        });

        authButton.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authErrorDisplay.textContent = '';

            if (!email || !password) {
                authErrorDisplay.textContent = 'Please enter email and password.';
                return;
            }

            try {
                if (isSignInMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                    // User will be redirected to profile setup via onAuthStateChanged
                }
            } catch (error) {
                console.error("Auth error:", error.code, error.message);
                authErrorDisplay.textContent = `Error: ${error.message}`;
            }
        });

        // --- Profile Setup Logic ---
        setupUsernameInput.addEventListener('input', async () => {
            const username = setupUsernameInput.value.trim();
            if (username.length > 0) {
                const usernameExists = await checkIfUsernameExists(username);
                if (usernameExists) {
                    usernameCheckFeedback.classList.remove('valid');
                    usernameCheckFeedback.classList.add('invalid');
                    usernameCheckFeedback.innerHTML = '<i class="fas fa-times-circle"></i> Not available';
                } else {
                    usernameCheckFeedback.classList.remove('invalid');
                    usernameCheckFeedback.classList.add('valid');
                    usernameCheckFeedback.innerHTML = '<i class="fas fa-check-circle"></i> Available';
                }
            } else {
                usernameCheckFeedback.innerHTML = '';
            }
        });

        async function checkIfUsernameExists(username) {
            const snapshot = await db.collection('users').where('username', '==', username).get();
            return !snapshot.empty;
        }

        completeProfileButton.addEventListener('click', async () => {
            if (!currentUser) {
                showErrorMessage("No user logged in. Please sign in again.");
                return;
            }

            const name = setupNameInput.value.trim();
            const username = setupUsernameInput.value.trim();
            const whatsapp = setupWhatsAppInput.value.trim();
            const instagram = setupInstagramInput.value.trim();
            profileSetupErrorDisplay.textContent = '';

            if (!name || !username || (!whatsapp && !instagram)) {
                profileSetupErrorDisplay.textContent = 'Full Name, Unique Username, and at least one social media link (WhatsApp or Instagram) are required.';
                return;
            }

            const usernameExists = await checkIfUsernameExists(username);
            if (usernameExists) {
                profileSetupErrorDisplay.textContent = 'This username is already taken. Please choose another.';
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid).set({
                    name: name,
                    username: username,
                    email: currentUser.email,
                    whatsapp: whatsapp,
                    instagram: instagram,
                    followers: 0,
                    following: 0,
                    avatarIndex: Math.floor(Math.random() * USER_AVATAR_COLORS.length), // Assign a random avatar color index
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge to update if user doc already exists

                // Initialize user's daily rewards document
                await db.collection('userRewards').doc(currentUser.uid).set({
                    lastClaimed: null, // Unix timestamp or Firestore timestamp
                    limit: 1,
                    coins: 10,
                    credit: 10,
                    lastPostUploadTime: null
                }, { merge: true });

                showPage('homePage'); // Redirect to home page after setup
                loadPosts();
                checkAndShowDailyReward();

            } catch (error) {
                console.error("Profile setup error:", error);
                profileSetupErrorDisplay.textContent = `Error: ${error.message}`;
            }
        });

        // --- Post Loading & Display Logic ---
        function createPostElement(postData, postId) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.dataset.postId = postId;

            const avatarHTML = generateAvatar(postData.username);
            const contentWithLinks = parseAndHighlightUrls(postData.content || '');

            postCard.innerHTML = `
                <div class="post-header">
                    ${avatarHTML}
                    <span class="username" data-user-id="${postData.userId}">${postData.username}</span>
                </div>
                <div class="post-content">
                    ${contentWithLinks}
                </div>
                <div class="post-actions">
                    <div class="action-item like-button" data-post-id="${postId}">
                        <i class="far fa-heart"></i>
                        <span class="like-count">${formatNumber(postData.likes || 0)}</span>
                    </div>
                    <div class="action-item view-count">
                        <i class="fas fa-eye"></i>
                        <span class="views">${formatNumber(postData.views || 0)}</span>
                    </div>
                    <div class="action-item reaction-container">
                        <i class="far fa-smile"></i>
                        <div class="emoji-reaction-icons hidden">
                            <span>👍</span><span>❤️</span><span>😂</span><span>😮</span><span>😢</span><span>😡</span>
                        </div>
                    </div>
                </div>
                <div class="emoji-summary" data-post-id="${postId}">
                    </div>
            `;

            // Add event listeners for like, long-press, username click
            const likeButton = postCard.querySelector('.like-button');
            likeButton.addEventListener('dblclick', (event) => { // Double-click for like
                event.stopPropagation(); // Prevent long-press on double click
                toggleLike(postId, postCard.querySelector('.like-count'));
            });

            const reactionContainer = postCard.querySelector('.reaction-container');
            const emojiIcons = reactionContainer.querySelector('.emoji-reaction-icons');
            let longPressTimer;

            reactionContainer.addEventListener('mousedown', (e) => {
                longPressTimer = setTimeout(() => {
                    emojiIcons.classList.remove('hidden');
                }, 500); // 0.5 seconds for long press
            });
            reactionContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            reactionContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));

            // For mobile touch events
            reactionContainer.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    emojiIcons.classList.remove('hidden');
                }, 500);
            }, { passive: true });
            reactionContainer.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
                setTimeout(() => emojiIcons.classList.add('hidden'), 3000); // Hide after 3 seconds
            });
            reactionContainer.addEventListener('touchcancel', () => clearTimeout(longPressTimer));

            emojiIcons.querySelectorAll('span').forEach(emojiSpan => {
                emojiSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sendEmojiReaction(postId, e.target.textContent);
                    emojiIcons.classList.add('hidden'); // Hide after selection
                });
            });

            // Click on post itself for neon effect
            postCard.addEventListener('click', (e) => {
                // Check if click was on a link or action item
                if (e.target.tagName === 'A' || e.target.closest('.action-item') || e.target.closest('.username')) {
                    return; // Don't trigger neon for internal links/buttons
                }
                applyNeonEffect(postId);
            });

            // Username click
            const usernameSpan = postCard.querySelector('.username');
            usernameSpan.addEventListener('click', () => {
                displayUserProfile(postData.userId);
                showPage('profilePage');
            });

            // Update like state if current user has liked
            db.collection('posts').doc(postId).collection('likes').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    likeButton.querySelector('i').classList.add('liked');
                    likeButton.querySelector('i').classList.remove('far');
                    likeButton.querySelector('i').classList.add('fas');
                }
            });

            // Update emoji reactions
            updateEmojiSummary(postId, postCard.querySelector('.emoji-summary'));

            return postCard;
        }

        async function loadPosts(append = true, isRefresh = false) {
            if (fetchingPosts && !isRefresh) return;
            fetchingPosts = true;

            if (!append) {
                postsContainer.innerHTML = ''; // Clear existing posts if not appending
                lastVisiblePost = null;
            }

            let query = db.collection('posts')
                .orderBy('createdAt', 'desc')
                .limit(POSTS_PER_LOAD);

            if (lastVisiblePost && !isRefresh) {
                query = query.startAfter(lastVisiblePost);
            }

            try {
                const snapshot = await query.get();
                if (snapshot.empty && !isRefresh) {
                    console.log("No more posts to load.");
                    fetchingPosts = false;
                    return;
                }

                if (isRefresh) {
                    postsContainer.innerHTML = ''; // Clear for full refresh
                    horizontalPostsWrapper.innerHTML = '';
                    tablePostsGrid.innerHTML = '';
                    horizontalPostsSection.classList.add('hidden');
                    tablePostsSection.classList.add('hidden');
                }


                const postElements = [];
                snapshot.forEach(doc => {
                    const postData = doc.data();
                    const postId = doc.id;
                    postElements.push({ id: postId, data: postData, element: createPostElement(postData, postId) });

                    // Increment view count for the current user
                    incrementViewCount(postId);
                });

                // Implement random and repeating posts, and mixed layouts
                // This is a simplified approach. A true "never-ending" feed with
                // controlled duplicates and random ordering would need a much
                // more sophisticated backend and client-side logic.
                const allFetchedPosts = [...postElements];
                if (allFetchedPosts.length > 0) {
                    const displayOrder = [];
                    // Simulate random and repeating posts
                    for (let i = 0; i < 20; i++) { // Generate 20 "slots"
                        displayOrder.push(allFetchedPosts[Math.floor(Math.random() * allFetchedPosts.length)]);
                    }

                    postsContainer.innerHTML = ''; // Clear for new mixed display

                    let verticalCount = 0;
                    for (const item of displayOrder) {
                        if (!item) continue; // Skip if undefined from random pick

                        // Add vertical posts
                        postsContainer.appendChild(item.element);
                        verticalCount++;

                        // Insert horizontal or table sections intermittently
                        if (verticalCount >= 5 && verticalCount % 5 === 0) { // After every 5 vertical posts
                            if (Math.random() < 0.5) { // 50% chance for horizontal
                                // Simulate horizontal posts by picking random ones
                                horizontalPostsSection.classList.remove('hidden');
                                horizontalPostsWrapper.innerHTML = '';
                                for(let i = 0; i < 4; i++) { // 4 horizontal posts
                                    const randomPost = allFetchedPosts[Math.floor(Math.random() * allFetchedPosts.length)];
                                    if(randomPost) {
                                        const horizontalCard = document.createElement('div');
                                        horizontalCard.className = 'horizontal-post-card';
                                        horizontalCard.innerHTML = `
                                            ${generateAvatar(randomPost.data.username)}
                                            <span class="username">${randomPost.data.username}</span>
                                            <div class="post-content">${parseAndHighlightUrls(randomPost.data.content.substring(0, 100) + '...')}</div>
                                        `;
                                        // Add click listener for horizontal post too
                                        horizontalCard.addEventListener('click', () => {
                                            applyNeonEffect(randomPost.id);
                                            // You might want to open the full post view here
                                        });
                                        horizontalPostsWrapper.appendChild(horizontalCard);
                                    }
                                }
                            } else { // 50% chance for table
                                tablePostsSection.classList.remove('hidden');
                                tablePostsGrid.innerHTML = '';
                                for(let i = 0; i < 6; i++) { // 6 table posts
                                    const randomPost = allFetchedPosts[Math.floor(Math.random() * allFetchedPosts.length)];
                                    if(randomPost) {
                                        const tableCard = document.createElement('div');
                                        tableCard.className = 'table-post-card';
                                        tableCard.innerHTML = `
                                            ${generateAvatar(randomPost.data.username)}
                                            <span class="username">${randomPost.data.username}</span>
                                            <div class="post-content">${parseAndHighlightUrls(randomPost.data.content.substring(0, 80) + '...')}</div>
                                        `;
                                        tableCard.addEventListener('click', () => {
                                            applyNeonEffect(randomPost.id);
                                            // Open full post view
                                        });
                                        tablePostsGrid.appendChild(tableCard);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    postsContainer.innerHTML = '<p class="text-center">No posts available. Be the first to post!</p>';
                }


                if (!snapshot.empty) {
                    lastVisiblePost = snapshot.docs[snapshot.docs.length - 1];
                }
                fetchingPosts = false;

            } catch (error) {
                console.error("Error loading posts:", error);
                showErrorMessage(`Error loading posts: ${error.message}`);
                fetchingPosts = false;
            }
        }

        async function incrementViewCount(postId) {
            if (!currentUser) return; // Only count views for logged-in users

            const viewRef = db.collection('posts').doc(postId).collection('views').doc(currentUser.uid);
            const postRef = db.collection('posts').doc(postId);

            try {
                const viewDoc = await viewRef.get();
                if (!viewDoc.exists) {
                    await viewRef.set({
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await postRef.update({
                        views: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    const viewData = viewDoc.data();
                    const now = new Date();
                    const lastView = viewData.timestamp ? viewData.timestamp.toDate() : new Date(0);
                    const hoursSinceLastView = (now - lastView) / (1000 * 60 * 60);

                    // Allow re-counting view after 24 hours (example) or up to 3 times
                    if (viewData.count < 3 || hoursSinceLastView >= 24) {
                        await viewRef.update({
                            count: firebase.firestore.FieldValue.increment(1),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await postRef.update({
                            views: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error("Error incrementing view count:", error);
                // Don't show modal for this minor background error
            }
        }

        async function toggleLike(postId, likeCountElement) {
            if (!currentUser) {
                showErrorMessage("Please sign in to like posts.");
                return;
            }

            const likeRef = db.collection('posts').doc(postId).collection('likes').doc(currentUser.uid);
            const postRef = db.collection('posts').doc(postId);

            try {
                const doc = await likeRef.get();
                if (doc.exists) {
                    // Unlike
                    await likeRef.delete();
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(-1)
                    });
                    likeCountElement.previousElementSibling.classList.remove('liked', 'fas');
                    likeCountElement.previousElementSibling.classList.add('far');
                } else {
                    // Like
                    await likeRef.set({
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await postRef.update({
                        likes: firebase.firestore.FieldValue.increment(1)
                    });
                    likeCountElement.previousElementSibling.classList.add('liked', 'fas');
                    likeCountElement.previousElementSibling.classList.remove('far');
                }
                // Fetch and update like count immediately
                const postDoc = await postRef.get();
                if (postDoc.exists) {
                    likeCountElement.textContent = formatNumber(postDoc.data().likes || 0);
                }
            } catch (error) {
                console.error("Error toggling like:", error);
                showErrorMessage(`Error liking post: ${error.message}`);
            }
        }

        async function sendEmojiReaction(postId, emoji) {
            if (!currentUser) {
                showErrorMessage("Please sign in to react to posts.");
                return;
            }

            const reactionRef = db.collection('posts').doc(postId).collection('reactions').doc(currentUser.uid);
            try {
                // Check if user already reacted
                const existingReaction = await reactionRef.get();
                if (existingReaction.exists) {
                    const oldEmoji = existingReaction.data().emoji;
                    if (oldEmoji === emoji) {
                        // User clicked same emoji, remove reaction
                        await reactionRef.delete();
                        // Decrement old emoji count on post
                        await db.collection('posts').doc(postId).update({
                            [`reactions.${oldEmoji}`]: firebase.firestore.FieldValue.increment(-1)
                        });
                    } else {
                        // User changed emoji, update reaction
                        await reactionRef.set({ emoji: emoji, userId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                        // Decrement old emoji count, increment new emoji count
                        await db.collection('posts').doc(postId).update({
                            [`reactions.${oldEmoji}`]: firebase.firestore.FieldValue.increment(-1),
                            [`reactions.${emoji}`]: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                } else {
                    // New reaction
                    await reactionRef.set({ emoji: emoji, userId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    // Increment new emoji count on post
                    await db.collection('posts').doc(postId).update({
                        [`reactions.${emoji}`]: firebase.firestore.FieldValue.increment(1)
                    });
                }
                updateEmojiSummary(postId, document.querySelector(`.emoji-summary[data-post-id="${postId}"]`));

            } catch (error) {
                console.error("Error sending emoji reaction:", error);
                showErrorMessage(`Error reacting: ${error.message}`);
            }
        }

        async function updateEmojiSummary(postId, summaryElement) {
            if (!summaryElement) return;
            const postDoc = await db.collection('posts').doc(postId).get();
            if (postDoc.exists) {
                const reactions = postDoc.data().reactions || {};
                let summaryHTML = '';
                let totalReactions = 0;

                // Sort emojis for consistent display (e.g., by count or alphabetically)
                const sortedEmojis = Object.keys(reactions).sort((a, b) => (reactions[b] || 0) - (reactions[a] || 0));

                for (let i = 0; i < Math.min(3, sortedEmojis.length); i++) { // Show top 3 distinct emojis
                    const emoji = sortedEmojis[i];
                    const count = reactions[emoji] || 0;
                    if (count > 0) {
                        summaryHTML += `<span>${emoji}</span>`;
                        totalReactions += count;
                    }
                }
                if (totalReactions > 0) {
                    summaryHTML += `<span class="count">${formatNumber(totalReactions)}</span>`;
                }

                summaryElement.innerHTML = summaryHTML;
                if (totalReactions === 0) {
                    summaryElement.classList.add('hidden');
                } else {
                    summaryElement.classList.remove('hidden');
                }
            }
        }


        // --- Infinite Scroll ---
        mainContent.addEventListener('scroll', () => {
            // Load more posts when user scrolls near the bottom of the feed
            if (homePage.classList.contains('active') && mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 200) {
                loadPosts(true); // true to append
            }
        });

        refreshPostsButton.addEventListener('click', () => {
            loadPosts(false, true); // false to clear, true for refresh
        });

        // --- Post Upload Logic ---
        publishPostButton.addEventListener('click', async () => {
            if (!currentUser) {
                showErrorMessage("Please sign in to publish posts.");
                return;
            }

            const content = postContentInput.value.trim();
            const boostHours = parseInt(postBoostHoursSelect.value);

            if (!content) {
                uploadMessageDisplay.style.color = 'var(--neon-red)';
                uploadMessageDisplay.textContent = 'Post content cannot be empty.';
                return;
            }

            try {
                const userRewardsRef = db.collection('userRewards').doc(currentUser.uid);
                const userRewardsDoc = await userRewardsRef.get();
                const userRewards = userRewardsDoc.data();

                let coinsNeeded = 5;
                let limitNeeded = 1;
                let adsToWatch = 0;

                if (boostHours === 18) adsToWatch = 1;
                else if (boostHours === 24) adsToWatch = 2;
                else if (boostHours === 30) adsToWatch = 3;

                if (userRewards.coins < coinsNeeded || userRewards.limit < limitNeeded) {
                    showInfoMessage(
                        "Not Enough Resources!",
                        `You need ${coinsNeeded} coins and ${limitNeeded} limit to post. You have ${userRewards.coins || 0} coins and ${userRewards.limit || 0} limit. Watch an ad to earn more!`
                    );
                    showModal('adWatchModal');
                    return;
                }

                // If no ads needed for boost, proceed with post
                if (adsToWatch === 0) {
                    await proceedWithPostUpload(content, boostHours, coinsNeeded, limitNeeded);
                } else {
                    // Show ad modal for boost
                    showInfoMessage(
                        "Boost Your Post!",
                        `You need to watch ${adsToWatch} ad(s) to boost your post for ${boostHours} hours.`
                    );
                    showModal('adWatchModal');
                    // Store post details temporarily
                    sessionStorage.setItem('pendingPostContent', content);
                    sessionStorage.setItem('pendingPostBoostHours', boostHours);
                    sessionStorage.setItem('pendingPostAdsNeeded', adsToWatch);
                    sessionStorage.setItem('pendingPostCoinsNeeded', coinsNeeded);
                    sessionStorage.setItem('pendingPostLimitNeeded', limitNeeded);
                }

            } catch (error) {
                console.error("Error checking post upload conditions:", error);
                uploadMessageDisplay.style.color = 'var(--neon-red)';
                uploadMessageDisplay.textContent = `Error: ${error.message}`;
            }
        });

        async function proceedWithPostUpload(content, boostHours, coinsCut, limitCut) {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists || !userDoc.data().username) {
                    showErrorMessage("Profile not complete. Please complete your profile first.");
                    showPage('profileSetupPage');
                    return;
                }

                const username = userDoc.data().username;

                const postData = {
                    userId: currentUser.uid,
                    username: username,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0,
                    views: 0,
                    reactions: {}, // {👍: 5, ❤️: 2}
                    boostHours: boostHours
                };

                // Calculate expiry date
                const expiryDate = new Date();
                expiryDate.setHours(expiryDate.getHours() + boostHours);
                postData.expiresAt = firebase.firestore.Timestamp.fromDate(expiryDate);


                await db.collection('posts').add(postData);

                // Deduct coins and limit
                await db.collection('userRewards').doc(currentUser.uid).update({
                    coins: firebase.firestore.FieldValue.increment(-coinsCut),
                    limit: firebase.firestore.FieldValue.increment(-limitCut),
                    lastPostUploadTime: firebase.firestore.FieldValue.serverTimestamp()
                });

                uploadMessageDisplay.style.color = 'var(--neon-green)';
                uploadMessageDisplay.textContent = 'Post published successfully!';
                postContentInput.value = ''; // Clear input
                postBoostHoursSelect.value = '12'; // Reset boost hours

                // Refresh posts on home page
                loadPosts(false, true);
                showPage('homePage');

            } catch (error) {
                console.error("Error publishing post:", error);
                uploadMessageDisplay.style.color = 'var(--neon-red)';
                uploadMessageDisplay.textContent = `Error publishing post: ${error.message}`;
            }
        }


        // --- Reward System (Coins, Limit, Credit) ---
        async function checkAndShowDailyReward() {
            if (!currentUser) return;
            const userRewardsRef = db.collection('userRewards').doc(currentUser.uid);
            try {
                const userRewardsDoc = await userRewardsRef.get();
                if (userRewardsDoc.exists) {
                    const rewardsData = userRewardsDoc.data();
                    const lastClaimed = rewardsData.lastClaimed ? rewardsData.lastClaimed.toDate() : null;
                    const now = new Date();

                    if (!lastClaimed || (now - lastClaimed) / (1000 * 60 * 60 * 24) >= 1) { // 24 hours passed
                        rewardModalTitle.textContent = "Daily Reward!";
                        rewardModalMessage.textContent = `Claim your 2 Limit, 10 Coins, and 10 Credit!`;
                        claimRewardButton.classList.remove('hidden');
                        closeRewardModalButton.classList.add('hidden'); // Hide close button initially
                        showModal('rewardModal');
                    } else {
                        const nextClaimTime = new Date(lastClaimed.getTime() + (24 * 60 * 60 * 1000));
                        const timeLeft = nextClaimTime - now;
                        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        rewardModalTitle.textContent = "Reward Available Soon!";
                        rewardModalMessage.textContent = `Next reward in ${hours}h ${minutes}m.`;
                        claimRewardButton.classList.add('hidden'); // Hide claim button
                        closeRewardModalButton.classList.remove('hidden'); // Show close button
                        showModal('rewardModal');
                    }
                } else {
                    // Initialize rewards for new user if not already
                    await userRewardsRef.set({
                        lastClaimed: null,
                        limit: 1,
                        coins: 10,
                        credit: 10,
                        lastPostUploadTime: null
                    }, { merge: true });
                    checkAndShowDailyReward(); // Re-run to show reward now
                }
            } catch (error) {
                console.error("Error checking daily reward:", error);
                // Not crucial to show a modal for this, but log it.
            }
        }

        giftButton.addEventListener('click', () => {
            checkAndShowDailyReward();
        });

        claimRewardButton.addEventListener('click', async () => {
            if (!currentUser) {
                showErrorMessage("Please sign in to claim rewards.");
                return;
            }
            try {
                const userRewardsRef = db.collection('userRewards').doc(currentUser.uid);
                await userRewardsRef.update({
                    limit: firebase.firestore.FieldValue.increment(2),
                    coins: firebase.firestore.FieldValue.increment(10),
                    credit: firebase.firestore.FieldValue.increment(10),
                    lastClaimed: firebase.firestore.FieldValue.serverTimestamp()
                });
                rewardModalTitle.textContent = "Reward Claimed!";
                rewardModalMessage.textContent = "You've received 2 Limit, 10 Coins, and 10 Credit!";
                claimRewardButton.classList.add('hidden');
                closeRewardModalButton.classList.remove('hidden'); // Show close button
                // You can add an animation here if you want
            } catch (error) {
                console.error("Error claiming reward:", error);
                showErrorMessage(`Error claiming reward: ${error.message}`);
                hideModal('rewardModal'); // Hide modal on error
            }
        });

        closeRewardModalButton.addEventListener('click', () => hideModal('rewardModal'));
        closeErrorModalButton.addEventListener('click', () => hideModal('errorModal'));
        closeInfoModalButton.addEventListener('click', () => hideModal('infoModal'));


        // Simulated Ad Watch
        startAdButton.addEventListener('click', () => {
            showInfoMessage("Ad Playing...", "Please wait while the ad plays. (Simulated)");
            startAdButton.disabled = true;
            skipAdButton.disabled = true;

            setTimeout(async () => {
                hideModal('infoModal'); // Hide "Ad Playing" modal
                showInfoMessage("Ad Complete!", "You've earned rewards!");
                startAdButton.disabled = false;
                skipAdButton.disabled = false;

                // Grant rewards based on context (e.g., if posting, if just for credits)
                const pendingPostContent = sessionStorage.getItem('pendingPostContent');
                if (pendingPostContent) {
                    const adsNeeded = parseInt(sessionStorage.getItem('pendingPostAdsNeeded'));
                    const coinsNeeded = parseInt(sessionStorage.getItem('pendingPostCoinsNeeded'));
                    const limitNeeded = parseInt(sessionStorage.getItem('pendingPostLimitNeeded'));
                    const boostHours = parseInt(sessionStorage.getItem('pendingPostBoostHours'));

                    try {
                         // This is where you'd securely add rewards via a Cloud Function after ad verification
                        await db.collection('userRewards').doc(currentUser.uid).update({
                            limit: firebase.firestore.FieldValue.increment(adsNeeded), // Each ad gives 1 limit for boost
                        });
                        await proceedWithPostUpload(pendingPostContent, boostHours, coinsNeeded, limitNeeded);
                    } catch (error) {
                        console.error("Error granting post boost reward:", error);
                        showErrorMessage(`Error applying boost: ${error.message}`);
                    } finally {
                        sessionStorage.removeItem('pendingPostContent');
                        sessionStorage.removeItem('pendingPostBoostHours');
                        sessionStorage.removeItem('pendingPostAdsNeeded');
                        sessionStorage.removeItem('pendingPostCoinsNeeded');
                        sessionStorage.removeItem('pendingPostLimitNeeded');
                    }
                } else {
                    // General ad for coins/credits/limit
                    try {
                        await db.collection('userRewards').doc(currentUser.uid).update({
                            coins: firebase.firestore.FieldValue.increment(10),
                            credit: firebase.firestore.FieldValue.increment(10),
                            limit: firebase.firestore.FieldValue.increment(1)
                        });
                        showInfoMessage("Rewards Gained!", "You received 10 Coins, 10 Credit, and 1 Limit!");
                    } catch (error) {
                        console.error("Error granting general ad reward:", error);
                        showErrorMessage(`Error getting ad reward: ${error.message}`);
                    }
                }
                setTimeout(() => hideModal('infoModal'), 2000);
                hideModal('adWatchModal');

            }, 3000); // Simulate 3 second ad
        });

        skipAdButton.addEventListener('click', () => {
            hideModal('adWatchModal');
            sessionStorage.removeItem('pendingPostContent'); // Clear any pending post if skipped
            sessionStorage.removeItem('pendingPostBoostHours');
            sessionStorage.removeItem('pendingPostAdsNeeded');
            sessionStorage.removeItem('pendingPostCoinsNeeded');
            sessionStorage.removeItem('pendingPostLimitNeeded');
        });

        // --- Side Menu & Navigation ---
        menuButton.addEventListener('click', () => {
            sideMenu.classList.toggle('open');
        });

        // Close side menu when clicking outside
        document.addEventListener('click', (event) => {
            if (!sideMenu.contains(event.target) && !menuButton.contains(event.target)) {
                sideMenu.classList.remove('open');
            }
        });

        // Data Saver Toggle
        document.getElementById('dataSaverCheckbox').addEventListener('change', (e) => {
            if (e.target.checked) {
                console.log('Data Saver ON');
                // Implement data saver logic (e.g., lower image quality, less frequent updates)
            } else {
                console.log('Data Saver OFF');
                // Revert data saver changes
            }
        });

        document.getElementById('aboutApp').addEventListener('click', () => {
            showInfoMessage("About Addmint", "Addmint is a social sharing platform designed to connect people and share moments. We prioritize user experience and privacy.");
            sideMenu.classList.remove('open');
        });

        document.getElementById('privacyPolicy').addEventListener('click', () => {
            showInfoMessage("Privacy Policy", "Your privacy is important to us. We collect minimal data necessary for app functionality and do not share your personal information with third parties. For full details, please visit our website.");
            sideMenu.classList.remove('open');
        });

        document.getElementById('instagramLink').addEventListener('click', () => {
            window.open('https://www.instagram.com/addmint__', '_blank');
            sideMenu.classList.remove('open');
        });

        document.getElementById('youtubeLink').addEventListener('click', () => {
            window.open('https://www.youtube.com/@add_mint', '_blank');
            sideMenu.classList.remove('open');
        });

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPageId = item.dataset.page;
                showPage(targetPageId);
            });
        });

        // --- Profile Display & Edit ---
        async function displayUserProfile(userId) {
            if (!userId) {
                showErrorMessage("User ID is missing.");
                return;
            }

            // Determine if it's the current user's profile
            const isCurrentUserProfile = (currentUser && currentUser.uid === userId);
            editProfileButton.classList.toggle('hidden', !isCurrentUserProfile);
            profileFollowButton.classList.toggle('hidden', isCurrentUserProfile); // Hide follow button on own profile

            // Hide social buttons if not viewing own profile (or implement logic for public/private profiles)
            if (!isCurrentUserProfile) {
                profileWhatsAppButton.classList.add('hidden');
                profileInstagramButton.classList.add('hidden');
                profileMessageButton.classList.add('hidden');
            } else {
                 profileWhatsAppButton.classList.remove('hidden');
                 profileInstagramButton.classList.remove('hidden');
                 profileMessageButton.classList.remove('hidden');
            }


            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    profilePageAvatar.innerHTML = generateAvatar(userData.username);
                    profilePageName.textContent = userData.name || 'Unknown User';
                    profilePageUsername.textContent = `@${userData.username}`;
                    profilePostsUsername.textContent = userData.username; // For "Posts by [username]" section

                    followersCountSpan.textContent = formatNumber(userData.followers || 0);
                    followingCountSpan.textContent = formatNumber(userData.following || 0);

                    // Update follow button state
                    if (currentUser && currentUser.uid !== userId) {
                        const followDoc = await db.collection('users').doc(currentUser.uid).collection('following').doc(userId).get();
                        if (followDoc.exists) {
                            profileFollowButton.textContent = 'Following';
                            profileFollowButton.classList.remove('follow');
                            profileFollowButton.classList.add('following');
                        } else {
                            profileFollowButton.textContent = 'Follow';
                            profileFollowButton.classList.remove('following');
                            profileFollowButton.classList.add('follow');
                        }
                    }

                    // Social links and message button
                    profileWhatsAppButton.onclick = () => {
                        if (userData.whatsapp) window.open(`https://wa.me/${userData.whatsapp}`, '_blank');
                        else showInfoMessage("No WhatsApp", "This user has not provided a WhatsApp number.");
                    };
                    profileInstagramButton.onclick = () => {
                        if (userData.instagram) window.open(`https://instagram.com/${userData.instagram.replace('@', '')}`, '_blank');
                        else showInfoMessage("No Instagram", "This user has not provided an Instagram handle.");
                    };
                    profileMessageButton.onclick = () => {
                         if (!currentUser) { showErrorMessage("Please sign in to message users."); return; }
                         if (currentUser.uid === userId) { showErrorMessage("You cannot message yourself."); return; }
                         currentChatPartnerId = userId;
                         chatPartnerAvatar.innerHTML = generateAvatar(userData.username);
                         chatPartnerUsername.textContent = userData.username;
                         showPage('messagesPage');
                         loadChatMessages(currentUser.uid, userId);
                         messageThreadsList.classList.add('hidden');
                         chatView.classList.remove('hidden');
                    };

                    loadUserPosts(userId); // Load posts by this user

                } else {
                    showErrorMessage("User not found.");
                    profilePageName.textContent = 'User Not Found';
                    profilePageUsername.textContent = '';
                    followersCountSpan.textContent = 'N/A';
                    followingCountSpan.textContent = 'N/A';
                    profilePostsContainer.innerHTML = '';
                    noProfilePostsText.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error displaying user profile:", error);
                showErrorMessage(`Error loading profile: ${error.message}`);
            }
        }

        async function loadUserPosts(userId) {
            profilePostsContainer.innerHTML = '';
            noProfilePostsText.classList.add('hidden');
            try {
                const snapshot = await db.collection('posts')
                    .where('userId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .limit(10) // Load initial 10 posts
                    .get();

                if (snapshot.empty) {
                    noProfilePostsText.classList.remove('hidden');
                } else {
                    snapshot.forEach(doc => {
                        profilePostsContainer.appendChild(createPostElement(doc.data(), doc.id));
                    });
                }
            } catch (error) {
                console.error("Error loading user posts:", error);
                showErrorMessage(`Error loading user posts: ${error.message}`);
            }
        }

        profileFollowButton.addEventListener('click', async () => {
            if (!currentUser) {
                showErrorMessage("Please sign in to follow users.");
                return;
            }
            if (!profileVisitUserId) return; // Should be set by displayUserProfile

            const followerRef = db.collection('users').doc(currentUser.uid).collection('following').doc(profileVisitUserId);
            const followedRef = db.collection('users').doc(profileVisitUserId).collection('followers').doc(currentUser.uid);
            const currentUserDocRef = db.collection('users').doc(currentUser.uid);
            const targetUserDocRef = db.collection('users').doc(profileVisitUserId);

            try {
                const followDoc = await followerRef.get();
                if (followDoc.exists) {
                    // Unfollow
                    await followerRef.delete();
                    await followedRef.delete();
                    await currentUserDocRef.update({
                        following: firebase.firestore.FieldValue.increment(-1)
                    });
                    await targetUserDocRef.update({
                        followers: firebase.firestore.FieldValue.increment(-1)
                    });
                    profileFollowButton.textContent = 'Follow';
                    profileFollowButton.classList.remove('following');
                    profileFollowButton.classList.add('follow');
                } else {
                    // Follow
                    await followerRef.set({
                        userId: profileVisitUserId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await followedRef.set({
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await currentUserDocRef.update({
                        following: firebase.firestore.FieldValue.increment(1)
                    });
                    await targetUserDocRef.update({
                        followers: firebase.firestore.FieldValue.increment(1)
                    });
                    profileFollowButton.textContent = 'Following';
                    profileFollowButton.classList.remove('follow');
                    profileFollowButton.classList.add('following');
                }
                // Update counts immediately
                const currentUserData = (await currentUserDocRef.get()).data();
                const targetUserData = (await targetUserDocRef.get()).data();
                followersCountSpan.textContent = formatNumber(targetUserData.followers || 0);
                followingCountSpan.textContent = formatNumber(currentUserData.following || 0); // Only update current user's following count if viewing their own profile, otherwise this isn't correct.
            } catch (error) {
                console.error("Error following/unfollowing:", error);
                showErrorMessage(`Error: An error occurred. Please try again.`);
            }
        });


        editProfileButton.addEventListener('click', async () => {
            if (!currentUser) return;
            showPage('editProfilePage');
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    editNameInput.value = userData.name || '';
                    editUsernameInput.value = userData.username || '';
                    editWhatsAppInput.value = userData.whatsapp || '';
                    editInstagramInput.value = userData.instagram || '';
                }
            } catch (error) {
                console.error("Error loading edit profile data:", error);
                showErrorMessage("Could not load profile data for editing.");
            }
        });

        editUsernameInput.addEventListener('input', async () => {
            const username = editUsernameInput.value.trim();
            if (username.length > 0 && currentUser) {
                const currentUsername = (await db.collection('users').doc(currentUser.uid).get()).data().username;
                if (username === currentUsername) {
                    editUsernameCheckFeedback.innerHTML = ''; // Same as current, no check needed
                    return;
                }
                const usernameExists = await checkIfUsernameExists(username);
                if (usernameExists) {
                    editUsernameCheckFeedback.classList.remove('valid');
                    editUsernameCheckFeedback.classList.add('invalid');
                    editUsernameCheckFeedback.innerHTML = '<i class="fas fa-times-circle"></i> Not available';
                } else {
                    editUsernameCheckFeedback.classList.remove('invalid');
                    editUsernameCheckFeedback.classList.add('valid');
                    editUsernameCheckFeedback.innerHTML = '<i class="fas fa-check-circle"></i> Available';
                }
            } else {
                editUsernameCheckFeedback.innerHTML = '';
            }
        });

        saveProfileButton.addEventListener('click', async () => {
            if (!currentUser) return;
            editProfileMessage.textContent = '';

            const name = editNameInput.value.trim();
            const username = editUsernameInput.value.trim();
            const whatsapp = editWhatsAppInput.value.trim();
            const instagram = editInstagramInput.value.trim();

            if (!name || !username || (!whatsapp && !instagram)) {
                editProfileMessage.style.color = 'var(--neon-red)';
                editProfileMessage.textContent = 'Full Name, Unique Username, and at least one social media link (WhatsApp or Instagram) are required.';
                return;
            }

            try {
                const currentUsername = (await db.collection('users').doc(currentUser.uid).get()).data().username;
                if (username !== currentUsername) {
                    const usernameExists = await checkIfUsernameExists(username);
                    if (usernameExists) {
                        editProfileMessage.style.color = 'var(--neon-red)';
                        editProfileMessage.textContent = 'This username is already taken. Please choose another.';
                        return;
                    }
                }

                await db.collection('users').doc(currentUser.uid).update({
                    name: name,
                    username: username,
                    whatsapp: whatsapp,
                    instagram: instagram
                });

                editProfileMessage.style.color = 'var(--neon-green)';
                editProfileMessage.textContent = 'Profile updated successfully!';
                // Refresh the displayed profile
                displayUserProfile(currentUser.uid);
                setTimeout(() => showPage('profilePage'), 1500);

            } catch (error) {
                console.error("Error saving profile:", error);
                editProfileMessage.style.color = 'var(--neon-red)';
                editProfileMessage.textContent = `Error updating profile: ${error.message}`;
            }
        });

        // Click on followers/following count to view lists
        followersStat.addEventListener('click', () => {
            if (!profileVisitUserId) return;
            showInfoMessage("Followers", "Feature to view followers list coming soon!");
        });

        followingStat.addEventListener('click', () => {
            if (!profileVisitUserId) return;
            showInfoMessage("Following", "Feature to view following list coming soon!");
        });


        // --- Search Functionality ---
        searchButton.addEventListener('click', () => performSearch());
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        async function performSearch() {
            const queryText = searchInput.value.trim().toLowerCase();
            searchResultsDiv.innerHTML = '';
            noSearchResultsText.classList.add('hidden');

            if (queryText.length === 0) {
                return;
            }

            try {
                // Search users by username
                const usersSnapshot = await db.collection('users')
                    .where('username', '>=', queryText)
                    .where('username', '<=', queryText + '\uf8ff')
                    .limit(10)
                    .get();

                if (usersSnapshot.empty) {
                    noSearchResultsText.classList.remove('hidden');
                } else {
                    usersSnapshot.forEach(userDoc => {
                        const userData = userDoc.data();
                        const userId = userDoc.id;
                        const userResultDiv = document.createElement('div');
                        userResultDiv.className = 'user-search-result';
                        userResultDiv.dataset.userId = userId;

                        let followButtonHtml = '';
                        if (currentUser && currentUser.uid !== userId) {
                            followButtonHtml = `<button class="profile-action-button follow-button" data-user-id="${userId}">Follow</button>`;
                        }

                        userResultDiv.innerHTML = `
                            ${generateAvatar(userData.username)}
                            <div class="user-search-info">
                                <span class="username">@${userData.username}</span>
                                <p>${userData.name || ''}</p>
                            </div>
                            ${followButtonHtml}
                        `;
                        searchResultsDiv.appendChild(userResultDiv);

                        userResultDiv.querySelector('.username').addEventListener('click', () => {
                            displayUserProfile(userId);
                            showPage('profilePage');
                        });
                        userResultDiv.querySelector('.profile-avatar').addEventListener('click', () => {
                            displayUserProfile(userId);
                            showPage('profilePage');
                        });

                        const resultFollowButton = userResultDiv.querySelector('.follow-button');
                        if (resultFollowButton) {
                            // Update follow button state on search results
                            db.collection('users').doc(currentUser.uid).collection('following').doc(userId).get().then(doc => {
                                if (doc.exists) {
                                    resultFollowButton.textContent = 'Following';
                                    resultFollowButton.classList.remove('follow');
                                    resultFollowButton.classList.add('following');
                                }
                            });

                            resultFollowButton.addEventListener('click', async (e) => {
                                e.stopPropagation(); // Prevent opening profile
                                if (!currentUser) { showErrorMessage("Please sign in to follow users."); return; }

                                const targetUserId = e.target.dataset.userId;
                                const followerRef = db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId);
                                const followedRef = db.collection('users').doc(targetUserId).collection('followers').doc(currentUser.uid);
                                const currentUserDocRef = db.collection('users').doc(currentUser.uid);
                                const targetUserDocRef = db.collection('users').doc(targetUserId);

                                try {
                                    const followDoc = await followerRef.get();
                                    if (followDoc.exists) {
                                        await followerRef.delete();
                                        await followedRef.delete();
                                        await currentUserDocRef.update({ following: firebase.firestore.FieldValue.increment(-1) });
                                        await targetUserDocRef.update({ followers: firebase.firestore.FieldValue.increment(-1) });
                                        e.target.textContent = 'Follow';
                                        e.target.classList.remove('following');
                                        e.target.classList.add('follow');
                                    } else {
                                        await followerRef.set({ userId: targetUserId, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                                        await followedRef.set({ userId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                                        await currentUserDocRef.update({ following: firebase.firestore.FieldValue.increment(1) });
                                        await targetUserDocRef.update({ followers: firebase.firestore.FieldValue.increment(1) });
                                        e.target.textContent = 'Following';
                                        e.target.classList.remove('follow');
                                        e.target.classList.add('following');
                                    }
                                } catch (error) {
                                    console.error("Error toggling follow from search:", error);
                                    showErrorMessage(`Error: An error occurred. Please try again.`);
                                }
                            });
                        }
                    });
                }

            } catch (error) {
                console.error("Error during search:", error);
                showErrorMessage(`Error performing search: ${error.message}`);
            }
        }


        // --- Messaging ---
        async function loadMessageThreads() {
            if (!currentUser) {
                messageThreadsList.innerHTML = '<p class="text-center">Please sign in to view messages.</p>';
                return;
            }
            messageThreadsList.innerHTML = '';
            try {
                // Get all users current user has messaged or been messaged by
                const threads = {};

                const sentMessagesSnapshot = await db.collection('messages')
                    .where('senderId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();

                sentMessagesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const partnerId = data.receiverId;
                    if (!threads[partnerId] || threads[partnerId].timestamp < data.timestamp) {
                        threads[partnerId] = {
                            partnerId: partnerId,
                            lastMessage: data.message,
                            timestamp: data.timestamp,
                            isSender: true
                        };
                    }
                });

                const receivedMessagesSnapshot = await db.collection('messages')
                    .where('receiverId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();

                receivedMessagesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const partnerId = data.senderId;
                    if (!threads[partnerId] || threads[partnerId].timestamp < data.timestamp) {
                        threads[partnerId] = {
                            partnerId: partnerId,
                            lastMessage: data.message,
                            timestamp: data.timestamp,
                            isSender: false
                        };
                    }
                });

                const sortedThreads = Object.values(threads).sort((a, b) => b.timestamp - a.timestamp);

                if (sortedThreads.length === 0) {
                    messageThreadsList.innerHTML = '<p class="text-center">No active chats. Start a new conversation!</p>';
                    return;
                }

                for (const thread of sortedThreads) {
                    const partnerUserDoc = await db.collection('users').doc(thread.partnerId).get();
                    if (partnerUserDoc.exists) {
                        const partnerData = partnerUserDoc.data();
                        const threadItem = document.createElement('div');
                        threadItem.className = 'message-thread-item';
                        threadItem.dataset.partnerId = thread.partnerId;

                        threadItem.innerHTML = `
                            ${generateAvatar(partnerData.username)}
                            <div class="thread-info">
                                <span class="username">${partnerData.username}</span>
                                <p class="last-message">${thread.isSender ? 'You: ' : ''}${thread.lastMessage}</p>
                            </div>
                        `;
                        threadItem.addEventListener('click', () => {
                            currentChatPartnerId = thread.partnerId;
                            chatPartnerAvatar.innerHTML = generateAvatar(partnerData.username);
                            chatPartnerUsername.textContent = partnerData.username;
                            messageThreadsList.classList.add('hidden');
                            chatView.classList.remove('hidden');
                            loadChatMessages(currentUser.uid, thread.partnerId);
                        });
                        messageThreadsList.appendChild(threadItem);
                    }
                }

            } catch (error) {
                console.error("Error loading message threads:", error);
                showErrorMessage(`Error loading chats: ${error.message}`);
            }
        }

        async function loadChatMessages(userId1, userId2) {
            chatMessagesContainer.innerHTML = '';
            // Order to find conversation doc: smaller ID first
            const convoId = userId1 < userId2 ? `${userId1}_${userId2}` : `${userId2}_${userId1}`;

            // Listen for real-time updates to messages
            db.collection('conversations').doc(convoId).collection('messages')
                .where('timestamp', '>', firebase.firestore.Timestamp.now().toDate().getTime() - (12 * 60 * 60 * 1000)) // Only show last 12 hours
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    chatMessagesContainer.innerHTML = ''; // Clear existing messages
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${messageData.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        messageElement.textContent = messageData.message;
                        chatMessagesContainer.appendChild(messageElement);
                    });
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
                }, error => {
                    console.error("Error loading chat messages:", error);
                    showErrorMessage(`Error loading messages: ${error.message}`);
                });
        }

        sendMessageButton.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            if (!currentUser || !currentChatPartnerId) {
                showErrorMessage("Cannot send message: User or recipient not identified.");
                return;
            }

            const message = chatMessageInput.value.trim();
            if (!message) return;

            try {
                const userRewardsRef = db.collection('userRewards').doc(currentUser.uid);
                const userRewardsDoc = await userRewardsRef.get();
                const userRewards = userRewardsDoc.data();

                if (userRewards.credit < 1) { // 1 credit per message
                    showInfoMessage(
                        "Not Enough Credits!",
                        "You need 1 credit to send a message. Watch an ad to earn more!"
                    );
                    showModal('adWatchModal');
                    return;
                }

                // Deduct credit
                await userRewardsRef.update({
                    credit: firebase.firestore.FieldValue.increment(-1)
                });

                const convoId = currentUser.uid < currentChatPartnerId ? `${currentUser.uid}_${currentChatPartnerId}` : `${currentChatPartnerId}_${currentUser.uid}`;

                await db.collection('conversations').doc(convoId).collection('messages').add({
                    senderId: currentUser.uid,
                    receiverId: currentChatPartnerId,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                chatMessageInput.value = ''; // Clear input

            } catch (error) {
                console.error("Error sending message:", error);
                showErrorMessage(`Error sending message: ${error.message}`);
                // If it was a permissions error, it's likely Firestore Rules
            }
        }

        backToThreadsButton.addEventListener('click', () => {
            chatView.classList.add('hidden');
            messageThreadsList.classList.remove('hidden');
            currentChatPartnerId = null; // Clear current chat partner
            loadMessageThreads(); // Reload threads to show latest
        });

        chatEmojiButton.addEventListener('click', () => {
            chatEmojiPopup.classList.toggle('hidden');
        });

        chatEmojiPopup.querySelectorAll('span').forEach(emojiSpan => {
            emojiSpan.addEventListener('click', (e) => {
                e.stopPropagation();
                chatMessageInput.value += e.target.textContent; // Append emoji to message
                chatEmojiPopup.classList.add('hidden');
                chatMessageInput.focus();
            });
        });


        // --- Splash Screen Logic ---
        setTimeout(() => {
            splashScreen.classList.add('hidden');
            // Check auth state after splash screen
            // auth.onAuthStateChanged will handle showing the correct page
        }, 3000); // 3 seconds splash screen

        // Initial setup for the app (hide app until authenticated)
        appContainer.classList.add('hidden');

    </script>
</body>
</html>
